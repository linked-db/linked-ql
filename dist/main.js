(()=>{function m(n){return Array.isArray(n)}function j(n){return n instanceof String||typeof n=="string"&&n!==null}function b(n){return arguments.length&&(n===void 0||typeof n>"u")}function Ut(n){return!j(n)&&!b(n.length)}function U(n){return n===null||n===""}function Oe(n){return typeof n=="function"}function C(n){return Array.isArray(n)||typeof n=="object"&&n||Oe(n)}function W(n){return U(n)||b(n)||n===!1||n===0||C(n)&&!Object.keys(n).length}function y(n){return!Array.isArray(n)&&typeof n=="object"&&n}function _(n,e=!0){return m(n)?n:!e&&y(n)?[n]:n!==!1&&n!==0&&W(n)?[]:Ut(n)?Array.prototype.slice.call(n):y(n)?Object.values(n):[n]}function oe(n){return n instanceof Number||typeof n=="number"}function I(n){return oe(n)||n!==!0&&n!==!1&&n!==null&&n!==""&&!isNaN(n*1)}function v(n,e){var t=void 0;return C(n)&&Object.keys(n).forEach((r,i)=>{t!==!1&&(t=e(I(r)?parseFloat(r):r,n[r],i))}),t}var Z=class{constructor(){this.$={schema:{}},this.defaultDB="db1",this.defaultDBParams={}}async bindSchema(e){if(!y(e))throw new Error("Schema must be an object.");return this.$.schema=e,this}async setDefaultDB(e,t=this.defaultDBParams){return this.defaultDB=e,this.defaultDBParams=t,this}async createDatabaseIfNotExists(e,t=this.defaultDBParams){return t={...t},t.ifNotExists=!0,this.createDatabase(e,t)}async dropDatabaseIfExists(e,t={}){return t={...t},t.ifExists=!0,this.dropDatabase(e,t)}async importDatabase(e,t,r={}){if((await this.databases(e,r)).length){if(r.ifNotExists)return;throw new Error(`Database ${e} already exists.`)}if(!y(t.schema)||t.data&&!y(t.data))throw new Error("Malformed import data.");var i=await this.createDatabase(e,r);return Promise.all(Object.keys(t.schema).map(async s=>{var o=t.schema[s],f=(t.data||{})[s];if(I(s)&&(s=o.name),!s||!y(o)||f&&!m(f))throw new Error(`Malformed import data for table ${s}.`);var a=await i.createTable(s,o);return a.addAll(f||[])}))}async exportDatabase(e,t){if(!(await this.databases(e,t)).length){if(t.ifExists)return;throw new Error(`Database ${e} does not exist.`)}var r=await this.database(e,t),i={schema:{},data:{}},s=await r.tables();return await Promise.all(s.map(async o=>{var f=await r.table(o);i.schema[o]=await f.getSchema(),i.data[o]=await f.getAll()})),i}getDatabaseSchema(e=this.defaultDB){return this.$.schema[e]||{}}setDatabaseSchema(e,t){let r={};return v(t,(i,s)=>{s.name&&s.name!==i?(r[s.name]=s,delete s.name):r[i]=s}),this.$.schema[e]=r,this}unsetDatabaseSchema(e){return delete this.$.schema[e],this}matchDatabaseList(e,t=null,r=[]){return e.filter(i=>(b(t)||U(t)||i.name===t)&&(W(r)||!("version"in r)||!("version"in i)||i.version===r.version))}};function R(n){return Oe(n)||n&&{}.toString.call(n)==="[object function]"}function ee(n,e,t=null){return m(e)?n.filter(r=>t?e.filter(i=>t(r,i)).length:e.indexOf(r)!==-1):[]}function M(n){let e=(t,r,i)=>i.indexOf(t)===r;return n.filter(e)}function J(n,e,t=null){return m(e)?n.filter(r=>t?e.filter(i=>t(r,i)).length:e.indexOf(r)===-1):[]}var te=class{constructor(e,t,r){this.driver=e,this.databaseName=t,this.def=r}async tables(){}async table(e){}async createTable(e,t={},r={}){}async alterTable(e,t,r={}){}async dropTable(e,t={}){}getTableSchema(e){return this.driver.getDatabaseSchema(this.databaseName)[e]}setTableSchema(e,t){let r={};v(t.columns,(s,o)=>{o.name&&o.name!==s?(r[o.name]=o,delete o.name):r[s]=o}),t.columns=r;let i=this.driver.getDatabaseSchema(this.databaseName);return i[e]=t,this.driver.setDatabaseSchema(this.databaseName,i),this}unsetTableSchema(e){return delete this.driver.getDatabaseSchema(this.databaseName)[e],this}cloneTableSchema(e){if(y(e)){var t={};return v(e,(r,i)=>{t[r]=this.cloneTableSchema(i)}),t}return m(e)?e.map(r=>this.cloneTableSchema(r)):e}diffTableSchema(e,t,r){let i={columns:{add:{},alter:{},drop:{}},primaryKey:{},foreignKeys:{add:{},alter:{},drop:{}},indexes:{add:{},alter:{},drop:{}},jsonColumns:{add:{},alter:{},drop:{}},renamedColumns:{},renameTo:null},s={columns:(a,h,u)=>{var c=Object.keys(a==="drop"?{}:h),p=Object.keys(a==="add"?{}:u);J(c,p).forEach(l=>{i.columns.add[l]=h[l],h[l].primaryKey&&(i.primaryKey.add=l),h[l].referencedEntity&&(i.foreignKeys.add["fk_index__"+l]={columnName:l,...h[l].referencedEntity}),h[l].index&&(i.indexes.add["index__"+l]={keys:l,type:"index"}),h[l].unique&&(i.indexes.add["unique_index__"+l]={keyPath:l,type:"unique"}),h[l].fulltext&&(i.indexes.add["fulltext_index__"+l]={keyPath:l,type:"fulltext"}),(h[l].type||"").toLowerCase()==="json"&&(i.jsonColumns.add["json_check_constraint__"+l]=l)}),ee(c,p).forEach(l=>{var g=Object.keys(h[l]),T=Object.keys(u[l]),E={current:h[l],prev:u[l],addedProps:J(g,T),alteredProps:ee(g,T).filter(O=>!bt(h[l][O],u[l][O])),droppedProps:J(T,g)};J(M([].concat(E.addedProps,E.alteredProps,E.droppedProps)),["name","primaryKey","referencedEntity","index","unique","fulltext"]).length&&(i.columns.alter[l]=E),(E.addedProps.includes("name")||E.alteredProps.includes("name")&&h[l].name!==l)&&(i.renamedColumns[l]=h[l].name),E.addedProps.includes("primaryKey")||E.alteredProps.includes("primaryKey")&&h[l].primaryKey?i.primaryKey.add=l:(E.droppedProps.includes("primaryKey")||E.alteredProps.includes("primaryKey")&&!h[l].primaryKey)&&(i.primaryKey.drop=l),E.addedProps.includes("referencedEntity")||E.alteredProps.includes("referencedEntity")&&h[l].referencedEntity?i.foreignKeys.add["fk_index__"+l]=h[l].referencedEntity:(E.droppedProps.includes("referencedEntity")||E.alteredProps.includes("referencedEntity")&&!h[l].referencedEntity)&&(i.foreignKeys.drop["fk_index__"+l]=u[l].referencedEntity),E.addedProps.includes("index")||E.alteredProps.includes("index")&&h[l].index?i.indexes.add["index__"+l]={keys:l,type:"index"}:(E.droppedProps.includes("index")||E.alteredProps.includes("index")&&!h[l].index)&&(i.indexes.drop["index__"+l]={keys:l,type:"index"}),E.addedProps.includes("unique")||E.alteredProps.includes("unique")&&h[l].unique?i.indexes.add["unique_index__"+l]={keyPath:l,type:"unique"}:(E.droppedProps.includes("unique")||E.alteredProps.includes("unique")&&!h[l].unique)&&(i.indexes.drop["unique_index__"+l]={keyPath:l,type:"unique"}),E.addedProps.includes("fulltext")||E.alteredProps.includes("fulltext")&&h[l].fulltext?i.indexes.add["fulltext_index__"+l]={keyPath:l,type:"fulltext"}:(E.droppedProps.includes("fulltext")||E.alteredProps.includes("fulltext")&&!h[l].fulltext)&&(i.indexes.drop["fulltext_index__"+l]={keyPath:l,type:"fulltext"}),(E.addedProps.includes("type")||E.alteredProps.includes("type"))&&(h[l].type||"").toLowerCase()==="json"?i.jsonColumns.add["json_check_constraint__"+l]=l:(E.droppedProps.includes("type")||E.alteredProps.includes("type"))&&(u[l].type||"").toLowerCase()==="json"&&(i.jsonColumns.drop["json_check_constraint__"+l]=l)}),J(p,c).forEach(l=>{i.columns.drop[l]=u[l],u[l].primaryKey&&(i.primaryKey.drop=l),u[l].referencedEntity&&(i.foreignKeys.drop["fk_index__"+l]=u[l].referencedEntity),u[l].index&&(i.indexes.drop["index__"+l]={keys:l,type:"index"}),u[l].unique&&(i.indexes.drop["unique_index__"+l]={keyPath:l,type:"unique"}),u[l].fulltext&&(i.indexes.drop["fulltext_index__"+l]={keyPath:l,type:"fulltext"}),(u[l].type||"").toLowerCase()==="json"&&(i.jsonColumns.drop["json_check_constraint__"+l]=!0)})},name:(a,h)=>{a!=="drop"&&h!==r&&(i.renameTo=h)},primaryKey:(a,h,u)=>{var c=_(h).join("___"),p=_(u).join("___");c!==p&&(i.primaryKey[a]=a==="drop"?u:h)},foreignKeys:(a,h,u)=>{var c=Object.keys(a==="drop"?{}:h),p=Object.keys(a==="add"?{}:u);J(c,p).forEach(l=>{i.foreignKeys.add[l]=h[l]}),ee(c,p).forEach(l=>{i.foreignKeys.alter[l]={current:h[l],prev:u[l]}}),J(p,c).forEach(l=>{i.foreignKeys.drop[l]=u[l]})},indexes:(a,h,u)=>{var c=Object.keys(a==="drop"?{}:h),p=Object.keys(a==="add"?{}:u);J(c,p).forEach(l=>{i.indexes.add[l]=h[l]}),ee(c,p).forEach(l=>{i.indexes.alter[l]={current:h[l],prev:u[l]}}),J(p,c).forEach(l=>{i.indexes.drop[l]=u[l]})}};var o=Object.keys(t),f=Object.keys(e);return J(o,f).forEach(a=>{s[a]("add",t[a],null)}),ee(o,f).forEach(a=>{s[a]("alter",t[a],e[a])}),J(f,o).forEach(a=>{s[a]("drop",null,e[a])}),i}validateSchema(e,t=!1){try{if(!y(e))throw new Error("Table definition must be an object.");if(!e.name)throw new Error("Table must have a name.");if(!y(e.columns))throw new Error('Table must have a valid "columns" list.');v(e.columns,(r,i)=>{if(!y(i))throw new Error('Invalid column definition: "'+r+'" at "'+e.name+'".');if(i.referencedEntity&&!(y(i.referencedEntity)&&i.referencedEntity.name))throw new Error('Invalid foreign key definition: "'+r+'" at "'+e.name+'".')})}catch(r){if(t)throw r;return!1}return!0}},bt=(n,e)=>{if(n===e)return!0;if(m(n)&&m(e)&&n.length===e.length)return n.reduce((r,i)=>r&&e.includes(i),!0);var t={};return y(n)&&y(e)&&(t.keys_a=Object.keys(n)).length===(t.keys_b=Object.keys(e)).length?t.keys_a.reduce((r,i)=>r&&bt(n[i],e[i]),!0):!1};function Ge(n,...e){return e.forEach(t=>{n.indexOf(t)<0&&n.push(t)}),n}function ut(r,e){e=e||Object.prototype,e=e&&!m(e)?[e]:e;for(var t=[],r=r;r&&(!e||e.indexOf(r)<0)&&r.name!=="default";)t.push(r),r=r?Object.getPrototypeOf(r):null;return t}function jt(n,e){var t=[];return ut(n,e).forEach(r=>{Ge(t,...Object.getOwnPropertyNames(r))}),t}function G(n,e,t=!1,r=!1,i=!1){var s=0,o=n.shift();if((I(o)||o===!0||o===!1)&&(s=o,o=n.shift()),!n.length)throw new Error("_merge() requires two or more array/objects.");return n.forEach((f,a)=>{!C(f)&&!R(f)||(t?jt(f):Object.getOwnPropertyNames(f)).forEach(h=>{if(e(h,o,f,a)){var u=o[h],c=f[h];if((m(u)&&m(c)||y(u)&&y(c))&&(s===!0||s>0))o[h]=m(u)&&m(c)?[]:{},G([I(s)?s-1:s,o[h],u,c],e,t,r,i);else if(m(o)&&m(f))r?o[h]=c:o.push(c);else try{i?Object.defineProperty(o,h,Object.getOwnPropertyDescriptor(f,h)):o[h]=f[h]}catch{}}})}),o}function ae(...n){return G(n,(e,t,r)=>!0,!1,!1,!1)}var we=class extends Error{};function Re(n,e){return n.reduce((t,r,i)=>t&&e(r,i),!0)}function L(n,e,t){return n.startsWith(e)&&n.endsWith(t)}var re=class{constructor(e,t,r,i={}){this.database=e,this.name=t,this.def=r,this.params=i,W(r.schema)&&(r.schema={primaryKey:"",columns:{},indexes:{},derived:!0})}getKeyPathForPrimaryKey(){var e=Object.keys(this.def.schema.columns).filter(t=>this.def.schema.columns[t].primaryKey);return!e.length&&this.def.schema.primaryKey&&(e=_(this.def.schema.primaryKey)),e}getKeyPathsForIndex(e){var t=Object.keys(this.def.schema.columns).filter(r=>this.def.schema.columns[r][e]);return this.def.schema.indexes&&Object.keys(this.def.schema.indexes).filter(r=>this.def.schema.indexes[r].type===e).forEach(r=>{t.push(_(this.def.schema.indexes[r].keyPath))}),t}async syncCursor(e){return await this.putAll(e.cache)}async match(e){var t,r;if(this.def.schema.primaryKey&&(t=ct(e,this.def.schema.primaryKey))&&(r=await this.get(t)))return{matchingKey:"PRIMARY_KEY",primaryKey:t,row:r};var i,s=Object.keys(this.def.schema.indexes).filter(o=>this.def.schema.indexes[o].type==="unique");return s.length&&(await this.getAll()).forEach((o,f)=>{i||s.forEach(a=>{var h=this.def.schema.indexes[a].keyPath;o&&ct(e,h)===ct(o,h)&&(i={matchingKey:a,primaryKey:this.def.schema.primaryKey?ct(o,this.def.schema.primaryKey):f,row:{...o}})})}),i}async addAll(e,t=[],r=null,i=!1){var s,o=[],f=await Promise.all(e.map(async(a,h)=>{var u={};if(y(a))u=a;else{var c=t.length?t:Object.keys(this.def.schema.columns);if(c.length&&c.length!==a.length)throw new Error("Column/values count mismatch at line "+h+"!");c.forEach((p,l)=>{u[p]=a[l]})}return this.handleInput(u,!0),this.shouldMatchInput(u)||r?(s=new Promise(async p=>{await s;var l=await this.match(u);if(l&&r){var g={...l.row};return r(g,u)&&o.push(g),p("0")}await this.beforeAdd(u,l),p(this.add(u))}),s):(await this.beforeAdd(u),this.add(u))}));return o.length&&(f=f.concat(await this.putAll(o))),f.filter((a,h)=>a!==0&&f.indexOf(a)===h)}async beforeAdd(e,t){var r=new Date().toISOString();v(this.def.schema.columns||{},(i,s)=>{(s.type==="datetime"||s.type==="timestamp")&&s.default==="CURRENT_TIMESTAMP"&&(e[i]=r)})}async putAll(e){var t,r=await Promise.all(e.map(async i=>(this.handleInput(i),this.shouldMatchInput(i)?(t=new Promise(async s=>{await t,await this.beforePut(i,await this.match(i)),s(this.put(i))}),t):(await this.beforePut(i),this.put(i)))));return r}async beforePut(e,t){if(t&&!Re(Object.keys(e),i=>e[i]===t.row[i])){var r=new Date().toISOString();v(this.def.schema.columns||{},(i,s)=>{(s.type==="datetime"||s.type==="timestamp")&&s.onupdate==="CURRENT_TIMESTAMP"&&(e[i]=r)})}}async deleteAll(e){var t=await Promise.all(e.map(async r=>this.delete(await this.beforeDelete(r))));return t}async beforeDelete(e){return e}handleInput(e,t=!1){var r=Object.keys(e),i=Object.keys(this.def.schema.columns),s=r.filter(o=>i.indexOf(o)===-1);if(s.length)throw new Error("Unknown column: "+s[0]);i.forEach(o=>{var f=e[o],a=y(this.def.schema.columns[o])?this.def.schema.columns[o]:{};if(r.includes(o)?a.type==="json"?!C(_value)&&(!j(f)||!L(f,"[","]")&&L(f,"{","}")):["char","tinytext","smalltext","text","bigtext","varchar"].includes(a.type)?j(f):["bit","tinyint","smallint","int","bigint","decimal","number","float","real"].includes(a.type)?I(f):["enum","set"].includes(a.type)?I(f):["date","datetime","timestamp"].includes(a.type)&&j(f):t&&!ee(_(o),_(this.def.schema.primaryKey)).length&&(e[o]="default"in a&&!(["date","datetime","timestamp"].includes(a.type)&&a.default==="CURRENT_TIMESTAMP")?a.default:null),a.nullable===!1&&(U(e[o])||b(e[o])))throw new Error("Inserting NULL on non-nullable column: "+o)})}shouldMatchInput(e){return Object.keys(this.def.schema.columns).filter(t=>{var r=this.def.schema.columns[t];return["datetime","timestamp"].includes(r.type)&&(r.default==="CURRENT_TIMESTAMP"||r.onupdate==="CURRENT_TIMESTAMP")}).length}},ct=(n,e)=>_(e).map(t=>n[t]).filter(t=>t).join("-");var ie=class{constructor(e){this.cache=e,this.key=0,this.flags={},this._onfinish=[]}onfinish(e){this._onfinish.push(e)}next(){if(!this.cache.length||this.key===this.cache.length-1){this.__eof=!0,this._onfinish.forEach(e=>e()),this.key=0;return}this.key++}eof(){return!this.cache.length||this.key===this.cache.length-1}async fetch(){if(this.key<this.cache.length)return this.cache[this.key]}};var Ye=class extends ie{};var ye=class extends re{constructor(e,t,r,i={}){super(...arguments),this.ongoingWrite=null}getCursor(){return new Ye((this.def.data||[]).reduce((e,t)=>e.concat(t?{...t}:void 0),[]).filter(e=>e))}async getAll(){return(this.def.data||[]).reduce((e,t)=>e.concat(t?{...t}:void 0),[])}async get(e){var t=Object.keys(this.def.schema.columns).filter(s=>this.def.schema.columns[s].primaryKey)[0],r=Object.keys(this.def.schema.columns).filter(s=>this.def.schema.columns[s].autoIncrement)[0];if(!t)throw new Error("Table must define a Primary Key to fetch an item by Primary Key.");var i=this.def.data;return e=_(e).join("-"),t===r?i[e-1]?{...i[e-1]}:void 0:i[e]?{...i[e]}:void 0}async count(){var e=this.def.data;return e.length}shouldMatchInput(e){return this.def.schema.primaryKey||super.shouldMatchInput(e)}async beforeAdd(e,t){if(t)throw new we("Inserting duplicate values on unique key constraint: "+t.matchingKey);var r=this.def.data;Nt(r,e,this.def.schema.primaryKey,this.def.schema.autoIncrement),await super.beforeAdd(e,t)}add(e){return this.ongoingWrite=new Promise(async(t,r)=>{try{await this.ongoingWrite}catch{}var i=this.def.data,s=St(e,this.def.schema.primaryKey);this.def.schema.autoIncrement?i[s-1]=e:i[s]=e,t(s)}),this.ongoingWrite}async beforePut(e,t){if(t)v(t.row,(i,s)=>{i in e||(e[i]=s)});else{var r=this.def.data;Nt(r,e,this.def.schema.primaryKey,this.def.schema.autoIncrement)}await super.beforePut(e,t)}put(e){return this.ongoingWrite=new Promise(async t=>{try{await this.ongoingWrite}catch{}var r=this.def.data,i=St(e,this.def.schema.primaryKey);this.def.schema.autoIncrement?r[i-1]=e:r[i]=e,t(i)}),this.ongoingWrite}delete(e,t=!0){return this.ongoingWrite=new Promise(async(r,i)=>{try{await this.ongoingWrite}catch{}var s,o=this.def.data;if(this.def.schema.autoIncrement?o[e-1]&&(delete o[e-1],s=e):o[e]&&(delete o[e],s=e),!s&&t)return i(new Error("The given row (with "+_(this.def.schema.primaryKey).join(",")+" = "+s+") does not exist in the store."));r(s)}),this.ongoingWrite}async clear(){var e=this.def.data;return e.splice(0),!0}},St=(n,e)=>_(e).map(t=>n[t]).filter(t=>t).join("-");function Nt(n,e,t,r){if(t){var i=St(e,t),s=_(t);if(s.length>1)throw new Error("The Auto-Increment flag cannot be used with Composite Primary Keys.");return i=n.length+1,e[s[0]]=i,i}}var _e=class extends te{async tables(){return Object.keys(this.def.schema)}async table(e,t={}){return new ye(this,e,{schema:this.def.schema[e],data:this.def.data[e]},t)}async createTable(e,t,r={}){if((await this.tables()).includes(e)){if(r.ifNotExists)return;throw new Error(`Store name "${e}" already exists!`)}return this.def.schema[e]=t,this.def.data[e]=[],new ye(this,e,{schema:this.def.schema[e],data:this.def.data[e]})}async alterTable(e,t,r={}){var i=await this.getTableSchema(e),s;if(R(t))s=this.cloneSchema(i),await t(s);else if(y(callback))s=t;else throw new Error("Table/store modification expects only an object (new schema) or a function (callback that recieves existing schema).");if(!(await this.tables()).includes(e)){if(r.ifExists)return;throw new Error(`Store name "${e}" does not exist!`)}var o=this.def.data[e];return v(this.diffSchema(i,s),(f,a)=>{f!=="renamedColumns"?(v(a.add,(h,u)=>{this.applyToStore[f](o,h,u,"add")}),v(a.alter,(h,u)=>{this.applyToStore[f](o,h,u.current,"alter")}),v(a.drop,(h,u)=>{this.applyToStore[f](o,h,u,"drop")})):v(a,(h,u)=>{this.applyToStore[f](o,h,u)})}),new ye(this,e,{schema:this.def.schema[e],data:o},{})}async dropTable(e,t={}){if(!(await this.tables()).includes(e)){if(t.ifExists)return;throw new Error(`Store name "${e}" does not exist!`)}delete this.def.schema[e],delete this.def.data[e]}async getTableSchema(e){return this.def.schema[e]}};_e.prototype.applyToStore={primaryKey:(n,e,t,r)=>{},columns:(n,e,t,r)=>{},foreignKeys:(n,e,t,r)=>{},indexes:(n,e,t,r)=>{if(r==="drop"){n.deleteIndex(e);return}r==="alter"&&n.indexNames.contains(e)&&n.deleteIndex(e),n.createIndex(e,t.keyPath,{unique:t.type==="unique"})},jsonColumns:(n,e,t,r)=>{},renamedColumns:(n,e,t)=>"ALTER COLUMN `"+e+"` RENAME TO `"+t+"`"};var He=class extends Z{constructor(){super(),this.$.data={},this.name="odb"}async databases(e=null,t={}){var r=Object.keys(this.$.schema).map(i=>({name:i}));return this.matchDatabaseList(r,e,t)}async database(e=this.defaultDB,t=this.defaultDBParams){if(t.version&&!I(t.version))throw new Error("Database version (params.version) must be numeric.");var r=await this.databases(e,t);return r.length,e in this.$.data||(this.setDatabaseSchema(e,{}),this.$.data[e]={}),new _e(this,e,{schema:this.getDatabaseSchema(e),data:this.$.data[e]},t)}async createDatabase(e,t=this.defaultDBParams){if((await this.databases(e,t)).length){if(t.ifNotExists)return;throw new Error(`Database ${e} already exists.`)}return this.setDatabaseSchema(e,{}),this.$.data[e]={},await this.setDefaultDB(e,t),new _e(this,e,{schema:this.getDatabaseSchema(e),data:this.$.data[e]},t)}async dropDatabase(e,t={}){if(!(await this.databases(e,t)).length){if(t.ifExists)return;throw new Error(`Database ${e} does not exist.`)}this.unsetDatabaseSchema(e)}async query(e,t=[],r={}){return r={...r},r.vars=t,r.dbDriver=this,ObjSQL.parse(e,null,r).eval(this)}};var Qe=class extends ie{constructor(e){super([]),this._store=e,this._storeFetch=new Promise(async t=>{var r=await this._store,i=r.getAll();i.onsuccess=s=>{this.cache=_(s.target.result),t()}})}async fetch(){return await this._storeFetch,super.fetch()}};var Je=class{constructor(e){this._store=e,this.cache=[],this.key=0,this._onfinish=[],this.flags={}}onfinish(e){this._onfinish.push(e)}next(){if(this._eof){if(!this.cache.length||this.key===this.cache.length-1){this._onfinish.forEach(e=>e()),this.key=0;return}this.key++}else{if(!this._cursorRequest)throw new Error("fetch() must be called before calling next()");this.key++}}eof(){return this._eof&&(!this.cache.length||this.key===this.cache.length-1)}async fetch(){var e=await this._store;return new Promise(t=>{this._eof||this.key<this.cache.length?t(this.cache[this.key]):this._countRequest?(this._handleCursorFetch(t),this._continueCursor()):(this._countRequest=e.count(),this._countRequest.onsuccess=r=>{this._count=r.target.result,this._cursorRequest=e.openCursor(),this._handleCursorFetch(t),this._continueCursor=()=>this._cursor.continue()})})}_handleCursorFetch(e){this._cursorRequest.onsuccess=t=>{if(this._cursor=t.target.result,this._cursor){var r=this._cursor.value;this.cache.push(r),this.cache.length===this._count&&(this._eof=!0),e(r)}else this._eof=!0,e()}}};var ve=class extends re{getCursor(){return new Qe(this.def.getStore())}getProgressiveCursor(){return new Je(this.def.getStore())}getAll(){return new Promise(async(e,t)=>{var r=(this.tx_store||this.def.getStore("readonly")).getAll();r.onsuccess=i=>e(_(i.target.result)),r.onerror=i=>t(i.target.error)})}get(e){return new Promise(async(t,r)=>{e=I(e)?parseInt(e):e;var i=(this.tx_store||this.def.getStore("readonly")).get(e);i.onsuccess=s=>t(s.target.result),i.onerror=s=>r(s.target.error)})}count(...e){return new Promise(async(t,r)=>{var i=this.def.getStore().count(...e);i.onsuccess=s=>t(s.target.result),i.onerror=s=>r(s.target.error)})}addAll(e,t=[],r=null){return this.tx_store=this.def.getStore(),super.addAll(...arguments)}add(e){return new Promise(async(t,r)=>{var i=(this.tx_store||this.def.getStore()).add(e);i.onsuccess=s=>t(s.target.result),i.onerror=s=>{var o=s.target.error;o.name==="ConstraintError"?r(new we(o.message)):r(o)}})}putAll(e){return this.tx_store=this.def.getStore(),super.putAll(...arguments)}put(e){return new Promise(async(t,r)=>{var i=(this.tx_store||this.def.getStore()).put(e);i.onsuccess=s=>t(s.target.result),i.onerror=s=>r(s.target.error)})}deleteAll(e){return this.tx_store=this.def.getStore(),super.deleteAll(...arguments)}delete(e){if(m(e)){if(e.length>1)throw new Error("IDB does not support Composite Primary Keys");e=e[0]}return e=I(e)?parseInt(e):e,new Promise(async(t,r)=>{var i=(this.tx_store||this.def.getStore()).delete(e);i.onsuccess=s=>t(e),i.onerror=s=>r(s.target.error)})}};var Se=class extends te{async tables(){return _(this.def.objectStoreNames)}async table(e,t={}){var r=i=>{var s=this.def.transaction([e],i||t.mode);return s.objectStore(e)};return new ve(this,e,{schema:await this.getTableSchema(e),getStore:r},t)}async createTable(e,t,r={}){return this.driver.alterDatabase(this.name,i=>{if(_(i.objectStoreNames).includes(e)){if(r.ifNotExists)return;throw new Error(`Store name "${e}" already exists!`)}var s={},o=Object.keys(t.columns).filter(h=>t.columns[h].primaryKey)[0],f=Object.keys(t.columns).filter(h=>t.columns[h].autoIncrement)[0];o&&(s.keyPath=o,o===f&&(s.autoIncrement=!0));var a=i.createObjectStore(e,s);return v(this.diffSchema({},t),(h,u)=>{h!=="primaryKey"&&v(u.add,(c,p)=>{this.applyToStore[h](a,c,p)})}),this.def.schema[e]=t,new ve(this,e,{schema:t,getStore:()=>a},{})})}async alterTable(e,t,r={}){var i=await this.getTableSchema(e),s;if(R(t))s=this.cloneSchema(i),await t(s);else if(y(callback))s=t;else throw new Error("Table/store modification expects only an object (new schema) or a function (callback that recieves existing schema).");return this.driver.alterDatabase(this.name,o=>{if(!_(o.objectStoreNames).includes(e)){if(r.ifExists)return;throw new Error(`Store name "${e}" does not exist!`)}var f=o.transaction([e],"readwrite"),a=f.objectStore(e);return v(this.diffSchema(i,s),(h,u)=>{h!=="renamedColumns"?(v(u.add,(c,p)=>{this.applyToStore[h](a,c,p,"add")}),v(u.alter,(c,p)=>{this.applyToStore[h](a,c,p.current,"alter")}),v(u.drop,(c,p)=>{this.applyToStore[h](a,c,p,"drop")})):v(u,(c,p)=>{this.applyToStore[h](a,c,p)})}),this.def.schema[e]=s,new ve(this,e,{schema:i,getStore:()=>a},{})})}async dropTable(e,t={}){return this.driver.alterDatabase(this.name,r=>{if(_(r.objectStoreNames).includes(e)){if(t.ifExists)return;throw new Error(`Store name "${e}" does not exist!`)}delete this.def.schema[e],r.deleteObjectStore(e)})}async getTableSchema(e){return this.def.schema[e]}};Se.prototype.applyToStore={primaryKey:(n,e,t,r)=>{},columns:(n,e,t,r)=>{},foreignKeys:(n,e,t,r)=>{},indexes:(n,e,t,r)=>{if(r==="drop"){n.deleteIndex(e);return}r==="alter"&&n.indexNames.contains(e)&&n.deleteIndex(e),n.createIndex(e,t.keyPath,{unique:t.type==="unique"})},jsonColumns:(n,e,t,r)=>{},renamedColumns:(n,e,t)=>"ALTER COLUMN `"+e+"` RENAME TO `"+t+"`"};var Ve=class extends Z{constructor(){if(super(),typeof indexedDB>"u")throw new Error("IndexedDB is not in scope.");this.indexedDB=indexedDB,this.name="idb"}async databases(e=null,t={}){var r=_(await this.indexedDB.databases());return this.matchDatabaseList(r,e,t)}async database(e=this.defaultDB,t=this.defaultDBParams){return new Promise(r=>{var i=this.indexedDB.open(e,t.version||0);i.onsuccess=s=>{r(new Se(this,e,{database:s.target.result},t))}})}async createDatabase(e,t=this.defaultDBParams){if((await this.databases(e,t)).length){if(t.ifNotExists)return;throw new Error(`Database ${e} already exists.`)}return new Promise(r=>{var i=this.indexedDB.open(e,t.version);(schema||[]).length&&(i.onupgradeneeded=s=>{}),i.onsuccess=s=>{this.setDatabaseSchema(e,{}),this.setDefaultDB(e,t).then(()=>{r(new Se(this,e,{database:s.target.result,schema:this.getDatabaseSchema(e)},t))})}})}async alterDatabase(e,t,r){if(!I(t.version))throw new Error("Database version (params.version) must be numeric.");if(!(await this.databases(e,t.version)).length){if(t.ifExists)return;throw new Error(`Database ${e} does not exist.`)}return new Promise(i=>{var s,o,f=this.indexedDB.open(e,t.version);f.onupgradeneeded=a=>{s=!0,o=r(a.target.result)},f.onsuccess=a=>{if(!s)throw new Error(`Store name "${e}@${t.version}" could not be accessed for modification!`);i(o)}})}async dropDatabase(e,t={}){if(!(await this.databases(e,t)).length){if(t.ifExists)return;throw new Error(`Database ${e} does not exist.`)}return new Promise(r=>{var i=this.indexedDB.deleteDatabase(e);i.onsuccess=s=>{this.unsetDatabaseSchema(e),r(!0)}})}async query(e,t=[],r={}){return r={...r},r.vars=t,r.dbDriver=this,ObjSQL.parse(e,null,r).eval(this)}};var Ft=function(n,e=1,t=!0){return!I(e)||e<=0||(!m(n)&&y(n)&&t&&(n=Object.values(n)),!m(n))?n:n.reduce((r,i)=>m(i)||y(i)&&t?r.concat(Ft(m(i)?i:Object.values(i),e-1,t)):r.concat(i),[])},V=Ft;function D(n,e=1){var t=0;n.forEach(i=>{t++});var r=n.slice(n.length-t,e);return arguments.length>1?r:r[0]}function q(n,e=1){return arguments.length>1?D(n.slice().reverse(),e).reverse():D(n.slice().reverse())}function xt(n){return y(n)&&Object.getPrototypeOf(n)===Object.prototype}function Ce(n){return n===!0||n===!1}function It(n,e,t=!0,r=!0,i=!1,s=!1){if(m(n)&&m(e)){var o=[],f=!0;return n.forEach(a=>{if(f){var h=!1;v(e,(u,c)=>{(!h||r&&C(a))&&(h=t(a,c),(m(h)&&!h.length||y(h)&&!Object.keys(h).length)&&(h=!1),C(h)&&r&&(a=h))}),C(h)?o.push(r?h:a):Ce(h)?i&&!h||!i&&h?o.push(a):s&&(f=!1):o.push(h)}}),o}if(y(n)&&y(e)){var o={},f=!0;return Object.keys(n).forEach(u=>{if(f){var c=t(n[u],e[u]);(m(c)&&!c.length||y(c)&&!Object.keys(c).length)&&(c=!1),C(c)?o[u]=r?c:n[u]:Ce(c)?i&&!c||!i&&c?o[u]=n[u]:s&&(f=!1):o[u]=c}}),o}}var Tt=function(n,e,t=!0,r=1){if(m(n)&&m(e)&&n.length!==e.length)return!t;if(y(n)&&y(e)){var i=Object.keys(n),s=Object.keys(e);if(!i.length&&!s.length)return xt(n)&&xt(e)?t:n===e===t;if(!Tt(i,s))return!t}if(r>0&&(m(n)&&m(e)||y(n)&&y(e))){var o=It(n,e,(f,a)=>Tt(f,a,t,r-1),!1,!1,!0);return m(o)?o.length===n.length&&o.length===e.length:y(o)&&y(n)?Object.keys(o).length===Object.keys(n).length&&Object.keys(o).length===Object.keys(e).length:o}return R(t)?t(n,e):oe(n)&&oe(e)&&isNaN(n)&&isNaN(e)?t:n===e===t},lt=Tt;function At(n,e=[]){return G([{},n],(t,r,i)=>{if(!R(i[t]))return R(e)?e(t):m(e)&&e.length?e.indexOf(t)>-1:!0},!1,!1,!1)}var d=class n{static lex(e,t,r={}){if(!j(e=e+""))throw new Error("Argument1 must be a string!");var i=h=>({delims:h.delims.slice(),options:At(h.options),nesting:h.nesting.slice(),maxDepth:h.maxDepth,comments:h.comments.slice(),tokens:h.tokens.slice(),matches:h.matches.slice(),matchesi:At(h.matchesi)});if(n.$cache[e]&&r.cache!==!1)for(var s=0;s<n.$cache[e].length;s++){var o=n.$cache[e][s];if(lt(o.delims,t))return i(o)}var f=new n(e,r),a=f.lex(t);return r.cache!==!1&&(n.$cache[e]=n.$cache[e]||[],n.$cache[e].push(a)),i(a)}static split(e,t,r){return n.lex(e,t,r).tokens}static match(e,t,r){return n.lex(e,t,r).matches}constructor(e,t){if(!j(e))throw new Error("Lexer requires the first argument to be a string.");this.$str=e,this.$options=t||{},this.$options.blocks||(this.$options.blocks=n.$blocks),this.$options.quotes||(this.$options.quotes=n.$quotes),this.$options.comments||(this.$options.comments=n.$comments)}lex(e,t){for(var r={delims:_(e),options:ae(!0,{},this.$options,t||{}),nesting:[],maxDepth:0,comments:[],tokens:[],matches:[],matchesi:{}},i=0;typeof i=="number";)i=this._evalCharsAt(r,i);if(r.nesting.length)throw new Error("Error parsing the string: "+this.$str+". Unterminated blocks: "+V(r.nesting).join(", "));return r}_evalCharsAt(e,t){if(!(t>=this.$str.length)){var r=1,i={},s={},o={};if(e.openComment||(s=this._testQuotes(e,t)),e.openQuote||(i=this._testComments(e,t)),e.openComment||i.ending)if(!e.nesting.length&&!o.ending){var f=i.starting||i.ending||this.$str[t];r=f.length,this._push(e,f,"comments",i.starting)}else this._push(e,this.$str[t]);else if(e.openQuote||s.ending)this._push(e,this.$str[t]);else{if(e.options.limit&&e.matches.length===e.options.limit)return this._push(e,this.$str[t]),t+1;o=this._testNesting(e,t);var o=this._testNesting(e,t),a=this._testChars(e.options.stopChars||[],e,t);if(!e.nesting.length&&a!==!1){e.options.stopChar=a,e.options.stopCharForward=this.$str.substr(t);return}if(!e.delims.length)e.nesting.length===2&&o.starting?(e.matches.push(null),this._push(e,o.starting),r=o.starting.length):!e.nesting.length&&o.ending?(this._push(e,o.ending),r=o.ending.length,e.matches.push(null)):this._push(e,this.$str[t]);else if(!e.nesting.length&&!o.ending){this._push(e,"");var h=this._testChars(e.delims,e,t);if(h!==!1&&(e.matches.push(h),e.matchesi[t]=h,r=h.length||1,!e.options.preserveDelims)){var u=t+(h.length||1);return u===this.$str.length&&this._push(e,""),u}this._push(e,h||this.$str[t])}else{var f=o.starting||o.ending||this.$str[t];r=f.length,this._push(e,f)}}return t+r}}_testQuotes(e,t){var r={};return(e.options.quotes||[]).forEach(i=>{this.$str.substr(t,1)===i&&(e.openQuote?i===e.openQuote&&(e.openQuote=!1,r.ending=i):(e.openQuote=i,r.starting=i))}),r}_testComments(e,t){var r={};return(e.options.comments||[]).forEach(i=>{if(e.openComment){if(q(i)===q(e.openComment)){var o=q(i);this.$str.substr(t).startsWith(o)&&(e.openComment=!1,r.ending=o)}}else{var s=D(i);this.$str.substr(t).startsWith(s)&&(e.openComment=i,r.starting=s)}}),r}_testNesting(e,t){var r={};return(e.options.blocks||[]).forEach(i=>{var s=D(i);if(this.$str.substr(t).startsWith(s))e.nesting=e.nesting.concat([i]),r.starting=s;else if(e.nesting.length&&q(i)===q(q(e.nesting))){var o=q(i);this.$str.substr(t).startsWith(o)&&(e.nesting=e.nesting.slice(0,-1),r.ending=o)}}),e.maxDepth=Math.max(e.maxDepth,e.nesting.length),r}_testChars(e,t,r){for(var i=0;i<e.length;i++){var s=e[i];if(R(s)){var o=s(this.$str.substr(0,r),this.$str.substr(r));if(o!==!1)return o}if(t.options.useRegex){var f=this.$str.substr(r).match(new RegExp("^"+s,t.options.useRegex!==!0?t.options.useRegex:""));if(f)return f[0]}if(!t.options.ci&&this.$str.substr(r,s.length)===s||t.options.ci&&this.$str.substr(r,s.length).toLowerCase()===s.toLowerCase())return s}return!1}_push(e,t,r="tokens",i=!1){var s=e.matches.length;if(b(e.tokens[s])&&(e.tokens[s]=""),r==="comments"){e.tokens[s].comments||(e.tokens[s]=new String(e.tokens[s]),e.tokens[s].comments=[]);var o=e.tokens[s].comments.length-(!e.tokens[s].comments.length||i?0:1);e.tokens[s].comments[o]=(e.tokens[s].comments[o]||"")+t}else{var f=e.tokens[s].comments;e.tokens[s]=e.tokens[s]+t}}split(e,t,r){return this.lex(t,r).tokens}match(e,t,r){return this.lex(t,r).matches}regParse(e,t){return this.lex(e,ae({useRegex:!0},t||{}))}regSplit(e,t){return this.regParse(e,t).tokens}regMatch(e,t){return this.regParse(e,t).matches}};d.$blocks=[["(",")"],["[","]"],["{","}"]];d.$quotes=['"',"'","`"];d.$comments=[["/*","*/"],["//",`
`]];d.$cache={};var S=class{even(n){return y(n)&&n.jsenType===this.jsenType?lt(n,this):!1}inherit(n){return this}withComments(n){return this.meta||(this.meta={}),this.meta.comments=n,this}withVars(n){return this.meta||(this.meta={}),this.meta.vars=n,this}};var Dt=class extends S{};Object.defineProperty(Dt.prototype,"jsenType",{get(){return"Reference"}});var Y=Dt;var kt=class extends S{};Object.defineProperty(kt.prototype,"jsenType",{get(){return"CallExpression"}});var X=kt;var $=class extends S{};var se=class extends Error{constructor(...n){super(...n),this.name="Syntax Error"}};var Ot={},Xe=class{static parse(e,t,r={}){if(e.length){if(Ot[e]&&!t&&r.allowCache!==!1){var i;if(i=this.parseOne(e,Ot[e],r))return i}for(var s=Object.values(t||this.grammar),o=0;o<s.length;o++){var f=this.parseOne(e,s[o],r);if(f)return!t&&r.allowCache!==!1&&(Ot[e]=s[o]),f}if(r.assert===!1)return;throw new se(e)}}static parseOne(e,t,r={}){var i=Bt(),s=t.parse(e,(o,f,a={})=>{var h=this.parse(o,f,a?ae({},r,a):r);if(h instanceof Y){for(var u,c=h;c=c.context;)c instanceof X&&(u=!0);if(h.role=a.role,!u&&a.role!=="CONTEXT"){var p=a.role==="ASSIGNMENT_SPECIFIER"?"writes":a.role==="DELETION_SPECIFIER"?"deletes":a.role==="CALL_SPECIFIER"?"_calls":"reads";i[p].push(h)}}else h instanceof X&&i.calls.push(h);return h&&(Object.keys(h.meta).forEach(l=>{l!=="deep"&&h.meta[l].forEach(g=>i[l].push(g))}),Object.keys(h.meta.deep).forEach(l=>{i.deep[l]||(i.deep[l]=[]),h.meta.deep[l].forEach(g=>i.deep[l].push(g))})),h},r);return s&&(s instanceof $?s.meta=Bt():s.meta=i,s instanceof X&&s.reference.context&&!(s.reference.context instanceof X)&&s.meta.reads.push(s.reference.context),m(r.explain)&&r.explain.push(e+" >>------------->> "+s.jsenType)),s}};function Bt(){return{reads:[],writes:[],deletes:[],calls:[],_calls:[],deep:{}}}var Le=class extends Xe{static parse(e,t,r={}){return"mutates"in r||(r.mutates=!0),!r.placeholdersTransformed&&e.indexOf("?")>0&&(e=d.split(e,["?"],{blocks:[]}).reduce((i,s,o)=>i?i+"?"+(o-1)+s:s,null),r.placeholdersTransformed=!0),r.opts||(r.opts={}),"ci"in r.opts||(r.opts.ci=!0),r.allowCache=!1,super.parse(e,t,r)}};function k(n,e,t=!1){if(e=="")return n;var r=t?n.lastIndexOf(e):n.indexOf(e);return r===-1?"":n.substr(r+e.length)}function N(n,e,t=!1){if(e=="")return n;var r=t?n.lastIndexOf(e):n.indexOf(e);return r===-1?n:n.substr(0,r)}function pt(n,e){return N(n,e,!0)}function B(n,e,t){return pt(k(n,e),t)}var qt=class extends S{};Object.defineProperty(qt.prototype,"jsenType",{get(){return"Abstraction"}});var xe=qt;var oi=class extends xe{constructor(n){super(),this.expr=n}eval(n=null,e={}){return this.expr.eval(n,e)}toString(){return this.stringify()}stringify(n={}){return"("+this.expr.stringify(n)+")"}static parse(n,e,t={}){if(L(n,"(",")")&&!d.match(n,[" "]).length&&d.split(n,[]).length===2)return new this(e(B(n,"(",")")))}},mt=oi;function fe(...n){var e={},t="last";m(arguments[0])&&(n=arguments[0],e=arguments[1],arguments[2]&&(t=arguments[2]));var r=q(n),i={},s=class{constructor(...f){var a=null;n.reverse().forEach((h,u)=>{var c=Reflect.construct(h,f,this.constructor);a&&Object.setPrototypeOf(c,a),a=c}),Object.setPrototypeOf(this,a)}},o=Symbol.for("webqit/util/mixin");return n.forEach((f,a)=>{ut(f).forEach(h=>{if(!h[o]){Object.defineProperty(h,o,{value:[]});try{var u=h[Symbol.hasInstance].bind(h);Object.defineProperty(h,Symbol.hasInstance,{value:function(c){return u(c)?!0:h[o].reduce((p,l)=>p||c instanceof l,!1)}})}catch{}}h[o].push(s)})}),n.forEach(f=>{G([s,f],(a,h,u)=>!["name","prototype","prototypes","length","caller","callee","arguments","constructor","apply","bind","call","toString"].includes(a),!0),G([s.prototype,f.prototype],(a,h,u)=>["prototype","prototypes"].includes(a)?!1:R(u[a])?(m(i[a])?i[a].push(u[a]):i[a]=[u[a]],!1):!0,!0)}),v(i,(f,a)=>{f!=="constructor"&&(s.prototype[f]=function(...h){if(Object.hasOwnProperty(e,f)&&R(e[f]))return e[f].call(this,a,...h);var u=[];return a.forEach(c=>{u.push(c.call(this,...h))}),q(u)})}),s}var Wt=function(n,e,t=!1){var r=null,i=n;m(n)||(r=Object.keys(n),i=Object.values(n));var s=void 0,o=i.reduce((a,h)=>s===void 0&&(e(h,a)||t&&(C(h)||R(h))&&(s=Wt(h,e,t))!==void 0)?h:a,void 0);if(o!==void 0){var f=r?r[i.indexOf(o)]:i.indexOf(o);return s!==void 0?[f].concat(_(s)):f}},Pe=Wt;var Mt=class extends S{};Object.defineProperty(Mt.prototype,"jsenType",{get(){return"Arguments"}});var $t=Mt;var ai=class extends $t{constructor(n=[]){super(),this.list=n}eval(n=null,e={}){return this.list.map(t=>t.eval(n,e))}toString(){return this.stringify()}stringify(n={}){return"("+this.list.map(e=>e.stringify(n)).join(", ")+")"}static parse(n,e,t={}){var r;if(n=n.trim(),L(n,"(",")")&&!d.match(n,[" "]).length)return new this(d.split(B(n,"(",")"),[","]).map(i=>e(i.trim())))}},Kt=ai;var K=class extends Error{constructor(...n){super(...n),this.name="Reference Error"}};var fi=class extends X{constructor(n,e){super(),this.reference=n,this.args=e}eval(n=null,e={}){try{var t=this.args.eval(n,e);return this.reference.getEval(n,e).exec(t)}catch(r){throw r instanceof K?new K("["+this+"]: "+r.message):r}}toString(){return this.stringify()}stringify(n={}){return this.reference.stringify(n)+this.args.stringify(n)}static parse(n,e,t={}){if(n.endsWith(")")&&!d.match(n,[" "]).length){var r=d.split(n,[]),i,s=r.pop();if(!((i=e(r.join(""),null,{role:"CALL_SPECIFIER"}))instanceof Y)||!(s=e(s,[Kt])))throw new se(n);return new this(i,s)}}},dt=fi;var Gt=class extends S{};Object.defineProperty(Gt.prototype,"jsenType",{get(){return"AggregateExpression"}});var Ue=Gt;function Et(...n){return G(n,(e,t,r)=>{if(m(t)&&m(r)){if(t.indexOf(r[e])===-1)return!0}else if(!(e in t))return!0})}var Yt=class extends S{};Object.defineProperty(Yt.prototype,"jsenType",{get(){return"WindowConstruct"}});var Ht=Yt;function Qt(n,e,t=null){for(var r=[],i=n.length,s=0;s<i;s++)r.push({index:s,value:t?t(n[s]):n[s]});return r.sort(function(o,f){return j(o.value)&&"".localeCompare?o.value.localeCompare(f.value):o.value===f.value?0:o.value>f.value?1:-1}),(e||"").trim().toLowerCase()==="desc"&&(r=r.reverse()),r.map(o=>n[o.index])}var Jt=class extends S{};Object.defineProperty(Jt.prototype,"jsenType",{get(){return"OrderByExpression"}});var Vt=Jt;var he=class extends Vt{constructor(e,t=!1){super(),this.columns=e,this.withRollup=t}eval(e,t={}){var r=(i,s)=>{var o={};i.forEach(a=>{var h=s[0].expr.eval(a,t);o[h]=o[h]||[],o[h].push(a)});var f=[];return Qt(Object.keys(o),s[0].order).forEach(a=>{f=f.concat(s.length>1?r(o[a],s.slice(1)):o[a])}),f};return r(e,this.columns)}toString(){return this.stringify()}stringify(e={}){var t=[this.columns.map(r=>r.expr.stringify(e)+(r.order?" "+r.order:"")).join(", ")];return this.withRollup&&t.push("WITH ROLLUP"),t.join(" ")}static parse(e,t,r={}){var i=[],s=!1,o=d.lex(e,["WITH[ ]+ROLLUP"],{useRegex:"i"});return i=d.split(o.tokens.shift().trim(),[","]).map(f=>{var a=f.match(/ASC|DESC/,"i");return a&&(a=a[0],f=pt(f,a).trim()),{expr:t(f),order:a}}),o.matches.length===1&&(s=!0),new this(i,s)}};var Ie=class extends Ht{constructor(e){super(),this.dfn=e}eval(e,t={},r={}){var i=this.dfn,s=this.stringify();if(this.dfn.name){if(!t||!t[this.dfn.name])throw new Error('Window name "'+this.dfn.name+'" is undefined!');i=Et({},this.dfn,t[this.dfn.name])}var o=(f,a)=>{if(a.length){var h={};f.forEach(u=>{var c=a[0].eval(u,r);h[c]=h[c]||[],h[c].push(u)}),Object.values(h).map(u=>o(u,a.slice(1)))}else i.orderBy&&(f=i.orderBy.eval(f,r)),f.forEach(u=>{u.WINDOWS||(u.WINDOWS={}),u.WINDOWS[s]=f})};try{o(e,i.partitionBy||[])}catch(f){throw new Error('["'+this.stringify()+'" in window definition]: '+f.message)}}toString(){return this.stringify()}stringify(e={}){var t=Object.keys(this.dfn).length;if(t===1&&this.dfn.name)return this.dfn.name;var r=[this.dfn.name];return this.dfn.partitionBy&&r.push("PARTITION BY "+this.dfn.partitionBy.map(i=>i.stringify(e)).join(", ")),this.dfn.orderBy&&r.push("ORDER BY "+this.dfn.orderBy.stringify(e)),"("+r.filter(i=>i).join(" ")+")"}static parse(e,t,r={}){var i={};if(L(e,"(",")")){if(e=B(e,"(",")")){var s=d.lex(e,["PARTITION[ ]+BY","ORDER[ ]+BY"],{useRegex:"i"});i.name=s.tokens.shift().trim(),s.matches.forEach(o=>{o.toLowerCase().startsWith("partition")?i.partitionBy=d.split(s.tokens.shift().trim(),[","]).map(f=>t(f)):o.toLowerCase().startsWith("order")&&(i.orderBy=t(s.tokens.shift().trim(),[he]))})}}else i.name=e;return new this(i)}};var be=class extends fe(dt,Ue){eval(e,t={}){var r=this.args.list.slice();return r.unshift(this.window?e.WINDOWS[this.window.stringify()]:e.AGGR.rows,this.aggrFlag),this.reference.getEval(e,t).exec(r)}toString(){return this.stringify()}stringify(e={}){var t=super.stringify(e);return this.aggrFlag&&(t=t.replace("(","("+this.aggrFlag+" ")),t+(this.window?" OVER "+this.window.stringify(e):"")}static parse(e,t,r={}){var i,s,o="",f=V(this.funcs).join("\\(|")+"\\(";if(i=e.trim().match(new RegExp("^("+f+")","i"))){var a=N(i[0],"(").toUpperCase(),h=k(e,a+"(");(s=h.match(new RegExp("^(([ ]+)?"+["ALL","DISTINCT"].join("[ ]+|([ ]+)?")+"[ ]+)","i")))&&(o=s[0],e=e.replace(o,""));var u=Pe(this.funcs,l=>l===a,!0)[0],c=d.split(e,["OVER"],{ci:!0});if(u==="explicitOver"&&c.length===1)throw new Error(i[0]+"() requires an OVER clause!");var p=super.parse(c.shift().trim(),t,r);return p.funcCategory=u,p.aggrFlag=o.trim(),c.length&&(p.window=t(c.pop().trim(),[Ie])),p}}};be.funcs={normal:["AVG","BIT_AND","BIT_OR","BIT_XOR","COUNT","JSON_ARRAYAGG","JSON_OBJECTAGG","MAX","MIN","STDDEV_POP","STDDEV","STD","STDDEV_SAMP","SUM","VAR_POP","VARIANCE","VAR_SAMP","GROUP_CONCAT","GROUP_CONCAT_WS"],explicitOver:["CUME_DIST","DENSE_RANK","FIRST_VALUE","LAG","LAST_VALUE","LEAD","NTH_VALUE","NTLE","PERCENT_RANK","RANK","ROW_NUMBER"],support:["ANY_VALUE","COLUMN","COLUMNS","GROUPING"]};function gt(n){return m(n)?D(n):n[Object.keys(n)[0]]}function Xt(n){return Oe(n)&&/^class\s?/.test(Function.prototype.toString.call(n))}var ce=class n{constructor(e,t={}){if(!("main"in e))throw new Error('A "main" context must be provided!');Object.defineProperty(this,"stack",{value:e||{},enumerable:!1}),Object.defineProperty(this,"params",{value:t||{},enumerable:!1}),e.super&&Object.defineProperty(this.stack,"super",{value:n.create(e.super,{errorLevel:t.errorLevel}),enumerable:!1}),Object.defineProperty(this.stack,"local",{value:e.local||{},enumerable:!1}),Object.defineProperty(this.stack,"$local",{value:e.$local||{},enumerable:!1})}observe(e,t,r={}){this.stack.super&&this.stack.super.observe(e,s=>{if(s.props.filter(o=>!ue(this.stack.local,o,e)&&!ue(this.stack.main,o,e)).length)return s.scope="super",t(s)},r);var i={...r};i.subtree="auto",i.tags=(i.tags||[]).slice(0),i.tags.push(this,"jsen-context"),i.diff=!0,e.observe(this.stack,s=>{var o=[];if(s.forEach(a=>{if(a.name==="main")if(a.path.length>1)o.push(a.path.slice(1));else{var h=M((C(a.value)?Object.keys(a.value):[]).concat(a.oldValue&&C(a.oldValue)?Object.keys(a.oldValue):[]));o.push(...h.map(u=>[u]))}}),o=o.filter(a=>!ue(this.stack.local,a[0],e)),o.length){var f=o.map(a=>a[0]);return t({props:f,references:o,scope:"local"})}},i)}unobserve(e,t={}){this.stack.super&&this.stack.super.unobserve(e,t);var r={...t};r.tags=(r.tags||[]).slice(0),r.tags.push(this,"jsen-context"),e.unobserve(this.stack,null,null,r)}handle(e,t,r,i=0){var s=()=>t(this.stack.main,null,()=>{if(this.stack.super)return this.stack.super.handle(e,t,r,i+1);if(r)return r()},i);return e==="toString"&&this.stack.local.toString===Object.prototype.toString?s():t(this.stack.local,this.stack.$local,s,i)}get(e,t={},r=!0){return e instanceof String&&(e=e+""),this.handle(e,(i,s,o,f)=>{var a=wt(i,e,t);return!b(a)||ue(i,e,t)?R(a)&&!Xt(a)&&r?a.bind(i):a:o()})}set(e,t,r={},i=!1,s=!0){if(this.params.type===2&&i==="var"&&this.stack.super)return this.stack.super.set(e,t,r,i);e instanceof String&&(e=e+"");let o=(f,a,h,u)=>u.set?u.set(f,a,h):(f[a]=h,!0);return this.handle(i?!0:e,(f,a,h,u)=>{if(a&&a[e]==="const")throw new LogicalError("CONST "+e+" cannot be modified!");if(i)return a[e]=i,o(f,e,t,r);if(ue(f,e,r))return o(f,e,t,r);try{return h()}catch(c){if(c instanceof K&&f&&!a&&u===0&&this.params.strictMode===!1)return o(f,e,t,r);throw c}},()=>{throw new K('"'+e+'" does not exist in scope!')})}del(e,t={}){return e instanceof String&&(e=e+""),this.handle(e,(r,i,s)=>ue(r,e,t)?(i&&delete i[e],t.deleteProperty||t.del?(t.deleteProperty||t.del)(r,e):(delete r[e],!0)):s())}has(e,t,r={}){return e instanceof String&&(e=e+""),t instanceof String&&(t=t+""),this.handle(e,(i,s,o)=>{if(ue(i,e,r)){var f=wt(i,e,r);return ue(f,t,r)}return o()},()=>{throw new K('"'+e+'" is undefined!')})}exec(e,t,r={}){return e instanceof String&&(e=e+""),this.handle(e,(i,s,o)=>{var f=wt(i,e,r);if(!b(f)||ue(i,e,r)){if(!R(f)){if(r.exec)return r.exec(i,e,t);throw new K('"'+e+'" is not a function! (Called on type: '+typeof i+".)")}return r.apply?r.apply(f,i,t):f.apply(i,t)}return o()},()=>{if(r.execUnknown)return r.execUnknown(this,e,t);throw new K('"'+e+'()" is undefined!')})}static create(e,t={},r={}){if(e instanceof n)return e;var i={};return r.set?r.set(i,"main",e):i.main=e,new n(i,t)}static createStack(e,t={},r={}){return e.reverse().reduce((i,s,o)=>{if(s instanceof n){if(o===0)return s;throw new Error("Only the top-most context is allowed to be an instance of Scope.")}var f={};return r.set?r.set(f,"main",s):f.main=s,f.super=i,new n(f,t)},null)}},wt=(n,e,t)=>{if(!(U(n)||b(n)))return t.get&&C(n)?t.get(n,e):n[e]},ue=(n,e,t)=>U(n)||b(n)?!1:t.has&&C(n)?t.has(n,e):C(n)?e in n:!b(n[e]);var H=class n extends Y{constructor(e,t,r=!1){super(),this.context=e,this.name=t,this.backticks=r}toString(){return this.stringify()}stringify(e={}){return this.interpreted&&e.interpreted?_isArray(this.interpreted)?this.interpreted.map(t=>t.stringify(e)).join(", "):this.interpreted.stringify(e):this._stringify(e)}_stringify(e={}){var t=this.name;if(this.context){var r=this.context.stringify(e);t instanceof S?t="["+t.stringify(e)+"]":this.backticks&&(t="`"+t+"`")}else{var r=e.context;this.backticks&&(t="`"+t+"`")}return(r||"")+(r&&!t.startsWith("[")?n.separator:"")+t}getEval(e,t={}){if(this.interpreted)return _isArray(this.interpreted)?this.interpreted.reduce((s,o)=>(s[o.name]=o.getEval(e,t),s),{}):this.interpreted.getEval(e,t);var r=e,i=this.name;if(this.context)r=this.context.eval(e,t);else if(!(this.role==="CONTEXT"||this.role==="CALL_SPECIFIER")){if(!e.$)throw new Error('"'+this+'" is undefined!');r=e.$}return{get(){return ce.create(r,t).get(i,t.trap)},del(){return ce.create(r,t).del(i,t.trap)},has(s){return ce.create(r,t).has(i,s,t.trap)},set(s,o=null){return ce.create(r,t).set(i,s,t.trap,o)},exec(s){return ce.create(r,t).exec(i.toUpperCase(),s,t.trap)}}}eval(e,t={}){return this.interpreted?_isArray(this.interpreted)?this.interpreted.map(r=>r.eval(e,t)):this.interpreted.eval(e,t):this.getEval(e,t).get()}static parse(e,t,r={}){if(!d.match(e.trim(),[" "]).length){var i=d.split(e,[]),s,o=i.pop(),f,a=d.split(o.trim(),[this.separator],{preserveDelims:!0});if(a.length>1&&(o=a.pop().substr(1),i=i.concat(a)),L(o,"`","`")&&(o=B(o,"`","`"),f=!0),i.length&&(s=t(i.join(""),null,{role:"CONTEXT"})),L(o,"[","]")){if(!s)throw new se(e);o=t(B(o,"[","]"))}return new this(s,o,f)}}};H.separator=".";var zt=class extends H{};Object.defineProperty(zt.prototype,"jsenType",{get(){return"ArrowReferenceExpression"}});var je=zt;var le=class n extends je{process(e,t=null){var r=this.interpreted?this.interpreted.toString():this.toString();return n.process(e,r.replace(/`/g,""),t)}static parse(e,t,r={}){if(this.isReference(e)){var i=super.parse(e,t,r);return i&&(i.backticks=!0),i}}static isReference(e){return e.indexOf(this.arrLeft)>-1||e.indexOf(this.arrRight)>-1}static isOutgoing(e){return e.indexOf(this.arrRight)>-1&&N(e,this.arrRight).indexOf(this.arrLeft)===-1}static isIncoming(e){return e.indexOf(this.arrLeft)>-1&&N(e,this.arrLeft).indexOf(this.arrRight)===-1}static reverse(e){return e.replace(new RegExp(this.arrRight,"g"),"|"+this.arrRight+"|").replace(new RegExp(this.arrLeft,"g"),"|"+this.arrLeft+"|").split("|").map(t=>t===this.arrRight?this.arrLeft:t===this.arrLeft?this.arrRight:t).reverse().join("")}static process(e,t,r=null){var i,s=(e?r.getDatabaseSchema(e.databaseName):r.getDatabaseSchema())||{columns:{}};if(this.isIncoming(t)){var o=N(t,this.arrLeft),f=k(t,this.arrLeft);if(o.indexOf(".")>0&&(e||(e=s[N(o,".")]),o=k(o,".")),this.isIncoming(f)){i=this.process(null,f,r).a.table;var a=f}else{var h=N(f,this.arrRight);if(a=k(f,this.arrRight),!(i=s[h]))throw new Error("["+t+']: The implied table "'+h+'" is not defined.')}if(!e){var c;if(!i.columns[o]||!(c=i.columns[o].referencedEntity))throw new Error("["+t+']: The "'+i.name+'" table does not define the implied foreign key "'+o+'".');e=s[c.table]}return{a:{table:e,actingKey:e.primaryKey},b:{table:i,actingKey:o,select:a}}}var u=N(t,this.arrRight);a=k(t,this.arrRight),u.indexOf(".")>0?(e||(e=s[N(u,".")]),u=k(u,".")):e=gt(s);var c;if(!e.columns[u]||!(c=e.columns[u].referencedEntity))throw new Error("["+e.name+this.arrRight+t+']: The "'+e.name+'" table does not define the implied foreign key "'+u+'".');return i=s[c.table],{a:{table:e,actingKey:u},b:{table:i,actingKey:i.primaryKey,select:a}}}};le.arrRight="~>";le.arrLeft="<~";var Zt=class extends S{};Object.defineProperty(Zt.prototype,"jsenType",{get(){return"AssertionExpression"}});var er=Zt;var Rt=class extends er{constructor(n,e){super(),this.exprs=n,this.logic=e}eval(n=null,e={}){var t=this.constructor;if(this.logic.toLowerCase()===t.negation.toLowerCase())return!D(this.exprs).eval(n,e);for(var r=V(t.operators),i=(this.logic||"").trim().toUpperCase(),s=i===(t.operators.or||"").trim().toUpperCase(),o=i===(t.operators.nor||"").trim().toUpperCase(),f=i===(t.operators.and||"").trim().toUpperCase(),a=i===(t.operators.nand||"").trim().toUpperCase(),h=!0,u=0,c=0;c<this.exprs.length;c++){if(h=this.exprs[c].eval(n,e),f&&!h)return!1;if(a&&!h)return!0;if(s&&h)return h;u+=h?1:0}return s?h:f||a?f:o&&u===0}toString(){return this.stringify()}stringify(n={}){var e=this.constructor;return this.logic.toLowerCase()===e.negation.toLowerCase()?this.logic+D(this.exprs).stringify(n):this.exprs.map(t=>t.stringify(n)).join(" "+this.logic.trim()+" ")}static parse(n,e,t={}){if(n.toUpperCase().startsWith(this.negation.toUpperCase()))return new this([e(n.substr(this.negation.length))],this.negation);var r=d.lex(n,V(this.operators));if(r.tokens.length>1){var i=M(r.matches);if(i.length>1)throw new Error('"AND" and "OR" logic cannot be asserted in the same expression: '+n+"!");return new this(r.tokens.map(s=>e(s.trim())),D(i))}}};Rt.negation="NOT ";Rt.operators={and:" and ",or:" or ",AND:" AND ",OR:" OR "};var tr=Rt;var rr=class extends S{};Object.defineProperty(rr.prototype,"jsenType",{get(){return"AssignmentExpression"}});var ir=rr;var sr=class extends S{};Object.defineProperty(sr.prototype,"jsenType",{get(){return"BooleanType"}});var nr=sr;var hi=class extends nr{constructor(n){super(),this.state=n}eval(){return this.state.toLowerCase().trim()==="true"}toString(){return this.stringify()}stringify(n={}){return this.state}static parse(r,e,t={}){var r=r.toLowerCase().trim();if(r==="true"||r==="false")return new this(r)}},or=hi;var ar=class extends S{};Object.defineProperty(ar.prototype,"jsenType",{get(){return"ComparisonExpression"}});var fr=ar;var Ne=class extends fr{constructor(e,t,r){super(),this.operand1=e,this.operand2=t,this.operator=r}eval(e=null,t={}){return this.constructor.compare(this.operand1.eval(e,t),this.operand2.eval(e,t),this.operator)}toString(){return this.stringify()}stringify(e={}){return[this.operand1.stringify(e),this.operator,this.operand2.stringify(e)].join(" ")}static parse(e,t,r={}){var i=V(this.operators).map(o=>" "+o+" "),s=d.lex(e,i);if(s.tokens.length>1){if(s.tokens.length>2)throw new Error('Malformed "Comparison" expression: '+e+"!");return new this(t(D(s.tokens).trim()),t(q(s.tokens).trim()),s.matches[0].trim())}}static compare(e,t,r="=="){if(V(this.operators).indexOf(r)===-1)throw new Error('The operator "'+r+'" is not recognized.');switch(r){case"===":return e===t;case"==":case"=":return e==t;case">":return e>t;case"<":return e<t;case">=":return e>=t;case"<=":return e<=t;case"!=":return e!=t;case"<>":case"!==":return e!==t;case"^=":return j(e)&&e.startsWith(t);case"$=":return j(e)&&e.endsWith(t);case"*=":return m(t)||j(t)?e.indexOf(t)>-1:!1;case"~=":return j(e)&&j(t)&&(" "+e+" ").indexOf(" "+t+" ")>-1;case">=<":if(!(m(t)&&t.length===2))throw new Error("A 'Between' comparison requires argument 2 to be an array of exactly 2 values.");return e>=t[0]&&e<=t[1];case"/**/":return t.match(new RegExp(e));default:return!1}}static diff(e,t,r){return!this.compare(e,t,r?"===":"==")}};Ne.operators={relative:{lesserThan:"<",greaterThan:">",lesserThanOrEqualsTo:"<=",greaterThanOrEqualsTo:">="},partial:{any:"any",in:"in",like:"like"},exact:{notEqualsTo:"<>",is:"="}};var hr=class extends S{};Object.defineProperty(hr.prototype,"jsenType",{get(){return"TernaryConditional"}});var ur=hr;var ze=class extends ur{constructor(e,t,r){super(),this.assertion=e,this.onTrue=t,this.onFalse=r}toString(){return this.stringify()}stringify(e={}){return"IF ("+[this.assertion.stringify(e),this.onTrue.stringify(e),this.onFalse.stringify(e)].join(", ")+")"}eval(e=null,t={}){return this.assertion.eval(e,t)?this.onTrue.eval(e,t):this.onFalse.eval(e,t)}static parse(e,t,r={}){if(e.match(/^if[ ]*?\(/i)){var i=d.split(B(e.trim().substr(2).trim(),"(",")"),[","]);if(i.length!==3)throw new Error("Malformed condition expression: "+e+"!");return new this(...i.map(s=>t(s.trim())))}}};var cr=class extends ${};Object.defineProperty(cr.prototype,"jsenType",{get(){return"DeleteStatement"}});var lr=cr;function Ze(n,e=null){var t={};return arguments.length===2&&(m(n)&&m(e)?n.forEach((r,i)=>t[r]=e[i]):t[n]=e),t}var pr=class extends S{};Object.defineProperty(pr.prototype,"jsenType",{get(){return"Literal"}});var yt=pr;var Te=class extends yt{constructor(e){super(),this.expr=e}eval(){return this.expr}toString(){return this.stringify()}stringify(e={}){return this.expr}static parse(e,t=null,r={}){return new this(e)}};var mr=class extends ${};Object.defineProperty(mr.prototype,"jsenType",{get(){return"TableExpression"}});var dr=mr;var et=class extends re{constructor(e,t,r,i,s={}){super(t,r,i,s),this.stmt=e}getCursor(){return new ie((this.def.data||[]).filter(e=>e))}async syncCursor(e){return this.stmt.base.syncCursors()}};var z=class extends dr{constructor(e,t,r=!1,i=null){super(),this.expr=e,this.alias=t,this.claused=r,this.schema=i,this.associatedReferences=[]}as(e){return this.alias=e,this.claused=!0,this}getDatabaseName(){return(this.expr+"").split(".").slice(0,-1)[0]||""}getName(){return this.isDerivedQuery()?_(this.getDerivedQuery().getTable(),!1)[0].getName():(this.expr+"").split(".").pop()}getAlias(){return this.alias||this.getName()}isDerivedQuery(){return this.expr instanceof xe}getDerivedQuery(){return this.expr.expr}associateReference(e){return this.associatedReferences.push(e)}getAssociateReferences(){return this.associatedReferences}getSchema(){if(!this.schema&&this.isDerivedQuery()){var e=this.getAlias(),t=this.getDerivedQuery(),r=t.getSources(!0),i=a=>t.getFields().reduce((h,u)=>h||(a===u.getName()?u.getAlias():null),null),s={};r.forEach(a=>{s[a.getAlias()]=a.getSchema()});var o=gt(s),f={name:e,columns:{},indexes:{},derived:!0};t.getFields().forEach(a=>{if(a.expr instanceof Y)if(a.getName()==="*")a.expr.interpreted.forEach(c=>{f.columns[c.name]=((s[c.context.name]||{}).columns||{})[h]||{type:"any",derived:!0}});else{var h=a.getName(),u=a.getContextName();f.columns[a.getAlias()]=(((u?s[u]:o)||{}).columns||{})[h]||{type:"any",derived:!0}}else f.columns[a.getAlias()]={type:"any",derived:!0}}),W(f.primaryKey)||(f.primaryKey=m(o.primaryKey)?o.primaryKey.map(a=>i(a)):i(o.primaryKey)),v(o.indexes||{},(a,h)=>{h={...h};var u=_(h.keyPath).map(c=>i(c));h.keyPath=m(h.keyPath)?u:u[0],W(h.keyPath)||(f.indexes[a]=h)}),f.driver=o.driver,this.schema=f}return this.schema}eval(e=null,t={}){if(this.interpreted)return this.interpreted.eval(e,t);if(!e)throw new Error("Context must be provided!");let r=a=>Promise.resolve().then(()=>{if(e instanceof Z)return a?e.database(a):e.database();if(a)throw new Error("["+this.expr+"]: For tables that are fully-qualified with a database name, a database factory must be provided as context.");return e});if(this.isDerivedQuery()){var i=this.getAlias(),s=this.getDerivedQuery(),o=this.getSchema(e);return s.eval(e,t).then(async a=>{var h=await r(),u={...t};return u.alias=i,new et(s,h,i,{schema:o,data:a},u)})}var f=this.getDatabaseName();return r(f).then(a=>{if(!(a instanceof te))throw new Error("["+this.expr+"]: The provided context could not be resolved to a valid database instance.");return a.table(this.getName(),{mode:t.mode,alias:this.getAlias()})})}toString(){return this.stringify()}stringify(e={}){return this.interpreted&&e.interpreted?this.interpreted.stringify(e):[this.expr.stringify(e),this.claused?"AS":"",this.alias].filter(t=>t).join(" ")}static parse(e,t,r={}){var i=d.lex(e,[" (as )?"],{useRegex:"i"});if(i.tokens.length<3){var s,o=t(i.tokens[0],[mt,Te]),f=(i.tokens[1]||"").trim(),a=(i.matches[0]||"").trim();if(o instanceof yt){var h=o.toString().split("."),u=h.pop(),c=h.pop(),p=r.dbDriver.getDatabaseSchema(c);if(p&&p[u])s=p[u];else{if(r.validation!==!1&&r.assertTableValidity!==!1)throw new Error("Unknown table: "+u+".");s={name:u,columns:{},indexes:{},derived:!0}}}else if(!f)throw new Error("Derived tables must be aliased.");return new this(o,f,a,s)}}};function _t(n){return n=n.slice(),n.reduce((e,t)=>e+t,n.shift())}function Er(n){return n.length?_t(n)/n.length:0}function gr(n){return n=n.slice(),n.reduce((e,t)=>Math.max(e,t),n.shift())}function yr(n){return n=n.slice(),n.reduce((e,t)=>Math.min(e,t),n.shift())}function _r(n,e=1){for(var t=[],r=null;t.length<e&&(r=n[Math.floor(Math.random()*n.length)])&&t.indexOf(r)===-1;)t.push(r);return arguments.length>1?t:t[0]}function vr(n,e,t={},r={}){e=_(e).slice();for(var i=n;!b(i)&&!U(i)&&e.length;){var s=e.shift();if(!(t.get?t.get(i,s):C(i)?s in i:i[s])){r.exists=!1;return}i=t.get?t.get(i,s):i[s]}return r.exists=!0,i}var de=class{constructor(e){Object.defineProperty(this,".params",{value:e})}CONCAT(...e){return e.join("")}CONCAT_WS(...e){return e.join(e.shift())}COALESCE(...e){return e.reduce((t,r)=>U(t)?r:t,null)}FIND_IN_SET(e,t){return t.indexOf(e)}ISNULL(e){return U(e)}COUNT(e,t,r){return r.stringify()==="*"?e.length:this.COLUMN(e,t,r).length}GROUP_CONCAT(e,t,r){return this.COLUMN(e,t,r).join("")}GROUP_CONCAT_WS(e,t,r,i){return this.COLUMN(e,t,i).join(r.eval(this,this[".params"]))}AVG(e,t,r){return Er(this.COLUMN(e,t,r))}MAX(e,t,r){return gr(this.COLUMN(e,t,r))}MIN(e,t,r){return yr(this.COLUMN(e,t,r))}SUM(e,t,r){return _t(this.COLUMN(e,t,r))}FIRST(e,t,r){return r.eval(D(e)||{},this[".params"])}LAST(e,t,r){return r.eval(q(e)||{},this[".params"])}ANY_VALUE(e,t,r){return _r(this.COLUMN(e,t,r))}GROUPING(e,t,...r){return!this.AGGR||!this.AGGR.isRollup?0:r.reduce((i,s,o)=>{var f=this.AGGR.by.filter(a=>{var h=a.stringify(),u=s.stringify();return u.indexOf(".")===-1&&h.indexOf(".")>-1&&(h=k(h,".")),u===h});return f.length?o+1:i},0)}COLUMN(e,t,r){var i=e.map(o=>r.eval(o,this[".params"]));if(m(i[0])){var s=i[0].length;i=i.filter(o=>{if(!m(o)||o.length!==s)throw new Error("Aggregate column list not even!");return o.reduce((f,a)=>U(f)?a:f,null)})}return i=i.filter(o=>!U(o)),t.toUpperCase()==="DISTINCT"&&(i=M(i)),i}COLUMNS(e,t,r){return r.map(i=>this.COLUMN(e,t,i))}JSON_EXTRACT(e,t){return vr(JSON.parse(e),t.split(".").slice(1))}JSON_OBJECT(e,t){return Ze(e,t)}JSON_MERGE(e,t){return ae(JSON.parse(e),JSON.parse(t))}};var tt=class{constructor(e,t,r,i){this.main=e,this.joins=t,this.mainCursor=e.then(s=>s.getCursor()),this.joinCursors=t.map(s=>s.then(o=>o.getCursor())),this.where=r,this.params=i,this._onfinish=[],Promise.all(this.joinCursors).then(s=>{var o=s.reduce((f,a)=>(f&&f.onfinish(a.next.bind(a)),a),null);this.mainCursor.then(f=>{o&&o.onfinish(f.next.bind(f)),f.onfinish(()=>{this.eof=!0,this._onfinish.forEach(a=>a())})})})}onfinish(e){this._onfinish.push(e)}async fetch(){if(this.eof)return;var e,t;let r=await this.main,i=await this.mainCursor,s=await i.fetch(),o=r.params.alias||r.name,f=await Promise.all(this.joins),a=await Promise.all(this.joinCursors),h=a.map(async(p,l)=>{if(!t){var g=await p.fetch(),T=f[l].params.alias||f[l].name;if(!f[l].join||f[l].join.type==="full")return p.flags[i.key]=!0,g;if(f[l].join.conditionClause.trim().toLowerCase()==="using"){var E=f[l].join.condition.stringify();if(g[E]===s[E])return p.flags[i.key]=!0,g}else{var O=new de(this.params);if(O[o]=s,O[T]=g,f[l].join.condition.eval(O,this.params))return p.flags[i.key]=!0,g}if(!p.flags[i.key]){if(p.eof()&&f[l].join.type.toLowerCase()==="left")return{};if(i.eof()&&f[l].join.type.toLowerCase()==="right")return s={},null}t=!0}}),u=await Promise.all(h);if((a[0]||i).next(),u.filter(p=>p).length===h.length){var c=new de(this.params);c[o]=s,u.forEach((p,l)=>{var g=f[l].params.alias||f[l].name;c[g]=p}),e=c}try{if(!e||this.where&&!this.where.eval(e,this.params))return await this.fetch()}catch(p){throw new Error('["'+this.where.stringify()+'" in WHERE clause]: '+p.message)}return e}async syncCursors(){var e=await Promise.all(this.joins.concat(this.main)),t=await Promise.all(this.joinCursors.concat(this.mainCursor));return Promise.all(t.map((r,i)=>e[i].syncCursor(r)))}};var Ee=class{constructor(e,t,r){var i=Ct(e,["uac"]);if(this.user=r||{id:0,parent:0,lineage:"0",privileges:[]},this.schema=t,this.alias="MAIN",this.select=[],this.where=[],i.SCHEMAS.uac&&(this.EXPLICIT_TABLE_ACCESS_QUERY={query:Sr(i,this.schema.name,this.user),alias:"EXPLICIT_TABLE_ACCESS",on:["EXPLICIT_TABLE_ACCESS.table_row = 0"]}),i.CONTROL_LEVEL==="row"&&(i.SCHEMAS.uac&&(this.EXPLICIT_ROW_ACCESS_QUERY={query:Sr(i,this.schema.name,this.user),alias:"EXPLICIT_ROW_ACCESS",on:["EXPLICIT_ROW_ACCESS.table_row = "+this.alias+"."+this.schema.primaryKey]}),this.schema.attributionKey&&i.SCHEMAS.account)){var s=Lt(i,this.user,!1);this.AUTHOR_user_RELATIONSHIP_QUERY={query:s,alias:"AUTHOR_user_RELATIONSHIP",on:["AUTHOR_user_RELATIONSHIP."+s.schema.primaryKey+" = "+this.alias+"."+this.schema.attributionKey]}}this.where.push(this.deriveEntityAccess("view")+" <> 0")}deriveEntityAccess(e,t=!1){var r=[];return this.EXPLICIT_ROW_ACCESS_QUERY&&r.push("JSON_EXTRACT("+this.EXPLICIT_ROW_ACCESS_QUERY.alias+'.uac, "$.'+e+'")'),this.EXPLICIT_TABLE_ACCESS_QUERY&&r.push("JSON_EXTRACT("+this.EXPLICIT_TABLE_ACCESS_QUERY.alias+'.uac, "$.'+e+'")'),r.push(xr(Ir(this.schema.uac,e),this.getGuestRightsExpression(),t)),"COALESCE("+r.join(", ")+")"}deriveFieldsAccess(e,t,r=!1){var i={};return e.forEach(s=>{var o=[];this.EXPLICIT_ROW_ACCESS_QUERY&&o.push("JSON_EXTRACT("+this.EXPLICIT_ROW_ACCESS_QUERY.alias+'.fields, "$.'+s+".uac."+t+'")'),this.EXPLICIT_TABLE_ACCESS_QUERY&&o.push("JSON_EXTRACT("+this.EXPLICIT_TABLE_ACCESS_QUERY.alias+'.fields, "$.'+s+".uac."+t+'")'),o.push(xr(Ir(this.schema.fields[s].uac,t),this.getGuestRightsExpression(),r)),i[s]="COALESCE("+o.join(", ")+")"}),i}getGuestRightsExpression(){var e=[];return this.AUTHOR_user_RELATIONSHIP_QUERY&&(e.push(this.AUTHOR_user_RELATIONSHIP_QUERY.alias+".relationship"),this.AUTHOR_user_TOKEN_QUERY&&e.push("IF("+this.AUTHOR_user_TOKEN_QUERY.alias+'.id, "user", "")')),this.user.privileges.length&&e.push('"'+this.user.privileges.join(",")+'"'),e.length?'CONCAT_WS(",", '+e.join(", ")+")":'""'}toString(){return"SELECT "+this.select.join(", ")+" FROM "+this.schema.name+" AS "+this.alias+(this.EXPLICIT_TABLE_ACCESS_QUERY?" LEFT JOIN ("+this.EXPLICIT_TABLE_ACCESS_QUERY.query+") AS "+this.EXPLICIT_TABLE_ACCESS_QUERY.alias+" ON "+this.EXPLICIT_TABLE_ACCESS_QUERY.on.join(" AND "):"")+(this.EXPLICIT_ROW_ACCESS_QUERY?" LEFT JOIN ("+this.EXPLICIT_ROW_ACCESS_QUERY.query+") AS "+this.EXPLICIT_ROW_ACCESS_QUERY.alias+" ON "+this.EXPLICIT_ROW_ACCESS_QUERY.on.join(" AND "):"")+(this.AUTHOR_user_RELATIONSHIP_QUERY?" LEFT JOIN ("+this.AUTHOR_user_RELATIONSHIP_QUERY.query+") AS "+this.AUTHOR_user_RELATIONSHIP_QUERY.alias+" ON "+this.AUTHOR_user_RELATIONSHIP_QUERY.on.join(" AND "):"")+" WHERE "+this.where.join(" AND ")}};function Ct(n,e=[]){var t=ae({dbDriver:n.dbDriver,SCHEMAS:{}},n.UAC||{});return e.forEach(r=>{var i=r;t.TABLE_SPECIFIERS&&(i=t.TABLE_SPECIFIERS[r]);var s=i.split("."),o=s.pop(),f=s.pop();t.SCHEMAS[r]=(t.dbDriver.getSchema(f)||{})[o]}),t}function Sr(n,e,t){var r='FIND_IN_SET(target, "'+t.lineage.replace("/",",")+'")';return{schema:n.SCHEMAS.uac,select:["*",r+" AS `lineage.target`"],where:["table_name = "+e,"target = "+t.id+" OR "+r],orderBy:"`lineage.target` DESC",limit:1,toString(){return"SELECT "+this.select.join(", ")+" FROM "+this.schema.name+" WHERE "+this.where.join(" AND ")+" ORDER BY "+this.orderBy+" LIMIT "+this.limit}}}function Lt(n,e,t=!1){var r={};r.DESCENDANT='FIND_IN_SET(id, "'+e.lineage.replace(e.id+"/","").replace(/\//g,",")+'")',r["DESCENDANT,CHILD"]="id = "+e.parent,r.SIBLING=e.parent+" = parent",r.ANCESTOR="FIND_IN_SET("+e.id+', REPLACE(REPLACE(lineage, CONCAT(id, "/"), ""), "/", ","))',r["ANCESTOR,PARENT"]=e.id+" = parent",r.AUTHOR="id = "+e.id;var i="NULL";return v(r,(s,o)=>{i="IF("+s+', "'+o+'", '+i+")"}),{schema:n.SCHEMAS.account,select:(t?"GROUP_CONCAT(DISTINCT ":"")+i+(t?")":"")+" AS relationship",where:[],toString(){return"SELECT "+this.select+" FROM "+this.schema.name+(this.where.length?" WHERE "+this.where.join(" AND "):"")}}}function xr(n,e,t=!1){var r=Ce(n[0])?n.shift():null;if(!n.length)return Ce(r)?parseInt(r):"NULL";var i=[];return n.forEach(s=>{var o=[];s.split("+").forEach(f=>{o.push('FIND_IN_SET("'+f+'", '+e+")")}),i.push("IF("+o.join(" AND ")+', "'+s+'", NULL)')}),i="COALESCE("+i.join(", ")+")",r?"IF(ISNULL("+i+"), 1, 0)":"IF(ISNULL("+i+"), 0, "+(t?i:"1")+")"}function Ir(n,e){return y(n)&&(n=n[e]),W(n)?[]:_(n)}var Fe=class n{static select(e,t,r,i=[]){i=_(i),(!i.length||i[0]==="*")&&(i=Object.keys(t.fields));var s=new Ee(e,t,r);return s.select.push(...i),s}static getRelatedAccounts(e,t,r,i=[]){var s=Ct(e,["uac","account"]),o={schema:s.SCHEMAS.account,alias:"ACCOUNT",select:[],where:[],orderBy:[],toString(){return"SELECT "+this.select.join(", ")+" FROM "+this.schema.name+" AS "+this.alias+" RIGHT JOIN ("+this.AUTHOR_USER_RELATIONSHIP_QUERY.query+") AS "+this.AUTHOR_USER_RELATIONSHIP_QUERY.alias+" ON "+this.AUTHOR_USER_RELATIONSHIP_QUERY.on.join(" AND ")+" WHERE "+this.where.join(" AND ")+(this.orderBy.length?" ORDER BY "+this.orderBy:"")}};return o.AUTHOR_USER_RELATIONSHIP_QUERY={query:Lt(s,t,!1),alias:"AUTHOR_USER_RELATIONSHIP",on:[o.alias+"."+s.SCHEMAS.account.primaryKey+" = AUTHOR_USER_RELATIONSHIP."+s.SCHEMAS.account.primaryKey,"NOT ISNULL(AUTHOR_USER_RELATIONSHIP.relationship)"]},i&&(o.select.push("FIND_IN_SET("+o.alias+"."+s.SCHEMAS.account.primaryKey+', "'+i.join(",")+'") AS priority'),o.orderBy.push("priority DESC")),r&&o.where.push('AUTHOR_USER_RELATIONSHIP.relationship in ("'+r.join('", "')+'")'),o}static getAccessesDoc(e,t,r,i=null,s=null,o=!1,f=!1){if(i&&s)throw new Error("UAC queries must be either over an object and its author (argument #2), or as related to a specific user (argument #3). But not both!");var a=new Ee(e,tableName,t);a.AUTHOR_USER_RELATIONSHIP_QUERY&&a.AUTHOR_USER_RELATIONSHIP_QUERY.on.push("NOT ISNULL(AUTHOR_USER_RELATIONSHIP.relationship)"),i?a.where.push(a.schema.primaryKey+" = "+i):a.schema.attributionKey&&s&&(a.where.push(a.schema.attributionKey+" = "+s),a.limit=1),!r.length||r==="*"?r=n.standardAccesses:r=_(r);var h=[],u={},c=o?Object.keys(a.schema.fields):[];if(r.forEach(l=>{h.push('JSON_OBJECT("'+l+'", COALESCE('+Ee.deriveEntityAccess(l,f)+"))"),v(Ee.deriveFieldsAccess(c,l,f),(g,T)=>{u[g]||(u[g]=[]),u[g].push('JSON_OBJECT("'+l+'", '+T+")")})}),r.length>1?a.select.push("JSON_MERGE("+h.join(", ")+") AS uac"):a.select.push(h.join(", ")+" AS uac"),u.length){var p=[];v(u,(l,g)=>{r.length>1?p.push('JSON_OBJECT("'+l+'", JSON_MERGE('+g.join(", ")+"))"):p.push('JSON_OBJECT("'+l+'", '+g.join(", ")+")")}),a.select.push("JSON_MERGE("+p.join(", ")+") AS fields")}return a}};Fe.standardAccesses=["view","create","update","delete","stats","use"];var pe=class{getBase(e,t={},r=[]){r.length||(r=m(this.exprs.TABLE_REFERENCES)?this.exprs.TABLE_REFERENCES:[this.exprs.TABLE_REFERENCES]),r=r.concat(this.exprs.JOIN_CLAUSE||[]).map(o=>o.eval(e,t));var i=r.shift(),s=r;return new tt(i,s,this.exprs.WHERE_CLAUSE,t)}getToString(e,t){var r=e.t||0,i=(f=0,a=!0)=>e.formatted&&a?`\r
`+"	".repeat(Math.max(0,r+f)):"",s={...e};s.t=r+1;var o=[];return v(this.exprs,(f,a,h)=>{if(!(!a&&h>0)){var u=null;if(f==="JOIN_CLAUSE"){var c=this.clauses[f];u=a.map((p,l)=>c[l].toString().toUpperCase()+" "+p.stringify(s)).join(i())}else{var c=this.clauses[f].toString().toUpperCase();f==="TABLE_REFERENCES"?u=c+" "+(m(a)?a.map(l=>l.stringify(s)).join(", "):a.stringify(s)):(!t||!(u=t(f,a,c,s,i)))&&(m(a)?u=a.map(l=>_isFunction(l.stringify)?l.stringify(s):a).join(", "):u=c+" "+a.stringify(s))}!u&&h===0&&(u=c),u&&o.push(i()+u)}}),o.join(" ")+i(-1)}static getParse(e,t,r,i,s,o,f=null){var a="i",h=d.lex(e,Object.values(r),{useRegex:a});if(h.matches.length){var u={},c={},p={},l={},g=[];h.matches.forEach((E,O)=>{var A=Pe(r,ne=>E.match(new RegExp(ne,a)),!0),x=h.tokens[O+1].trim(),w=null;if(A==="JOIN_CLAUSE"){var w=i(x,null,{withUac:t});(w.type=E.match(new RegExp("(INNER|CROSS|LEFT|RIGHT)","i")))&&(w.type=w.type[0].toLowerCase()),u[A]?(u[A].push(w),c[A].push(E)):(u[A]=[w],c[A]=[E])}else{if(A==="TABLE_REFERENCES"||A==="USING_CLAUSE")var P=d.split(x,[","]).map(Q=>i(Q.trim(),[z],{withUac:t,assertTableValidity:A==="TABLE_REFERENCES"&&!h.matches.includes("USING")})),w=P.length===1?P[0]:P;else if(!o||!(w=o(A,x)))var w=i(x,null,{withUac:t});A==="WHERE_CLAUSE"&&!u.JOIN_CLAUSE&&(u.JOIN_CLAUSE=[],c.JOIN_CLAUSE=[]),u[A]=w,c[A]=E}});let T=u.USING_CLAUSE||u.TABLE_REFERENCES;return(m(T)?T:[T]).concat((u.JOIN_CLAUSE||[]).map(E=>E.table)).forEach((E,O)=>{var A=E.getAlias(),x=E.getSchema();p[A]=E,l[A]=x,O===0&&(p[""]=p[A],l[""]=l[A])}),v(u,(E,O)=>{var A=_(O,!1).reduce((x,w)=>x.concat(w.meta.reads).concat(w.meta.writes).concat(w.meta.calls),[]);A.forEach(x=>{if(x.role!=="CONTEXT"&&g.push(x),!(x.role==="CONTEXT"||x.role==="CALL_SPECIFIER"||x instanceof X)){var w,P;if(x instanceof je){if(le.isIncoming(x+"")){x.context?p[x.context+""].associateReference(x):(x.interpreted=i(p[""].getAlias()+"."+x,[H]),p[""].associateReference(x));return}w=x.name.split("~>")[0].replace(/`/g,"")}else w=x.name.replace(/`/g,"");if(x.context){if(P=x.context.name.replace(/`/g,""),(!l[P]||w!=="*"&&!(w in l[P].columns))&&s.validation!==!1)throw new Error('"'+x+'" in '+E.replace(/_/g," ")+" is unknown!");w==="*"&&(x.interpreted=Object.keys(l[P].columns).map(Q=>i(P+"."+Q,[H])))}else if(w==="*"){P=p[""].getAlias();var ne;if((ne=Object.keys(l[""].columns))&&!ne.length)throw new Error('The wildcard column specifier (*) cannot used on table "'+P+'"; table defines no columns.');x.interpreted=ne.map(Q=>i(P+"."+Q,[H]))}else if(!(f&&f(w,E))){if(P=Object.keys(l).filter(Q=>Q).reduce((Q,F)=>{if(w in l[F].columns){if(Q){if(s.validation!==!1)throw new Error('"'+x+'" in '+E.replace(/_/g," ")+" is ambiguous!");return Q}return F}},null),!P){if(s.validation!==!1)throw new Error('"'+x+'" in '+E.replace(/_/g," ")+" is unknown!");P=p[""].getAlias()}x.interpreted=i(P+"."+x,[H])}p[P||""].associateReference(x)}})}),v(p,(E,O)=>{if(E){var A=O.getName();s.withUac&&!O.isDerivedQuery()&&(O.interpreted=i("("+Fe.select(s,l[E],null,O.getAssociateReferences().map(F=>F.name))+") AS "+(E||A),[z],{withUac:!1}));var x;if((x=O.getAssociateReferences().filter(F=>F instanceof je)).length){var w={},P=[],ne=O.getAssociateReferences().filter(F=>!(F instanceof je)).map(F=>A+"."+F.name);x.forEach(F=>{var me=F.process(l[E],s.dbDriver),vt=me.b.table.name+"__by__"+me.b.actingKey;w[vt]||(w[vt]=me),ne.push(vt+"."+me.b.select+" AS `"+F.name.replace(/`/g,"")+"`")}),v(w,(F,me)=>{P.push("LEFT JOIN "+me.b.table.name+" AS "+F+" ON "+F+"."+me.b.actingKey+" = "+A+"."+me.a.actingKey)});var Q="(SELECT"+(t?" WITH UAC":"")+" "+M(ne).join(", ")+" FROM "+A+" "+P.join(" ")+") AS "+O.getAlias();(O.interpreted||O).interpreted=i(Q,[z],{withUac:t})}}}),{exprs:u,clauses:c,tables:p,schemas:l,vars:g}}}};var De=class extends fe(pe,lr){constructor(e,t,r){super(),this.exprs=e,this.clauses=t,this.withUac=r}async eval(e,t={}){var r,i=this.exprs.TABLE_REFERENCES;this.exprs.DELETE_LIST.length?r=this.exprs.DELETE_LIST.map(c=>c.endsWith(".*")?N(c,".*"):c):this.exprs.USING_CLAUSE?(r=_(this.exprs.TABLE_REFERENCES,!1).map(c=>c.getAlias()),i=this.exprs.USING_CLAUSE):r=[(m(i)?i[0]:i).getAlias()];var s={...t};s.mode="readwrite",this.base=this.getBase(e,s,_(i,!1));var o={},f={},a=await Promise.all(this.base.joins.concat(this.base.main));r.forEach(c=>{if(o[c]=a.filter(p=>(p.params.alias||p.name)===c)[0],!o[c])throw new Error('"'+c+'" in table list is not found in main query.')});for(var h;h=await this.base.fetch();)r.forEach(c=>{f[c]||(f[c]=[]);var p=_(o[c].def.schema.primaryKey).map(l=>h[c][l]);f[c].filter(l=>Re(l,(g,T)=>g===p[T])).length||f[c].push(p)});var u=await Promise.all(r.map(async c=>{if(f[c].length){var p=await o[c].deleteAll(f[c]);return{[c]:p}}}));return u.reduce((c,p)=>({...c,...p}),{})}toString(){return this.stringify()}stringify(e={}){return this.getToString(e)}static parse(e,t,r={}){if(e.trim().substr(0,6).toLowerCase()==="delete"){var i=!1;e.match(/DELETE[ ]+WITH[ ]+UAC/i)&&(i=!0,e=e.replace(/[ ]+WITH[ ]+UAC/i,""));var s=super.getParse(e,i,this.clauses,t,r,(o,f)=>{if(o==="DELETE_LIST")return f.split(",").map(a=>a.trim()).filter(a=>a)});if(s.exprs.DELETE_LIST.length&&s.exprs.USING_CLAUSE)throw new Error('The "using" keyword cannot be used in a query with explicitly-listed tables.');return new this(s.exprs,s.clauses,i)}}};De.clauses={DELETE_LIST:"DELETE",TABLE_REFERENCES:"FROM",USING_CLAUSE:"USING",WHERE_CLAUSE:"WHERE",JOIN_CLAUSE:"(INNER[ ]+|CROSS[ ]+|(LEFT|RIGHT)([ ]+OUTER)?[ ]+)?JOIN"};var Tr=class extends S{};Object.defineProperty(Tr.prototype,"jsenType",{get(){return"FieldExpression"}});var Ar=Tr;var rt=class extends Ar{constructor(e,t,r=!1){super(),this.expr=e,this.alias=t,this.claused=r}as(e){return this.alias=e,this.claused=!0,this}getContextName(){return this.expr.interpreted?m(this.expr.interpreted)?this.expr.interpreted[0].context.name:this.expr.interpreted.context.name:this.expr.context?(this.expr.context.name||"").replace(/`/g,""):""}getName(){return(this.expr.name||"").replace(/`/g,"")}getAlias(){return(this.alias||"").replace(/`/g,"")||this.getName()||this.expr.toString()}getCallExprs(){return this.expr.meta.calls.concat(this.expr.meta.deep.calls||[]).concat([this.expr]).filter(e=>e instanceof X)}getAggrExprs(){return this.expr.meta.calls.concat(this.expr.meta.deep.calls||[]).concat([this.expr]).filter(e=>e instanceof Ue)}eval(e,t,r={}){var i=this.getAlias();if(this.expr instanceof Y){if(this.getName()==="*"){var s=this.expr.getEval(e,r);return v(s,(a,h)=>{r.mode==="readwrite"?Object.defineProperty(s,a,{get(){return h.get()},set(u){return h.set(u),!0},enumerable:!0}):s[a]=h.get()}),s}var o=this.expr.getEval(e,r);return r.mode==="readwrite"?{get[i](){return o.get()},set[i](a){return o.set(a),!0}}:Ze(i,o.get())}var f;return this.expr instanceof xe?f=this.expr.eval(t,r):f=this.expr.eval(e,r),r.mode==="readwrite"?{get[i](){return f},set[i](a){throw new Error('"'+i+'" cannot be modified; not a reference!')}}:Ze(i,f)}stringify(e={}){return[this.expr.stringify(e),this.claused?"AS":"",this.alias].filter(t=>t).join(" ")}static parse(e,t,r={}){var i=d.split(e,[" (as )?"],{useRegex:"i",preserveDelims:!0}),s=null,o=i.pop().trim(),f=o.substr(0,3).toLowerCase()==="as ";if(f)o=o.substr(3).trim(),s=t(i.join("").trim());else if(i.length&&(!o.match(/[^0-9a-zA-Z_]/)||L(o,"`","`")))try{s=t(i.join("").trim())}catch{}return s||(o=null,s=t(e)),s.isFieldName=!0,new this(s,o,f)}};function Or(n,e=[],t=!0){var r=0;return I(arguments[0])&&C(arguments[1])&&(r=arguments[0],n=arguments[1],e=arguments[2]||[]),G([r,{},n],(i,s,o)=>R(e)?e(i):m(e)&&e.length?e.indexOf(i)>-1:!0,!1,!1,t)}var wr=class extends S{};Object.defineProperty(wr.prototype,"jsenType",{get(){return"GroupByExpression"}});var Rr=wr;var ke=class extends Rr{constructor(e,t=null,r=!1){super(),this.columns=e,this.having=t,this.withRollup=r}eval(e,t={}){var r=(s,o,f)=>{if(o.length){var a={};s.forEach(u=>{var c=o[0].eval(u,t);a[c]=a[c]||[],a[c].push(u)}),Object.values(a).map(u=>r(u,o.slice(1),f))}if(!o.length||this.withRollup){var h=new de(t);return Et(h,s[0]),h.$=Or(h.$),h.AGGR={rows:s,by:o},h.AGGR.isRollup=o.length&&this.withRollup,h.AGGR.isRollup&&o.forEach(u=>{u=u.stringify().indexOf(".")>-1?k(u.stringify(),"."):u.stringify(),u in h.$&&(h.$[u]=null)}),f.push(h),h}},i=[];return r(e,this.columns.slice(),i),i}toString(){return this.stringify()}stringify(e={}){var t=[this.columns.map(r=>r.stringify(e)).join(", ")];return this.withRollup&&t.push("WITH ROLLUP"),this.having&&t.push("HAVING "+this.having.stringify(e)),t.join(" ")}static parse(e,t,r={}){var i=d.lex(e,["WITH[ ]+ROLLUP","HAVING"],{useRegex:"i"}),s=d.split(i.tokens.shift().trim(),[","]).map(a=>t(a.trim())),o=null,f=!1;return i.matches.forEach(a=>{a.toLowerCase().startsWith("with")?(f=!0,i.tokens.shift()):a.toLowerCase().startsWith("having")&&(o=t(i.tokens.shift().trim()))}),new this(s,o,f)}};var Cr=class extends ${};Object.defineProperty(Cr.prototype,"jsenType",{get(){return"InsertStatement"}});var Lr=Cr;var Pr=class extends ir{constructor(n,e,t,r="=",i=!1){super(),this.initKeyword=n,this.reference=e,this.val=t,this.operator=r,this.postIncrDecr=i}eval(n=null,e={}){var t,r,i=this.reference.getEval(n,e);if(["++","--"].includes(this.operator)){if(r=this.reference.eval(n,e),!oe(r))throw new Error(this.reference+" must be a number!");this.operator==="++"?t=r+1:t=r-1}else if(["+=","-=","*=","/="].includes(this.operator)){var s=i.get(),o=this.val.eval(n,e);if(this.operator!=="+="&&(!oe(s)||!oe(o)))throw new Error(this+" - operands must each be a number!");this.operator==="*="?t=s*o:this.operator==="/="?t=s/o:this.operator==="-="?t=s-o:t=s+o}else t=this.val.eval(n,e);try{return i.set(t,this.initKeyword),e&&m(e.references)&&_pushUnique(e.references,this.reference.toString()),this.postIncrDecr?r:t}catch(f){throw f instanceof K?new K("["+this+"]: "+f.message):f}}toString(){return this.stringify()}stringify(n={}){return["++","--"].includes(this.operator)?this.postIncrDecr?this.reference.stringify(n)+this.operator:this.operator+this.reference.stringify(n):(this.initKeyword?this.initKeyword+" ":"")+[this.reference.stringify(n),this.operator.trim(),this.val.stringify(n)].join(" ")}static parse(n,e,t={}){var r=d.lex(n,this.operators.concat([ui]));if(r.matches.length){var i,s,o,f=r.matches[0].trim(),a=["++","--"].includes(f),h;if(a?(h=n.trim().endsWith("++")||n.trim().endsWith("--"),s=r.tokens[h?"shift":"pop"]().trim()):(s=r.tokens.shift().trim(),o=r.tokens.shift().trim()),["var","let","const"].includes(N(s," "))){if(f!=="=")throw new se("Invalid declaration: "+n);i=N(s," "),s=k(s," ").trim()}if(!((s=e(s,null,{role:"ASSIGNMENT_SPECIFIER"}))instanceof Y)||!a&&!(o=e(o)))throw new se(n);return new this(i,s,o,f,h)}}};Pr.operators=["+=","-=","*=","/=","++","--"];var ui=(n,e)=>!n.endsWith("=")&&e.startsWith("=")&&!e.startsWith("=>")&&!e.startsWith("==")&&!e.startsWith("===")?"=":!1,it=Pr;var Be=class n extends Lr{constructor(e,t,r,i,s,o,f){super(),this.TABLE_REFERENCES=e,this.COLUMNS_LIST=t,this.VALUES_LIST=r,this.WITH_UAC=i,this.IGNORE=s,this.INSERT_TYPE=o,this.UPDATE_CLAUSE=f}async eval(e,t={}){var r={...t};r.mode="readwrite";var i=await this.TABLE_REFERENCES.eval(e,r),s=i.def.schema,o=this.VALUES_LIST,f=this.INSERT_TYPE.toUpperCase(),a=f==="TABLE";if(f==="SET"){var h=o.map(p=>p.reference.name);o=[o.map(p=>p.val.eval({},t))]}else{var h=this.COLUMNS_LIST||(s.columns?Object.keys(s.columns):[]);if(f==="SELECT")try{o=(await o.eval(e,t)).map(l=>Object.values(l))}catch(l){throw new Error('["'+o.stringify()+'" in SELECT clause]: '+l.message)}else if(f==="VALUES")o=o.map(l=>l.map(g=>g.eval({},t)));else throw new Error('Invalid insert statement "'+this+'"!')}h=h.map(p=>p+"");var u=this.UPDATE_CLAUSE?p=>{var l={...t};return l.strictMode=!1,this.UPDATE_CLAUSE.forEach(g=>g.eval({$:p},l)),!0}:this.IGNORE?()=>!1:null,c=await i.addAll(o,h,u,a);return{[i.name]:c}}toString(){return this.stringify()}stringify(e={}){var t=e.t||0,r=(o=0)=>e.formatted?`\r
`+"	".repeat(Math.max(0,t+o)):"",i={...e};i.t=t+1;var s=[this.TABLE_REFERENCES.stringify(i)];return this.INSERT_TYPE.toUpperCase()==="SET"?s.push(r(1)+"SET "+this.VALUES_LIST.map(o=>o.stringify(i)).join(", ")):(this.COLUMNS_LIST.length&&s.push("("+this.COLUMNS_LIST.join(", ")+")"),this.INSERT_TYPE.toUpperCase()==="SELECT"?s.push(this.VALUES_LIST.stringify(i)):s.push(r()+"VALUES "+r(1)+"("+this.VALUES_LIST.map(o=>o.map(f=>f.stringify(i)).join(", ")).join("), "+r(1)+"(")+")")),this.UPDATE_CLAUSE&&s.push(r()+"ON DUPLICATE KEY UPDATE "+this.UPDATE_CLAUSE.map(o=>o.stringify(i)).join(", ")),"INSERT "+(this.IGNORE?"IGNORE ":"")+"INTO "+s.join(" ")}static parse(e,t,r={}){if(e.trim().match(/^INSERT([ ]+WITH[ ]+UAC)?([ ]+IGNORE)?([ ]+INTO)?/,"i")){var i=!1,s=!1;e.match(/INSERT[ ]+WITH[ ]+UAC/i)&&(i=!0,e=e.replace(/[ ]+WITH[ ]+UAC/i,"")),e.match(/INSERT[ ]+IGNORE/i)&&(s=!0,e=e.replace(/[ ]+IGNORE/i,""));var o=d.lex(e,Object.values(n.clauses),{useRegex:"i"});o.tokens.shift();var f=o.tokens.shift().trim(),a=[],h=o.tokens.shift(),u=o.matches[1].toUpperCase();if(u==="SET")f=t(f,[z]),h=d.split(h.trim(),[","]).map(g=>t(g.trim(),[it]));else{var c=d.split(f,[" "]);f=t(c.shift().trim(),[z]),c.length&&(a=c[0].trim(),a=d.split(L(a,"(",")")?B(a,"(",")"):a,[","]).map(g=>g.trim())),u==="SELECT"?h=t("SELECT "+h.trim()):h=d.split(h.trim(),[","]).map(g=>d.split(B(g.trim(),"(",")"),[","]).map(T=>t(T.trim())))}var p=o.tokens.shift();p&&(p=d.split(p.trim(),[","]).map(g=>t(g.trim(),[it])));var l=new this(f,a,h,i,s,u,p);return l.parseCallback=t,l}}};Be.clauses={TABLE_REFERENCES:"INSERT([ ]+IGNORE)?([ ]+INTO)?",VALUES_LIST:"(VALUES|VALUE|SET|SELECT)",UPDATE_CLAUSE:"ON[ ]+DUPLICATE[ ]+KEY[ ]+UPDATE"};var Ur=class extends S{};Object.defineProperty(Ur.prototype,"jsenType",{get(){return"JoinConstruct"}});var br=Ur;var qe=class n extends br{constructor(e,t,r){super(),this.table=e,this.condition=t,this.conditionClause=r}eval(e,t={}){return this.table.eval(e,t).then(r=>(r.join={type:this.type,condition:this.condition,conditionClause:this.conditionClause},r))}getName(){return this.table.getName()}getAlias(){return this.table.getAlias()}toString(){return this.stringify()}stringify(e={}){return[this.table.stringify(e),this.conditionClause,this.condition.stringify(e)].join("")}static parse(e,t,r={}){var i=d.lex(e,n.clauses);if(i.tokens.length===2){var s=i.matches[0],o=t(i.tokens[0],[z]),f=s.trim().toUpperCase()==="USING"?t(i.tokens[1],[Te]):t(i.tokens[1]);return new this(o,f,s)}}};qe.clauses=[" on "," using "," ON "," USING "];var jr=class extends S{};Object.defineProperty(jr.prototype,"jsenType",{get(){return"MathExpression"}});var Nr=jr;var Fr=class extends Nr{constructor(n,e){super(),this.val=n,this.exprs=e}eval(n=null,e={}){return this.exprs.reduce((t,r)=>{var i=r.val.eval(n,e),s=r.operator.trim();if((!I(t)||!I(i))&&s!=="+")throw new Error("Invalid Math expression: "+this.toString()+"!");switch(s){case"+":return t+i;case"-":return t-i;case"*":return t*i;case"/":return t/i}},this.val.eval(n,e))}toString(){return this.stringify()}stringify(n={}){return[this.val.stringify(n)].concat(this.exprs.map(e=>e.operator+" "+e.val.stringify(n))).join(" ")}static parse(n,e,t={}){var r=d.lex(n,V(this.operators));if(r.tokens.filter(s=>s).length>1&&r.matches.length===r.tokens.length-1){var i=M(r.matches);if(ee(i,this.operators.sup).length&&ee(i,this.operators.sub).length)throw new Error('"Addition/subtraction" and "multiplication/division" operators cannot be used in the same expression: '+n+"!");return new this(e(r.tokens.shift().trim()),r.tokens.map((s,o)=>({operator:r.matches[o],val:e(s.trim())})))}}};Fr.operators={sup:["*","/"],sub:["+","-"]};var Dr=Fr;var kr=class extends S{};Object.defineProperty(kr.prototype,"jsenType",{get(){return"NumberType"}});var Br=kr;var ci=class extends Br{constructor(n,e=0){super(),this.int=n,this.dec=e}eval(){return parseFloat(this.int+(this.dec?"."+this.dec:null))}toString(){return this.stringify()}stringify(n={}){return this.int+(this.dec?"."+this.dec:null)}static parse(n,e,t={}){if(I(n)){var n=n.split(".");return new this(parseInt(n.shift()),parseInt(n.shift()))}}},qr=ci;var Wr=class extends S{};Object.defineProperty(Wr.prototype,"jsenType",{get(){return"Placeholder"}});var Mr=Wr;var st=class extends Mr{constructor(e,t){super(),this.name=I(e)?parseInt(e):e,this.notation=t}eval(e,t={}){if(typeof this.name=="number"){if(!t.vars)throw new Error('Annonymous placeholders require a "params.vars" array to be resolved.');return t.vars[this.name]}if(!t.vars)throw new Error('Named placeholders require a "params.vars" object to be resolved.');return t.vars[this.name]}toString(){return this.stringify()}stringify(e={}){return this.notation==="?"?"?":this.notation+this.name}static parse(e,t,r={}){if(e.startsWith("?")||e.startsWith(":"))return new this(e.substr(1),e.substr(0,1))}};var $r=class extends ${};Object.defineProperty($r.prototype,"jsenType",{get(){return"SelectStatement"}});var Kr=$r;var We=class extends fe(pe,Kr){constructor(e,t,r=!1,i=[],s=[]){super(),this.exprs=e,this.clauses=t,this.withUac=r,this.flags=i,this.vars=s}getFields(e=!1){return this.exprs.SELECT_LIST}getTable(){return this.exprs.TABLE_REFERENCES}getSources(e=!1){var t=this.getJoins()||[];return _(this.exprs.TABLE_REFERENCES,!1).concat(e?t.map(r=>r.table):t)}getWhere(){return this.exprs.WHERE_CLAUSE}getJoins(){return this.exprs.JOIN_CLAUSE}getGroupBy(){return this.exprs.GROUP_BY_CLAUSE}getWindows(){return this.exprs.WINDOWS_CLAUSE}getOrderBy(){return this.exprs.ORDER_BY_CLAUSE}getOffset(){return this.exprs.OFFSET_CLAUSE}getLimit(){return this.exprs.LIMIT_CLAUSE}async eval(e,t={}){this.base=this.getBase(e,t);for(var r=[],i;i=await this.base.fetch();)r.push(i);var s=(p,l,g=null)=>(g&&(g={aggr:[],win:[]}),p.forEach(T=>{T.$||(T.$={}),l.forEach(E=>{if(g){var O=E.getAggrExprs();if(O.length){Ge(O.filter(x=>x.window).length?g.win:g.aggr,E),E.getAlias()in T.$||(T.$[E.getAlias()]=void 0);return}}var A=E.eval(T,e,t);Object.keys(A).forEach(x=>{Object.defineProperty(T.$,x,Object.getOwnPropertyDescriptor(A,x))})})}),g),o={aggr:[],win:[]};this.vars.forEach(p=>{p instanceof Ue&&Ge(p.window?o.win:o.aggr,p)});var f=s(r,this.getFields(),!0);if(this.exprs.GROUP_BY_CLAUSE||o.aggr.length){var a=this.exprs.GROUP_BY_CLAUSE||new ke([]);r=a.eval(r,t),s(r,f.aggr)}if(this.exprs.WINDOWS_CLAUSE||o.win.length){var h=[];o.win.forEach(p=>{var l=p.window.stringify();h.indexOf(l)===-1&&(p.window.eval(r,this.exprs.WINDOWS_CLAUSE,t),h.push(l))}),s(r,f.win)}if(this.exprs.ORDER_BY_CLAUSE&&(r=this.exprs.ORDER_BY_CLAUSE.eval(r,t)),this.flags.includes("DISTINCT")&&(r=r.filter((p,l)=>l===Pe(r,g=>_even(g,p)))),this.exprs.OFFSET_CLAUSE||this.exprs.LIMIT_CLAUSE){var u=this.exprs.LIMIT_CLAUSE?this.exprs.LIMIT_CLAUSE.slice():[],c=this.exprs.OFFSET_CLAUSE||(u.length===2?u.shift():0);r=u.length?r.slice(c,c+u[0]):r.slice(c)}return r.map(p=>p.$)}toString(){return this.stringify()}stringify(e={}){return this.getToString(e,(t,r,i,s)=>{if(t==="SELECT_LIST")return i+" "+r.map(o=>o.stringify(s)).join(", ");if(t==="WINDOWS_CLAUSE")return i+" "+Object.keys(r).map(o=>o+" AS "+r[o].stringify(s)).join(", ");if(t==="GROUP_BY_CLAUSE"||t==="ORDER_BY_CLAUSE")return i+" "+r.stringify(s);if(t==="LIMIT_CLAUSE")return i+" "+r.join(", ")})}static parse(e,t,r={}){if(e.trim().substr(0,6).toLowerCase()==="select"){var i=!1;e.match(/SELECT[ ]+WITH[ ]+UAC/i)&&(i=!0,e=e.replace(/[ ]+WITH[ ]+UAC/i,""));var s=[],o=super.getParse(e,i,this.clauses,t,r,(f,a)=>{if(f==="SELECT_LIST")return d.split(a,[","]).map(c=>{var c=t(c.trim(),[rt]);return s.push(c.getAlias()),c});if(f==="WINDOWS_CLAUSE"){var h={};return d.split(a,[","]).forEach(u=>{var c=u.split(new RegExp(" as ","i"));h[c[0].trim()]=t(c[1].trim(),[Ie])}),h}else{if(f==="GROUP_BY_CLAUSE")return t(a,[ke]);if(f==="ORDER_BY_CLAUSE")return t(a,[he]);if(f==="LIMIT_CLAUSE")return a.split(",").map(u=>parseInt(u))}},(f,a)=>(a==="ORDER_BY_CLAUSE"||a==="GROUP_BY_CLAUSE")&&s.includes(f));return new this(o.exprs,o.clauses,i,o.clauses.SELECT_LIST.replace(/SELECT/i,"").split(" ").filter(f=>f),o.vars)}}};We.clauses={SELECT_LIST:"SELECT([ ]+(ALL|DISTINCT))?",TABLE_REFERENCES:"FROM",WHERE_CLAUSE:"WHERE",JOIN_CLAUSE:"(INNER[ ]+|CROSS[ ]+|(LEFT|RIGHT)([ ]+OUTER)?[ ]+)?JOIN",GROUP_BY_CLAUSE:"GROUP[ ]+BY",WINDOWS_CLAUSE:"WINDOW",ORDER_BY_CLAUSE:"ORDER[ ]+BY",OFFSET_CLAUSE:"OFFSET",LIMIT_CLAUSE:"LIMIT"};var Gr=class extends S{};Object.defineProperty(Gr.prototype,"jsenType",{get(){return"StringType"}});var Yr=Gr;var li=class extends Yr{constructor(n,e){super(),this.expr=n,this.quote=e}eval(){return this.expr}toString(){return this.stringify()}stringify(n={}){return this.quote+this.expr+this.quote}static parse(n,e,t={}){if(n=n.trim(),(L(n,'"','"')||L(n,"'","'"))&&!d.match(n,[" "]).length){var r=L(n,'"','"')?'"':"'";return new this(B(n,r,r),r)}}},Hr=li;var Qr=class extends S{};Object.defineProperty(Qr.prototype,"jsenType",{get(){return"UnionConstruct"}});var Jr=Qr;var nt=class extends Jr{constructor(e,t,r=null,i=null){super(),this.query=e,this.queries=t,this.orderBy=r,this.limit=i}toString(){return this.stringify()}stringify(e={}){var t=[[this.query.stringify(e)].concat(this.queries.map(r=>(r.onDuplicate?r.onDuplicate.toUpperCase()+" ":"")+r.select.stringify(e))).join(" UNION ")];return this.orderBy&&t.push("ORDER BY "+this.orderBy.stringify(e)),this.limit&&t.push("LIMIT "+this.limit.join(", ")),t.join(" ")}static parse(e,t,r={}){var i=null,s={useRegex:"i"};if((i=d.lex(e,[" UNION([ ]+(ALL|DISTINCT))? "],s))&&i.matches.length){var o=i.tokens,f=i.matches,a=null,h=null;if(o[0].trim().startsWith("(")){var u=d.lex(o.pop(),["ORDER[ ]+BY","LIMIT"],s);o.push(u.tokens.shift()),u.matches.forEach(c=>{var p=u.tokens.shift().trim();c.toUpperCase().startsWith("ORDER")?a=t(p,[he]):c.toUpperCase().startsWith("LIMIT")&&(h=p.split(",").map(l=>parseInt(l)))})}return new this(t(o.shift().trim()),o.map((c,p)=>({select:t(c.trim()),onDuplicate:(f[p].match(new RegExp("ALL|DISTINCT","i"))||[])[0]})),a,h)}}};var Vr=class extends ${};Object.defineProperty(Vr.prototype,"jsenType",{get(){return"UpdateStatement"}});var Xr=Vr;var Me=class extends fe(pe,Xr){constructor(e,t,r){super(),this.exprs=e,this.clauses=t,this.withUac=r}async eval(e,t={}){var r={...t};r.mode="readwrite",this.base=this.getBase(e,r);for(var i;i=await this.base.fetch();)this.exprs.ASSIGNMENT_LIST.forEach(o=>o.eval(i,t));var s=await this.base.syncCursors();return Promise.all(this.base.joins.concat(this.base.main)).then(o=>o.reduce((f,a,h)=>({[a.name]:s[h],...f}),{}))}toString(){return this.stringify()}stringify(e={}){return this.getToString(e,(t,r,i,s,o)=>{if(t==="ASSIGNMENT_LIST")return i+" "+r.map(f=>f.stringify(s)).join(", ")})}static parse(e,t,r={}){if(e.trim().substr(0,6).toLowerCase()==="update"){var i=!1;e.match(/UPDATE[ ]+WITH[ ]+UAC/i)&&(i=!0,e=e.replace(/[ ]+WITH[ ]+UAC/i,""));var s=super.getParse(e,i,this.clauses,t,r,(o,f)=>{if(o==="ASSIGNMENT_LIST")return d.split(f,[","]).map(a=>t(a.trim(),[it]))});return new this(s.exprs,s.clauses,i)}}};Me.clauses={TABLE_REFERENCES:"UPDATE",ASSIGNMENT_LIST:"SET",WHERE_CLAUSE:"WHERE",JOIN_CLAUSE:"(INNER[ ]+|CROSS[ ]+|(LEFT|RIGHT)([ ]+OUTER)?[ ]+)?JOIN"};var zr=class extends S{};Object.defineProperty(zr.prototype,"jsenType",{get(){return"Void"}});var Zr=zr;var pi=class extends Zr{constructor(n){super(),this.val=n}eval(){return this.val.toLowerCase().trim()==="null"?null:void 0}toString(){return this.stringify()}stringify(n={}){return this.val}static parse(r,e,t={}){var r=r.toLowerCase().trim();if(r==="null"||r==="undefined")return new this(r)}},ei=pi;var ti={Union:nt,Select:We,Insert:Be,Update:Me,Delete:De,Join:qe,Abstraction:mt,Condition:ze,Assertion:tr,Comparison:Ne,Math:Dr,Num:qr,Str:Hr,Bool:or,Void:ei,Aggr:be,Call:dt,Placeholder:st,ArrowReference:le,Reference:H};Le.grammar=ti;var ri=Le;var ot=class extends ie{constructor(e){super([]),this._store=e,this._storeFetch=new Promise(async t=>{this.cache=await this._store.getAll(),t()})}async fetch(){return await this._storeFetch,super.fetch()}};function Pt(n,e){return n.reduce((t,r,i)=>t||e(r,i),!1)}var at=class{constructor(e,t,r,i,s={}){this.table=e,this.rawResultMeta=t,this.columns=r,this.entries=i,this.duplicateKeyUpdateObj=s}getAffectedRowsPointers(){if(!(!m(this.columns)||!m(this.entries))){var e=[],t={all:{},each:[]},r=this.table.getKeyPathForPrimaryKey();if(Pt(r,f=>this.columns.includes(f)))e=[r],t.by="primaryKey";else{var i=this.table.getKeyPathsForIndex("unique");e=i.filter(f=>Pt(f,a=>this.columns.includes(a))),t.by="uniqueKeys"}if(e.length){var s={};M(e.reduce((f,a)=>f.concat(a),[])).forEach(f=>{var a=this.columns.indexOf(f);a===-1?t.all[f]=this.table.def.schema.columns[f].default:s[f]=a});var o=Object.keys(s);o.length&&this.entries.forEach(f=>{var a={};o.forEach(h=>{m(f)?a[h]=f[s[h]]:a[h]=f[h],this.duplicateKeyUpdateObj&&h in this.duplicateKeyUpdateObj&&(a[h]=[a[h],this.duplicateKeyUpdateObj[h]])}),t.each.push(a)})}return t}}};var ge=class extends at{info(){var e,t=(this.rawResultMeta.info||"").replace(/ /g,"").match(/Records:([0-9]*)Duplicates:([0-9]*)Warnings:([0-9]*)/);return t?e=t.slice(1).map(r=>parseInt(r)):e=[0,0,0],{records:e[0],duplicates:e[1],warnings:e[2]}}async getAffectedRows(e=!1){var t=this.getAffectedRowsPointers();if(t.by==="primaryKey"){var r=Object.keys(t.each[0]);if(r.length===1){var i=t.each.map(c=>c[r[0]]);if(Re(i,c=>I(c)))return e?i.map(c=>parseInt(c)):i.length}}var s="id";let o=c=>{var p=Object.keys(c),l=p.reduce((g,T)=>g.concat(m(c[T])?`${T} IN ("${c[T].join('", "')}")`:`${T} = "${c[T]}"`),[]).join(" AND ");return p.length>1?`(${l})`:l};var f="",a="";if(W(t.all)||(f=o(t.all)),!W(t.each)){var h=Object.keys(t.each[0]);h.length===1&&!m(t.each[0][h[0]])?a=`${h[0]} IN (${t.each.map(c=>c[h[0]]).join(", ")})`:a=t.each.map(c=>o(c)).join(" OR ")}if(f||a){var u=await this.table.database.driver.getConnection();return new Promise((c,p)=>{var l=f&&a?`${f} AND (${a})`:f||a,g=`SELECT ${e?s:"COUNT(*) AS count"} FROM ${this.table.name} WHERE ${l} ORDER BY ${s} ASC`;u.query(g,(T,E)=>{if(T)return p(T);if(!e)return c(E[0].count);c(E.map(O=>O[s]))})})}return this.rawResultMeta.insertId?e?this.entries.map((c,p)=>this.rawResultMeta.insertId+1):this.entries.length:e?[]:0}};var ft=class{constructor(e,t,r){this.table=e,this.rawResultMeta=t,this.whereObj=r}};var $e=class extends ft{async getAffectedRows(e=!1){if(e)throw new Error('The "withIDs" argument is not supported for delete queries.');return this.rawResultMeta.affectedRows}};var Ae=class extends re{getCursor(){return new ot(this)}async getAll(){var e=await this.database.driver.getConnection();return new Promise((t,r)=>{e.query("SELECT * FROM "+this.name,(i,s)=>{if(i)return r(i);t(s)})})}async get(e){var t=await this.database.driver.getConnection(),r=this.getPrimaryKeyColumns();if(r.length!==1)throw new Error("Cannot find records by primary key on a table with zero or multiple primary keys.");return new Promise((i,s)=>{t.query("SELECT * FROM "+this.name+" WHERE `"+r[0]+"` = ?",[e],(o,f)=>{if(o)return s(o);i(f[0])})})}async count(e="*"){var t=await this.database.driver.getConnection();return new Promise((r,i)=>{t.query("SELECT COUNT("+e+") AS c FROM "+this.name,(s,o)=>{if(s)return i(s);r(o[0].c)})})}async addAll(e,t=[],r=null){if(e.length){var i={};t.length||(y(e[0])?t=Object.keys(e[0]):t=Object.keys(this.def.schema.columns));var s=await this.database.driver.getConnection();return new Promise((o,f)=>{var a="INSERT INTO `"+this.name+"`\r\n"+(t.length?"(`"+t.join("`, `")+"`)\r\n":"");a+=`VALUES\r
`+e.map(h=>ii(Object.values(h))).join(`,\r
`)+`\r
`,r&&(r(i),a+=" ON DUPLICATE KEY UPDATE "+ni(i)),s.query(a,(h,u)=>{if(h)return f(h);o(new ge(this,u,t,e,i))})})}}async add(e){var t=await this.database.driver.getConnection();return new Promise((r,i)=>{var s="INSERT INTO `"+this.name+"`\r\n(`"+Object.keys(e).join("`, `")+"`)\r\n";s+=`VALUES\r
`+ii(Object.values(e)),t.query(s,(o,f)=>{if(o)return i(o);r(new ge(this,f,Object.keys(e),Object.values(e)))})})}async putAll(e){return await Promise.all(e.map(t=>this.put(t))),new ge(this,{},Object.keys(e[0]),e)}async put(e){var t=await this.database.driver.getConnection();return new Promise((r,i)=>{var s="INSERT INTO `"+this.name+"`\r\n"+mi(e);t.query(s,(o,f)=>{if(o)return i(o);r(new ge(this,f,Object.keys(e),Object.values(e)))})})}async deleteAll(e=[]){var t=await this.database.driver.getConnection();return new Promise((r,i)=>{var s="DELETE FROM `"+this.name+"`"+(e.length?" WHERE id in ("+e.join(", ")+")":"");t.query(s,(o,f)=>{if(o)return i(o);r(new $e(this,f))})})}async delete(e){var t=await this.database.driver.getConnection(),r=this.getPrimaryKeyColumns();if(r.length!==1)throw new Error("Cannot delete records by primary key on a table with zero or multiple primary keys.");return new Promise((i,s)=>{var o="DELETE FROM `"+this.name+"` WHERE `"+r[0]+"` = ?";t.query(o,[e],(f,a)=>{if(f)return s(f);i(new $e(this,a))})})}};var si=n=>{if(n instanceof Date)try{return"'"+n.toISOString().split(".")[0]+"'"}catch{return"NULL"}return I(n)?n:U(n)?"NULL":"'"+n+"'"},ni=n=>Object.keys(n).map(e=>"`"+e+"` = "+si(n[e])).join(", "),ii=n=>"("+n.map(si).join(", ")+")",mi=n=>{var e=ni(n);return"SET "+e+" ON DUPLICATE KEY UPDATE "+e};var Ke=class extends te{async tables(){var e=await this.driver.getConnection();return new Promise((t,r)=>{e.query(`SHOW TABLES FROM ${this.name}`,(i,s)=>{if(i)return r(i);t(s.map(o=>o["Tables_in_"+this.name]))})})}async table(e,t={}){return new Ae(this,e,{schema:this.getTableSchema(e)},t)}async createTable(e,t,r={}){var i=[],s=this.diffTableSchema({},t);v(s,(a,h)=>{a==="primaryKey"?h.add&&i.push(this.toSql[a](h.add,h.add)):a!=="renameTo"&&v(h.add,(u,c)=>{i.push(this.toSql[a](u,c))})});var o=`CREATE TABLE ${r.ifNotExists?"IF NOT EXISTS ":""}\`${e}\` (`;o+=`\r
	`+Object.values(i).join(`,\r
	`)+`\r
`,o+=") ENGINE="+(t.engine||"InnoDB")+";";var f=await this.driver.getConnection();return await new Promise((a,h)=>{f.query(o,(u,c)=>{if(u)return h(u);this.setTableSchema(e,t),a(new Ae(this,e,{schema:this.getTableSchema(e)}))})})}async alterTable(e,t,r={}){var i=this.getTableSchema(e),s;if(R(t))s=this.cloneTableSchema(i),await t(s);else if(y(t))s=t;else throw new Error("Table/store modification expects only an object (new schema) or a function (callback that recieves existing schema).");var o=[],f=this.diffTableSchema(i,s,e);v(f,(u,c)=>{u==="renameTo"?o.push(this.toSql[u](c)):u==="renamedColumns"?v(c,(p,l)=>{o.push(this.toSql[u](p,l))}):u==="primaryKey"?c.add&&c.drop||c.alter?o.push(this.toSql[u](c.alter,c.add||c.alter,"alter")):c.add?o.push(this.toSql[u](c.add,c.add,"add")):c.drop&&o.push(this.toSql[u](c.drop,c.drop,"drop")):(v(c.add,(p,l)=>{o.push(this.toSql[u](p,l,"add"))}),v(c.alter,(p,l)=>{o.push(this.toSql[u](p,l.current,"alter"))}),v(c.drop,(p,l)=>{o.push(this.toSql[u](p,l,"drop"))}))});var a=`ALTER TABLE ${r.ifExists?"IF EXISTS ":""}\`${e}\``;a+=`\r
	`+Object.values(o).join(`,\r
	`)+`\r
`,a+=";";var h=await this.driver.getConnection();return await new Promise((u,c)=>{h.query(a,(p,l)=>{if(p)return c(p);this.setTableSchema(e,s),u(new Ae(this,e,{schema:this.getTableSchema(e)}))})})}async dropTable(e,t={}){var r=`DROP TABLE ${t.ifExists?"IF EXISTS ":""}\`${e}\``,i=await this.driver.getConnection();return await new Promise((s,o)=>{i.query(r,(f,a)=>{if(f)return o(f);this.unsetTableSchema(e),s(a)})})}toSql={renameTo:e=>"RENAME TO `"+e+"`",primaryKey:(e,t,r)=>{if(r==="drop")return"DROP PRIMARY KEY";var i="PRIMARY KEY (`"+_(t).join("`, `")+"`)";return r?(r==="alter"?"DROP PRIMARY KEY, ADD ":"ADD ")+i:i},columns:(e,t,r)=>{if(r==="drop")return"DROP COLUMN `"+e+"`";var i="`"+e+"` "+(t.type?t.type+(t.charlen?" ("+t.charlen+")":""):t.referencedEntity?"int":"varchar(255)")+(t.notNull?" NOT NULL":"")+(t.autoIncrement?" AUTO_INCREMENT":"");return"default"in t&&(i+=" DEFAULT "+(U(t.default)?"NULL":t.default==="CURRENT_TIMESTAMP"?t.default:'"'+t.default+'"')),t.onupdate==="CURRENT_TIMESTAMP"&&(i+=" ON UPDATE CURRENT_TIMESTAMP"),r?(r==="alter"?"ALTER COLUMN ":"ADD COLUMN ")+i+(t.before?" BEFORE "+t.before:t.after?" AFTER "+t.after:""):i},foreignKeys:(e,t,r)=>{if(r==="drop")return"DROP CONSTRAINT `"+e+"`";var i="CONSTRAINT `"+e+"` FOREIGN KEY (`"+t.columnName+"`) REFERENCES "+t.table+" (`"+t.column+"`)";return t.onupdate&&(i+=" ON UPDATE "+t.onupdate.replace(/_/g," ")),t.ondelete&&(i+=" ON DELETE "+t.ondelete.replace(/_/g," ")),r?(r==="alter"?"ALTER ":"ADD ")+i:i},indexes:(e,t,r)=>{if(r==="drop")return"DROP CONSTRAINT `"+e+"`";var i;return t.type==="fulltext"||t.type==="unique"?i=(t.type==="fulltext"?"FULLTEXT":"UNIQUE KEY")+" `"+e+"` (`"+_(t.keyPath).join("`, `")+"`)":i="INDEX `"+e+"` (`"+_(t.keyPath).join("`, `")+"`)",r?(r==="alter"?"ALTER ":"ADD ")+i:i},jsonColumns:(e,t,r)=>{if(r==="drop")return"DROP CONSTRAINT `"+e+"`";var i="CONSTRAINT `"+e+"` CHECK(JSON_VALID("+t+"))";return r?(r==="alter"?"ALTER ":"ADD ")+i:i},renamedColumns:(e,t)=>"RENAME COLUMN `"+e+"` TO `"+t+"`"}};var ht=class extends Z{constructor(e,t){super(),this.name="sql",this.sqlClient=e,this.params=t}static connect(e,t){return new this(e,t)}async getConnection(){if(!this.conn){var e=(await import(this.sqlClient)).createConnection({host:this.params.host,user:this.params.user,password:this.params.password});this.conn=new Promise((r,i)=>{e.connect(s=>{if(s)return i(s);e.query("SELECT database() AS default_db",(o,f)=>{if(o)return i(o);var a=(f[0]||{}).default_db;a&&(this.defaultDB=a),r(e)})})})}return this.conn}async setDefaultDB(e,t=this.defaultDBParams){var r=await this.getConnection();return new Promise((i,s)=>{r.query("USE "+e,o=>{if(o)return s(o);i(super.setDefaultDB(e,t))})})}async databases(e=null,t={},r=!1){var i=await this.getConnection(),s=await new Promise((o,f)=>{i.query("SHOW DATABASES",(a,h)=>{if(a)return f(a);if(!r){var u=["information_schema","mysql","performance_schema","sys"];h=h.filter(c=>!u.includes(c.Database))}o(h.map(c=>({name:c.Database})))})});return this.matchDatabaseList(s,e,t)}async database(e=this.defaultDB,t=this.defaultDBParams){var r=await this.databases();return r.filter(i=>i.name=e&&i.version===t.version).length,await this.setDefaultDB(e,t),new Ke(this,e,{},t)}async createDatabase(e,t=this.defaultDBParams){if(t.version&&!I(t.version))throw new Error("Database version (params.version) must be numeric.");var r=await this.getConnection();return new Promise((i,s)=>{r.query(`CREATE DATABASE${t.ifNotExists?" IF NOT EXISTS":""} ${e}`,o=>{if(o)return s(o);this.setDatabaseSchema(e,{}),this.setDefaultDB(e,t).then(()=>{i(new Ke(this,e,{},t))})})})}async dropDatabase(e,t={}){var r=await this.getConnection();return new Promise((i,s)=>{r.query(`DROP DATABASE${t.ifExists?" IF EXISTS":""} ${e}`,o=>{if(o)return s(o);this.unsetDatabaseSchema(e),i(!0)})})}async query(e,t=[],r={}){var i=await this.getConnection();r={...r},r.vars=t,r.dbDriver=this;var s=ri.parse(e,null,r).stringify({interpreted:!0});return new Promise((o,f)=>{i.query(s,(a,h)=>{if(a)return f(a);o(h)})})}};self.webqit||(self.webqit={});self.webqit.ObjectiveSQL={ODB:He,IDB:Ve,SQL:ht};})();
//# sourceMappingURL=main.js.map
