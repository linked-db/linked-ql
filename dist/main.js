(()=>{var ka=Object.defineProperty;var Ce=(u,e)=>{for(var r in e)ka(u,r,{get:e[r],enumerable:!0})};var ua={};Ce(ua,{CTE:()=>ht,CTEItem:()=>gt,CTEItemAlias:()=>xt,PGCycleClause:()=>dt,PGSearchClause:()=>_t});function fe(u){return!Array.isArray(u)&&typeof u=="object"&&u}function oe(u,e,r=!1,s=null){if(Array.isArray(u)&&Array.isArray(e))return u.length===e.length&&(e=e.slice(0).sort())&&u.slice(0).sort().every((t,a)=>oe(t,e[a],r,s));if(typeof u?.jsonfy=="function"&&(u=u.jsonfy()),typeof e?.jsonfy=="function"&&(e=e.jsonfy()),fe(u)&&fe(e)){let t={indexs_a:Object.keys(u),indexs_b:Object.keys(e)};if(s?.length){let a=[].concat(s);t.indexs_a=t.indexs_a.filter(n=>!a.includes(n)),t.indexs_b=t.indexs_b.filter(n=>!a.includes(n))}return t.indexs_a.length===t.indexs_b.length&&t.indexs_a.reduce((a,n)=>a&&oe(u[n],e[n],r,s),!0)}return typeof u=="string"&&typeof e=="string"&&r===!1?u.toLowerCase()===e.toLowerCase():u===e}function Aa(u){let e=u.replace(/([a-z0-9])([A-Z])/g,"$1_$2");return e=e.replace(/([A-Z])([A-Z][a-z])/g,"$1_$2"),e.toUpperCase()}var ia={};Ce(ia,{TOK_TYPES:()=>nt,aggrFunctionNames:()=>Ja,dataTypes:()=>$a,functionNames:()=>ja,keywords:()=>Ua,operators:()=>mt,statements:()=>Pa});var nt={data_type:{type:"data_type",value:void 0,resolve(){return this}},identifier:{type:"identifier",value:void 0,delim:[void 0],resolve({dialect:u,mysqlAnsiQuotes:e}={}){return{...this,delim:this.delim.concat(u==="mysql"?e?['"',"`"]:["`"]:['"'])}}},keyword:{type:"keyword",value:void 0,resolve(){return this}},operator:{type:"operator",value:void 0,prec:void 0,assoc:void 0,resultType:void 0,resolve(){return this}},punctuation:{type:"punctuation",value:void 0,resolve(){return this}},string_literal:{type:"string_literal",value:void 0,delim:["'"],modifier:[void 0],resolve({dialect:u,mysqlAnsiQuotes:e}={}){return{...this,delim:this.delim.concat(u==="mysql"?e?[]:['"']:[/^(\$\$|\$[a-zA-Z_][a-zA-Z0-9_]*\$)$/]),modifier:this.modifier.concat(u==="mysql"?["N"]:["E"])}}},number_literal:{type:"number_literal",value:void 0,match({value:u}){return!!/^[+-]?(?:\d+(?:\.\d*)?|\.\d+)(?:[eE][+-]?\d+)?$/.test(u)}},null_literal:{type:"null_literal",value:void 0,resolve(){return this}},unknown_literal:{type:"unknown_literal",value:void 0,resolve(){return this}},bool_literal:{type:"bool_literal",value:void 0,resolve(){return this}},hex_literal:{type:"hex_literal",value:void 0,resolve(){return this}},bit_literal:{type:"bit_literal",value:void 0,resolve(){return this}},bind_var:{type:"bind_var",value:void 0,delim:[],resolve({dialect:u}={}){return{...this,delim:this.delim.concat(u==="mysql"?["?"]:["$"])}}},version_spec:{type:"version_spec",value:void 0,delim:[void 0,"'"],resolve(){return this}},user_var:{type:"user_var",value:void 0,delim:[void 0],resolve({dialect:u}={}){return{...this,delim:this.delim.concat(u==="mysql"?["'"]:[])}}},system_var:{type:"system_var",value:void 0,resolve(){return this}},brace_block:{type:"brace_block",value:void 0,resolve(){return this}},bracket_block:{type:"bracket_block",value:void 0,resolve(){return this}},parent_block:{type:"paren_block",value:void 0,resolve(){return this}},block_comment:{type:"block_comment",value:void 0,resolve(){return this}},line_comment:{type:"line_comment",value:void 0,delim:["--"],resolve({dialect:u}={}){return{...this,delim:this.delim.concat(u==="mysql"?["#"]:[])}}}},Pa={common:["ALTER","CREATE","DROP","SELECT","INSERT","UPSERT","UPDATE","MERGE","DELETE","BEGIN","COMMIT","ROLLBACK","RELEASE","DESCRIBE","EXPLAIN","USE"],postgres:["ANALYZE","CLUSTER","COMMENT ON","REFRESH","REINDEX","VACUUM"],mysql:["ANALYZE","FLUSH","LOCK","OPTIMIZE","RENAME","REPAIR","RESET","SET","SHOW","TRUNCATE","UNLOCK"]},Ua={common:["ALL","ON","NO","KEY","ANY","AS","BY","ASC","CASE","CAST","DEFAULT","DESC","DO","DISTINCT","ELSE","END","ESCAPE","EXISTS","FIRST","LAST","FOLLOWING","FOR","HAVING","FILTER","SHARE","UNIQUE","JOIN","SEPARATOR","SKIP","LOCKED","NOWAIT","OF","RECURSIVE","LIMIT","LOAD","NEXT","NOTHING","NULLS","OFFSET","ONLY","TIES","OVER","PARTITION","PRECEDING","RANGE","RETURNING","ROW","ROWS","INCLUDE","EXCLUDE","SET","SOME","THEN","USING","MATERIALIZED","MODE","TEMPORARY","MATCH","PARTIAL","SIMPLE","WITHIN","BOTH","CHECK","PRIMARY","FOREIGN","CONSTRAINT","REFERENCES","INHERITS","DATABASE","TABLE","COLUMN","INDEX","SEQUENCE","TRIGGER","VIEW","SAVEPOINT","VALUES","WHEN","WHERE","WINDOW","WITH","WITHOUT","TO","TABLESPACE","INTO","FROM","GROUP","ORDER","PARTITION","BREADTH","DEPTH","GENERATED","ALWAYS","INNER","LEFT","RIGHT","OUTER","FULL","CROSS","NATURAL","NO OTHERS","NO INHERIT","ROLLUP","UNBOUNDED","CURRENT ROW","GROUPS","IGNORE","RESPECT","CHARACTER SET","NO ACTION","SET NULL","SET DEFAULT","RESTRICT","CASCADE","STORED","GIST","SCHEMA"],postgres:["ARRAY","GROUPING SETS","CUBE","TABLESAMPLE","REPEATABLE","SEARCH","LATERAL","ORDINALITY","OVERLAPS","SIMILAR","BERNOULLI","SYSTEM","UNLOGGED","PERFORM","CURRENT OF","TYPE","EXTENSION","IMMUTABLE","STABLE","VOLATILE","CYCLE","CONFLICT","TEMP","TIME ZONE","FETCH","LOCAL","IDENTITY","DEFERRABLE","INITIALLY","DEFERRED","IMMEDIATE","AUTHORIZATION","CURRENT_ROLE","CURRENT_USER","SESSION_USER"],mysql:["LOCK","RENAME","REPLACE","SHOW","UNLOCK","VIRTUAL","VISIBLE","INVISIBLE","HIGH_PRIORITY","CACHE","SQL_CACHE","SQL_NO_CACHE","STRAIGHT_JOIN","COMMENT","DATABASES","TABLES","COLUMNS","PROCEDURE","FUNCTION","AUTO_INCREMENT","CHARACTER SET","ENGINE","VALUE","DUPLICATE"]},ja={common:["NOW","CURRENT_DATE","CURRENT_TIME","CURRENT_TIMESTAMP","IF","NULLIF","IFNULL","COALESCE","GREATEST","LEAST","CONCAT","GROUPING","CONCAT_WS","FORMAT","UNNEST","MD5","SHA1","ST_ASTEXT","ST_ASGEOJSON","ST_GEOMFROMTEXT","ST_WITHIN","ST_CONTAINS","ST_INTERSECTS","ST_DISTANCE","ST_BUFFER"],postgres:["MAKE_DATE","MAKE_TIME","MAKE_TIMESTAMP","TO_JSON","TO_JSONB","JSON_TYPEOF","JSONB_TYPEOF","JSON_BUILD_ARRAY","JSONB_BUILD_ARRAY","JSON_BUILD_OBJECT","JSONB_BUILD_OBJECT","JSON_POPULATE_RECORD","JSONB_POPULATE_RECORD","JSON_PATH_QUERY","JSON_PATH_EXISTS"],mysql:["CURDATE","CURTIME","SYSDATE","STR_TO_DATE","MAKEDATE","MAKETIME","JSON_ARRAY","JSON_OBJECT","JSON_EXTRACT","JSON_UNQUOTE","JSON_SET","JSON_INSERT","JSON_REPLACE","JSON_REMOVE","JSON_SEARCH","JSON_CONTAINS","JSON_CONTAINS_PATH","JSON_KEYS","JSON_ARRAY_APPEND","JSON_ARRAY_INSERT","JSON_DEPTH","JSON_LENGTH","JSON_MERGE_PRESERVE","JSON_MERGE_PATCH","JSON_PRETTY","JSON_STORAGE_FREE"]},Ja={common:["COUNT","SUM","AVG","MIN","MAX","COVAR_POP","COVAR_SAMP","CORR","ROW_NUMBER","BIT_AND","BIT_OR","STDDEV_POP","STDDEV_SAMP","VAR_POP","VAR_SAMP","VARIANCE","STD","LEAD","LAG","NTILE","FIRST_VALUE","LAST_VALUE"],postgres:["ARRAY_AGG","STRING_AGG","REGR_SLOPE","PERCENTILE_CONT","PERCENTILE_DISC","MODE","RANK","DENSE_RANK","EVERY","BOOL_AND","BOOL_OR","JSON_AGG","JSON_OBJECT_AGG","JSONB_OBJECT_AGG","XMLAGG"],mysql:["GROUP_CONCAT","BIT_XOR","JSON_ARRAYAGG","JSON_OBJECTAGG"]},$a={common:["SMALLINT","INTEGER","INT","BIGINT","DECIMAL","DEC","NUMERIC","REAL","FLOAT","DATE","TIME","TIMESTAMP","INTERVAL","CHAR","CHARACTER","VARCHAR","TEXT","BINARY","VARBINARY","BOOLEAN","JSON","GEOMETRY","POINT","LINESTRING","POLYGON","DOUBLE PRECISION","CHARACTER VARYING","BYTEA","ENUM"],postgres:["SERIAL","BIGSERIAL","MONEY","BIT","CIDR","INET","MACADDR","MACADDR8","TIMESTAMPTZ","TIMETZ","TSVECTOR","TSQUERY","UUID","XML","INT4RANGE","INT8RANGE","NUMRANGE","TSRANGE","TSTZRANGE","DATERANGE","BOX","PATH","CIRCLE","LINE","LSEG","POLYGON","OID","BIT VARYING","JSONB","REGCLASS"],mysql:["TINYINT","MEDIUMINT","BIT","YEAR","DATETIME","TINYTEXT","QUERY","MEDIUMTEXT","LONGTEXT","TINYBLOB","BLOB","MEDIUMBLOB","LONGBLOB","GEOMETRYCOLLECTION","MULTIPOINT","MULTILINESTRING","MULTIPOLYGON","BOOL"]},mt={common:[["<~",{prec:90,assoc:"left",resultType:":right"}],["~>",{prec:90,assoc:"right",resultType:":right"}],["BETWEEN",{prec:85,assoc:"left",resultType:"boolean"}],["NOT",{prec:80,assoc:"right",resultType:"boolean"}],["*",{prec:70,assoc:"left",resultType:"number"}],["/",{prec:70,assoc:"left",resultType:"number"}],["%",{prec:70,assoc:"left",resultType:"number"}],["+",{prec:60,assoc:"left",resultType:"number"}],["-",{prec:60,assoc:"left",resultType:"number"}],["&",{prec:60,assoc:"left",resultType:"number"}],["|",{prec:60,assoc:"left",resultType:"number"}],["<<",{prec:60,assoc:"left",resultType:"number"}],[">>",{prec:60,assoc:"left",resultType:"number"}],["=",{prec:50,assoc:"left",resultType:"boolean"}],["!=",{prec:50,assoc:"left",resultType:"boolean"}],["<>",{prec:50,assoc:"left",resultType:"boolean"}],["<",{prec:50,assoc:"left",resultType:"boolean"}],["<=",{prec:50,assoc:"left",resultType:"boolean"}],[">",{prec:50,assoc:"left",resultType:"boolean"}],[">=",{prec:50,assoc:"left",resultType:"boolean"}],["IS",{prec:50,assoc:"left",resultType:"boolean"}],["IS NOT",{prec:50,assoc:"left",resultType:"boolean"}],["DISTINCT FROM",{prec:50,assoc:"left",resultType:"boolean"}],["IN",{prec:50,assoc:"left",resultType:"boolean"}],["LIKE",{prec:50,assoc:"left",resultType:"boolean"}],["AND",{prec:40,assoc:"left",resultType:"boolean"}],["OR",{prec:30,assoc:"left",resultType:"boolean"}],["INTERSECT",{prec:20,assoc:"left",resultType:"set",isSetOp:!0}],["UNION",{prec:10,assoc:"left",resultType:"set",isSetOp:!0}],["EXCEPT",{prec:10,assoc:"left",resultType:"set",isSetOp:!0}]],postgres:[["COLLATE",{prec:83,assoc:"left",resultType:"string"}],["||",{prec:60,assoc:"left",resultType:"string"}],["::",{prec:100,assoc:"left",resultType:"casted"}],["AT",{prec:95,assoc:"left",resultType:"timestamptz"}],["^",{prec:90,assoc:"left",resultType:"number"}],["#",{prec:60,assoc:"left",resultType:"number"}],["->",{prec:80,assoc:"left",resultType:"json"}],["->>",{prec:80,assoc:"left",resultType:"text"}],["#>",{prec:80,assoc:"left",resultType:"json"}],["#>>",{prec:80,assoc:"left",resultType:"text"}],["@>",{prec:80,assoc:"left",resultType:"boolean"}],["<@",{prec:80,assoc:"left",resultType:"boolean"}],["?",{prec:80,assoc:"left",resultType:"boolean"}],["?|",{prec:80,assoc:"left",resultType:"boolean"}],["?&",{prec:80,assoc:"left",resultType:"boolean"}],["-@",{prec:80,assoc:"left",resultType:"boolean"}],["#-",{prec:80,assoc:"left",resultType:"json"}],["@?",{prec:80,assoc:"left",resultType:"boolean"}],["@@",{prec:80,assoc:"left",resultType:"boolean"}],["ILIKE",{prec:50,assoc:"left",resultType:"boolean"}],["~",{prec:50,assoc:"left",resultType:"boolean"}],["!~",{prec:50,assoc:"left",resultType:"boolean"}],["~*",{prec:50,assoc:"left",resultType:"boolean"}],["!~*",{prec:50,assoc:"left",resultType:"boolean"}],["SIMILAR TO",{prec:50,assoc:"left",resultType:"boolean"}],["&&",{prec:60,assoc:"left",resultType:"boolean"}],["<->",{prec:60,assoc:"left",resultType:"number"}],["@",{prec:60,assoc:"left",resultType:"geometry"}],["&<",{prec:60,assoc:"left",resultType:"boolean"}],["&>",{prec:60,assoc:"left",resultType:"boolean"}],["|-",{prec:60,assoc:"left",resultType:"boolean"}],["-|",{prec:60,assoc:"left",resultType:"boolean"}],["<<",{prec:60,assoc:"left",resultType:"boolean"}],[">>",{prec:60,assoc:"left",resultType:"boolean"}],["<<|",{prec:60,assoc:"left",resultType:"boolean"}],["|>>",{prec:60,assoc:"left",resultType:"boolean"}],["&<|",{prec:60,assoc:"left",resultType:"boolean"}],["|&>",{prec:60,assoc:"left",resultType:"boolean"}],["~=",{prec:50,assoc:"left",resultType:"boolean"}],["?#",{prec:60,assoc:"left",resultType:"boolean"}],["?-",{prec:60,assoc:"left",resultType:"boolean"}],["?-|",{prec:60,assoc:"left",resultType:"boolean"}],["?|",{prec:60,assoc:"left",resultType:"boolean"}],["?||",{prec:60,assoc:"left",resultType:"boolean"}],["#",{prec:60,assoc:"left",resultType:"number"}],["##",{prec:60,assoc:"left",resultType:"geometry"}],["@-@",{prec:60,assoc:"left",resultType:"number"}]],mysql:[["DIV",{prec:70,assoc:"left",resultType:"number"}],["MOD",{prec:70,assoc:"left",resultType:"number"}],["BINARY",{prec:90,assoc:"right",resultType:"binary"}],["^",{prec:80,assoc:"left",resultType:"number"}],["~",{prec:85,assoc:"right",resultType:"number"}],["<=>",{prec:50,assoc:"left",resultType:"boolean"}],["REGEXP",{prec:50,assoc:"left",resultType:"boolean"}],["RLIKE",{prec:50,assoc:"left",resultType:"boolean"}],["!",{prec:80,assoc:"right",resultType:"boolean"}],["XOR",{prec:40,assoc:"left",resultType:"boolean"}],["&&",{prec:40,assoc:"left",resultType:"boolean"}],["||",{prec:30,assoc:"left",resultType:"boolean"}],[":=",{prec:10,assoc:"right",resultType:":right"}],["SOUNDS LIKE",{prec:50,assoc:"left",resultType:"boolean"}]]};var ot=class{buffer="";cursor=0;line=1;column=1;mysqlBindingIndex=0;nestingContext=[];nextTokenEscape=0;next(e=1,r=!1){r&&(this.line++,this.column=0),this.column+=e,this.cursor+=e,this.nextTokenEscape===1?this.nextTokenEscape=2:this.nextTokenEscape===2&&(this.nextTokenEscape=0)}},it=class{#e;#r;#t=!1;#o=!1;#i=!1;#s=null;#a=[];#n;#l=[];constructor(e,{state:r,...s}={}){this.#e=e,this.#r=s}[Symbol.asyncIterator](){return this}get options(){return this.#r}get locked(){return this.#t}get started(){return this.#o}get done(){return this.#i&&!this.#l.length}previous(){return this.#a[this.#a.length-1]}current(){return this.#n}async next(){this.#u("next()"),this.#o=!0;let e,r=!1;return this.#l.length?(this.#p(this.#n),this.#n=this.#f(),e=this.#n):({value:e,done:r}=await this.#e.next(),this.#p(this.#n),this.#n=e,this.#i=r),this.#s!==null&&e?.type.endsWith("_block")&&e.value.savepoint(),{value:e,done:r}}async match(e,r=void 0){let[s,t,a]=typeof arguments[0]=="number"?arguments:[0,e,r],n=p=>p&&(Array.isArray(t)?t.includes(p.type):t===p.type)&&(a===void 0||(Array.isArray(a)?a.includes(p.value)||a.includes(void 0):a===p.value))&&p||void 0;if(s===1/0){let p=0,c;for(;c=await this.peek(p++);)if(n(c))return c;return}return n(s?await this.peek(s):this.current())}async peek(e=1){if(e===0)return this.#n;let r=e-this.#l.length;for(;r;){let t=await this.#e.next();if(t.done)break;this.#m(t.value),r--}return this.#l[e-1]}async eat(e=void 0,r=void 0){let s=e?await this.match(e,r):this.current();return s&&(await this.next())?.value,s}async expect(e,r=void 0){let s=await this.eat(e,r);if(!s)throw new Error(`Expected token: ${e}${r?` (${r})`:""}`);return s}#p(e){e?.type.endsWith("_block"),this.#s!==null?this.#a.push(e):this.#a=[e]}#f(){let e=this.#l.shift();return e?.type.endsWith("_block")&&(e.value.#t=!1),e}#c(){let e=this.#a.pop();return e?.type.endsWith("_block")&&e.value.restore(e.value.#s),e}#y(e){e?.type.endsWith("_block")&&(e.value.restore(e.value.#s),e.value.#t=!0),this.#l.unshift(e)}#m(e){e?.type.endsWith("_block")&&(e.value.#t=!0),this.#l.push(e)}#u(e){if(this.#t)throw new Error(`Can't execute ${e}; TokenStream is locked`)}savepoint(){this.#u("savepoint()");let e=this.#a.length;return this.#s===null&&(this.#s=e),e}savepointStatus(){return this.#s!==null?this.#a.length:null}restore(e){if(this.#u("restore()"),this.#s===null||typeof e!="number"||e>this.#a.length)throw new Error(`Invalid restore point ${e}${this.#s===null?". Not in savepoint mode":""}`);for(;e<this.#a.length;)this.#n&&this.#y(this.#n),this.#n=this.#c()}commit(e){if(this.#u("commit()"),e!==this.#s)return;let r;for(;e<this.#a.length&&(r=this.#c());)r.type.endsWith("_block")&&r.value.commit(r.value.#s);this.#s=null}static async create(e,{dialect:r="postgres",state:s=new ot,...t}={}){return Array.isArray(e)&&e.every(a=>typeof a=="object"&&a?.type)&&(e=e.slice())?new this(e[Symbol.iterator](),{dialect:r,...t}):(t.normalized||(t=Oa({dialect:r,...t,normalized:!0})),new this(await this.createIterator(e,{dialect:r,state:s,...t,extendedAPI:!0}),{dialect:r,...t}))}static toIterator(e){return typeof e[Symbol.asyncIterator]=="function"?typeof e.next=="function"?e:e[Symbol.asyncIterator]():typeof e[Symbol.iterator]=="function"&&typeof e!="string"&&!(e instanceof String)?typeof e.next=="function"?e:e[Symbol.iterator]():function*(){yield e+""}()}static async*createIterator(e,{dialect:r="postgres",state:s=new ot,...t}={}){let a=this.toIterator(e);if(!["postgres","mysql"].includes(r))throw new Error(`Unknown dialect: ${r}`);if(!(s instanceof ot))throw new Error("options.state must be an instance of TokenStreamState");t.normalized?t={dialect:r,...t}:t=Oa({dialect:r,...t,normalized:!0});let n={token:null,prevEmittedToken:null,nextTokenSpaceBefore:"",multiwordBuffer:[]},p=(l,y=!1)=>l?Ra(l,{options:t,state:s,localState:n},y):[],c={value:""};do{s.buffer+=c.value||"";let l;for(;l=s.buffer[s.cursor];){let y=s.buffer[s.cursor+1]===void 0&&!c.done,d=Ta.has(l),m=()=>{throw new SyntaxError(`Unexpected token: ${l} at line ${s.line}, column ${s.column}`)};if(n.token?.type==="hex_literal"||n.token?.type==="bit_literal"){(n.token.delim?l===n.token.delim:d)?(yield*p(n.token),n.token=null,d&&t.spaces&&(n.nextTokenSpaceBefore+=l)):(n.token?.type==="hex_literal"?/[0-9A-Fa-f]/.test(l)||m():/[01]/.test(l)||m(),n.token.value+=l),s.next();continue}if(n.token?.type==="version_spec"){let _=n.token.delim&&l===n.token.delim,S=_||d||l==="."||l===","||l===";"||l===")";if(S?(yield*p(n.token),n.token=null):(n.token.value&&(l==="="?["<",">"].includes(n.token.value)||m():l==="_"?/\d$/.test(n.token.value)||m():/\d/.test(l)||m()),n.token.value+=l),!S||_){s.next();continue}}if(d){let _=n.token?.type==="string_literal",S=n.token?.type==="identifier"&&n.token.delim,N=n.token?.type==="block_comment",E=n.token?.type==="line_comment";if(_||S||N||E&&!(l==="\r"||l===`
`))n.token.value+=l;else{let v=s.buffer[s.cursor-1];!Ta.has(v)&&n.token&&(yield*p(n.token),n.token=null),t.spaces&&(n.nextTokenSpaceBefore+=l)}l===`
`||l==="\r"?s.next(1,!0):s.next();continue}if(l==="\\"){if(y)break;let _=s.buffer[s.cursor+1],S=n.token?.type==="string_literal"&&(t.dialect==="mysql"?!t.mysqlNoBackslashEscapes:n.token.modifier==="E"),N=_===n.token?.delim||_==="\\"||_==="0"||_==="b"||_==="f"||_==="n"||_==="r"||_==="t"||_==="v"||_==="Z";if(S&&N){_={"\\":"\\",0:"\0",b:"\b",f:"\f",n:`
`,r:"\r",t:"	",v:"\v",Z:""}[_]||_,n.token.value+=_,s.next(2);continue}s.nextTokenEscape=1,s.next();continue}if(n.token?.type==="block_comment"||n.token?.type==="line_comment"||n.token?.type==="string_literal"||n.token?.type==="identifier"&&n.token.delim||n.token?.type==="user_var"&&n.token.delim){let _;if(n.token.type==="block_comment"){if(l==="*"){if(y)break;_=s.buffer[s.cursor+1]==="/"?2:0}}else if(l===n.token.delim){if(n.token.type==="identifier"||n.token.type==="string_literal"&&(t.dialect==="mysql"?t.mysqlNoBackslashEscapes:n.token.modifier!=="E")){if(y)break;if(s.buffer[s.cursor+1]===l){n.token.value+=l,s.next(2);continue}}_=1}else if(n.token.type==="string_literal"&&n.token.delim.startsWith("$")&&l==="$"){let S=s.cursor+1;s.buffer.slice(S-n.token.delim.length,S)===n.token.delim&&(n.token.value=n.token.value.slice(0,-n.token.delim.length+1),_=1)}if(_){yield*p(n.token),n.token=null,s.next(_);continue}n.token.value+=l,s.next();continue}if(s.nestingContext.length&&l==={"{":"}","[":"]","(":")"}[s.nestingContext[0]]){if(yield*p(n.token,!0),s.nestingContext.shift(),t.structured){s.next(),n.nestingEndTagSeen=!0;return}n.token=null}let f,x=0,g=0;if(t.dialect==="postgres"){if(n.token?.type==="pg_possible_dollar_delim"||l==="$"){if(n.token?.type==="pg_possible_dollar_delim"){if(l==="$"){let{type:S,value:N,delim:E,...v}=n.token;n.token={type:"string_literal",value:"",delim:`$${N}$`,...v}}else n.token.value+=l;s.next();continue}if(y)break;let _=s.buffer[s.cursor+1];/[0-9]/.test(_)?f={type:"bind_var"}:f={type:"pg_possible_dollar_delim",delim:l}}}else t.dialect==="mysql"&&(l==="?"&&(f={type:"bind_var"}),l==="#"&&(f={type:"line_comment",delim:l}),l==="`"&&(f={type:"identifier",delim:l}));if(l==="'"){let _=new RegExp(`(@)$|^\\W?(${t.dialect==="postgres"?"E|X|B":"N|X"})$`,"i"),S=s.buffer.slice(Math.max(s.cursor-2,0),s.cursor).match(_),N=S?.[1]||S?.[2];if(N==="@"&&n.prevEmittedToken?.type==="identifier"){if(y)break;let E=s.buffer[s.cursor+1];/[\^~=\d<>!]/.test(E)&&(f={type:"version_spec",delim:l},x=1)}if(!f)if(N&&(N!=="@"||t.dialect==="mysql")){let E=/^(E|N)/i.test(N)?"string_literal":N==="@"?"user_var":(N==="X"?"hex_":"bit_")+"literal";f={type:E,...E==="string_literal"?{modifier:N.toUpperCase()}:{},delim:l},x=N==="@"?1:N.length}else f={type:"string_literal",delim:l}}else l==='"'&&(f={type:t.dialect!=="mysql"||t.mysqlAnsiQuotes?"identifier":"string_literal",delim:l});if(l==="@"){if(y)break;let _=s.buffer[s.cursor+1];(n.token||n.prevEmittedToken)?.type==="identifier"&&/[\^~=\d<>!]/.test(_)?f={type:"version_spec"}:t.dialect==="mysql"&&(_==="@"?(f={type:"system_var"},g=1):/[a-zA-Z_$]/.test(_)&&(f={type:"user_var"}))}if(l==="/"||l==="-"){if(y)break;let _=s.buffer[s.cursor+1];l==="/"&&_==="*"?(f={type:"block_comment"},g=1):l==="-"&&_==="-"&&(f={type:"line_comment",delim:l+_},g=1)}if(f){n.token&&!x&&(yield*p(n.token)),n.token={type:f.type,value:"",...f,line:s.line,column:x?s.column-x:s.column},s.next(1+g);continue}if((l==="{"||l==="["||l==="(")&&(yield*p(n.token),n.token=null,s.nestingContext.unshift(l),t.structured)){s.next();let _={type:{"{":"brace_block","[":"bracket_block","(":"paren_block"}[l],value:await this[t.extendedAPI?"create":"createIterator"](a,{state:s,...t}),line:s.line,column:s.column};if(yield*p(_),t.extendedAPI)await _.value.peek(1/0);else for(;!(await _.value.next()).done;);continue}if(/[0-9]/.test(l)){if(n.token?.type!=="identifier"&&n.token?.type!=="bind_var"&&n.token?.type!=="version_spec"&&!n.token?.type.endsWith("_literal")&&!n.token?.type.endsWith("_var")){if(yield*p(n.token),l==="0"){if(y)break;let _=s.buffer[s.cursor+1]?.toUpperCase();if((_==="X"||_==="B")&&t.dialect==="mysql"){n.token={type:(_==="X"?"hex_":"bit_")+"literal",value:"",line:s.line,column:s.column},s.next(2);continue}}n.token={type:"number_literal",value:l,line:s.line,column:s.column},s.next();continue}}else if(/[a-zA-Z_]/.test(l)){if(n.token?.type!=="identifier"&&!n.token?.type.endsWith("_var")&&!(n.token?.type==="number_literal"&&/\d$/.test(n.token.value)&&/E/i.test(l))){n.token?.type==="number_literal"&&m(),yield*p(n.token),n.token={type:"identifier",value:l,line:s.line,column:s.column},s.next();continue}}else{let _="operator";if(l===";"||l===","||l===":"||l==="{"||l==="}"||l==="["||l==="]"||l==="("||l===")"){if(l===":"&&(s.nestingContext[0]!=="{"||s.nextTokenEscape)?_="operator":_="punctuation",t.dialect==="postgres"&&l===":"&&_==="operator"&&n.token?.type!=="operator"){let S=s.buffer[s.cursor-1];if(y)break;let N=s.buffer[s.cursor+1];S!==":"&&/[a-zA-Z_]/.test(N)&&t.PL_SQL!==!1&&(_="user_var",l="")}}else if(l===".")if(n.token?.type==="number_literal")n.token.value.includes(".")&&m(),_="number_literal";else{if(y)break;let S=s.buffer[s.cursor+1];/\d/.test(S)?_="number_literal":(_="punctuation",n.token?.type==="system_var"&&(_="system_var"))}else(l==="+"||l==="-")&&n.token?.type==="number_literal"&&/E$/i.test(n.token.value)&&(/\+|\-/.test(n.token.value)&&m(),_="number_literal");if(n.token?.type!==_||_==="punctuation"||_==="operator"&&!t.operators.classic.has(`${n.token.value}${l}`)){yield*p(n.token),n.token={type:_,value:l,line:s.line,column:s.column},s.next();continue}}n.token.value+=l,s.next()}if(c.done)break;s.buffer=s.buffer.slice(s.cursor),s.cursor=0}while(c=await a.next());if(n.token){if(n.token.type==="operator"&&n.token.value!=="*"||n.token.type==="number_literal"&&/E$/i.test(n.token.value)||n.token.type==="block_comment"||n.token.type==="pg_possible_dollar_delim"||["string_literal","hex_literal","bit_literal","identifier","version_spec","user_var"].includes(n.token.type)&&n.token.delim)throw new SyntaxError(`Unterminated ${n.token.type} at line ${s.line}, column ${s.column}`);yield*p(n.token,!0)}if(s.nestingContext.length&&!n.nestingEndTagSeen)throw new SyntaxError(`Unterminated nesting "${s.nestingContext[0]}" at line ${s.line}, column ${s.column}`)}},Ta=new Set([" ","\f",`
`,"\r","	","\v"]);function Oa(u){let e=(r,s,t,a)=>{t.split(" ").reduce((n,p)=>(n=n?`${n} ${p}`:p,r.set(n,a),n),s)};for(let r of["statements","functionNames","aggrFunctionNames","keywords","operators","dataTypes"]){let s=["statements","functionNames","aggrFunctionNames"].includes(r)?"keywords":r,t=u[s]||{classic:new Map,compound:new Map};for(let a of["common",u.dialect==="mysql"?"mysql":"postgres"]){let n=ia[r][a];for(let p of n){let[c,l]=Array.isArray(p)?[p[0],{...p[1],value:p[0]}]:[p,{value:p}];c.includes(" ")?e(t.compound,"",c,l):t.classic.set(c,l)}}u={...u,[s]:t}}return u}function Ra(u,{options:e,state:r,localState:s},t=!1){if(s.nextTokenSpaceBefore){let{type:p,...c}=u;u={type:p,spaceBefore:s.nextTokenSpaceBefore,...c},s.nextTokenSpaceBefore=""}if(u.type==="block_comment"||u.type==="line_comment")return Ba(u,{options:e});let a,n=!1;if(e.dialect==="mysql"&&u.type==="bind_var")a=[{...u,value:`${++r.mysqlBindingIndex}`}];else if(u.type==="operator"){let{line:p,column:c,...l}=u;a=[{...l,...e.operators.classic.get(u.value)||{},line:p,column:c}]}else u.type==="identifier"&&!u.delim&&(a=Fa(u,{options:e,state:r,localState:s},t),n=!0);return a||(a=[u]),a?.length?s.prevEmittedToken=a[0]:s.prevEmittedToken=u,!n&&a.length&&s.multiwordBuffer.length?s.multiwordBuffer.splice(0).concat(a):a}function Ba(u,{options:e}){return e.comments?(u.type==="block_comment"?u={...u,value:u.value.split(`
`).map(r=>r.replace(/^[ ]+\*[ ]+?/,"").trim()).join(`
`)}:u={...u,value:u.value.trim()},[u]):[]}function Fa(u,{options:e,state:r,localState:s},t=!1){let a,n=s.multiwordBuffer.length,p=(n?s.multiwordBuffer.map(g=>g.value).concat(u.value).join(" "):u.value).toUpperCase(),c=g=>{for(let _ of["keywords","operators","dataTypes"]){let S=e[_][g].get(p);if(S)return[_,S]}return[]},l=g=>{let{type:_,spaceBefore:S,line:N,column:E,...v}=u;return n&&(S=s.multiwordBuffer[0].spaceBefore,N=s.multiwordBuffer[0].line,E=s.multiwordBuffer[0].column),{type:f==="dataTypes"?"data_type":f.replace(/s$/,""),...S?{spaceBefore:S}:{},...v,...g,value:p,line:N,column:E}},y=g=>{let _=l(g);n?(a=[_],s.multiwordBuffer.splice(0),n=0):a=[_]},d=g=>{let _=l(g);s.multiwordBuffer.push(_),a=[]},m=!1,[f,x]=c("compound");if(x?.value===p)y(x),m=!0;else if(x){let[g,_]=c("classic");_&&g!==f&&([f,x]=[g,_]),t?y(x):d(x),m=!0}else[f,x]=c("classic"),x&&(y(x),m=!0);if(!m&&n){let g=s.multiwordBuffer.splice(0),_=Ra(u,{options:e,state:r,localState:s});return[...g,..._]}if(!a&&/^(TRUE|FALSE|NULL|UNKNOWN)$/i.test(u.value)){let{type:g,..._}=u;a=[{type:/UNKNOWN/.test(u.value)?"unknown_literal":/NULL/i.test(u.value)?"null_literal":"bool_literal",..._,value:u.value.toUpperCase()}]}return a}var o=Object.create(null);var h=class u{static get NODE_NAME(){return Aa(this.name)}get NODE_NAME(){return this.constructor.NODE_NAME}#e;get _ast(){return this.#e}#r;get options(){return this.#r||this.#t?.options||{dialect:"postgres"}}#t;get parentNode(){return this.#t}get statementNode(){return this.#t?.statementNode}get rootNode(){return this.#t?.rootNode||this}constructor(e={},r={}){this.#e=e,this.#r=r;for(let s of Object.values(this.#e))this._adoptNodes(...[].concat(s))}_keys(){return Object.keys(this.#e).filter(e=>this.#e[e]!==void 0)}_has(e,r=void 0,s=void 0){return e in this.#e?typeof r=="number"?typeof this.#e[e][r]<"u":r?this.#e[e].some(t=>t.identifiesAs?.(r,s)):!0:!1}_get(e,r=void 0,s=void 0){if(!(e in this.#e))return;if(typeof r<"u"&&!Array.isArray(this.#e[e]))throw new Error(`Can't use index in field "${e}"; not an array.`);let t=this.#e[e];return typeof r=="number"?t=t[r]:r&&(t=t.find(a=>a.identifiesAs?.(r,s))),t}_set(e,r,s=void 0,t=void 0){let a=arguments.length>2?r:void 0,n=arguments.length>2?s:r,p=typeof a<"u"?this._get(e,a,t):void 0;return p&&this._unadoptNodes(...[].concat(p)),typeof a<"u"?this.#e[e]=p?this.#e[e].reduce((c,l)=>l===p?c.concat(n):c.concat(l),[]):this.#e[e].concat(n):this.#e[e]=n,this._adoptNodes(...[].concat(n)),!0}_delete(e,r=void 0,s=void 0){if(!(e in this.#e))return!1;if(typeof r<"u"&&!Array.isArray(this.#e[e]))throw new Error(`Can't use index in field "${e}"; not an array.`);return typeof r<"u"?this.#e[e]=this.#e[e].reduce((t,a,n)=>(typeof r=="number"?n===r:a.identifiesAs?.(r,s))?(this._unadoptNodes(a),t):t.concat(a),[]):(this._unadoptNodes(...[].concat(this.#e[e])),this.#e[e]=Array.isArray(this.#e[e])?[]:void 0),!0}_add(e,...r){if(!Array.isArray(this.#e[e]))throw new Error(`Can't add on field "${e}"; not an array.`);return this._adoptNodes(...r),this.#e[e]=this.#e[e].concat(r),!0}_adoptNodes(...e){for(let r of e)if(r instanceof u){if(r.#t&&r.#t!==this){let s=`${this.NODE_NAME}`;throw new Error(`[${s}] Illegal node operation`)}r.#t=this}}_unadoptNodes(...e){for(let r of e)if(r instanceof u){if(r.#t!==this){let s=`${this.NODE_NAME}`;throw new Error(`[${s}] Illegal node operation`)}r.#t=null}}climbTree(e){if(this.#t)return e(this.#t,()=>this.#t.climbTree(e))}walkTree(e){let r=(s,t)=>{!(s instanceof u)&&!Array.isArray(s)||e(s,t)!==s||(Array.isArray(s)?s.map(r):s.statementNode!==s&&s.walkTree(e))};for(let[s,t]of Object.entries(this.#e))r(t,s)}containsNode(e){return e?this===e.parentNode||this.containsNode(e.parentNode):!1}identifiesAs(e,r=!1){if(typeof e>"u")return!1;if(typeof e?.jsonfy=="function")return oe(this.jsonfy({nodeNames:!1}),e.jsonfy({nodeNames:!1}),r)}static morphsTo(){return this}clone(e={},r=null,s=null){let t=this.jsonfy(e,r,s);return[this.constructor].concat(this.constructor.morphsTo()).reduce((p,c)=>p||c.fromJSON(t,{dialect:e.toDialect||this.options.dialect}),void 0)}deSugar(e,r={},s=null,t=null){return r={...r,deSugar:e},this.clone(r,s,t)}toDialect(e,r={},s=null,t=null){return r={...r,toDialect:e},this.clone(r,s,t)}static get syntaxRules(){return[]}static compileASTSchemaFromSyntaxRules({dialect:e="postgres"}={}){this._astSchemaCompileCache||(this._astSchemaCompileCache=new Map);let r=`${this.NODE_NAME}:${e}`;if(!this._astSchemaCompileCache.has(r)){let s,t=this.syntaxRules,a=[].concat(t);a.length===1&&Array.isArray(a[0].type)&&!a[0].as?s=a[0]:s=this._compileASTSchemaFromSyntaxRules(t,e,{trail:[this.NODE_NAME]}),this._astSchemaCompileCache.set(r,s)}return this._astSchemaCompileCache.get(r)}static _compileASTSchemaFromSyntaxRules(e,r="postgres",{trail:s=[],schemaSet:t=new Set([new Map]),assertionTrail:a={dependencies:new Set,optional:!1,assert:!1}}={}){let n=Array.isArray(e)?e:[e],p=new Set(a.dependencies),c=y=>new Set([...y].map(d=>new Map(d)));for(let[y,d]of n.entries()){if(d.dialect&&d.dialect!==r)continue;let{type:m,as:f,if:x=a.inference,value:g,arity:_,singletons:S,modifier:N,booleanfy:E,optional:v=a.optional,assert:w=a.assert,syntax:M,syntaxes:H,...L}=d,Y=s.concat(`${Array.isArray(e)?y:""}${f?`<${f}>`:""}`||[]),k=Y.join("."),J=va(L);if(J.length)throw new SyntaxError(`[${k}] Unsupported attributes in rule: "${J.join('", "')}".`);let K=typeof m=="string"&&m[0]===m[0].toLowerCase();if(f){if(!m)throw new SyntaxError(`[${k}] Field rules must have a "type" attribute of type string.`);if(M||H)throw new SyntaxError(`[${k}] Field rules ("${f}") can not have a "syntax" or "syntaxes" attribute.`);if(f==="."){if(!K)throw new SyntaxError(`[${k}] Terminal Node rules must be token-typed rules.`);if(v)throw new SyntaxError(`[${k}] Terminal Node rules can not be optional.`)}else if(N)throw new SyntaxError(`[${k}] Only Terminal Node rules can have a "modifier" attribute.`);if(K){if(![void 0,null].includes(_))throw new SyntaxError(`[${k}] Token rules can not be item-based.`);if(!nt[m])throw new SyntaxError(`[${k}] Unknown token type "${m}".`)}else{if(g)throw new SyntaxError(`[${k}] Only token rules can have a "value" attribute.`);for(let B of[].concat(m))if(!o[B])throw new SyntaxError(`[${k}] Unknown node type "${B}".`);if(![void 0,null].includes(_)){if(fe(_)){let B=Object.keys(_);if(B.some(j=>!["min","max","eager"].includes(j)||typeof _[j]!=(j==="eager"?"boolean":"number")))throw new SyntaxError(`Invalid arity object "{ ${B.join(", ")} }" for field "${f}". Only "min: <number>", "max: <number>" and "eager: <bool>" expected.`)}else if([].concat(_).some(B=>typeof B!="number"))throw new SyntaxError(`[${k}] Invalid arity value "${[].concat(_).join(", ")}" for field "${f}". Number(s) expected.`)}}let $={rulePath:k,type:m};g&&($.value=g),N&&($.modifier=N),E&&($.booleanfy=E),[void 0,null].includes(_)||($.arity=_),S&&($.singletons=S),v&&($.optional=!0),w&&($.assert=w),x&&($.if=x),v&&a.dependencies.size&&($.dependencies=Array.from(a.dependencies));for(let B of t)B.set(f,$);f!=="."&&v&&!d.optional&&p.add(f)}if(M||H){let $={dependencies:p,optional:v,assert:w,inference:x};if(M){t=this._compileASTSchemaFromSyntaxRules(M,r,{trail:Y.concat("syntax"),schemaSet:t,assertionTrail:$});continue}let B=new Set;for(let[j,T]of H.entries()){let b=c(t),G=this._compileASTSchemaFromSyntaxRules(T,r,{trail:Y.concat("syntaxes",j),schemaSet:b,assertionTrail:$});for(let P of G)B.add(P)}t=B}}let l=Array.from(t);for(let y=0;y<l.length;y++){let d=l[y],m=Object.fromEntries(d);if(!d.size){t.delete(d);continue}for(let f=y+1;f<l.length;f++){let x=l[f],g=Object.fromEntries(x);oe(m,g,"cs","rulePath")&&t.delete(x)}}return t}static fromJSON(e,r={},s=null){let t=this.compileASTSchemaFromSyntaxRules(r);if(Array.isArray(t.type)){for(let d of t.type){let f=o[d].fromJSON(e,r,s);if(f)return f}return}if(e instanceof u){if(e instanceof this)return e;e=e.jsonfy()}if(!fe(e))return;let a=null;if("nodeName"in e){if(e.nodeName&&e.nodeName!==this.NODE_NAME)return;({nodeName:a,...e}=e)}let n,p=(d,m=null,f=!1)=>{if(!(!a&&r.assert!==!0&&!(r.assert instanceof RegExp&&r.assert.test(activeTrailStr)))){if(m&&(d=`[${m}] ${d}`),f){n=d;return}throw new Error(d)}},c=(d,m)=>{if(d.value!==void 0){let f=d.booleanfy?[!0,!1]:d.value;return[].concat(f).includes(m.value)}return nt[d.type].match?.(m,r)!==!1},l=(d,m)=>{for(let f of[].concat(d.type))if(typeof f=="string"&&f[0]===f[0].toLowerCase()){if(c(d,{value:m})===!0)return m}else{let g=o[f].fromJSON(m,{...r,assert:!1});if(g)return g}},y=(d,m,f,x=!1)=>{if(f.dependencies?.length){for(let _ of f.dependencies)if(!(_ in d))return p(`Missing dependency field "${_}" required by "${m}"`,f.rulePath,x),!1}if(f.if&&!la(f.if,d,f.rulePath))return!0;if(![void 0,null].includes(f.arity)){if(e[m]===void 0)return f.optional?(d[m]=void 0,!0):(p(`Missing required field "${m}"`,f.rulePath,x),!1);if(!Array.isArray(e[m]))return p(`Field "${m}" must be an array`,f.rulePath,x),!1;if(f.arity!==1/0){let N=e[m].length;if(fe(f.arity)){if("min"in f.arity&&N<f.arity.min)return p(`A minimum of ${f.arity.min} argument(s) expected but got ${N}`,f.rulePath,x),!1;if("max"in f.arity&&N>f.arity.max)return p(`A maximum of ${f.arity.max} argument(s) expected but got ${N}`,f.rulePath,x),!1}else if(![].concat(f.arity).includes(N))return p(`Exactly ${[].concat(f.arity).join(" or ")} argument(s) expected but got ${N}`,f.rulePath,x),!1}let _=e[m].map(N=>l(f,N)).filter(N=>N!==void 0),S=_.length;if(e[m].length>S)return S?(p(`Failed to resolve some arguments for "${m}"`,f.rulePath,x),!1):(p(`Failed to resolve any argument for "${m}"`,f.rulePath,x),!1);if(f.singletons){let N=_.find((E,v)=>_.slice(v+1).some(w=>f.singletons==="BY_KEY"?w.identifiesAs?.(E):w instanceof E.constructor));if(N)return p(`Duplicate entry of type "${N.constructor.name}"`,f.rulePath,x),!1}return d[m]=_,!0}if(e[m]===void 0)return f.optional?(d[m]=f.booleanfy?!1:void 0,!0):(p(`Missing required field "${m}"`,f.rulePath,x),!1);let g=l(f,e[m]);return g===void 0?(p(`Failed to resolve field "${m}"`,f.rulePath,x),!1):(d[m]=g,!0)};e:for(let d of t instanceof Map?[t]:t){let m=Object.create(null),f=new Map(d),x=e;if(f.has(".")){let g=f.get("."),_=nt[g.type];if([void 0,null].includes(x.value))continue e;({value:m.value,...x}=x);for(let S of Object.keys(_))typeof _[S]!="function"&&S in x&&({[S]:m[S],...x}=x);if(c(g,m)===!1)continue e;f.delete(".")}for(let g of new Set(Object.keys(x).concat(...f.keys()))){if(!f.has(g)){if(e[g]===void 0)continue;continue e}let _=f.get(g);if(y(m,g,_,!0)===!1)continue e}return typeof s=="function"?s(m,r):new this(m,r)}p(`Failed to match any schema${n?`. ${n}`:""}`,this.NODE_NAME)}toJSON(){return this.jsonfy()}jsonfy(e={},r=null,s=null){let t=(a,n,p)=>{let c=(y=e,d=p)=>Array.isArray(n)?n.reduce((m,f,x)=>{let g=t(x,f,d);return g===void 0?m:m.concat(g)},[]):n instanceof u?n.jsonfy(y,d,s):n;if(n===void 0)return;let l=p?p.transform(n,c,a,e):c();if(l instanceof u)throw new Error('"jsonfy" transforms must return plain JSON objects.');return l};return{...e.nodeNames!==!1?{nodeName:this.NODE_NAME}:{},...Object.fromEntries(Object.entries(this.#e).reduce((a,[n,p])=>{let c=t(n,p,r);return c===void 0?a:[...a,[n,c]]},[]))}}static async toStream(e,r={}){let s=e instanceof it?e:await it.create(e,{structured:!0,spaces:!0,...r});return!s.current()&&!s.done&&await s.next(),s}static async parse(e,{left:r=void 0,minPrecedence:s=0,trail:t=[],...a}={}){let n=await this.toStream(e,a),p=n.savepoint(),c=this.syntaxRules,l,y;if((y=[].concat(c)).length===1&&Array.isArray(y[0].type)&&!y[0].as)y[0].expression?l=await this._parseAsExpression(n,y[0].type,{exprClass:y[0].expression,left:r,minPrecedence:s,trail:t.concat(this.NODE_NAME),...a}):l=await this._parseFromTypes(n,y[0].type,{left:r,minPrecedence:s,trail:t.concat(this.NODE_NAME),...a});else{let d=await this._parseFromRules(n,c,{left:r,minPrecedence:s,trail:t.concat(this.NODE_NAME),...a});d&&(l=new this(d,{...a,dialect:n.options.dialect}))}return l||n.restore(p),l}static async _parseAsExpression(e,r,{exprClass:s=1,left:t=void 0,minPrecedence:a,trail:n,...p}){if(t)throw new Error("TODO");for(t=await this._parseFromTypes(e,r,{minPrecedence:a,trail:n,...p});t;){let c=await e.match("operator");if(!c||c.prec<a||c.isSetOp&&s!==2)break;let l=await this._parseFromTypes(e,r,{left:t,minPrecedence:a,trail:n,...p});if(!l)return t;t=l}return t}static async _parseFromRules(e,r,{left:s,minPrecedence:t,trail:a,...n},p={}){let c=Array.isArray(r)?r:[r],l=0,y=t;for(let[d,m]of c.entries()){if(m.dialect&&m.dialect!==e.options.dialect){l++;continue}let{requiredSpacing:f,peek:x,type:g,value:_,syntax:S,syntaxes:N,as:E,if:v,arity:w,optionalParens:M,singletons:H,itemSeparator:L,optional:Y=!1,assert:k=!1,booleanfy:J,...K}=m,$=a.concat(`${Array.isArray(r)?d:""}${E?`<${E}>`:""}`||[]),B=$.join("."),j=va(K);if(j.length)throw new SyntaxError(`[${B}] Unsupported attributes in rule: "${j.join('", "')}".`);let T=typeof g=="string"&&g[0]===g[0].toLowerCase(),b=E&&!T&&c[d+1]?.type==="operator"||c[d+1]?.type==="punctuation"&&c[d+1]?.value===".",G=async()=>{if(!(Array.isArray(x)&&!await W(-1))){for(let R of[].concat(g))if(s instanceof o[R])return p[E]=s,!0;return!1}},P=()=>{let R=e.current();return f===!1&&!R?.spaceBefore||f===!0&&R?.spaceBefore||f===`
`&&/\n/.test(R?.spaceBefore)},W=async(R=0)=>R?await e.match(x[0]+R,...x.slice(1)):await e.match(...x),O=async()=>{let R;if((R=await e.match("operator"))&&R.prec<t)return;let D=await e.eat(g,g.endsWith("_block")?void 0:_);return D?.type==="operator"&&(y=D.prec+(D.assoc==="right"?0:1)),D},I=async(R,D)=>{if(Array.isArray(g))return await this._parseFromTypes(R,g,{minPrecedence:D,trail:$,...n});let ue=o[g];if(!ue)throw new SyntaxError(`[${B}] Unknown node type <${g}>.`);return await ue.parse(R,{minPrecedence:D,trail:$,...n})},q=(R,D,ue=!1,se=!1)=>{if(!(!k&&!se&&n.assert!==!0&&!(n.assert instanceof RegExp&&n.assert.test(B)))){if(ue){let le=R.current()||R.previous(),de=R.current()?ue===1?":":" near":" by";D+=le?`${de}${typeof le.value=="string"?` "${le.value}"`:""} (${le.type}) at <line ${le.line}, column ${le.column}>`:`${de} end of stream`}throw new SyntaxError(`[${B}] ${D}.`)}};if(g){if(s){if(!b||!await G())return;s=null;continue}else if(s===!1&&b){if(Y){s=null;continue}return}}if(v&&!la(v,p,B))continue;if(f!==void 0&&!P()){q(e,"Required spacing mismatch",!0);return}if(Array.isArray(x)&&!await W()){q(e,"Peek failure",!0);return}if(E==="."){if(!g||!T)throw new SyntaxError(`[${B}] Terminal node rules must be token-typed rules.`);let R=await O();if(!R){q(e,`Token of type "${g}"${_?` and value "${_}"`:""} expected but got "${e.current()?.type}"`,!0);return}let D,ue,se,le,de,ra,Ne,Te;({type:D,line:ue,column:se,spaceBefore:le,prec:de,assoc:ra,resultType:Ne,...Te}=R),Object.assign(p,Te);continue}let A=e;if(typeof g=="string"&&g.endsWith("_block")){if(!(A=(await O())?.value)){if(Y)continue;q(e,`Token of type "${g}" expected but got "${e.current()?.type}"`,!0);return}y=0,!A.current()&&!A.done&&await A.next()}if(![void 0,null].includes(w)){if(!E)throw new SyntaxError(`[${B}] Multi-argument field rules must have a "as" attribute.`);if(!g)throw new SyntaxError(`[${B}] Multi-argument field rules must have a "type" attribute.`);if(T)throw new SyntaxError(`[${B}] Multi-argument field rules must be node-typed rules.`);let R,D=[],ue=y;if(L?.type==="operator"){let se=L.value&&(A.options.operators?.classic.get(L.value)||A.options.operators?.compound.get(L.value));se?.prec&&(ue=se?.prec+1)}for(;R=await I(A,ue);){if(H&&(H==="BY_KEY"?D.some(le=>le.identifiesAs?.(R)):D.some(le=>le instanceof R.constructor))){q(A,`Duplicate entry of type "${R.constructor.name}"`,!0,!0);return}if(D.push(R),fe(w)&&w.eager===!1&&D.length===w.max||L&&!await A.eat(L.type,L.value))break}if(w!==1/0){let se=D.length;if(!se&&Y)continue;let le=A.current(),de=le?`. Unexpected ${le.type}${typeof le.value=="string"?` "${le.value}"`:""}`:"";if(fe(w)){if("min"in w&&se<w.min){q(A,`A minimum of ${w.min} argument(s) expected but got ${se}${de}`,!0);return}if("max"in w&&se>w.max){q(A,`A maximum of ${w.max} argument(s) expected but got ${se}${de}`,!0);return}}else if(![].concat(w).includes(se)){q(A,`Exactly ${[].concat(w).join(" or ")} argument(s) expected but got ${se}${de}`,!0);return}}p[E]=D;continue}let F;if(S){let R=A.savepoint();F=await this._parseFromRules(A,S,{left:s,minPrecedence:y,trail:$.concat("syntax"),...n}),F===void 0?A.restore(R):s&&(s=null)}else if(N){for(let[R,D]of N.entries()){let ue=A.savepoint();if(F=await this._parseFromRules(A,D,{left:s,minPrecedence:y,trail:$.concat("syntaxes",R),...n}),F===void 0)A.restore(ue);else break}F!==void 0&&s&&(s=null)}else if(!(typeof g=="string"&&g.endsWith("_block")))F=T?(await O())?.value:await I(A,y);else if(!g)throw new SyntaxError(`[${B}] Rules must have a "type", "syntax" or "syntaxes" attribute.`);if(F===void 0&&!Y){q(A,g?"Unexpected token":null,1);return}if(typeof g=="string"&&g.endsWith("_block")&&!A.done&&A.current())return;E?(J&&(F=F!==void 0),p[E]=F):(S||N)&&Object.assign(p,F)}if(l!==c.length)return p}static async _parseFromTypes(e,r,{left:s,minPrecedence:t,trail:a,...n}){for(let p of r)if(typeof p=="string"&&p[0]===p[0].toLowerCase()){if(await e.match(p))return await e.eat()}else{let l=o[p];if(!l)throw new SyntaxError(`[${this.NODE_NAME}] Unknown node type "${p}".`);let y=await l.parse(e,{left:s,minPrecedence:t,trail:a,...n});if(y!==void 0)return y}}toString(){return this.stringify()}stringify(e={}){return this._stringifyFromRules(this.constructor.syntaxRules,{trail:[this.NODE_NAME],...e})}_stringifyFromRules(e,{trail:r=[],startingIndentLevel:s=0,autoLineBreakThreshold:t=60,...a},n=null){let p=()=>" ",c=m=>`
${(a.tabSpaces===4?"	":" ".repeat(a.tabSpaces||2)).repeat(m)}`,l=[],y=[].concat(e),d=0;for(let[m,f]of y.entries()){if(f.dialect&&f.dialect!==this.options.dialect)continue;let{requiredSpacing:x,type:g,value:_,booleanfy:S,syntax:N,syntaxes:E,as:v,if:w,arity:M,itemSeparator:H,optional:L=!1,autoSpacing:Y=x,optionalParens:k,autoIndent:J=!1,autoIndentAdjust:K=0}=f,$=r.concat(`${Array.isArray(e)?m:""}${v?`<${v}>`:""}`||[]),B=$.join("."),j=J;if(w&&!la(w,this.#e,this.NODE_NAME))continue;let T={startingIndentLevel:s+(J?1:0)+K,autoLineBreakThreshold:t,...a},b;if([void 0,null].includes(M))if(N)b=this._stringifyFromRules(N,{trail:$.concat("syntax"),...T},n);else if(E){let O=-1;for(let[I,q]of E.entries()){let A={score:0},F=this._stringifyFromRules(q,{trail:$.concat("syntaxes",I),...T},A);typeof F=="string"&&A.score>O&&(b=F,O=A.score)}n&&(n.score+=O)}else if(v){let O=this._get(v==="."?"value":v),I=_!=null;if(I&&S&&O===!0&&(O=_),I&&([].concat(_).includes(O)?n&&n.score++:O=void 0),O!==void 0){O instanceof u&&(O=O.stringify(T));let q=v==="."?{...f,...this.#e}:{...f,value:O};b=this._stringifyTerminal(q,T)}}else b=this._stringifyTerminal(f,T);else{let O=!1,I=this._get(v),q=I?.length||0;if(typeof J=="number"&&q<J&&(T.startingIndentLevel-=1),I&&((O=M===1/0)||(fe(M)?O=(!("min"in M)||q>=M.min)&&(!("max"in M)||q<=M.max):O=[].concat(M).includes(q))),O){let A=I.map(ue=>ue.stringify(T));j=J===!0||typeof J=="number"&&I.length>=J||Y===`
`;let F=A.join(" "),R=T.prettyPrint&&j&&(F.length>t||F.includes(`
`))?c(T.startingIndentLevel):p(),D=H?this._stringifyTerminal(H,T):"";/^\w+$/.test(D)?D=`${R}${D}${R}`:D===";"&&T.prettyPrint?D=`${D}
${R}`:D=`${D}${R}`,b=A.join(D)}}if(g==="paren_block"&&k&&!b?.trim()){if(k===!0||a.pruneOptionalParens){n&&n.score++,d++;continue}b=""}if(b===void 0){if(L){d++;continue}return}v&&n&&n.score++;let G=!1,P=b.length>t||b.includes(`
`);if(typeof g=="string"&&g.endsWith("_block")){let O=T.prettyPrint&&J&&P,I={brace_block:"{}",bracket_block:"[]",paren_block:"()"}[g];b=[I[0],O&&!/^\s/.test(b)?c(s+1):I[0]==="{"?p():"",b,O||/^\s/.test(b)?c(s):I[1]==="}"?p():"",I[1]].join("")}else T.prettyPrint&&j&&(l.length||P)&&b!==""&&(b=[c(s+(Y===`
`?0:1)),b].join(""),G=!0);let W=l[l.length-1];b!==""&&!G&&l.length&&!/\s$/.test(W)&&(Array.isArray(Y)?Y.includes(W):Y!==!1)&&(Y===`
`&&T.prettyPrint?l.push(c(s)):l.push(p())),l.push(b)}if(l.length||d===y.length)return l.join("")}_stringifyTerminal(e,r={}){switch(e.type){case"data_type":return this._stringifyDataType(e,r);case"identifier":return this._stringifyIdentifier(e,r);case"keyword":return this._stringifyKeyword(e,r);case"operator":return this._stringifyOperator(e,r);case"punctuation":return this._stringifyPunctuation(e,r);case"bind_var":return this._stringifyBindVar(e,r);case"version_spec":return`@${e.value}`}if(!Array.isArray(e.type)){if(e.type.endsWith("_literal"))return this._stringifyLiteral(e,r);if(e.type.endsWith("_var"))return this._stringifyVariable(e,r);if(e.type.endsWith("_comment"))return this._stringifyComment(e,r)}return String(e.value)}_stringifyIdentifier(e){let{value:r}=e,s=['"'];this.options.dialect==="mysql"&&(this.options.mysqlAnsiQuotes?s.push("`"):s.fill("`"));let t=s.includes(e.delim)?e.delim:s[0];return e.delim||/^\d/.test(r)||!/^(\*|[\w]+)$/.test(r)?`${t}${String(r||"").replace(new RegExp(t,"g"),t.repeat(2))}${t}`:r}_stringifyKeyword(e){return String(e.value)}_stringifyOperator(e){return e.value===":"&&this.#t?.isProperty?"\\:":String(e.value)}_stringifyPunctuation(e){return String(e.value)}_stringifyDataType(e){return String(e.value)}_stringifyLiteral(e,r){let{value:s}=e;switch(e.type){case"bit_literal":return this._stringifyBitLiteral(e,r);case"hex_literal":return this._stringifyHexLiteral(e,r);case"number_literal":return this._stringifyNumberLiteral(e,r);case"string_literal":return this._stringifyStringLiteral(e,r);case"bool_literal":return/^true$/i.test(s+"")?"TRUE":"FALSE";case"null_literal":return"NULL"}return String(s)}_stringifyBindVar(e){let{value:r}=e;return this.options.dialect==="mysql"?"?":`$${r}`}_stringifyBitLiteral(e){let{value:r}=e;return this.options.dialect==="mysql"?`0b${r}`:`B'${r}'`}_stringifyHexLiteral(e){let{value:r}=e;return this.options.dialect==="mysql"?`0x${r}`:`X'${r}'`}_stringifyNumberLiteral(e){let{value:r}=e;return String(r)}_stringifyStringLiteral(e){let{value:r}=e,s=["'"],t=null;this.options.dialect==="postgres"&&e.delim?.startsWith("$")?s.fill(e.delim):this.options.dialect==="mysql"&&!this.options.mysqlAnsiQuotes&&s.push('"');let a=s.includes(e.delim)?e.delim:s[0];if((this.options.dialect==="mysql"&&!this.options.mysqlNoBackslashEscapes||this.options.dialect==="postgres"&&e.modifier==="E")&&(t="\\"),a.length>1)return`${a}${r}${a}`;if(!t)t=a;else if(t==="\\"){let n={"\\":"\\\\","\0":"\\0","\b":"\\b","\f":"\\f","\n":"\\n","\r":"\\r","	":"\\t","\v":"\\v","":"\\Z"};r=r.replace(/[\\\0\b\r\n\t\x1A]/g,p=>n[p])}return r=`${a}${(r||"").replace(new RegExp(a,"g"),`${t}${a}`)}${a}`,e.modifier?`${e.modifier}${r}`:r}_stringifyVariable(e){let{type:r,value:s}=e;return this.options.dialect==="mysql"?`${r==="system_var"?"@@":"@"}${s}`:`${this.#t?.isProperty?"\\:":":"}${s}`}_stringifyComment(e,r={}){let{value:s}=e;if(e.type==="block_comment"){let n="  ".repeat(r.startingIndentLevel||0),p=s.trim().split(`
`).map(l=>l.trim());return[`${n}/**`,...p.map(l=>`${n} * ${l}`),`${n} */`].join(`
`)}let t=["--"];return this.options.dialect==="mysql"&&t.push("#"),`${t.includes(e.delim)?e.delim:t[0]} ${s}`}},va=u=>Object.keys(u).filter(e=>!qa.has(e)),qa=new Set(["dialect","autoSpacing","optionalParens","autoIndent","autoIndentAdjust","type","value","delim","modifier","syntax","syntaxes","as","booleanfy","if","arity","itemSeparator","singletons","keyed","requiredSpacing","peek","optional","assert"]),la=(u,e,r)=>[].concat(u).some(s=>{if(fe(s))return Object.entries(s).every(([a,n])=>{let p=!0;return a.startsWith("!")&&(a=a.slice(1),p=!1),(Array.isArray(n)?n.includes(e[a]):e[a]===n)===p});if(typeof s!="string")throw new SyntaxError(`[${r}] A specifier of type string or object expected in inferenceMatch but got ${s===null?"null":`type ${typeof s}`}`);let t=!0;return s.startsWith("!")&&(s=s.slice(1),t=!1),![void 0,null,!1].includes(e[s])===t});var dt=class extends h{static get syntaxRules(){return{dialect:"postgres",syntax:[{type:"keyword",value:"CYCLE"},{assert:!0,syntax:[{type:"ColumnRef1",as:"column_names",arity:{min:1},itemSeparator:{type:"punctuation",value:","},assert:!0,autoIndent:2},{type:"keyword",value:"SET"},{type:"ColumnRef1",as:"mark_col_name"},{optional:!0,syntax:[{type:"keyword",value:"TO"},{type:"Expr",as:"mark_value"},{type:"keyword",value:"DEFAULT"},{type:"Expr",as:"mark_default"}]},{type:"keyword",value:"USING"},{type:"ColumnRef1",as:"path_col_name"}]}]}}breadthOrDepthFirst(){return this._get("breadth_or_depth_first")}columnNames(){return this._get("column_names")}markColName(){return this._get("mark_col_name")}markValue(){return this._get("mark_value")}markDefault(){return this._get("mark_default")}pathColName(){return this._get("path_col_name")}};var _t=class extends h{static get syntaxRules(){return{dialect:"postgres",syntax:[{type:"keyword",value:"SEARCH"},{assert:!0,syntax:[{type:"keyword",as:"breadth_or_depth_first",value:["BREADTH","DEPTH"]},{type:"keyword",value:"FIRST"},{type:"keyword",value:"BY"},{type:"ColumnRef1",as:"column_names",arity:{min:1},itemSeparator:{type:"punctuation",value:","},assert:!0,autoIndent:2},{type:"keyword",value:"SET"},{type:"ColumnRef1",as:"seq_col_name"}]}]}}breadthOrDepthFirst(){return this._get("breadth_or_depth_first")}columnNames(){return this._get("column_names")}seqColName(){return this._get("seq_col_name")}};var X=u=>class extends u{#e;resultSchema(){return this.#e}static fromJSON(e,r={},s=null){if(!e||e instanceof h)return super.fromJSON(e,r,s);let{result_schema:t,...a}=e,n=super.fromJSON(a,r,s);if(n&&t){if(!(t instanceof h))throw new Error("Invalid Schema object passed at inputJson.result_schema");n.#e=t}return n}jsonfy(e={},r=null,s=null){let t=super.jsonfy(e,r,s);return this.#e&&e.resultSchemas!==!1&&(t={...t,result_schema:this.#e}),t}};var Ca=u=>class extends u{#e;originSchemas(){return this.#e}static fromJSON(e,r={},s=null){if(!e||e instanceof h)return super.fromJSON(e,r,s);let{origin_schemas:t,...a}=e,n=super.fromJSON(a,r,s);if(n&&t){if(!Array.isArray(t))throw new Error("Invalid list passed at inputJson.origin_schemas");n.#e=t}return n}jsonfy(e={},r=null,s=null){let t=super.jsonfy(e,r,s);return this.#e&&e.originSchemas!==!1&&(t={...t,origin_schemas:this.#e}),t}getOriginSchemas(e){let r=[],s=!1;for(let{resultSchema:t}of e.statementContext.artifacts.get("tableSchemas")){if(t instanceof o.JSONSchema){if(s)throw new Error("Multiple anonymous origin schemas detected");s=!0}r.push(t)}return r}};var Fe=class extends h{get statementNode(){return this}#e;get uuid(){return this.#e||(this.#e=`$query${(0|Math.random()*9e6).toString(36)}`),this.#e}static fromJSON(e,r={},s=null){if(e instanceof h)return super.fromJSON(e,r,s);let{uuid:t,...a}=e,n=super.fromJSON(a,r,s);return n&&(n.#e=t),n}jsonfy(e={},r=null,s=null){let t=super.jsonfy(e,r,s);return this.#e&&(t={uuid:this.#e,...t}),t}};var _e=class extends X(Ca(Fe)){renderBindings(e){if(!Array.isArray(e))throw new Error("Values must be an array");let r=[...this.queryBindings()];for(let s=0;s<e.length;s++){let t=r.filter(a=>a.offset()===s+1);if(!t.length)throw new Error(`No bindings exists at offset #${s}`);t.forEach(a=>a.value(e[s]))}}normalizeBindings(e=!1){let r=[...this.queryBindings()];if(!e)return r.forEach((a,n)=>a.offset(n+1)),r;let s=new Map,t=1;for(let a of r)if(a.offset()===0||!s.has(a.offset())){let n=t++;s.set(a.offset(),n),a.offset(n)}else a.offset(s.get(a.offset())).withDetail("redundant",!0);return r.filter(a=>!a.getDetail("redundant"))}};var ae=class u{#e;get cb(){return this.#e}#r=new Map;#t=new Map;#o;get parentTransformer(){return this.#o}#i;get statementNode(){return this.#i}get statementContext(){return this.#s?this:this.#o.statementContext}get rootContext(){return this.#o?.rootContext||this}#s;get isStatementContext(){return this.#s}#a=new Map([["outputSchemas",new Set],["tableSchemas",new Set],["selectorDimensions",new Map],["payloadDimensions",new Set]]);get artifacts(){return this.#a}constructor(e,r=null,s=null){this.#e=e,this.#o=r,this.#i=s,this.#s=!r||s!==r.statementNode}rand(e,{asSalt:r=!1,rands:s=this.#r}={}){return s.set(e,s.has(e)?s.get(e)+1:0),`${r?"~":"$"}${e}~${s.get(e)}`}hash(e,r,{hashes:s=this.#t}={}){return s.has(e)||s.set(e,this.rand(r)),s.get(e)}transform(e,r,s,t,a=this){let n=(p=t,c=a)=>(typeof p=="function"&&(c=new u(p,c,this.#i),p=t),a.statementNode!==this.#i?r(p,c):this.#e(e,(l=p)=>(typeof l=="function"&&(c=new u(l,c,this.#i),l=p),r(l,c)),s,p));return this.#o?this.#o.transform(e,n,s,t,a):n()}};var ht=class extends _e{static get _bodyTypes(){return["SelectStmt","TableStmt","InsertStmt","UpsertStmt","UpdateStmt","DeleteStmt","ValuesConstructor"]}static get syntaxRules(){return[{type:"keyword",value:"WITH"},{type:"keyword",as:"recursive",value:"RECURSIVE",booleanfy:!0,optional:!0},{type:"CTEItem",as:"declarations",arity:{min:1},itemSeparator:{type:"punctuation",value:","},assert:!0,autoIndent:2},{type:this._bodyTypes,as:"body",assert:!0,autoSpacing:`
`}]}recursive(){return this._get("recursive")}declarations(){return this._get("declarations")}body(){return this._get("body")}jsonfy(e={},r=null,s=null){if(!e.deSugar)return super.jsonfy(e,r,s);let t;return r=new ae((n,p,c)=>{if(c==="body"&&n.parentNode===this){let l=p();return t=l.result_schema,l}return p()},r,this),{...super.jsonfy(e,r,s),result_schema:t}}};var gt=class extends _e{static get syntaxRules(){return[{type:"CTEItemAlias",as:"alias",assert:!0},{type:"keyword",value:"AS"},{optional:!0,dialect:"postgres",syntaxes:[[{type:"operator",as:"not_materialized_kw",value:"NOT",booleanfy:!0},{type:"keyword",value:"MATERIALIZED",assert:!0}],{type:"keyword",as:"materialized",value:"MATERIALIZED",booleanfy:!0}]},{type:"paren_block",syntax:{type:["SelectStmt","InsertStmt","UpsertStmt","UpdateStmt","DeleteStmt","TableStmt","ValuesConstructor"],as:"expr",autoIndent:!0}},{type:"PGSearchClause",as:"search_clause",optional:!0},{type:"PGCycleClause",as:"cycle_clause",optional:!0}]}alias(){return this._get("alias")}notMaterializedKW(){return this._get("not_materialized_kw")}materialized(){return this._get("materialized")}expr(){return this._get("expr")}searchClause(){return this._get("search_clause")}cycleClause(){return this._get("cycle_clause")}jsonfy(e={},r=null,s=null){let t=super.jsonfy(e,r,s);if(e.deSugar){let a={nodeName:o.Identifier.NODE_NAME,value:t.alias.value,delim:t.alias.delim},n=t.expr.result_schema;if(n instanceof o.TableSchema?n=n.clone({renameTo:a}):n=o.TableSchema.fromJSON({name:a,entries:n?.entries().map(p=>p.jsonfy())||[]}),t.alias.columns?.length){if(t.alias.columns.length!==n.length)throw new SyntaxError(`[${this}] Number of column aliases must match number of result columns.`);n=n.clone({},new ae((p,c,l)=>typeof l=="number"&&p.parentNode===n?p instanceof o.ColumnSchema?p.jsonfy({renameTo:t.alias.columns[l]}):{...p.jsonfy(),nodeName:o.ColumnSchema.NODE_NAME,name:t.alias.columns[l]}:c()))}r.statementContext.artifacts.get("tableSchemas").add({type:"CTEItem",resultSchema:n}),t={...t,result_schema:n}}return t}};var ie=class u extends h{static get syntaxRules(){return{type:"identifier",as:"."}}static get syntaxPriority(){return-1}value(){return this._get("value")}identifiesAs(e,r=void 0){return e instanceof u?oe(this.value(),e.value(),r===void 0?this._has("delim")||e._has("delim"):r):typeof e=="string"?oe(this._get("value"),e,r===void 0?this._has("delim"):r):super.identifiesAs(e,r)}};var xt=class extends ie{static get syntaxRules(){let e={type:"punctuation",value:","};return[{...[].concat(super.syntaxRules)[0]},{type:"paren_block",syntax:{type:"Identifier",as:"columns",arity:{min:1},itemSeparator:e,assert:!0},if:"value",optional:!0,optionalParens:!0}]}columns(){return this._get("columns")}};var pa={};Ce(pa,{CheckConstraint:()=>kt,ColumnDefaultConstraint:()=>Dt,ColumnDiff:()=>Nt,ColumnExpressionConstraint:()=>It,ColumnFKConstraint:()=>Mt,ColumnIdent:()=>Lr,ColumnIdentityConstraint:()=>Ge,ColumnNullConstraint:()=>Lt,ColumnPKConstraint:()=>Pt,ColumnSchema:()=>Et,ColumnUKConstraint:()=>Ut,ConstraintSchema:()=>z,CreateSchemaStmt:()=>Gr,CreateTableStmt:()=>Wr,DDLStmt:()=>xe,DropSchemaStmt:()=>Yr,DropTableStmt:()=>Kr,FKDeleteRule:()=>At,FKMatchRule:()=>St,FKUpdateRule:()=>Tt,IndexDiff:()=>jr,IndexSchema:()=>Jr,MYColumnAutoIncrementModifier:()=>qe,MYColumnCommentModifier:()=>jt,MYColumnOnUpdateModifier:()=>Jt,MYColumnVisibilityModifier:()=>$t,PGIndexParamInclude:()=>Rt,PGIndexParamUsing:()=>vt,PGIndexParamWith:()=>Ct,PGIndexParameters:()=>Ot,PGTableEXConstraint:()=>Bt,PGTableEXConstraintItem:()=>bt,ReferentialAction:()=>wt,SchemaDiff:()=>$r,SchemaIdent:()=>Pr,SchemaSchema:()=>Br,TableDiff:()=>Fr,TableFKConstraint:()=>Ft,TableIdent:()=>Ur,TablePKConstraint:()=>qt,TableSchema:()=>qr,TableUKConstraint:()=>Gt});var C=class extends h{static get syntaxRules(){return[]}get length(){return(this._get("entries")||[]).length}[Symbol.iterator](){return(this._get("entries")||[])[Symbol.iterator]()}entries(){return(this._get("entries")||[]).slice(0)}delete(e){return this._delete("entries",e)}get(e){return this._get("entries",e)}set(e,r){return this._set("entries",e,r)}has(e){return this._has("entries",e)}add(...e){return this._add("entries",...e)}};var Ee=class extends C{};var Nt=class extends Ee{};var he=class u extends C{name(){return this._get("name")}identifiesAs(e,...r){return this.name()?.identifiesAs(e instanceof u?e.name():e,...r)}static fromJSON(e,r={},s=null){if(e instanceof h)return super.fromJSON(e,r,s);let{ddl_name:t,...a}=e,n=super.fromJSON(a,r,s);if(t&&n){let p=[o.SchemaIdent,o.TableIdent,o.ColumnIdent].reduce((c,l)=>c||l.fromJSON(t),null);n._set("ddl_name",p)}return n}jsonfy({renameTo:e,...r}={},s=null,t=null){let a=super.jsonfy(r,s,t);if(e){if(e instanceof h)throw new Error("options.renameTo must be a JSON value.");return a.name?.value&&!a.ddl_name&&(a={...a,ddl_name:a.name}),{...a,name:e}}return a}};var Et=class extends he{static get syntaxRules(){return[{type:["ColumnIdent","Identifier"],as:"name"},{type:"DataType",as:"data_type"},{type:["CheckConstraint","ColumnDefaultConstraint","ColumnExpressionConstraint","ColumnFKConstraint","ColumnIdentityConstraint","ColumnNullConstraint","ColumnPKConstraint","ColumnUKConstraint","MYColumnAutoIncrementModifier","MYColumnCommentModifier","MYColumnOnUpdateModifier","MYColumnVisibilityModifier"],as:"entries",arity:1/0,singletons:!0,optional:!0}]}dataType(){return this._get("data_type")}defaultConstraint(){for(let e of this)if(e instanceof o.ColumnDefaultConstraint)return e}expressionConstraint(){for(let e of this)if(e instanceof o.ColumnExpressionConstraint)return e}identityConstraint(){for(let e of this)if(e instanceof o.ColumnIdentityConstraint)return e}autoIncrementConstraint(){for(let e of this)if(e instanceof o.MYColumnAutoIncrementModifier)return e}nullConstraint(){for(let e of this)if(e instanceof o.ColumnNullConstraint)return e}pkConstraint(e=!1){for(let r of this)if(r instanceof o.ColumnPKConstraint)return r;if(e&&this.parentNode instanceof o.TableSchema){let r=this.parentNode.pkConstraint(!1),s=r?.columns()||[];if(s.length===1&&s[0].identifiesAs(this.name())){let{nodeName:t,columns:a,...n}=r.jsonfy(),p=o.ColumnPKConstraint.fromJSON(n);return this._adoptNodes(p),p}}}fkConstraint(e=!1){for(let r of this)if(r instanceof o.ColumnFKConstraint)return r;if(e&&this.parentNode instanceof o.TableSchema){let{nodeName:r,columns:s,...t}=this.parentNode.fkConstraints(!1).find(a=>{let n=a.columns();return n.length===1&&n[0].identifiesAs(this.name())})?.jsonfy()||{};if(r){let a=o.ColumnFKConstraint.fromJSON(t);return this._adoptNodes(a),a}}}ukConstraint(e=!1){for(let r of this)if(r instanceof o.ColumnUKConstraint)return r;if(e&&this.parentNode instanceof o.TableSchema){let{nodeName:r,columns:s,...t}=this.parentNode.ukConstraints(!1).find(a=>{let n=a.columns();return n.length===1&&n[0].identifiesAs(this.name())})?.jsonfy()||{};if(r){let a=o.ColumnUKConstraint.fromJSON(t);return this._adoptNodes(a),a}}}ckConstraint(e=!1){for(let r of this)if(r instanceof o.CheckConstraint)return r;if(e&&this.parentNode instanceof o.TableSchema){let r=this.parentNode.ckConstraints(!1).find(s=>{let t=s.columns();return t.length===1&&t[0].identifiesAs(this.name())});if(r=r?.clone())return this._adoptNodes(r),r}}jsonfy({normalized:e=!1,...r}={},s=null,t=null){let a=super.jsonfy(r,s,t);if(e){let n=[];for(let p of["pk","fk","uk","ck"]){let c=`${p}Constraint`;this[c]()||n.push(this[c](!0)?.jsonfy())}if((n=n.filter(p=>p)).length)return{...a,entries:a.entries.concat(n)}}return a}};var St=class extends h{static get syntaxRules(){return[{type:"keyword",value:"MATCH"},{type:"keyword",as:"value",value:["FULL","PARTIAL","SIMPLE"],assert:!0}]}value(){return this._get("value")}};var At=class extends h{static get syntaxRules(){return[{type:"keyword",value:"ON"},{type:"keyword",value:"DELETE"},{type:"ReferentialAction",as:"action",assert:!0}]}action(){return this._get("action")}};var Tt=class extends h{static get syntaxRules(){return[{type:"keyword",value:"ON"},{type:"keyword",value:"UPDATE"},{type:"ReferentialAction",as:"action",assert:!0}]}action(){return this._get("action")}};var Ot=class extends C{static get syntaxRules(){return[{type:["PGIndexParamInclude","PGIndexParamUsing","PGIndexParamWith"],as:"entries",arity:1/0,singletons:!0}]}};var Rt=class extends C{static get syntaxRules(){return[{type:"keyword",value:"INCLUDE"},{type:"paren_block",syntax:{type:"ColumnRef2",as:"entries",arity:{min:1},itemSeparator:{type:"punctuation",value:","}}}]}};var vt=class extends h{static get syntaxRules(){return[{type:"keyword",value:"USING"},{type:"keyword",value:"INDEX"},{type:"keyword",value:"TABLESPACE"},{type:"identifier",as:"."}]}};var Ct=class extends C{static get syntaxRules(){return[{type:"keyword",value:"WITH"},{type:"paren_block",syntax:{type:"ConfigAssignmentExprAlt2",as:"entries",arity:{min:1},itemSeparator:{type:"punctuation",value:","}}}]}};var z=class extends he{static buildSyntaxRules(e){return[{optional:!0,syntax:[{type:"keyword",value:"CONSTRAINT"},{type:"Identifier",as:"name",assert:!0}]},...e,{optional:!0,dialect:"postgres",syntaxes:[[{type:"operator",as:"pg_deferrable",value:"NOT"},{type:"keyword",value:"DEFERRABLE"}],{type:"keyword",as:"pg_deferrable",value:"DEFERRABLE"}]},{optional:!0,dialect:"postgres",syntax:[{type:"keyword",value:"INITIALLY"},{type:"keyword",as:"pg_deferred",value:["DEFERRED","IMMEDIATE"]}]}]}static get syntaxRules(){return{type:["TableFKConstraint","TablePKConstraint","TableUKConstraint","CheckConstraint","ColumnDefaultConstraint","ColumnExpressionConstraint","ColumnFKConstraint","ColumnIdentityConstraint","ColumnNullConstraint","ColumnPKConstraint","ColumnUKConstraint"]}}get isColumnLevel(){return this.parentNode instanceof o.ColumnSchema}pgDeferrable(){return this._get("pg_deferrable")}pgDeferred(){return this._get("pg_deferred")}};var bt=class extends z{static get syntaxRules(){return[{syntaxes:[{type:"ColumnRef2",as:"expr"},{type:"ParenExpr",as:"expr"}]},{optional:!0,syntax:[{type:"operator",value:"COLLATE"},{type:"string_literal",as:"collation",assert:!0}]},{optional:!0,syntax:[{type:"Identifier",as:"opclass"},{optional:!0,type:"paren_block",syntax:{type:"ConfigAssignmentExpr",as:"opclass_parameters",arity:{min:1},itemSeparator:{type:"punctuation",value:","},assert:!0}}]},{type:"keyword",value:["ASC","DESC"],as:"dir",optional:!0},{optional:!0,syntax:[{type:"keyword",value:"NULLS"},{type:"keyword",as:"nulls_spec",value:["FIRST","LAST"],assert:!0}]},{type:"keyword",value:"WITH"},{type:"operator",as:"operator"}]}expr(){return this._get("expr")}collation(){return this._get("collation")}opclass(){return this._get("opclass")}opclassParameters(){return this._get("opclass_parameters")}dir(){return this._get("dir")}nullsSpec(){return this._get("nulls_spec")}operator(){return this._get("operator")}};var wt=class extends h{static get syntaxRules(){return{syntaxes:[{type:"keyword",as:"value",value:["NO ACTION","RESTRICT","CASCADE"]},[{type:"keyword",as:"value",value:["SET NULL","SET DEFAULT"]},{optional:!0,dialect:"postgres",type:"paren_block",syntax:{type:"Identifier",as:"columns",arity:{min:1},itemSeparator:{type:"punctuation",value:","}}}]]}}value(){return this._get("value")}columns(){return this._get("columns")}};var kt=class extends z{static get syntaxRules(){return this.buildSyntaxRules([{type:"keyword",value:"CHECK"},{type:"paren_block",syntax:{type:"Expr",as:"expr",assert:!0},assert:!0},{type:"keyword",as:"no_inherit_kw",value:"NO INHERIT",optional:!0}])}expr(){return this._get("expr")}noInheritKW(){return this._get("no_inherit_kw")}columns(){let e=[];return this.expr()?.walkTree(r=>{if(r instanceof o.ColumnRef1)e.push(o.ColumnRef2.fromJSON({value:r.value()}));else return r}),e}};var Dt=class extends z{static get syntaxRules(){return this.buildSyntaxRules([{type:"keyword",value:"DEFAULT"},{type:"Expr",as:"expr",assert:!0,dialect:"postgres"},{type:["NumberLiteral","StringLiteral","NullLiteral","BoolLiteral","CallExpr","RowConstructor"],as:"expr",assert:!0,dialect:"mysql"}])}expr(){return this._get("expr")}};var It=class extends z{static get syntaxRules(){return this.buildSyntaxRules([{dialect:"postgres",syntax:[{type:"keyword",value:"GENERATED"},{type:"keyword",value:"ALWAYS"},{type:"keyword",value:"AS"},{type:"paren_block",syntax:{type:"Expr",as:"expr",assert:!0}},{type:"keyword",as:"stored",value:"STORED",assert:!0}]},{dialect:"mysql",syntax:[{optional:!0,syntax:[{type:"keyword",as:"my_generated_kw",value:"GENERATED",booleanfy:!0},{type:"keyword",value:"ALWAYS"}]},{type:"keyword",value:"AS"},{type:"paren_block",syntax:{type:"Expr",as:"expr",assert:!0}},{type:"keyword",as:"stored",value:["STORED","VIRTUAL"],optional:!0}]}])}myGeneratedKW(){return this._get("my_generated_kw")}expr(){return this._get("expr")}stored(){return this._get("stored")}};var{ColumnSchema:Ga,ColumnRef2:Ya}=o,Mt=class extends z{static get syntaxRules(){let e={type:"punctuation",value:","};return this.buildSyntaxRules([{type:"keyword",value:"REFERENCES"},{type:"TableRef2",as:"target_table",assert:!0},{dialect:"postgres",optional:!0,type:"paren_block",syntax:{type:"Identifier",as:"target_columns",arity:1,itemSeparator:e,singletons:"BY_KEY",assert:!0}},{dialect:"mysql",type:"paren_block",syntax:{type:"Identifier",as:"target_columns",arity:1,itemSeparator:e,singletons:"BY_KEY",assert:!0}},{type:["FKMatchRule","FKDeleteRule","FKUpdateRule"],as:"referential_rules",arity:1/0,singletons:!0}])}targetTable(){return this._get("target_table")}targetColumns(){return this._get("target_columns")}referentialRules(){return this._get("referential_rules")}columns(){return this.parentNode instanceof Ga?[Ya.fromJSON({value:this.parentNode.name().value()})]:[]}};var qe=class extends h{static get syntaxRules(){return{dialect:"mysql",syntax:{type:"keyword",as:".",value:"AUTO_INCREMENT"}}}jsonfy(e={},r=null,s=null){return(e.toDialect||this.options.dialect)==="postgres"?new Ge().jsonfy(e,r,s):super.jsonfy(e,r,s)}};var Ge=class extends z{static get syntaxRules(){return this.buildSyntaxRules([{type:"keyword",value:"GENERATED"},{syntaxes:[{type:"keyword",as:"always_kw",value:"ALWAYS",booleanfy:!0},{syntax:[{type:"keyword",as:"by_default_kw",value:"BY",booleanfy:!0},{type:"keyword",value:"DEFAULT",assert:!0}]}]},{optional:!0,syntax:[{type:"keyword",as:"as_identity_kw",value:"AS",booleanfy:!0},{type:"keyword",value:"IDENTITY",assert:!0}]}])}alwaysKW(){return this._get("always_kw")}byDefaultKW(){return this._get("by_default_kw")}asIdentityKW(){return this._get("as_identity_kw")}jsonfy(e={},r=null,s=null){return(e.toDialect||this.options.dialect)==="mysql"?new qe().jsonfy(e,r,s):super.jsonfy(e,r,s)}};var Lt=class extends z{static get syntaxRules(){return this.buildSyntaxRules([{syntaxes:[[{type:"operator",as:".",value:"NOT"},{type:"null_literal",value:"NULL"}],{type:"null_literal",as:".",value:"NULL"}]}])}value(){return this._get("value")}};var Pt=class extends z{static get syntaxRules(){return this.buildSyntaxRules([{type:"keyword",value:"PRIMARY"},{type:"keyword",as:".",value:"KEY",assert:!0},{type:"PGIndexParameters",as:"pg_index_parameters",optional:!0,dialect:"postgres"}])}primaryKW(){return this._get("primary_kw")}pgIndexParameters(){return this._get("pg_index_parameters")}columns(){return this.parentNode instanceof o.ColumnSchema?[o.ColumnRef2.fromJSON({value:this.parentNode.name().value()})]:[]}};var Ut=class extends z{static get syntaxRules(){return this.buildSyntaxRules([{type:"keyword",value:"UNIQUE"},{type:"keyword",as:"my_key_kw",value:["KEY","INDEX"],optional:!0,dialect:"mysql"},{optional:!0,dialect:"postgres",syntaxes:[[{type:"keyword",value:"NULLS"},{type:"operator",as:"pg_nulls_distinct",value:"NOT"},{type:"keyword",value:"DISTINCT",assert:!0}],[{type:"keyword",value:"NULLS"},{type:"keyword",as:"pg_nulls_distinct",value:"DISTINCT",assert:!0}]]},{type:"PGIndexParameters",as:"pg_index_parameters",optional:!0,dialect:"postgres"}])}myKeyKW(){return this._get("my_key_kw")}pgNullsDistinct(){return this._get("pg_nulls_distinct")}pgIndexParameters(){return this._get("pg_index_parameters")}columns(){let{ColumnSchema:e,ColumnRef2:r}=o;return this.parentNode instanceof e?[r.fromJSON({value:this.parentNode.name().value()})]:[]}};var jt=class extends h{static get syntaxRules(){return{dialect:"mysql",syntax:[{type:"keyword",value:"COMMENT"},{type:"string_literal",as:"."}]}}};var Jt=class extends h{static get syntaxRules(){return{dialect:"mysql",syntax:[{type:"keyword",value:"ON"},{type:"keyword",value:"UPDATE"},{type:"keyword",as:"."}]}}};var $t=class extends h{static get syntaxRules(){return{dialect:"mysql",syntaxes:[{type:"keyword",as:".",value:"VISIBLE"},{type:"keyword",as:".",value:"INVISIBLE"}]}}};var Bt=class extends z{static get syntaxRules(){let e={type:"punctuation",value:","};return{dialect:"postgres",syntax:this.buildSyntaxRules([{type:"keyword",value:"EXCLUDE"},{optional:!0,syntax:[{type:"keyword",value:"USING"},{type:"keyword",as:"index_method",assert:!0}]},{type:"paren_block",syntax:{type:"PGTableEXConstraintItem",as:"entries",arity:{min:1},itemSeparator:e,assert:!0},assert:!0},{type:"PGIndexParameters",as:"pg_index_parameters",optional:!0},{optional:!0,syntax:[{type:"keyword",value:"WHERE"},{type:"paren_block",syntax:{type:"Expr",as:"where_predicate",assert:!0},assert:!0}]}])}}indexMethod(){return this._get("index_method")}entries(){return this._get("entries")}pgIndexParameters(){return this._get("pg_index_parameters")}wherePredicate(){return this._get("where_predicate")}};var Ft=class extends z{static get syntaxRules(){let e={type:"punctuation",value:","};return this.buildSyntaxRules([{type:"keyword",value:"FOREIGN"},{type:"keyword",value:"KEY",assert:!0},{type:"paren_block",syntax:{type:"ColumnRef2",as:"columns",arity:{min:1},itemSeparator:e,assert:!0,singletons:"BY_KEY"}},{type:"keyword",value:"REFERENCES"},{type:"TableRef2",as:"target_table",assert:!0},{dialect:"postgres",optional:!0,type:"paren_block",syntax:{type:"Identifier",as:"target_columns",arity:{min:1},itemSeparator:e,singletons:"BY_KEY",assert:!0}},{dialect:"mysql",type:"paren_block",syntax:{type:"Identifier",as:"target_columns",arity:{min:1},itemSeparator:e,singletons:"BY_KEY",assert:!0}},{type:["FKMatchRule","FKDeleteRule","FKUpdateRule"],as:"referential_rules",arity:1/0,assert:!0,singletons:!0}])}columns(){return this._get("columns")}targetTable(){return this._get("target_table")}targetColumns(){return this._get("target_columns")}referentialRules(){return this._get("referential_rules")}};var qt=class extends z{static get syntaxRules(){let e={type:"punctuation",value:","};return this.buildSyntaxRules([{type:"keyword",value:"PRIMARY"},{type:"keyword",as:".",value:"KEY",assert:!0},{type:"paren_block",syntax:{type:"ColumnRef2",as:"columns",arity:{min:1},itemSeparator:e,singletons:"BY_KEY",assert:!0},assert:!0},{type:"PGIndexParameters",as:"pg_index_parameters",optional:!0,dialect:"postgres"}])}columns(){return this._get("columns")}pgIndexParameters(){return this._get("pg_index_parameters")}};var Gt=class extends z{static get syntaxRules(){let e={type:"punctuation",value:","};return this.buildSyntaxRules([{type:"keyword",value:"UNIQUE"},{type:"keyword",as:"my_key_kw",value:["KEY","INDEX"],optional:!0,dialect:"mysql"},{optional:!0,dialect:"postgres",syntaxes:[[{type:"keyword",value:"NULLS"},{type:"operator",as:"pg_nulls_distinct",value:"NOT"},{type:"keyword",value:"DISTINCT",assert:!0}],[{type:"keyword",value:"NULLS"},{type:"keyword",as:"pg_nulls_distinct",value:"DISTINCT",assert:!0}]]},{type:"paren_block",syntax:{type:"ColumnRef2",as:"columns",arity:{min:1},itemSeparator:e,singletons:"BY_KEY",assert:!0},assert:!0},{type:"PGIndexParameters",as:"pg_index_parameters",optional:!0,dialect:"postgres"}])}myKeyKW(){return this._get("my_key_kw")}pgNullsDistinct(){return this._get("pg_nulls_distinct")}columns(){return this._get("columns")}pgIndexParameters(){return this._get("pg_index_parameters")}};var be=u=>class extends u{static get _qualifierType(){return"Identifier"}static buildSyntaxRules(e=null){return[{optional:!0,syntax:[{type:this._qualifierType,as:"qualifier"},{type:"punctuation",value:".",autoSpacing:!1}]},e||{...[].concat(super.syntaxRules)[0],autoSpacing:!1}]}static get syntaxRules(){return this.buildSyntaxRules()}static get syntaxPriority(){return-1}qualifier(){return this._get("qualifier")}identifiesAs(e,r=void 0){let s=super.identifiesAs(e,r);return s&&this.qualifier()&&e.qualifier?.()?this.qualifier().identifiesAs(e.qualifier(),r):s}static async _parseFromRules(e,r,{left:s=void 0,minPrecedence:t=0,trail:a,...n},p={}){if(s)return super._parseFromRules(e,r,{left:s,minPrecedence:t,trail:a,...n},p);let c=[];for(;;){if(await e.match(1,"punctuation","."))c.push(await e.eat());else if(await e.match(1,"version_spec")&&await e.match(2,"punctuation","."))c.push(await e.eat()),c.push(await e.eat());else break;(await e.match(2,"punctuation",".")||await e.match(2,"version_spec")&&await e.match(3,"punctuation","."))&&c.push(await e.eat())}let l="qualifier";if(c.length){let y=[].concat(this._qualifierType),d=await this.toStream(c,n),m={minPrecedence:t,trail:a.concat(this.NODE_NAME,`<${l}>`),...n};s=await this._parseFromTypes(d,y,m)}else s=!1;return await super._parseFromRules(e,r,{left:s,minPrecedence:t,trail:a,...n},p)}};var ge={};Ce(ge,{AggrCallExpr:()=>Kt,AtTimeZoneExpr:()=>hr,BetweenExpr:()=>gr,BinaryExpr:()=>ee,BindVar:()=>Dr,BitLiteral:()=>er,BoolLiteral:()=>tr,CallExpr:()=>We,CaseBranch:()=>Vt,CaseExpr:()=>Ht,CastExpr:()=>Qt,ColumnRef0:()=>Ar,ColumnRef1:()=>Qe,ColumnRef2:()=>Je,DefaultLiteral:()=>rr,DistinctFromExpr:()=>xr,Expr:()=>ct,ExtractExpr:()=>Xt,HexLiteral:()=>sr,Identifier:()=>ie,InExpr:()=>Nr,LQArrayLiteral:()=>yr,LQBackBackRef:()=>Ie,LQBackRef:()=>Tr,LQBackRefAbstraction:()=>pt,LQBackRefEndpoint:()=>Or,LQDeepDeepRef1:()=>Re,LQDeepDeepRef2:()=>Rr,LQDeepRef1:()=>Xe,LQDeepRef2:()=>vr,LQObjectLiteral:()=>mr,LQObjectProperty:()=>dr,NullLiteral:()=>ar,NumberLiteral:()=>nr,PGCastExpr2:()=>Er,PGFilterClause:()=>Yt,PGTypedArrayLiteral:()=>_r,PGWithinGroupClause:()=>Wt,ParenExpr:()=>we,PredicateExpr:()=>zt,QuantitativeExpr:()=>Zt,RowConstructor:()=>je,ScalarSubquery:()=>lt,SchemaRef:()=>Cr,StringLiteral:()=>or,SystemVar:()=>Ir,TableRef0:()=>br,TableRef1:()=>Me,TableRef2:()=>wr,TypedDateLiteral:()=>ir,TypedIntervalLiteral:()=>lr,TypedLiteral:()=>me,TypedRowConstructor:()=>ut,TypedTimeLiteral:()=>ur,TypedTimeZoneLiteral:()=>cr,TypedTimestampLiteral:()=>pr,UnaryExpr:()=>Sr,UnknownLiteral:()=>fr,UserVar:()=>Mr,WindowRef:()=>kr});var Se=u=>class extends u{dataType(){return o.DataType.fromJSON({value:"TEXT"})}};var re=class extends Se(h){};var we=class u extends re{static get syntaxRules(){return{type:"paren_block",syntax:{type:"Expr",as:"expr"},autoIndent:!0}}static get syntaxPriority(){return-1}expr(){return this._get("expr")}exprUnwrapped(){let e=this._get("expr");return e instanceof u?e.exprUnwrapped():e}dataType(){return this.expr()?.dataType()}};var je=class u extends X(Se(C)){static get syntaxRules(){return{syntax:[{type:"paren_block",syntax:{type:["DerivedQuery","ValuesTableLiteral","Expr"],as:"entries",arity:1/0,itemSeparator:{type:"punctuation",value:","},autoIndent:10}}]}}static get syntaxPriority(){return 49}exprUnwrapped(){return this._get("entries")?.length===1&&this._get("entries")[0]instanceof u?this._get("entries")[0].exprUnwrapped():this}dataType(){return o.DataType.fromJSON({value:"SET"})}jsonfy(e={},r=null,s=null){let t=super.jsonfy(e,r,s);if(e.deSugar?.rowConstructorSchemas||e.forceDeSugar){let a=this.entries()||[],p=(t.entries||[]).map((c,l)=>{let y={nodeName:o.Identifier.NODE_NAME,value:l};return c.result_schema instanceof o.ColumnSchema?c.result_schema.clone({renameTo:y}):o.ColumnSchema.fromJSON({name:y,data_type:a[l].dataType().jsonfy()})});t={...t,result_schema:o.JSONSchema.fromJSON({entries:p},{assert:!0})}}return t}};var Ye=class extends X(we){static get syntaxRules(){return{type:"paren_block",syntax:{type:["SelectStmt","TableStmt","CTE"],as:"expr",autoIndent:!0}}}static get syntaxPriority(){return-1}dataType(){return this.expr()?.dataType()}#e=!1;isCorrelated(){return this.#e}static fromJSON(e,r={},s=null){if(!e||e instanceof h)return super.fromJSON(e,r,s);let{is_correlated:t,...a}=e,n=super.fromJSON(a,r,s);if(n&&t){if(typeof t!="boolean")throw new Error("Invalid value passed at inputJson.is_correlated");n.#e=t}return n}jsonfy(e={},r=null,s=null){let t=r?.statementContext?.artifacts||new Map;t.set("derivedQueryCorrelationFlag",null);let a=super.jsonfy(e,r,s),n=t.get("derivedQueryCorrelationFlag");if(t.delete("derivedQueryCorrelationFlag"),e.deSugar){let p=a.expr?.result_schema;a={...a,is_correlated:!!n,result_schema:p}}else a={...a,is_correlated:this.#e};return a}};var lt=class extends Ye{static get syntaxRules(){return{type:"paren_block",syntax:{type:["SelectStmt","CTE"],as:"expr"},autoIndent:!0}}static get syntaxPriority(){return 48}dataType(){return this.resultSchema()?this.resultSchema().dataType():o.DataType.fromJSON({value:"TEXT"})}jsonfy(e={},r=null,s=null){let t=super.jsonfy(e,r,s);if(e.deSugar){let a=t.expr?.result_schema;if(a?.length!==1)throw new Error("Scalar subqueries must return a scalar value.");a=a.entries()[0],t={...t,result_schema:a}}return t}};var ut=class extends je{static get syntaxRules(){return[{type:"keyword",value:"ROW"},...[].concat(super.syntaxRules)]}static get syntaxPriority(){return 52}};var Yt=class extends h{static get syntaxRules(){return{dialect:"postgres",syntax:[{type:"keyword",value:"FILTER"},{type:"paren_block",syntax:{type:"WhereClause",as:"where_clause"},assert:!0,autoIndent:!0}]}}static get syntaxPriority(){return-1}whereClause(){return this._get("where_clause")}};var Wt=class extends h{static get syntaxRules(){return{dialect:"postgres",syntax:[{type:"keyword",value:"WITHIN"},{type:"keyword",value:"GROUP"},{type:"paren_block",syntax:{type:"OrderByClause",as:"order_by_clause"},assert:!0,autoIndent:!0}]}}static get syntaxPriority(){return-1}orderByClause(){return this._get("order_by_clause")}};var We=class extends X(re){static get syntaxRules(){let e={type:"punctuation",value:","};return{syntaxes:[{peek:[0,"keyword",["NOW","CURRENT_DATE","CURRENT_TIME","CURRENT_TIMESTAMP","IF","NULLIF","IFNULL","COALESCE","GREATEST","LEAST","CONCAT","CONCAT_WS","FORMAT","MD5","SHA1","TO_JSON","TO_JSONB","JSON_TYPEOF","JSONB_TYPEOF","JSON_BUILD_ARRAY","JSONB_BUILD_ARRAY","JSON_BUILD_OBJECT","JSONB_BUILD_OBJECT","JSON_POPULATE_RECORD","JSONB_POPULATE_RECORD","JSON_PATH_QUERY","JSON_PATH_EXISTS","JSON_ARRAY","JSON_OBJECT","JSON_EXTRACT","JSON_UNQUOTE","JSON_SET","JSON_INSERT","JSON_REPLACE","JSON_REMOVE","JSON_SEARCH","JSON_CONTAINS","JSON_CONTAINS_PATH","JSON_KEYS","JSON_ARRAY_APPEND","JSON_ARRAY_INSERT","JSON_DEPTH","JSON_LENGTH","JSON_MERGE_PRESERVE","JSON_MERGE_PATCH","JSON_PRETTY","JSON_STORAGE_FREE","ST_ASTEXT","ST_ASGEOJSON","ST_GEOMFROMTEXT","ST_WITHIN","ST_CONTAINS","ST_INTERSECTS","ST_DISTANCE","ST_BUFFER","MAKE_DATE","MAKE_TIME","MAKE_TIMESTAMP","ARRAY","CURDATE","CURTIME","SYSDATE","STR_TO_DATE","MAKEDATE","MAKETIME"]],syntaxes:[[{type:"keyword",as:"name",value:["CURRENT_DATE","CURRENT_TIME","CURRENT_TIMESTAMP"]},{type:"paren_block",syntax:{type:"Expr",as:"arguments",arity:0,itemSeparator:e,assert:!0},optional:!0,optionalParens:!0,autoSpacing:!1}],[{type:"keyword",as:"name",value:["NOW"]},{type:"paren_block",syntax:{type:"Expr",as:"arguments",arity:0,itemSeparator:e,assert:!0},optional:!0,autoSpacing:!1}],[{type:"keyword",as:"name",value:["IF","NULLIF","IFNULL"]},{type:"paren_block",syntax:{type:"Expr",as:"arguments",arity:{min:2,max:3},itemSeparator:e,assert:!0},autoSpacing:!1}],[{type:"keyword",as:"name",value:["COALESCE","GREATEST","LEAST","CONCAT"]},{type:"paren_block",syntax:{type:"Expr",as:"arguments",arity:{min:1},itemSeparator:e,assert:!0},autoSpacing:!1}],[{type:"keyword",as:"name",value:["CONCAT_WS","FORMAT"]},{type:"paren_block",syntax:{type:"Expr",as:"arguments",arity:{min:2},itemSeparator:e,assert:!0},autoSpacing:!1}],[{type:"keyword",as:"name",value:["MD5","SHA1"]},{type:"paren_block",syntax:{type:"Expr",as:"arguments",arity:1,itemSeparator:e,assert:!0},autoSpacing:!1}],[{type:"keyword",as:"name",value:["ST_ASTEXT","ST_ASGEOJSON","ST_GEOMFROMTEXT"]},{type:"paren_block",syntax:{type:"Expr",as:"arguments",arity:1,itemSeparator:e,assert:!0},autoSpacing:!1}],[{type:"keyword",as:"name",value:["ST_WITHIN","ST_CONTAINS","ST_INTERSECTS","ST_DISTANCE","ST_BUFFER"]},{type:"paren_block",syntax:{type:"Expr",as:"arguments",arity:2,itemSeparator:e,assert:!0},autoSpacing:!1}],{dialect:"postgres",syntax:[{type:"keyword",as:"name",value:["TO_JSON","TO_JSONB","JSON_TYPEOF","JSONB_TYPEOF"]},{type:"paren_block",syntax:{type:"Expr",as:"arguments",arity:1,itemSeparator:e,assert:!0},autoSpacing:!1}]},{dialect:"postgres",syntax:[{type:"keyword",as:"name",value:["JSON_BUILD_ARRAY","JSONB_BUILD_ARRAY","JSON_BUILD_OBJECT","JSONB_BUILD_OBJECT"]},{type:"paren_block",syntax:{type:"Expr",as:"arguments",arity:{min:0},itemSeparator:e,assert:!0},autoSpacing:!1}]},{dialect:"postgres",syntax:[{type:"keyword",as:"name",value:["JSON_POPULATE_RECORD","JSONB_POPULATE_RECORD","JSON_PATH_QUERY","JSON_PATH_EXISTS"]},{type:"paren_block",syntax:{type:"Expr",as:"arguments",arity:2,itemSeparator:e,assert:!0},autoSpacing:!1}]},{dialect:"postgres",syntax:[{type:"keyword",as:"name",value:["ARRAY"]},{type:"paren_block",syntax:{type:"SelectStmt",as:"arguments",arity:1,itemSeparator:e,assert:!0},autoIndent:!0,autoSpacing:!0}]},{dialect:"postgres",syntax:[{type:"keyword",as:"name",value:["MAKE_DATE","MAKE_TIME","MAKE_TIMESTAMP"]},{type:"paren_block",syntax:{type:"Expr",as:"arguments",arity:1/0,itemSeparator:e,assert:!0},autoSpacing:!1}]},{dialect:"mysql",syntax:[{type:"keyword",as:"name",value:["JSON_ARRAY","JSON_OBJECT","JSON_EXTRACT","JSON_UNQUOTE","JSON_SET","JSON_INSERT","JSON_REPLACE","JSON_REMOVE","JSON_SEARCH","JSON_CONTAINS","JSON_CONTAINS_PATH","JSON_KEYS","JSON_ARRAY_APPEND","JSON_ARRAY_INSERT","JSON_DEPTH","JSON_LENGTH","JSON_MERGE_PRESERVE","JSON_MERGE_PATCH","JSON_PRETTY","JSON_STORAGE_FREE"]},{type:"paren_block",syntax:{type:"Expr",as:"arguments",arity:{min:1},itemSeparator:e,assert:!0},autoSpacing:!1}]},{dialect:"mysql",syntax:[{type:"keyword",as:"name",value:["CURDATE","CURTIME","SYSDATE"]},{type:"paren_block",syntax:{type:"Expr",as:"arguments",arity:0,itemSeparator:e,optional:!0,assert:!0},autoSpacing:!1}]},{dialect:"mysql",syntax:[{type:"keyword",as:"name",value:"STR_TO_DATE"},{type:"paren_block",syntax:{type:"Expr",as:"arguments",arity:2,itemSeparator:e,assert:!0},autoSpacing:!1}]},{dialect:"mysql",syntax:[{type:"keyword",as:"name",value:["MAKEDATE","MAKETIME"]},{type:"paren_block",syntax:{type:"Expr",as:"arguments",arity:2,itemSeparator:e,assert:!0},autoSpacing:!1}]}]},[{type:"keyword",as:"name"},{type:"paren_block",syntax:{type:"Expr",as:"arguments",arity:1/0,itemSeparator:e},autoSpacing:!1}],[{type:"identifier",as:"name"},{type:"paren_block",syntax:{type:"Expr",as:"arguments",arity:1/0,itemSeparator:e},autoSpacing:!1}]]}}static get syntaxPriority(){return 51}name(){return this._get("name")}arguments(){return this._get("arguments")}};var Kt=class extends We{static get syntaxRules(){let e={type:"punctuation",value:","},r={type:"keyword",as:"distinct",value:"DISTINCT",booleanfy:!0,optional:!0},s={optional:!0,syntax:[{type:"keyword",value:"SEPARATOR"},{type:"Expr",as:"separator",assert:!0}]},t={type:"OrderByClause",as:"order_by_clause",optional:!0},a={type:"PGFilterClause",as:"pg_filter_clause",optional:!0,dialect:"postgres"},n={type:"PGWithinGroupClause",as:"pg_within_group_clause",optional:!0,dialect:"postgres"},p={optional:!0,syntax:[{type:"keyword",as:"null_handling",value:["IGNORE","RESPECT"]},{type:"keyword",value:"NULLS",assert:!0}]},c={optional:!0,syntax:[{type:"keyword",value:"OVER"},{type:["WindowRef","WindowSpec"],as:"over_clause",assert:!0}]};return{peek:[0,"keyword",["COUNT","SUM","AVG","MIN","MAX","ARRAY_AGG","STRING_AGG","GROUP_CONCAT","REGR_SLOPE","COVAR_POP","COVAR_SAMP","CORR","PERCENTILE_CONT","PERCENTILE_DISC","MODE","RANK","DENSE_RANK","ROW_NUMBER","EVERY","BOOL_AND","BOOL_OR","BIT_AND","BIT_OR","BIT_XOR","JSON_AGG","JSON_ARRAYAGG","JSON_OBJECT_AGG","JSONB_OBJECT_AGG","JSON_OBJECTAGG","STDDEV_POP","STDDEV_SAMP","VAR_POP","VAR_SAMP","VARIANCE","STD","XMLAGG","LEAD","LAG","NTILE","FIRST_VALUE","LAST_VALUE"]],syntaxes:[[{type:"keyword",as:"name",value:"COUNT"},{type:"paren_block",syntax:[{dialect:"postgres",type:"ColumnRef0",as:"arguments",arity:1,assert:!1,itemSeparator:e},{dialect:"mysql",type:"ColumnRef0",as:"arguments",arity:1/0,assert:!1,itemSeparator:e,optional:!0}],autoSpacing:!1},{...a},{...c}],[{type:"keyword",as:"name",value:["COUNT","SUM","AVG","MIN","MAX"]},{type:"paren_block",syntax:[{...r},{type:"Expr",as:"arguments",arity:1,itemSeparator:e,assert:!0}],autoSpacing:!1},{...a},{...c}],{dialect:"postgres",syntax:[{type:"keyword",as:"name",value:"ARRAY_AGG"},{type:"paren_block",syntax:[{...r},{type:"Expr",as:"arguments",arity:{min:1},itemSeparator:e,assert:!0},{...t}],autoSpacing:!1},{...a},{...c}]},{dialect:"postgres",syntax:[{type:"keyword",as:"name",value:"STRING_AGG"},{type:"paren_block",syntax:[{...r},{type:"Expr",as:"arguments",arity:2,itemSeparator:e,assert:!0},{...t},{...s}],autoSpacing:!1},{...a},{...c}]},{dialect:"mysql",syntax:[{type:"keyword",as:"name",value:"GROUP_CONCAT"},{type:"paren_block",syntax:[{...r},{type:"Expr",as:"arguments",arity:{min:1},itemSeparator:e,assert:!0},{...t},{...s}],autoSpacing:!1},{...c}]},{dialect:"postgres",syntax:[{type:"keyword",as:"name",value:"REGR_SLOPE"},{type:"paren_block",syntax:{type:"Expr",as:"arguments",arity:2,itemSeparator:e,assert:!0},autoSpacing:!1},{...a},{...c}]},[{type:"keyword",as:"name",value:["COVAR_POP","COVAR_SAMP","CORR"]},{type:"paren_block",syntax:{type:"Expr",as:"arguments",arity:2,itemSeparator:e,assert:!0},autoSpacing:!1},{...a},{...c}],{dialect:"postgres",syntax:[{type:"keyword",as:"name",value:["PERCENTILE_CONT","PERCENTILE_DISC"]},{type:"paren_block",syntax:{type:"Expr",as:"arguments",arity:1,itemSeparator:e,assert:!0},autoSpacing:!1},{...a},{...n,optional:!1}]},{dialect:"postgres",syntax:[{type:"keyword",as:"name",value:"MODE"},{type:"paren_block",syntax:{type:"Expr",as:"arguments",arity:0,itemSeparator:e,assert:!0},autoSpacing:!1},{...a},{...n,optional:!1}]},{dialect:"postgres",syntax:[{type:"keyword",as:"name",value:["RANK","DENSE_RANK"]},{type:"paren_block",syntax:{type:"Expr",as:"arguments",arity:0,itemSeparator:e,assert:!0},autoSpacing:!1},{...a},{...c,optional:!1}]},[{type:"keyword",as:"name",value:"ROW_NUMBER"},{type:"paren_block",syntax:{type:"Expr",as:"arguments",arity:0,itemSeparator:e,assert:!0},autoSpacing:!1},{...c,optional:!1}],{dialect:"postgres",syntax:[{type:"keyword",as:"name",value:["EVERY","BOOL_AND","BOOL_OR"]},{type:"paren_block",syntax:[{...r},{type:"Expr",as:"arguments",arity:1,itemSeparator:e,assert:!0}],autoSpacing:!1},{...a},{...c}]},{dialect:"postgres",syntax:[{type:"keyword",as:"name",value:"JSON_AGG"},{type:"paren_block",syntax:[{...r},{type:"Expr",as:"arguments",arity:{min:1},itemSeparator:e,assert:!0}],autoSpacing:!1},{...a},{...c}]},{dialect:"mysql",syntax:[{type:"keyword",as:"name",value:"JSON_ARRAYAGG"},{type:"paren_block",syntax:[{...r},{type:"Expr",as:"arguments",arity:{min:1},itemSeparator:e,assert:!0}],autoSpacing:!1},{...c}]},{dialect:"mysql",syntax:[{type:"keyword",as:"name",value:"BIT_XOR"},{type:"paren_block",syntax:[{...r},{type:"Expr",as:"arguments",arity:1,itemSeparator:e,assert:!0}],autoSpacing:!1},{...c}]},[{type:"keyword",as:"name",value:["BIT_AND","BIT_OR"]},{type:"paren_block",syntax:[{...r},{type:"Expr",as:"arguments",arity:1,itemSeparator:e,assert:!0}],autoSpacing:!1},{...a},{...c}],{dialect:"postgres",syntax:[{type:"keyword",as:"name",value:["JSON_OBJECT_AGG","JSONB_OBJECT_AGG"]},{type:"paren_block",syntax:[{...r},{type:"Expr",as:"arguments",arity:2,itemSeparator:e,assert:!0}],autoSpacing:!1},{...a},{...c}]},{dialect:"mysql",syntax:[{type:"keyword",as:"name",value:"JSON_OBJECTAGG"},{type:"paren_block",syntax:[{...r},{type:"Expr",as:"arguments",arity:2,itemSeparator:e,assert:!0}],autoSpacing:!1},{...c}]},[{type:"keyword",as:"name",value:["STDDEV_POP","STDDEV_SAMP","VAR_POP","VAR_SAMP","VARIANCE","STD"]},{type:"paren_block",syntax:[{...r},{type:"Expr",as:"arguments",arity:1,itemSeparator:e,assert:!0}],autoSpacing:!1},{...a},{...c}],{dialect:"postgres",syntax:[{type:"keyword",as:"name",value:"XMLAGG"},{type:"paren_block",syntax:[{type:"Expr",as:"arguments",arity:1,itemSeparator:e,assert:!0},{...t}],autoSpacing:!1},{...a},{...c}]},[{type:"keyword",as:"name",value:["LEAD","LAG"]},{type:"paren_block",syntax:{type:"Expr",as:"arguments",arity:{max:3},itemSeparator:e,optional:!0,assert:!0},autoSpacing:!1},{...p},{...c}],[{type:"keyword",as:"name",value:["NTILE","FIRST_VALUE","LAST_VALUE"]},{type:"paren_block",syntax:{type:"Expr",as:"arguments",arity:1,itemSeparator:e,assert:!0},autoSpacing:!1},{...c,optional:!1}]]}}distinct(){return this._get("distinct")}orderByClause(){return this._get("order_by_clause")}separator(){return this._get("separator")}overClause(){return this._get("over_clause")}pgFilterClause(){return this._get("pg_filter_clause")}pgWithinGroupClause(){return this._get("pg_within_group_clause")}};var Ht=class extends Se(C){static get syntaxRules(){return[{type:"keyword",value:"CASE"},{type:"Expr",as:"subject",optional:!0},{type:"CaseBranch",as:"entries",arity:{min:1},assert:!0,autoIndent:2},{optional:!0,syntax:[{type:"keyword",value:"ELSE"},{type:"Expr",as:"alternate",autoIndent:!0}],autoSpacing:`
`},{type:"keyword",value:"END",autoSpacing:`
`}]}subject(){return this._get("subject")}branches(){return this.entries()}alternate(){return this._get("alternate")}};var Vt=class extends h{static get syntaxRules(){return[{type:"keyword",value:"WHEN"},{type:"Expr",as:"condition"},{type:"keyword",value:"THEN"},{type:"Expr",as:"consequent"}]}static get syntaxPriority(){return-1}condition(){return this._get("condition")}consequent(){return this._get("consequent")}};var Qt=class extends re{static get syntaxRules(){return[{type:"keyword",value:"CAST"},{type:"paren_block",syntax:[{type:"Expr",as:"expr"},{type:"keyword",value:"AS"},{type:"DataType",as:"data_type",assert:!0}],assert:!0,autoSpacing:!1}]}expr(){return this._get("expr")}dataType(){return this._get("data_type")}};var ee=class extends re{static get syntaxRules(){return[{type:"Expr",as:"left",peek:[1,"operator",["NOT",void 0]]},{type:"operator",as:"negation",value:"NOT",booleanfy:!0,optional:!0},{type:"operator",as:"operator"},{type:"Expr",as:"right"}]}static get syntaxPriority(){return 0}left(){return this._get("left")}negation(){return this._get("negation")}operator(){return this._get("operator")}right(){return this._get("right")}dataType(){let e=this.operator();if(!e)return this.left()?.dataType();let r=this.options.dialect,t=new Map(mt.common.concat(mt[r])).get(e)?.resultType;if(t)return t===":right"?this.right()?.dataType():t===":left"?this.left()?.dataType():o.DataType.fromJSON({value:t.toUpperCase()})}};var Xt=class extends ee{static get syntaxRules(){return[{type:"keyword",value:"EXTRACT"},{type:"paren_block",syntax:[{type:"Expr",as:"left"},{type:"keyword",value:"FROM"},{type:"Expr",as:"right",assert:!0}],autoSpacing:!1}]}left(){return this._get("left")}right(){return this._get("right")}};var zt=class extends re{static get syntaxRules(){return[{type:"keyword",as:"predicate",value:["EXISTS"]},{type:"ScalarSubquery",as:"expr"}]}predicate(){return this._get("predicate")}expr(){return this._get("expr")}dataType(){return o.DataType.fromJSON({value:"BOOLEAN"})}};var Zt=class extends h{static get syntaxRules(){return[{type:"keyword",as:"quantifier",value:["ALL","ANY","SOME"]},{syntaxes:[{type:"DerivedQuery",as:"expr"},{type:"paren_block",syntax:{type:"Expr",as:"expr"}}]}]}quantifier(){return this._get("quantifier")}expr(){return this._get("expr")}};var ce=class extends re{static get syntaxPriority(){return 49}value(){return this._get("value")}};var er=class extends ce{static get syntaxRules(){return{type:"bit_literal",as:"."}}dataType(){return o.DataType.fromJSON({value:"BINARY"})}};var tr=class extends ce{static get syntaxRules(){return{type:"bool_literal",as:"."}}dataType(){return o.DataType.fromJSON({value:"BOOLEAN"})}};var rr=class extends ce{static get syntaxRules(){return{type:"keyword",as:".",value:"DEFAULT"}}};var sr=class extends ce{static get syntaxRules(){return{type:"hex_literal",as:"."}}dataType(){return o.DataType.fromJSON({value:"BINARY"})}};var ar=class extends ce{static get syntaxRules(){return{type:"null_literal",as:"."}}};var nr=class extends ce{static get syntaxRules(){return{type:"number_literal",as:"."}}dataType(){return o.DataType.fromJSON({value:"INT"})}};var or=class extends ce{static get syntaxRules(){return{type:"string_literal",as:"."}}qualifier(){return this._get("qualifier")}dataType(){return o.DataType.fromJSON({value:"TEXT"})}};var me=class extends re{static get syntaxRules(){return[{type:"data_type",as:"data_type"},{type:"string_literal",as:"value"}]}static get syntaxPriority(){return 50}dataType(){return o.DataType.fromJSON({value:this._get("data_type")})}value(){return this._get("value")}};var ir=class extends me{static get syntaxRules(){return[{type:"data_type",as:"data_type",value:"DATE"},{type:"string_literal",as:"value"}]}};var lr=class extends me{static get syntaxRules(){return[{type:"data_type",as:"data_type",value:"INTERVAL"},{syntaxes:[{type:"string_literal",as:"value"},{type:"number_literal",as:"value",dialect:"mysql"}]},{optional:!0,syntax:[{type:"keyword",as:"unit",value:["YEAR","MONTH","DAY","HOUR","MINUTE","SECOND"]},{optional:!0,syntax:[{type:"keyword",value:"TO"},{type:"keyword",as:"to_unit",value:["YEAR","MONTH","DAY","HOUR","MINUTE","SECOND"],assert:!0}]}]}]}unit(){return this._get("unit")}toUnit(){return this._get("to_unit")}parseInterval(){let e=this._get("value");if(!e)return{};let r="";if(e.type==="string_literal")r=e.value.toString().trim();else if(e.type==="number_literal"){let c=e.value,l=(this.unit()||"").toUpperCase();return this.#e(c,l)}let s=r.startsWith("-")?-1:1;s===-1&&(r=r.slice(1).trim());let t={years:0,months:0,days:0,hours:0,minutes:0,seconds:0},a=this.unit()?this.unit().toUpperCase():null,n=this.toUnit()?this.toUnit().toUpperCase():null;if(a&&n)switch(`${a} TO ${n}`){case"YEAR TO MONTH":{let[l,y]=r.split("-").map(Number);return t.years=l,t.months=y,this.#r(t,s)}case"DAY TO HOUR":{let[l,y]=r.split(/\s+/);return t.days=Number(l),t.hours=Number(y),this.#r(t,s)}case"DAY TO MINUTE":{let[l,y]=r.split(/\s+/);t.days=Number(l);let[d,m]=y.split(":").map(Number);return t.hours=d,t.minutes=m,this.#r(t,s)}case"DAY TO SECOND":{let[l,y]=r.split(/\s+/);t.days=Number(l);let[d,m,f]=y.split(":").map(Number);return t.hours=d,t.minutes=m,t.seconds=f,this.#r(t,s)}case"HOUR TO MINUTE":{let[l,y]=r.split(":").map(Number);return t.hours=l,t.minutes=y,this.#r(t,s)}case"HOUR TO SECOND":{let[l,y,d]=r.split(":").map(Number);return t.hours=l,t.minutes=y,t.seconds=d,this.#r(t,s)}case"MINUTE TO SECOND":{let[l,y]=r.split(":").map(Number);return t.minutes=l,t.seconds=y,this.#r(t,s)}}let p=r.split(/\s+/);for(let c=0;c<p.length;c++){let l=p[c];if(/^\d{1,2}:\d{1,2}(:\d{1,2}(\.\d+)?)?$/.test(l)){let[d,m,f]=l.split(":").map(Number);isNaN(d)||(t.hours+=d),isNaN(m)||(t.minutes+=m),isNaN(f)||(t.seconds+=f);continue}let y=parseFloat(l);if(!isNaN(y)){let d=(p[c+1]||"").toUpperCase();if(d){let m=this.#e(y,d);for(let[f,x]of Object.entries(m))t[f]+=x;c++}}}return this.#r(t,s)}#e(e,r){let s={};switch(r){case"YEAR":s.years=e;break;case"MONTH":s.months=e;break;case"DAY":s.days=e;break;case"HOUR":s.hours=e;break;case"MINUTE":s.minutes=e;break;case"SECOND":s.seconds=e;break;default:break}return s}#r(e,r){for(let s of Object.keys(e))e[s]*=r;return e}applyToDate(e,r="FOLLOWING"){let s=this.parseInterval(),t=new Date(e),a=r==="FOLLOWING"?1:-1;return s.years&&t.setFullYear(t.getFullYear()+a*s.years),s.months&&t.setMonth(t.getMonth()+a*s.months),s.days&&t.setDate(t.getDate()+a*s.days),s.hours&&t.setHours(t.getHours()+a*s.hours),s.minutes&&t.setMinutes(t.getMinutes()+a*s.minutes),s.seconds&&t.setSeconds(t.getSeconds()+a*s.seconds),t.getTime()}};var ur=class extends me{static get syntaxRules(){return[{type:"data_type",as:"data_type",value:"TIME"},{type:"string_literal",as:"value"},{optional:!0,dialect:"postgres",syntax:[{type:"keyword",as:"pg_with_tz",value:["WITH","WITHOUT"]},{type:"keyword",value:"TIME ZONE",assert:!0}]}]}pgWithTZ(){return this._get("pg_with_tz")}};var pr=class extends me{static get syntaxRules(){return[{type:"data_type",as:"data_type",value:"TIMESTAMP",dialect:"postgres"},{type:"data_type",as:"data_type",value:["TIMESTAMP","DATETIME"],dialect:"mysql"},{type:"string_literal",as:"value"},{optional:!0,dialect:"postgres",syntax:[{type:"keyword",as:"pg_with_tz",value:["WITH","WITHOUT"]},{type:"keyword",value:"TIME ZONE",assert:!0}]}]}pgWithTZ(){return this._get("pg_with_tz")}};var cr=class extends me{static get syntaxRules(){return[{type:"keyword",value:"TIME ZONE"},{type:"Expr",as:"value"}]}};var fr=class extends ce{static get syntaxRules(){return{type:"unknown_literal",as:"."}}};var Ke=u=>class extends u{get isSugar(){return!0}};var He=class extends Ke(Se(C)){dataType(){return o.DataType.fromJSON({value:"JSON"})}};var yr=class extends He{static get syntaxRules(){return{syntax:[{type:"bracket_block",syntax:{type:"Expr",as:"entries",arity:1/0,itemSeparator:{type:"punctuation",value:","},autoIndent:2}}]}}static morphsTo(){return o.CallExpr}jsonfy(e={},r=null,s=null){let t=super.jsonfy(e,r,s);if(e.deSugar){let a=[];t={nodeName:o.CallExpr.NODE_NAME,name:(e.toDialect||this.options.dialect)==="mysql"?"JSON_ARRAY":"JSON_BUILD_ARRAY",arguments:t.entries.map((n,p)=>{let c=n.result_schema,l={value:p,nodeName:o.Identifier.NODE_NAME};return c instanceof o.ColumnSchema?c=c.clone({renameTo:l}):c=o.ColumnSchema.fromJSON({name:l,data_type:this.entries()[p].dataType().jsonfy()}),a.push(c),n}),result_schema:o.JSONSchema.fromJSON({entries:a},{assert:!0})}}return t}};var mr=class extends He{static get syntaxRules(){return{syntax:[{type:"brace_block",syntax:{type:"LQObjectProperty",as:"entries",arity:1/0,itemSeparator:{type:"punctuation",value:","},autoIndent:3}}]}}static morphsTo(){return o.CallExpr}jsonfy(e={},r=null,s=null){let t=super.jsonfy(e,r,s);if(e.deSugar){let a=t.entries.reduce((p,c)=>{if(c.star_ref){for(let l of c.star_ref.result_schema){let y={key:{value:l.value(),delim:l._get("delim")},value:l.jsonfy()};p=p.reduce((d,m)=>oe(y.key.value,m.key.value,y.key.delim||m.key.delim)?d:d.concat(m),[]),p=p.concat(y)}return p}return p.concat(c)},[]),n=[];t={nodeName:o.CallExpr.NODE_NAME,name:(e.toDialect||this.options.dialect)==="mysql"?"JSON_OBJECT":"JSON_BUILD_OBJECT",arguments:a.reduce((p,c,l)=>{let y=c.value.result_schema,d={...c.key,nodeName:o.Identifier.NODE_NAME};return y instanceof o.ColumnSchema?y=y.clone({renameTo:d}):y=o.ColumnSchema.fromJSON({name:d,data_type:this.entries()[l].value()?.dataType().jsonfy()||{nodeName:o.DataType.NODE_NAME,value:"TEXT"}}),n.push(y),p.concat({...c.key,nodeName:o.StringLiteral.NODE_NAME},{...c.value})},[]),result_schema:o.JSONSchema.fromJSON({entries:n},{assert:!0})}}return t}};var dr=class u extends h{static get syntaxRules(){return{syntaxes:[{type:"ColumnRef0",as:"star_ref"},[{type:"SelectItemAlias",as:"key"},{optional:!0,syntax:[{type:"punctuation",value:":"},{type:"Expr",as:"value",assert:!0}],autoSpacing:!1}]]}}static get syntaxPriority(){return-1}get isProperty(){return!0}starRef(){return this._get("star_ref")}key(){return this._get("key")}value(){return this._get("value")}jsonfy(e={},r=null,s=null){if(e.deSugar&&!this.starRef()){let t=this.key(),a,n=r?r.transform(t,(y=e)=>t.jsonfy(y),"key",e):t.jsonfy(e);n.is_aggr&&({is_aggr:a,...n}=n);let p=this.value();p||(p=o.ColumnRef1.fromJSON({...n,nodeName:void 0}),this._adoptNodes(p));let c;a&&!(p instanceof o.LQDeepRef1)?c=(y=e,d=r)=>({nodeName:o.AggrCallExpr.NODE_NAME,name:(e.toDialect||this.options.dialect)==="mysql"?"JSON_ARRAYAGG":"JSON_AGG",arguments:[p.jsonfy(y,d,s)]}):c=(y=e,d=r)=>p.jsonfy(y,d,s);let l=r?r.transform(p,c,"value",{...e,asAggr:a}):c();return{nodeName:u.NODE_NAME,key:n,value:l}}return super.jsonfy(e,r,s)}};var _r=class extends C{static get syntaxRules(){return{dialect:"postgres",syntax:[{type:"keyword",value:"ARRAY"},{type:"bracket_block",syntax:{type:"Expr",as:"entries",arity:1/0,itemSeparator:{type:"punctuation",value:","},autoIndent:2},autoSpacing:!1}]}}static morphsTo(){return o.CallExpr}dataType(){return o.DataType.fromJSON({value:"JSON"})}jsonfy(e={},r=null,s=null){let t=super.jsonfy(e,r,s);return(e.toDialect||this.options.dialect)==="mysql"&&(t={nodeName:o.CallExpr.NODE_NAME,name:"JSON_ARRAY",arguments:t.entries}),t}};var hr=class extends ee{static get syntaxRules(){return[{type:"Expr",as:"left",peek:[1,"operator","AT"]},{type:"operator",as:"operator",value:"AT"},{syntaxes:[{type:"TypedTimeZoneLiteral",as:"right"},{type:"keyword",as:"right",value:"LOCAL"}]}]}static get syntaxPriority(){return 0}left(){return this._get("left")}right(){return this._get("right")}dataType(){return o.DataType.fromJSON({value:"TIME ZONE"})}};var gr=class extends ee{static get syntaxRules(){return[{type:"Expr",as:"left",peek:[1,"operator",["NOT","BETWEEN"]]},{type:"operator",as:"negation",value:"NOT",booleanfy:!0,optional:!0},{type:"operator",as:"operator",value:"BETWEEN"},{type:"Expr",as:"right",arity:{min:2,max:2,eager:!1},itemSeparator:{type:"operator",value:"AND"},assert:!0}]}};var xr=class extends ee{static get syntaxRules(){return[{type:"Expr",as:"left",peek:[1,"operator",["IS","IS NOT"]]},{type:"operator",as:"logic",value:["IS","IS NOT"]},{type:"operator",as:"operator",value:"DISTINCT FROM"},{type:"Expr",as:"right",assert:!0}]}logic(){return this._get("logic")}};var Nr=class extends ee{static get syntaxRules(){return[{type:"Expr",as:"left",peek:[1,"operator",["NOT","IN"]]},{type:"operator",as:"negation",value:"NOT",booleanfy:!0,optional:!0},{type:"operator",as:"operator",value:"IN"},{type:["DerivedQuery","RowConstructor","TypedRowConstructor"],as:"right",assert:!0}]}};var Er=class extends ee{static get syntaxRules(){return{dialect:"postgres",syntax:[{type:"Expr",as:"left",peek:[1,"operator","::"]},{type:"operator",as:"operator",value:"::",autoSpacing:!1},{type:"DataType",as:"right",assert:!0,autoSpacing:!1}]}}expr(){return this.left()}dataType(){return this.right()}};var Sr=class extends re{static get syntaxRules(){return[{type:"operator",as:"operator",value:["-","+","NOT"]},{type:"Expr",as:"operand",autoSpacing:["NOT"]}]}static get syntaxPriority(){return 1}operator(){return this._get("operator")}operand(){return this._get("operand")}dataType(){let e=this.operator();return e?o.DataType.fromJSON({value:e==="NOT"?"BOOLEAN":"NUMBER"}):super.dataType()}};var Oe=class extends Error{};var Ve=class extends Error{};var Ae=class extends X(Se(ie)){#e;resolution(){return this.#e}lookup(e,r){return[]}resolve(e,r){let s=this.lookup(null,e,r)||[],t=this.constructor.name.match(/schema/i)?"Schema":this.constructor.name.match(/table/i)?"Table":"Column";if(s.length>1)throw new Ve(`[${this.parentNode?.parentNode||this.parentNode||this}] ${t} ${this} is ambiguous. (Is it ${s.join(" or ")}?)`);if(!s.length)throw new Oe(`[${this.parentNode?.parentNode||this.parentNode||this}] ${t} ${this} does not exist.`);return s[0]}static fromJSON(e,r={},s=null){if(!e||e instanceof h)return super.fromJSON(e,r,s);let{resolution:t,...a}=e,n=super.fromJSON(a,r,s);if(n&&t){if(typeof t!="string")throw new Error('Invalid "resolution" hint passed at inputJson.resolution');n.#e=t}return n}jsonfy(e={},r=null,s=null){let t=super.jsonfy(e,r,s);return this.#e&&(t={...t,resolution:this.#e}),t}};var Qe=class u extends be(Ae){static get _qualifierType(){return["TableRef1","LQBackRefAbstraction"]}static get syntaxRules(){return this.buildSyntaxRules({type:"identifier",as:".",autoSpacing:!1})}static get syntaxPriority(){return 51}static morphsTo(){return o.ColumnRef2}dataType(){return this.resultSchema()?.dataType()||super.dataType()}canReferenceOutputColumns(){return this.climbTree((e,r)=>e instanceof o.SelectStmt?!1:e instanceof o.GroupByClause||e instanceof o.HavingClause||e instanceof o.OrderByClause?e:r())}lookup(e=null,r=null,s=null){if(!r&&!s)return[];let t=this._get("value"),a=(!t||t==="*")&&!e,n=[],p=(l,y=void 0,d="default")=>{if(!(l instanceof o.ColumnSchema)||t&&t!=="*"&&!l.identifiesAs(this))return!1;let m;if(e&&!(m=e(l,y,d)))return!1;if(m instanceof h||Array.isArray(m))return m;let f=l.clone({normalized:!0});l.parentNode?._adoptNodes(f);let x=u.fromJSON({...l.name().jsonfy({nodeNames:!1}),resolution:d,qualifier:y,result_schema:f});return this.parentNode._adoptNodes(x),x};if(((this.options.dialect||"postgres")==="postgres"?["CTID","OID","XMIN","XMAX","TABLEOID"]:[]).includes(t?.toUpperCase())){let l=o.ColumnSchema.fromJSON({name:{nodeName:o.Identifier.NODE_NAME,value:t},data_type:{nodeName:o.DataType.NODE_NAME,value:"INT"}},{assert:!0});return[].concat(p(l,void 0,"system")||[])}if(this.canReferenceOutputColumns()&&r){let l=r.statementContext;for(let y of l.artifacts.get("outputSchemas"))if(n=n.concat(p(y,void 0,"scope")||[]),!a&&n.length)break}if(a||!n.length){let l=new o.TableRef1(this.qualifier()?.jsonfy()||{});this._adoptNodes(l),n=n.concat(l.lookup((y,d=void 0,m=void 0)=>y._get("entries").reduce((f,x)=>{if(y instanceof o.JSONSchema)return f.concat(p(x)||[]);let g={...y.name().jsonfy({nodeNames:!1}),resolution:m,qualifier:d,result_schema:y};return f.concat(p(x,g)||[])},[]),r,s))}if(t==="*"){let l=o.ColumnRef0.fromJSON({value:this.value(),result_schema:o.JSONSchema.fromJSON({entries:n.map(y=>y.clone())},{assert:!0})});this.parentNode._adoptNodes(l),n=[l]}return n}jsonfy({toKind:e=1,...r}={},s=null,t=null){let a;if(r.deSugar&&((r.deSugar===!0||r.deSugar.columnQualifiers)&&!this.qualifier()||!this.resultSchema())&&(s||t)){let n=this.resolve(s,t);if(n.value?.()!==this.value())return n.jsonfy();a=n.jsonfy(),(r.deSugar===!0||r.deSugar.normalizeCasing)&&!a.delim&&(a={...a,value:a.resolution==="system"?a.value.toUpperCase():a.value.toLowerCase()}),!(r.deSugar===!0||r.deSugar.columnQualifiers)&&!this.qualifier()&&(a={...a,qualifier:void 0})}else a=super.jsonfy(r,s,t),e===2&&(a={...a,nodeName:o.ColumnRef2.NODE_NAME},delete a.qualifier);return a}};var Ar=class extends Qe{static get _qualifierType(){return["TableRef1"]}static get syntaxRules(){return this.buildSyntaxRules({type:"operator",as:".",value:"*",autoSpacing:!1})}static get syntaxPriority(){return-1}dataType(){return o.DataType.fromJSON({value:"SET"})}};var ke=class extends Error{constructor(e){super(e),this.name="ErrorFKInvalid"}};var De=class extends Ke(ee){rhsTable(e,r){let t=(this.operand()?.resolve(e,r)).resultSchema()?.fkConstraint(!0);if(!t)throw new ke(`[${this.parentNode||this}] Column ${this.operand()} is not a foreign key.`);return t.targetTable()?.resolve(null,r)}rhsSchema(e,r){return this.rhsTable(e,r)?.resultSchema()}};var Je=class u extends Ae{static get syntaxPriority(){return-1}static morphsTo(){return o.ColumnRef1}dataType(){return this.resultSchema()?.dataType()||super.dataType()}lookup(e,r=null,s=null){if(!r&&!s)return[];let t=this._get("value"),a=!t&&!e,n=[],p=l=>{if(!(l instanceof o.ColumnSchema)||t&&!l.identifiesAs(this))return!1;let y;if(e&&!(y=e(l)))return!1;if(y instanceof h||Array.isArray(y))return y;let d=l.clone({normalized:!0});l.parentNode._adoptNodes(d);let m=u.fromJSON({...l.name().jsonfy({nodeNames:!1}),result_schema:d});return this.parentNode._adoptNodes(m),m},c;this.parentNode instanceof De?this===this.parentNode.operand()?c=[this.parentNode.parentNode.rhsSchema(r,s)]:c=[this.parentNode.rhsSchema(r,s)]:c=this.climbTree((l,y)=>{if(l instanceof o.InsertStmt||l instanceof o.UpdateStmt){let d=[...r.statementContext.artifacts.get("tableSchemas")].map(m=>m.resultSchema);return this.options.dialect!=="mysql"&&(d=d.slice(0,1)),d}return l instanceof o.TableSchema?[l]:y()});e:for(let l of c||[])for(let y of l)if(n=n.concat(p(y)||[]),!a&&n.length)break e;return n}jsonfy({toKind:e=2,...r}={},s=null,t=null){if(r.deSugar&&!this.resultSchema()&&(s||t))return this.resolve(s,t).jsonfy();let a=super.jsonfy(r,s,t);return e===1&&(a={...a,nodeName:o.ColumnRef1.NODE_NAME},delete a.qualifier),a}};var Ie=class u extends De{static get _leftType(){return["LQBackRefEndpoint","LQBackBackRef"]}static get syntaxRules(){return[{type:this._leftType,as:"left",peek:[1,"operator","<~"]},{type:"operator",value:"<~"},{type:"ColumnRef2",as:"right",peek:[1,"operator","<~"]}]}static get syntaxPriority(){return 1}static morphsTo(){return[o.LQDeepRef1,o.LQDeepRef2,o.LQDeepDeepRef1,o.LQDeepDeepRef2]}operand(){return this.right()}endpoint(){return this.left()instanceof u?this.left().endpoint():this.left()}jsonfy({reverseRef:e=!1,toKind:r=1,...s}={},t=null,a=null){return e?{nodeName:r===2?e===1/0?o.LQDeepDeepRef2.NODE_NAME:o.LQDeepRef2.NODE_NAME:e===1/0?o.LQDeepDeepRef1.NODE_NAME:o.LQDeepRef1.NODE_NAME,left:this.right().jsonfy({toKind:e!==1/0?1:2,...s}),right:this.left()instanceof o.LQBackRefEndpoint?{nodeName:o.ColumnRef2.NODE_NAME,value:this.left().value(),delim:this.left()._get("delim")}:this.left().jsonfy({reverseRef:1/0,toKind:r,...s})}:super.jsonfy(s,t,a)}};var Tr=class extends Ie{static get syntaxRules(){return[{type:this._leftType,as:"left",peek:[1,"operator","<~"]},{type:"operator",value:"<~"},{type:"TableRef2",as:"right"}]}static get syntaxPriority(){return 0}rhsTable(e,r){if(!r)return;let s=this.right()?.lookup(null,null,r)||[];if(!s.length)throw new Oe(`[${this.parentNode||this}] Implied RHS table ${this.right()} does not exist.`);return s[0]}resolve(e,r,s=1){if(!e||!r)return;let t=this.left(),a=t instanceof Ie?t.endpoint():t,n=a.qualifier(),p=o.ColumnRef2.fromJSON({...a.jsonfy({nodeNames:!1}),qualifier:void 0}),l=a.resolve(e,r).resultSchema().fkConstraint(!0);if(!l)throw new ke(`[${this.parentNode||this}] Endpoint column ${p} is not a foreign key.`);let y=l.targetTable(),d,m=(_,S)=>{let N=S.pkConstraint(!0)?.columns()[0]?.resolve(e,r);if(!N)throw new ke(`[${this.parentNode||this}] The referenced LHS table ${_} does not have a primary key.`);let E=o.ColumnRef1.fromJSON({qualifier:{...S.name().jsonfy({nodeNames:!1}),result_schema:S},value:N.value(),delim:N._get("delim"),result_schema:N.resultSchema()});if(d)throw new Ve(`[${this.parentNode||this}]: The referenced endpoint for foreign key ${p} is ambiguous. (Is it ${d} or ${E}?)`);d=E},f=e.statementContext;e:do for(let{type:_,resultSchema:S}of f.artifacts.get("tableSchemas")){if(_==="CTEItem")continue;let N=S._get("ddl_name")||S.name();if(n){if(!S.identifiesAs(n))continue;if(!y.identifiesAs(N))throw new ke(`[${this.parentNode||this}] The endpoint table implied by ${n} (${N}) is not the actual target (${y}) of the foreign key column ${p}.`);m(N,S);break e}else y.identifiesAs(N)&&m(N,S)}while(!d&&(f=f.parentTransformer?.statementContext));if(!d)throw new Oe(`[${this.parentNode||this}] Ref does not correlate with current query.`);let x=this.rhsTable(e,r),g=t instanceof Ie?t.clone({reverseRef:!0,toKind:s}):p.constructor.fromJSON({...p.jsonfy(),result_schema:x.resultSchema()._get("entries",p)});return{lhsOperand:d,rhsOperand:g.clone({toKind:s}),rhsTable:x}}};var pt=class extends we{static get syntaxRules(){return{type:"paren_block",syntaxes:[{type:"Expr",as:"expr",peek:[1,"operator","<~"]},{type:"Expr",as:"expr",peek:[2,"operator","<~"]}]}}static get syntaxPriority(){return 51}expr(){return this._get("expr")}};var Or=class extends Je{static get syntaxRules(){return[{optional:!0,type:"paren_block",syntax:{type:"Identifier",as:"qualifier"}},{...[].concat(super.syntaxRules)[0],peek:[1,"operator","<~"]}]}static get syntaxPriority(){return 52}static morphsTo(){return Je}qualifier(){return this._get("qualifier")}};var Re=class u extends De{static get _rightType(){return["LQDeepDeepRef1","LQObjectLiteral","LQArrayLiteral","RowConstructor","ColumnRef2"]}static get syntaxRules(){return[{type:["ColumnRef2","LQBackRefAbstraction"],as:"left",peek:[1,"operator","~>"]},{type:"operator",value:"~>"},{type:this._rightType,as:"right"}]}static get syntaxPriority(){return-1}static morphsTo(){return[o.LQDeepRef1,o.LQDeepRef2,o.LQDeepDeepRef1,o.LQDeepDeepRef2]}operand(){return this.left()}endpoint(){return this.right()instanceof u?this.right().endpoint():this.right()}jsonfy({toDeepRef:e=!1,toKind:r=1,...s}={},t=null,a=null){if(e||r===1||r===2){let n=[o.LQDeepRef1.NODE_NAME,o.LQDeepRef2.NODE_NAME,o.LQDeepDeepRef1.NODE_NAME,o.LQDeepDeepRef2.NODE_NAME],p=n.indexOf(this.NODE_NAME);return e&&p>1&&(p-=2),{nodeName:n[(p+1)%2===r%2?p:r%2?p-1:p+1],left:this.left().jsonfy({toKind:p>1?2:1}),right:this.right().jsonfy({toKind:this.right()instanceof u?r:void 0})}}return super.jsonfy(s,t,a)}};var Rr=class extends Re{static get _rightType(){return["LQDeepDeepRef2","ColumnRef2","ColumnsConstructor"]}jsonfy({toDeepRef:e=!1,toKind:r=2,...s}={},t=null,a=null){return super.jsonfy({toDeepRef:e,toKind:r,...s},t=null,a)}};var Xe=class u extends Re{static get syntaxRules(){return[{syntaxes:[[{type:["ColumnRef1","LQBackRefAbstraction"],as:"left",peek:[1,"operator","~>"]},{type:"operator",value:"~>"}],[{type:"ColumnRef1",as:"left",peek:[3,"operator","~>"]},{type:"operator",value:"~>"}]]},{type:this._rightType,as:"right"}]}static get syntaxPriority(){return 1}rhsTable(e,r){return this.left()?.qualifier?.()instanceof o.LQBackRefAbstraction?this._normalize().rhsTable(e,r):this.left()instanceof o.LQBackRefAbstraction?this.left().expr().rhsTable(e,r):super.rhsTable(e,r)}_normalize(){let e=this.left(),r=this.right(),s=e.qualifier().jsonfy(),t={...e.jsonfy(),qualifier:void 0,nodeName:o.ColumnRef2.NODE_NAME},a=u.fromJSON({left:s,right:{nodeName:Re.NODE_NAME,left:t,right:r.jsonfy()}});return this._adoptNodes(a),a}resolve(e,r,s=1){if(!e||!r)return;if(this.left()?.qualifier?.()instanceof o.LQBackRefAbstraction)return this._normalize().resolve(e,r,s);let t;if(this.right()instanceof o.ColumnRef2?t=this.right().clone({toKind:s}):this.right()instanceof o.LQDeepDeepRef1?t=this.right().clone({toDeepRef:!0,toKind:s}):t=this.right(),this.left()instanceof o.LQBackRefAbstraction)return{...this.left().expr().resolve(e,r,s),detail:t};let a=this.left().resolve(e,r),n=this.rhsTable(e,r),p=n.resultSchema().pkConstraint(!0)?.columns()[0]?.resolve(e,r);if(!p)throw new Error(`[${this.parentNode||this}] The referenced RHS table ${n} does not have a primary key.`);return{lhsOperand:a,rhsOperand:p.clone({toKind:s}),rhsTable:n,detail:t}}};var vr=class extends Xe{static get _rightType(){return["LQDeepDeepRef2","ColumnRef2","ColumnsConstructor"]}static get syntaxPriority(){return-1}resolve(e,r,s=2){return super.resolve(e,r,s)}jsonfy({toDeepRef:e=!1,toKind:r=2,...s}={},t=null,a=null){return super.jsonfy({toDeepRef:e,toKind:r,...s},t,a)}};var Cr=class extends Ae{static get syntaxRules(){return[{type:"identifier",as:"."},{type:"LQVersionSpec",as:"version_spec",optional:!0,autoSpacing:!1}]}static get syntaxPriority(){return-1}versionSpec(){return this._get("version_spec")}lookup(e=null,r=null,s=null){if(!s)return[];let t=this._get("value"),a=!t&&!e,n=[],p=c=>{if(!(c instanceof o.SchemaSchema)||t&&!c.identifiesAs(this))return!1;let l;if(e&&!(l=e(c)))return!1;if(l instanceof h||Array.isArray(l))return l;let y=ColumnRef2.fromJSON({...c.name().jsonfy({nodeNames:!1}),ddl_schema:c});return this.parentNode._adoptNodes(y),y};for(let c of s.catalog)if(n=n.concat(p(c)||[]),!a&&n.length)break;return n}jsonfy(e={},r=null,s=null){let t;return e.deSugar&&!this.resultSchema()&&s?t=this.resolve(r,s).jsonfy():t=super.jsonfy(e,r,s),(e.deSugar===!0||e.deSugar?.normalizeCasing)&&!t.delim&&(t={...t,value:t.value.toLowerCase()}),(e.deSugar===!0||e.deSugar?.dropVersionSpecs)&&t.version_spec&&(t={...t,version_spec:void 0}),t}};var Me=class extends be(Ae){static get _qualifierType(){return"SchemaRef"}static get syntaxRules(){return this.buildSyntaxRules({syntax:[{type:"identifier",as:"."},{type:"LQVersionSpec",as:"version_spec",optional:!0,autoSpacing:!1}],autoSpacing:!1})}versionSpec(){return this._get("version_spec")}dataType(){return o.DataType.fromJSON({value:"SET"})}canReferenceInlineTables(){return!0}lookup(e=null,r=null,s=null){if(!r&&!s)return[];let t=this._get("value"),a=(!t||t==="*")&&(!e||this.parentNode?.value?.()==="*"),n=this.parentNode instanceof o.FromItem,p=this.statementNode?.parentNode instanceof o.DerivedQuery?this.statementNode?.parentNode:null,c=n||!p||!(p.parentNode instanceof o.FromItem)||!(p.parentNode.parentNode?.parentNode instanceof o.SelectStmt)||p.parentNode.lateralKW(),l=[],y=(m,f=void 0,x="default")=>{if(m instanceof o.JSONSchema&&(!t||t==="*")&&e)return e(m,f,x);if(!(m instanceof o.TableSchema)||t&&t!=="*"&&!m.identifiesAs(this))return!1;let g;if(e&&!(g=e(m,f,x)))return!1;if(g instanceof h||Array.isArray(g))return g;let _=this.constructor.fromJSON({...m.name().jsonfy({nodeNames:!1}),resolution:x,qualifier:f,result_schema:m});return this.parentNode?._adoptNodes(_),_};if(((this.options.dialect||"postgres")==="postgres"?["EXCLUDED"]:[]).includes(t?.toUpperCase())&&r){let m=[...r.statementContext.artifacts.get("tableSchemas")][0].resultSchema.clone({renameTo:{nodeName:o.Identifier.NODE_NAME,value:t}});return[].concat(y(m,void 0,"system")||[])}if(this.canReferenceInlineTables()&&r){let m=r.statementContext,f,x,g=new Set;do{x=m!==r.statementContext,n||g.add(m);for(let{type:_,resultSchema:S}of m.artifacts.get("tableSchemas")){if(n){if(_!=="CTEItem")continue}else{if(_==="CTEItem"||f&&f!=="dml"&&_==="dml")continue;f||(f=_)}if(l=l.concat(y(S,void 0,_==="CTEItem"?"cte":x?"scope":"default")||[]),l.length&&!a){for(let N of g)N.artifacts.has("derivedQueryCorrelationFlag")&&N.artifacts.set("derivedQueryCorrelationFlag",!0);break}}}while(c&&(a||!l.length)&&(m=m.parentTransformer?.statementContext))}if(!e&&(a||!l.length)){let m=new o.SchemaRef(this.qualifier()?.jsonfy()||{});this._adoptNodes(m),l=l.concat(m.lookup(f=>f._get("entries").reduce((x,g)=>{let _={...f.name().jsonfy({nodeNames:!1}),result_schema:f};return x.concat(y(g,_)||[])},[]),r,s))}if(t==="*"){let m=o.TableRef0.fromJSON({value:this.value(),result_schema:o.JSONSchema.fromJSON({entries:l.map(f=>f.clone())},{assert:!0})});this.parentNode._adoptNodes(m),l=[m]}return l}jsonfy(e={},r=null,s=null){let t;return e.deSugar&&((e.deSugar===!0||e.deSugar.tableQualifiers)&&!this.qualifier()||!this.resultSchema())&&(r||s)?(t=this.resolve(r,s).jsonfy(),(e.deSugar===!0||e.deSugar.normalizeCasing)&&!t.delim&&(t={...t,value:t.resolution==="system"?t.value.toUpperCase():t.value.toLowerCase()}),!(e.deSugar===!0||e.deSugar.tableQualifiers)&&!this.qualifier()&&(t={...t,qualifier:void 0})):t=super.jsonfy(e,r,s),(e.deSugar===!0||e.deSugar?.dropVersionSpecs)&&t.version_spec&&(t={...t,version_spec:void 0}),t}};var br=class extends Me{static get _qualifierType(){return["SchemaRef"]}static get syntaxRules(){return this.buildSyntaxRules({type:"operator",as:".",value:"*",autoSpacing:!1})}static get syntaxPriority(){return-1}dataType(){return o.DataType.fromJSON({value:"SET"})}};var wr=class extends Me{canReferenceInlineTables(){return!1}};var kr=class extends ie{static get syntaxPriority(){return-1}};var Dr=class extends re{static get syntaxRules(){return{type:"bind_var",as:"."}}value(){return this._get("value")}};var Ir=class extends re{static get syntaxRules(){return{type:"system_var",as:"."}}value(){return this._get("value")}};var Mr=class extends re{static get syntaxRules(){return{type:"user_var",as:"."}}value(){return this._get("value")}};var ct=class extends re{static get syntaxRules(){return{type:Ka,expression:1}}static[Symbol.hasInstance](e){return e instanceof re||e.constructor.name in ge}},Wa=Object.keys(ge),Ka=Wa.filter(u=>ge[u]!==ct&&ge[u].syntaxPriority!==-1).sort((u,e)=>{let r=(ge[e].syntaxPriority??100)-(ge[u].syntaxPriority??100);return r===0?ge[e].prototype.isPrototypeOf(ge[u].prototype)?-1:1:r});var Lr=class extends be(ie){static get _qualifierType(){return"TableRef2"}};var Pr=class extends ie{};var Ur=class extends be(ie){static get _qualifierType(){return"SchemaRef"}};var jr=class extends Ee{};var Jr=class extends he{static get syntaxRules(){return[{type:"Identifier",as:"name",assert:!0}]}};var $r=class extends Ee{};var Br=class extends he{static get syntaxRules(){return[{type:"SchemaIdent",as:"name",assert:!0},{type:"paren_block",syntax:{type:"TableSchema",as:"entries",arity:1/0,itemSeparator:{type:"punctuation",value:","},singletons:"BY_KEY",autoIndent:!0}}]}tables(){let e=[];for(let r of this)r instanceof o.TableSchema&&e.push(r);return e}};var Fr=class extends Ee{};var qr=class extends he{static get syntaxRules(){let e={type:"punctuation",value:","},r=["TablePKConstraint","TableFKConstraint","TableUKConstraint","PGTableEXConstraint","CheckConstraint","ColumnSchema","IndexSchema"];return[{type:["TableIdent","Identifier"],as:"name"},{type:"paren_block",syntaxes:[{type:r,as:"entries",arity:1/0,itemSeparator:e,singletons:"BY_KEY",optional:!0,dialect:"postgres",autoIndent:!0},{type:r,as:"entries",arity:{min:1},itemSeparator:e,singletons:"BY_KEY",dialect:"mysql",autoIndent:!0}]}]}columns(){let e=[];for(let r of this)r instanceof o.ColumnSchema&&e.push(r);return e}pkConstraint(e=!1){for(let r of this){if(r instanceof o.TablePKConstraint)return r;let s;if(e&&r instanceof o.ColumnSchema&&(s=r.pkConstraint())){let t=o.TablePKConstraint.fromJSON({...s.jsonfy(),nodeName:void 0,columns:[o.ColumnRef2.fromJSON({value:r.name().value()})]});return this._adoptNodes(t),t}}}fkConstraints(e=!1){let r=[];for(let s of this){s instanceof o.TableFKConstraint&&r.push(s);let t;if(e&&s instanceof o.ColumnSchema&&(t=s.fkConstraint())){let a=o.TableFKConstraint.fromJSON({...t.jsonfy(),nodeName:void 0,columns:[o.ColumnRef2.fromJSON({value:s.name().value()})]});this._adoptNodes(a),r.push(a)}}return r}ukConstraints(e=!1){let r=[];for(let s of this){s instanceof o.TableUKConstraint&&r.push(s);let t;if(e&&s instanceof o.ColumnSchema&&(t=s.ukConstraint())){let a=o.TableUKConstraint.fromJSON({...t.jsonfy(),nodeName:void 0,columns:[o.ColumnRef2.fromJSON({value:s.name().value()})]});this._adoptNodes(a),r.push(a)}}return r}ckConstraints(e=!1){let r=[];for(let s of this){s instanceof o.CheckConstraint&&r.push(s);let t;e&&s instanceof o.ColumnSchema&&(t=s.ckConstraint()?.clone())&&(this._adoptNodes(t),r.push(t))}return r}jsonfy({normalized:e=!1,...r}={},s=null,t=null){let a=[],n={[o.ColumnPKConstraint.NODE_NAME]:o.TablePKConstraint.NODE_NAME,[o.ColumnFKConstraint.NODE_NAME]:o.TableFKConstraint.NODE_NAME,[o.ColumnUKConstraint.NODE_NAME]:o.TableUKConstraint.NODE_NAME,[o.CheckConstraint.NODE_NAME]:o.CheckConstraint.NODE_NAME};e&&(s=new ae((c,l)=>{if(c?.NODE_NAME in n&&c.parentNode instanceof o.ColumnSchema){a.push({...c.jsonfy(),nodeName:n[c.NODE_NAME],...c instanceof o.CheckConstraint?{}:{columns:[o.ColumnRef2.fromJSON({value:c.parentNode.name().value()})]}});return}return l()},s));let p=super.jsonfy(r,s,t);return e&&(p={...p,entries:p.entries.concat(a)}),p}};var xe=class extends Fe{static get syntaxRules(){return{type:["CreateSchemaStmt","DropSchemaStmt","CreateTableStmt","DropTableStmt"]}}};var Gr=class extends xe{static get syntaxRules(){let e={type:["SchemaIdent","Identifier"],as:"name"},r={syntax:[{type:"keyword",value:"AUTHORIZATION"},{syntaxes:[{type:"keyword",as:"pg_authorization",value:["CURRENT_ROLE","CURRENT_USER","SESSION_USER"]},{type:"Identifier",as:"pg_authorization"}]}]},s={type:["CreateTableStmt"],as:"pg_entries",arity:1/0,optional:!0,dialect:"postgres"};return[{type:"keyword",value:"CREATE"},{type:"keyword",value:"SCHEMA",dialect:"postgres"},{type:"keyword",value:["SCHEMA","DATABASE"],dialect:"mysql"},{dialect:"postgres",syntaxes:[[{type:"keyword",as:"if_not_exists",value:"IF",booleanfy:!0},{type:"operator",value:"NOT"},{type:"keyword",value:"EXISTS"},{syntaxes:[[{...e},{...r,optional:!0}],{...r}]}],[{...e},{...r,optional:!0},{...s}],[{...r},{...s}]]},{dialect:"mysql",syntax:[{optional:!0,syntax:[{type:"keyword",as:"if_not_exists",value:"IF",booleanfy:!0},{type:"operator",value:"NOT"},{type:"keyword",value:"EXISTS"}]},{...e}]}]}ifNotExists(){return this._get("if_not_exists")}name(){return this._get("name")}pgAuthorization(){return this._get("pg_authorization")}pgEntries(){return this._get("pg_entries")}};var Yr=class extends xe{static get syntaxRules(){return[{type:"keyword",value:"DROP"},{type:"keyword",value:"SCHEMA",dialect:"postgres"},{type:"keyword",value:["SCHEMA","DATABASE"],dialect:"mysql"},{optional:!0,syntax:[{type:"keyword",as:"if_exists",value:"IF",booleanfy:!0},{type:"keyword",value:"EXISTS"}]},{type:["SchemaIdent","Identifier"],as:"pg_names",arity:{min:1},itemSeparator:{type:"punctuation",value:","},dialect:"postgres"},{type:["SchemaIdent","Identifier"],as:"my_name",dialect:"mysql"},{type:"keyword",as:"pg_cascade_rule",value:["CASCADE","RESTRICT"],optional:!0,dialect:"postgres"}]}ifExists(){return this._get("if_exists")}pgNames(){return this._get("pg_names")}myName(){return this._get("my_name")}pgCascadeRule(){return this._get("pg_cascade_rule")}};var Wr=class extends xe{static get syntaxRules(){return[{type:"keyword",value:"CREATE"},{optional:!0,syntaxes:[{type:"keyword",as:"temporary_kw",value:"TEMPORARY",booleanfy:!0},{type:"keyword",as:"temporary_kw",value:"TEMP",booleanfy:!0,dialect:"postgres"}]},{type:"keyword",value:"TABLE"},{optional:!0,syntax:[{type:"keyword",as:"if_not_exists",value:"IF",booleanfy:!0},{type:"operator",value:"NOT"},{type:"keyword",value:"EXISTS"}]},{type:"TableSchema",as:"argument"},{type:["ConfigAssignmentExprAlt1","ConfigAssignmentExprAlt2"],as:"my_create_options",arity:1/0,dialect:"mysql"}]}temporaryKW(){return this._get("temporary_kw")}ifNotExists(){return this._get("if_not_exists")}argument(){return this._get("argument")}myCreateOptions(){return this._get("my_create_options")}};var Kr=class extends xe{static get syntaxRules(){return[{type:"keyword",value:"DROP"},{type:"keyword",as:"my_temporary_kw",value:"TEMPORARY",booleanfy:!0,optional:!0,dialect:"mysql"},{type:"keyword",value:"TABLE"},{optional:!0,syntax:[{type:"keyword",as:"if_exists",value:"IF",booleanfy:!0},{type:"keyword",value:"EXISTS"}]},{type:["TableIdent","Identifier"],as:"names",arity:{min:1},itemSeparator:{type:"punctuation",value:","}},{type:"keyword",as:"cascade_rule",value:["CASCADE","RESTRICT"],optional:!0}]}myTemporaryKW(){return this._get("my_temporary_kw")}ifExists(){return this._get("if_exists")}names(){return this._get("names")}cascadeRule(){return this._get("cascade_rule")}};var ca={};Ce(ca,{AssignmentExpr:()=>ns,ColumnsConstructor:()=>as,ConfigAssignmentExpr:()=>os,ConfigAssignmentExprAlt1:()=>is,ConfigAssignmentExprAlt2:()=>ls,DeleteStmt:()=>fs,InsertStmt:()=>Pe,MYOnDuplicateKeyUpdateClause:()=>Hr,MYPartitionClause:()=>Vr,MYSetStmt:()=>ms,MYVarAssignmentExpr:()=>us,PGConflictTarget:()=>Qr,PGConflictTargetIndexSpec:()=>Xr,PGDefaultValuesClause:()=>zr,PGOnConflictClause:()=>Zr,PGWhereCurrentClause:()=>ts,ReturningClause:()=>es,SetClause:()=>rs,TableAbstraction1:()=>cs,TableAbstraction2:()=>ps,UpdateStmt:()=>ds,UpsertStmt:()=>_s,UsingFromClause:()=>ss,ValuesConstructor:()=>Ze});var Hr=class extends C{static get syntaxRules(){return{dialect:"mysql",syntax:[{type:"keyword",value:"ON"},{type:"keyword",value:"DUPLICATE"},{type:"keyword",value:"KEY"},{type:"keyword",value:"UPDATE"},{type:"AssignmentExpr",as:"entries",arity:{min:1},itemSeparator:{type:"punctuation",value:","},assert:!0,autoIndent:!0}]}}};var Vr=class extends C{static get syntaxRules(){return{dialect:"mysql",syntax:[{type:"keyword",value:"PARTITION"},{type:"Identifier",as:"entries",arity:{min:1},itemSeparator:{type:"punctuation",value:","},assert:!0}]}}};var Qr=class extends h{static get syntaxRules(){return{syntaxes:[[{type:"keyword",value:"ON"},{type:"keyword",value:"CONSTRAINT"},{type:"Identifier",as:"constraint_name",assert:!0}],[{type:"paren_block",syntax:{type:"PGConflictTargetIndexSpec",as:"index_list",arity:{min:1},itemSeparator:{type:"punctuation",value:","},assert:!0},autoIndent:!0},{type:"WhereClause",as:"where_clause",optional:!0,autoIndent:!0}]]}}constraintName(){return this._get("constraint_name")}indexList(){return this._get("index_list")}whereClause(){return this._get("where_clause")}};var Xr=class extends h{static get syntaxRules(){return[{syntaxes:[{type:"ColumnRef2",as:"column_name"},{type:"paren_block",syntax:{type:"Expr",as:"expr",assert:!0},autoIndent:!0},{type:"CallExpr",as:"expr"}]},{optional:!0,syntax:[{type:"operator",value:"COLLATE"},{type:"string_literal",as:"collation",assert:!0}]},{type:"Identifier",as:"opclass",optional:!0}]}columnName(){return this._get("column_name")}expr(){return this._get("expr")}collation(){return this._get("collation")}opclass(){return this._get("opclass")}};var zr=class extends h{static get syntaxRules(){return{dialect:"postgres",syntax:[{type:"keyword",as:".",value:"DEFAULT"},{type:"keyword",value:"VALUES"}]}}};var Zr=class extends C{static get syntaxRules(){return{dialect:"postgres",syntax:[{type:"keyword",value:"ON"},{type:"keyword",value:"CONFLICT"},{syntaxes:[[{type:"PGConflictTarget",as:"conflict_target",optional:!0},{type:"keyword",as:"do_nothing_kw",value:"DO",booleanfy:!0},{type:"keyword",value:"NOTHING"}],[{type:"PGConflictTarget",as:"conflict_target"},{type:"keyword",value:"DO"},{type:"keyword",value:"UPDATE"},{type:"keyword",value:"SET"},{type:"AssignmentExpr",as:"entries",arity:{min:1},itemSeparator:{type:"punctuation",value:","},assert:!0,autoIndent:!0},{type:"WhereClause",as:"where_clause",optional:!0,autoIndent:!0}]]}]}}conflictTarget(){return this._get("conflict_target")}doNothingKW(){return this._get("do_nothing_kw")}whereClause(){return this._get("where_clause")}};var ze=class extends X(C){static get syntaxRules(){return{type:"SelectItem",as:"entries",arity:{min:1},itemSeparator:{type:"punctuation",value:","},assert:!0,autoIndent:2}}jsonfy(e={},r=null,s=null){let t=super.jsonfy(e,r,s);if(!e.deSugar)return t;let a=[],n=e.deSugar===!0||e.deSugar?.flattenUnaliasedRootObjects,p=!1,c=l=>{p&&(a=a.reduce((y,d)=>l.alias&&d.alias&&oe(l.alias.value,d.alias.value,l.alias.delim||d.alias.delim)?y:y.concat(d),[])),a=a.concat(l)};for(let[l,y]of t.entries.entries())if(y.expr.value==="*")for(let d of y.result_schema){let m=d.jsonfy(),f={nodeName:o.SelectItemAlias.NODE_NAME,as_kw:!0,value:m.value,delim:m.delim};c({nodeName:o.SelectItem.NODE_NAME,expr:m,alias:f,result_schema:m.result_schema.clone(),_originalStarJson:y})}else if(n&&this.entries()[l].expr()instanceof o.LQObjectLiteral&&!this.entries()[l].alias()){let[d]=y.expr.arguments.reduce(([f,x],g)=>x?[[...f,[x,g]]]:[f,g],[[]]),m=y.expr.result_schema.entries();for(let f=0;f<d.length;f++)c({nodeName:o.SelectItem.NODE_NAME,expr:d[f][1],alias:{...d[f][0],nodeName:o.SelectItemAlias.NODE_NAME,as_kw:!0},result_schema:m[f]})}else c(y);return{...t,entries:a}}finalizeJSON(e,r,s,t){let a=t.deSugar===!0||t.deSugar?.expandStarRefs,n,[p,c]=e.entries.reduce(([l,y],{_originalStarJson:d,...m})=>{if(d&&(n=!0),d&&!a)return d.result_schema||(d.result_schema=o.JSONSchema.fromJSON({entries:[]},{assert:!0})),d.result_schema._add("entries",m.result_schema),[l.concat(d),y.concat(m.result_schema.clone())];if(!m.result_schema){let f=o.SelectItem.fromJSON(m,this.options);this._adoptNodes(f),m=f.jsonfy(t,r,s)}return[l.concat(m),y.concat(m.result_schema.clone())]},[[],[]]);return e={...e,entries:n&&!a?[...new Set(p)]:p,result_schema:o.JSONSchema.fromJSON({entries:c},{assert:!0})},r.statementContext.artifacts.set("outputSchemas",new Set(c)),e}};var es=class extends ze{static get syntaxRules(){return[{type:"keyword",value:"RETURNING"},...[].concat(super.syntaxRules)]}};var ts=class extends h{static get syntaxRules(){return{dialect:"postgres",syntax:[{type:"keyword",value:"WHERE"},{type:"keyword",value:"CURRENT OF"},{type:"identifier",as:"cursor_name",assert:!0}]}}cursorName(){return this._get("cursor_name")}};var rs=class extends C{static get syntaxRules(){return[{type:"keyword",value:"SET"},{type:"AssignmentExpr",as:"entries",arity:{min:1},itemSeparator:{type:"punctuation",value:","},assert:!0,autoIndent:2}]}};var ss=class extends C{static get syntaxRules(){return[{type:"keyword",value:"USING"},{type:"FromItem",as:"entries",arity:{min:1},itemSeparator:{type:"punctuation",value:","},assert:!0}]}};var as=class extends C{static get syntaxRules(){return{syntax:[{type:"paren_block",syntax:{type:["LQDeepRef2","ColumnRef2"],as:"entries",arity:1/0,itemSeparator:{type:"punctuation",value:","},autoIndent:10}}]}}static get syntaxPriority(){return-1}};var Ze=class extends X(C){static get syntaxRules(){let e={type:"punctuation",value:","};return{syntaxes:[[{type:"keyword",value:"VALUES"},{type:["TypedRowConstructor","RowConstructor"],as:"entries",arity:{min:1},itemSeparator:e,assert:!0,autoIndent:2}],{dialect:"mysql",syntax:[{type:"keyword",value:["VALUES","VALUE"]},{type:["TypedRowConstructor","RowConstructor"],as:"entries",arity:{min:1},itemSeparator:e,assert:!0,autoIndent:2}]}]}}static get syntaxPriority(){return-1}jsonfy(e={},r=null,s=null){let t=super.jsonfy({...e,forceDeSugar:e.deSugar},r,s);if(e.deSugar){let a=t.entries?.[0]?.result_schema;t={...t,result_schema:a?.clone()}}return t}};var ns=class extends ee{static get syntaxRules(){return[{type:["LQDeepRef2","ColumnsConstructor","ColumnRef2"],as:"left",dialect:"postgres"},{type:["LQDeepRef2","ColumnRef1"],as:"left",dialect:"mysql"},{type:"operator",as:"operator",value:"="},{type:["ValuesTableLiteral","DerivedQuery","Expr"],as:"right"}]}};var os=class extends ee{static get syntaxRules(){return[{type:"keyword",as:"my_default_kw",value:"DEFAULT",booleanfy:!0,dialect:"mysql",optional:!0},{syntaxes:[{type:"keyword",as:"left"},{type:"identifier",as:"left"}]},{type:"operator",as:"operator",value:"="},{syntaxes:[{type:"Expr",as:"right"},{type:"keyword",as:"right"}]}]}myDefaultKW(){return this._get("my_default_kw")}};var is=class extends ee{static get syntaxRules(){return[{type:"keyword",as:"my_default_kw",value:"DEFAULT",booleanfy:!0,dialect:"mysql",optional:!0},{syntaxes:[{type:"keyword",as:"left"},{type:"identifier",as:"left"}]},{type:"operator",as:"operator",value:"=",optional:!0},{syntaxes:[{type:"Expr",as:"right"},{type:"keyword",as:"right"}]}]}myDefaultKW(){return this._get("my_default_kw")}};var ls=class extends ee{static get syntaxRules(){return[{type:"keyword",as:"default_kw",value:"DEFAULT",booleanfy:!0,optional:!0},{syntaxes:[{type:"keyword",as:"left"},{type:"identifier",as:"left"}]},{optional:!0,syntax:[{type:"operator",as:"operator",value:"="},{syntaxes:[{type:"Expr",as:"right"},{type:"keyword",as:"right"}]}]}]}myDefaultKW(){return this._get("my_default_kw")}};var us=class extends ee{static get syntaxRules(){return{dialect:"mysql",syntax:[{type:["UserVar","SystemVar"],as:"left"},{type:"operator",as:"operator",value:["=",":="]},{type:"Expr",as:"right"}]}}};var ps=class extends X(h){static get syntaxRules(){return[{type:"keyword",as:"pg_only_kw",value:"ONLY",optional:!0,dialect:"postgres"},{type:"TableRef1",as:"table_ref",assert:!0},{type:"operator",as:"pg_star_ref",value:"*",booleanfy:!0,optional:!0,dialect:"postgres"},{type:"SelectItemAlias",as:"alias",optional:!0}]}tableRef(){return this._get("table_ref")}alias(){return this._get("alias")}pgOnlyKW(){return this._get("pg_only_kw")}pgStarRef(){return this._get("pg_star_ref")}deriveAlias(){let e;return this.alias()?e=this.alias():e=o.SelectItemAlias.fromJSON({as_kw:!0,value:this.tableRef().value(),delim:this.tableRef()._get("delim")}),e}jsonfy(e={},r=null,s=null){let t=super.jsonfy(e,r,s);if(e.deSugar){let a=t.alias||this.deriveAlias().jsonfy(),n={nodeName:o.Identifier.NODE_NAME,value:a.value,delim:a.delim},p=t.table_ref.result_schema.clone({renameTo:n});t.alias&&(p=p.clone({renameTo:{nodeName:o.Identifier.NODE_NAME,value:t.alias.value,delim:t.alias.delim}})),r.statementContext.artifacts.get("tableSchemas").add({resultSchema:p});let c=(e.deSugar===!0||e.deSugar?.tableAliases)&&a||t.alias;t={...t,alias:c,result_schema:p}}return t}};var cs=class extends X(h){static get syntaxRules(){return[{type:"TableRef1",as:"table_ref"},{optional:!0,dialect:"mysql",syntax:[{type:"punctuation",value:".",autoSpacing:!1},{type:"operator",as:"my_star_ref",value:"*",booleanfy:!0,autoSpacing:!1}]},{type:"SelectItemAlias",as:"alias",optional:!0}]}tableRef(){return this._get("table_ref")}myStarRef(){return this._get("my_star_ref")}alias(){return this._get("alias")}deriveAlias(){let e;return this.alias()?e=this.alias():e=o.SelectItemAlias.fromJSON({as_kw:!0,value:this.tableRef().value(),delim:this.tableRef()._get("delim")}),e}jsonfy(e={},r=null,s=null){let t=super.jsonfy(e,r,s);if(e.deSugar){let a=t.alias||this.deriveAlias().jsonfy(),n={nodeName:o.Identifier.NODE_NAME,value:a.value,delim:a.delim},p=t.table_ref.result_schema.clone({renameTo:n});t.alias&&(p=p.clone({renameTo:{nodeName:o.Identifier.NODE_NAME,value:t.alias.value,delim:t.alias.delim}})),r.statementContext.artifacts.get("tableSchemas").add({resultSchema:p});let c=(e.deSugar===!0||e.deSugar?.tableAliases)&&a||t.alias;t={...t,alias:c,result_schema:p}}return t}};var et=u=>class extends u{get isSelectorStmt(){return!0}jsonfy(e={},r=null,s=null){if(!e.deSugar)return super.jsonfy(e,r,s);let{ColumnRef1:t,ColumnRef2:a,AggrCallExpr:n,LQBackRefAbstraction:p,LQDeepRef1:c,LQBackRef:l}=o;return r=new ae((y,d,m,{deSugar:f,asAggr:x,...g})=>{let _=E=>E instanceof t&&E.qualifier()instanceof p,S=E=>{let v=E.qualifier().jsonfy(),w={...E.jsonfy(),qualifier:void 0,nodeName:a.NODE_NAME},M=c.fromJSON({left:v,right:w});return E.parentNode._adoptNodes(M),M},N=E=>({nodeName:n.NODE_NAME,name:(g.toDialect||this.options.dialect)==="mysql"?"JSON_ARRAYAGG":"JSON_AGG",arguments:[E]});if(_(y)&&(y=S(y)),y instanceof c){let{select:E,detail:v}=this.createSelectorDimension(y,r,s,{...g,asAggr:x}),w=x?N(v.jsonfy()):v.jsonfy();return E(w)}if(y instanceof l||y instanceof p){y instanceof p&&(y=y.expr());let{alias:E}=this.createSelectorDimension(y,r,s,g);return E()}return d()},r,this),super.jsonfy(e,r,s)}createSelectorDimension(e,r,s,{asAggr:t=!1,...a}={}){let{lhsOperand:n,rhsOperand:p,rhsTable:c,detail:l}=e.resolve(r,s),y=r.statementContext.artifacts.get("selectorDimensions"),{CompleteSelectStmt:d,DerivedQuery:m,FromClause:f,JoinClause:x,OnClause:g,GroupByClause:_,GroupingElement:S,FromItem:N,SelectList:E,SelectItem:v,FromItemAlias:w,SelectItemAlias:M,TableRef1:H,ColumnRef1:L,BinaryExpr:Y}=o,k=`dimension${t?"/g":""}|${[n,p,c].join("|")}`,J=r.statementContext.hash(k,"join");if(y?.has(J))return{...y.get(J),detail:l};let K=new Map,$=r.rand("key",K),B=p.jsonfy(),j={nodeName:v.NODE_NAME,expr:B,alias:{nodeName:M.NODE_NAME,as_kw:!0,value:$}},T={nodeName:x.NODE_NAME,join_type:"LEFT",expr:{nodeName:m.NODE_NAME,expr:{nodeName:d.NODE_NAME,select_list:{nodeName:E.NODE_NAME,entries:[j]},from_clause:{nodeName:f.NODE_NAME,entries:[{nodeName:N.NODE_NAME,expr:c.jsonfy({...a,deSugar:null})}]},group_by_clause:t?{nodeName:_.NODE_NAME,entries:[{nodeName:S.NODE_NAME,expr:{nodeName:L.NODE_NAME,value:$}}]}:void 0}},alias:{nodeName:w.NODE_NAME,as_kw:!0,value:J},condition_clause:{nodeName:g.NODE_NAME,expr:{nodeName:Y.NODE_NAME,operator:"=",left:n.jsonfy({...a,deSugar:null},r,s),right:{nodeName:L.NODE_NAME,qualifier:{nodeName:H.NODE_NAME,value:J},value:$}}}},P={id:J,type:"join",query:T,alias:()=>({nodeName:H.NODE_NAME,value:J}),select:W=>{let O=r.rand("ref",K);return T.expr.expr.select_list.entries.push({nodeName:v.NODE_NAME,expr:W,alias:{nodeName:M.NODE_NAME,as_kw:!0,value:O}}),{nodeName:L.NODE_NAME,qualifier:{nodeName:H.NODE_NAME,value:J},value:O}},detail:l};return y.set(J,P),P}finalizeSelectorJSON(e,r,s,t){let a;[e,a]=this.preprocessSelectorDimensions(e,r,s,t),e={...e,join_clauses:e.join_clauses?.slice(0)||[]};for(let n of a){let p=o.JoinClause.fromJSON(n,this.options);this._adoptNodes(p);let c=r.transform(p,(l=t,y=r)=>p.jsonfy(l,y,s),null,t);e.join_clauses.push(c)}return e}preprocessSelectorDimensions(e,r,s,t){let a=r.statementContext.artifacts.get("selectorDimensions");if(!a.size)return[e,[]];if(this.options.dialect==="postgres"&&(this instanceof o.DeleteStmt||this instanceof o.UpdateStmt)){if(e.where_clause?.cursor_name)throw new Error('Deep/Back Refs are currently not supported with a "WHERE CURRENT OF..." statement');let{DerivedQuery:n,CompleteSelectStmt:p,SelectList:c,SelectItem:l,FromItemAlias:y,FromClause:d,WhereClause:m,TableRef1:f,BinaryExpr:x,FromItem:g}=o,_=r.rand("join"),S=e.table_expr,N=S.alias.value,E=S.alias.delim,v=`${_}:${N}`,M=S.result_schema.pkConstraint(!0)?.columns()[0].jsonfy({toKind:1}),H,L,Y=j=>({nodeName:x.NODE_NAME,left:{...j,qualifier:{nodeName:f.NODE_NAME,value:N,delim:E}},operator:"=",right:{...j,qualifier:{nodeName:f.NODE_NAME,value:v}}}),k,J=j=>{if(!oe(j.qualifier.value,N,j.qualifier.delim||E))return j;if(!H){let T={nodeName:g.NODE_NAME,expr:{nodeName:n.NODE_NAME,expr:{nodeName:p.NODE_NAME,select_list:{nodeName:c.NODE_NAME,entries:[]},from_clause:{nodeName:d.NODE_NAME,entries:[{nodeName:g.NODE_NAME,expr:S.table_ref}]}}},alias:{nodeName:y.NODE_NAME,as_kw:!0,value:v}};k=T.expr.expr.select_list.entries,M&&(k.push({nodeName:l.NODE_NAME,expr:M}),L={nodeName:m.NODE_NAME,expr:Y(M)}),H=T}if(k.find(T=>oe(T.expr.value,j.value,T.expr.delim||j.delim))||k.push({nodeName:l.NODE_NAME,expr:j}),!M){let T=Y(j);L&&(T={nodeName:x.NODE_NAME,left:L.expr,operator:"AND",right:T}),L={nodeName:m.NODE_NAME,expr:T}}return{...j,qualifier:{nodeName:f.NODE_NAME,value:v}}},K=[];for(let[,{query:j}]of a)K.push({...j,condition_clause:{...j.condition_clause,expr:{...j.condition_clause.expr,left:J(j.condition_clause.expr.left)}}});let[$,B]=this instanceof o.DeleteStmt?["pg_using_clause","UsingFromClause"]:["pg_from_clause","FromClause"];if(H){let j=g.fromJSON(H,this.options);this._adoptNodes(j),e={...e,[$]:{nodeName:o[B].NODE_NAME,entries:(e[$]?.entries||[]).concat(j.jsonfy(t,r,s))},where_clause:e.where_clause?{nodeName:m.NODE_NAME,expr:{nodeName:x.NODE_NAME,left:L.expr,operator:"AND",right:e.where_clause.expr}}:L}}return[e,K]}return[e,[...a].map(([,{query:n}])=>n)]}};var Le=class extends _e{static get syntaxRules(){return{type:["InsertStmt","UpsertStmt","UpdateStmt","DeleteStmt"]}}finalizeOutputJSON(e,r,s,t){if(e.returning_clause){let a=this.returningClause().finalizeJSON(e.returning_clause,r,s,t);e={...e,returning_clause:a,result_schema:a.result_schema}}else e={...e,result_schema:o.JSONSchema.fromJSON({entries:[]},this.options)};return e}};var fs=class extends et(Le){static get syntaxRules(){let e={type:"punctuation",value:","};return[{type:"keyword",value:"DELETE"},{assert:!0,syntaxes:[{dialect:"postgres",syntax:[{type:"keyword",value:"FROM"},{type:"TableAbstraction2",as:"table_expr"},{type:"UsingFromClause",as:"pg_using_clause",optional:!0,autoIndent:!0},{type:"JoinClause",as:"join_clauses",arity:1/0,optional:!0,autoIndent:!0},{type:["PGWhereCurrentClause","WhereClause"],as:"where_clause",optional:!0,autoIndent:!0},{type:"ReturningClause",as:"returning_clause",optional:!0,autoIndent:!0}]},{dialect:"mysql",syntax:[{type:"Identifier",as:"my_delete_list",arity:{min:1},itemSeparator:e},{type:"FromClause",as:"my_from_clause",autoIndent:!0},{type:"JoinClause",as:"join_clauses",arity:1/0,optional:!0,autoIndent:!0},{type:"WhereClause",as:"where_clause",optional:!0,autoIndent:!0}]},{dialect:"mysql",syntax:[{type:"keyword",value:"FROM"},{type:"Identifier",as:"my_delete_list",arity:{min:1},itemSeparator:e},{type:"UsingFromClause",as:"my_using_clause",autoIndent:!0},{type:"JoinClause",as:"join_clauses",arity:1/0,optional:!0,autoIndent:!0},{type:"WhereClause",as:"where_clause",optional:!0,autoIndent:!0}]},{dialect:"mysql",syntax:[{type:"keyword",value:"FROM"},{type:"TableAbstraction2",as:"table_expr"},{type:"MYPartitionClause",as:"my_partition_clause",optional:!0,autoIndent:!0},{type:"WhereClause",as:"where_clause",optional:!0,autoIndent:!0},{type:"OrderByClause",as:"my_order_by_clause",optional:!0,dialect:"mysql",autoIndent:!0},{type:"LimitClause",as:"my_limit_clause",optional:!0,dialect:"mysql",autoIndent:!0}]}]}]}tableExpr(){return this._get("table_expr")}joinClauses(){return this._get("join_clauses")}whereClause(){return this._get("where_clause")}returningClause(){return this._get("returning_clause")}pgUsingClause(){return this._get("pg_using_clause")}myUsingClause(){return this._get("my_using_clause")}myPartitionClause(){return this._get("my_partition_clause")}myDeleteList(){return this._get("my_delete_list")}myFromClause(){return this._get("my_from_clause")}myOrderByClause(){return this._get("my_order_by_clause")}myLimitClause(){return this._get("my_limit_clause")}jsonfy(e={},r=null,s=null){if(!e.deSugar)return super.jsonfy(e,r,s);r=new ae((a,n)=>n(),r,this);let t=super.jsonfy(e,r,s);return(e.toDialect||this.options.dialect)==="mysql"?t={uuid:t.uuid,nodeName:t.nodeName,my_delete_list:t.my_delete_list,my_from_clause:t.my_from_clause,my_using_clause:t.my_using_clause,join_clauses:t.join_clauses,where_clause:t.where_clause,table_expr:t.table_expr,my_partition_clause:t.my_partition_clause,my_order_by_clause:t.my_order_by_clause,my_limit_clause:t.my_limit_clause,returning_clause:t.returning_clause,result_schema:t.result_schema}:t={uuid:t.uuid,nodeName:t.nodeName,table_expr:t.table_expr,pg_using_clause:t.pg_using_clause,join_clauses:t.join_clauses,where_clause:t.where_clause,returning_clause:t.returning_clause,result_schema:t.result_schema},t=this.finalizeOutputJSON(t,r,s,e),t=this.finalizeSelectorJSON(t,r,s,e),t={...t,origin_schemas:this.getOriginSchemas(r)},t}};var ys=u=>class extends u{get isPayloadStmt(){return!0}static morphsTo(){return o.CTE}jsonfy(e={},r=null,s=null){if(!e.deSugar)return super.jsonfy(e,r,s);let{LQDeepRef2:t,AssignmentExpr:a,DerivedQuery:n,ColumnsConstructor:p,ValuesConstructor:c,TypedRowConstructor:l,RowConstructor:y}=o,d=["column_list","pg_default_values_clause","values_clause","select_clause"].map(E=>this._get(E)),[m,f,x,g]=d,_=m?.entries().some(E=>E instanceof t),S=_?new Set(d):new Set;r=new ae((E,v,w,{deSugar:M,...H})=>{if(S.has(E))return;if(!(E instanceof a))return v();let L=!!this._get("conflict_handling_clause")?.containsNode(E);if(L&&this.options.dialect!=="postgres")return v();let Y={...H,conflictHandlingClauseContext:L};if(E.left()instanceof t){let[[k],[[J]]]=this.deSugarPayload(p.fromJSON({entries:[E.left().jsonfy()]}),[[E.right()]],r,s,Y);return k?{nodeName:a.NODE_NAME,operator:"=",left:k,right:J}:void 0}if(E.left()instanceof p&&E.left().entries().some(k=>k instanceof t)){let k=E.left(),J,K;return E.right()instanceof y?([J,[K]]=this.deSugarPayload(k,[E.right().entries()],r,s,Y),K={nodeName:l.NODE_NAME,entries:K}):E.right()instanceof n?([J,K]=this.deSugarPayload(k,E.right().expr(),r,s,Y),K={nodeName:n.NODE_NAME,expr:K}):[J,[K]]=this.deSugarPayload(k,[[E.right()]],r,s,Y),J.length?{nodeName:a.NODE_NAME,operator:"=",left:{nodeName:p.NODE_NAME,entries:J},right:K}:void 0}return v()},r,this);let N=super.jsonfy(e,r,s);if(_){let[E,v]=this.deSugarPayload(m,f||x?.entries().map(w=>w.entries())||g,r,s,e);if(N={...N,column_list:{nodeName:p.NODE_NAME,entries:E}},f&&Array.isArray(v)||x){let w=v.map(M=>({nodeName:l.NODE_NAME,entries:M}));N={...N,values_clause:{nodeName:c.NODE_NAME,entries:w}}}else f?N={...N,pg_default_values_clause:v}:N={...N,select_clause:v}}return N}deSugarPayload(e,r,s,t,{conflictHandlingClauseContext:a=!1,deSugar:n,...p}={}){let c=s.statementContext.artifacts.get("payloadDimensions"),{LQDeepRef2:l,TableRef1:y,ColumnRef1:d,SelectItemAlias:m,ColumnRef2:f,ColumnsConstructor:x,TypedRowConstructor:g,RowConstructor:_,DefaultLiteral:S,SelectStmt:N,CompleteSelectStmt:E,PGDefaultValuesClause:v,SelectList:w,SelectItem:M,FromClause:H,FromItem:L}=o,Y=(b,G=n)=>b.jsonfy({...p,deSugar:G},s,t),k=(b,G)=>b.entries().reduce((P,W,O)=>{if(W instanceof l){let I=this.createPayloadDimension(W,s,t,{conflictHandlingClauseContext:a,...p});return G.set(O,I),I.refMode==="dependency"&&I.lhsOperandJson?P.concat({nodeName:f.NODE_NAME,value:I.lhsOperandJson.value,delim:I.lhsOperandJson.delim,result_schema:I.lhsOperandJson.result_schema}):P}return P.concat(Y(W))},[]),J=(b,G)=>{let P=e.entries().reduce((W,O,I)=>{let q=G.has(I)?G.get(I).offload(b):{nodeName:S.NODE_NAME,value:"DEFAULT"};return q?W.concat(q):W},[]);return e.length-P.length===G.size?b.jsonfy():[P]},K=(b,G)=>b.map((P,W)=>P.reduce((O,I,q)=>{let A;return e.get(q)instanceof l&&I instanceof S?A=G.get(q).offload(v.fromJSON({value:"DEFAULT"},this.options),W):G.has(q)?A=G.get(q).offload(I,W):A=Y(I),A?O.concat(A):O},[])),$=(b,G)=>{let P={...Y(b,2),result_schema:void 0},W=P.select_list.entries;if(W.length!==e.length)throw new Error(`Select list (${W.length}) does not match columns length (${e.length})`);let O;if(!a&&P.from_clause&&!/^[`"]\$memo~.+[`"]$/.test(b.fromClause().entries()[0].expr()+"")){let A=s.rootContext.rand("memo");O={...P,uuid:A,select_list:{nodeName:w.NODE_NAME,entries:[wa("$row_number~a")]}},c.add({refMode:"memo",query:O});let F={nodeName:L.NODE_NAME,expr:{nodeName:y.NODE_NAME,value:A}};P={nodeName:E.NODE_NAME,select_list:{nodeName:w.NODE_NAME,entries:[]},from_clause:{nodeName:H.NODE_NAME,entries:[F]}}}let I=(A,F=!1)=>O?(A.alias&&F?A={...A,alias:{...A.alias,value:A.alias.value+s.rand("rand",{asSalt:!0})}}:A.alias||(A.alias={nodeName:m.NODE_NAME,as_kw:!0,value:s.rand("value")}),O.select_list.entries.push(A),{nodeName:M.NODE_NAME,expr:{nodeName:d.NODE_NAME,value:A.alias.value,delim:A.alias.delim}}):A,q=W.reduce((A,F,R)=>{if(G.has(R)){let D;[g.NODE_NAME,_.NODE_NAME].includes(F.expr.nodeName)?(D=F.expr.entries.map(se=>I({nodeName:M.NODE_NAME,expr:se,alias:F.alias},!0)),e.get(R).right()instanceof x||(D=[{nodeName:M.NODE_NAME,expr:{nodeName:g.NODE_NAME,entries:D.map(se=>se.expr)}}])):D=[I(F)];let ue=N.fromJSON({...P,select_list:{nodeName:w.NODE_NAME,entries:D}},this.options);if(F=G.get(R).offload(ue),F){let se=G.get(R).lhsOperandJson;return A.concat({nodeName:M.NODE_NAME,expr:F,alias:{nodeName:m.NODE_NAME,as_kw:!0,value:se.value,delim:se.delim}})}return A}if(!F.alias){let D=e.get(R);F={...F,alias:{nodeName:m.NODE_NAME,as_kw:!0,value:D.value(),delim:D._get("delim")}}}return A.concat(I(F))},[]);return P={...P,select_list:{nodeName:w.NODE_NAME,entries:q}},P},B=new Map,j=k(e,B),T=r instanceof v?J(r,B):r instanceof N?$(r,B):K(r,B);return B.clear(),[j,T]}createPayloadDimension(e,r,s,{conflictHandlingClauseContext:t=!1,...a}={}){let{lhsOperand:n,rhsOperand:p,rhsTable:c,detail:l}=e.resolve(r,s,2),y=r.statementContext.artifacts.get("payloadDimensions"),{LQDeepRef2:d,LQBackRefAbstraction:m,ReturningClause:f,ColumnRef2:x,ColumnRef1:g,TableRef1:_,SelectList:S,SelectItem:N,SelectItemAlias:E,AssignmentExpr:v,ColumnsConstructor:w,TypedRowConstructor:M,RowConstructor:H,PGDefaultValuesClause:L,ValuesConstructor:Y,ValuesTableLiteral:k,DefaultLiteral:J,SelectStmt:K,WhereClause:$,CompleteSelectStmt:B,ScalarSubquery:j,DerivedQuery:T,FromItem:b,FromClause:G,SetClause:P,BinaryExpr:W,BoolLiteral:O,NumberLiteral:I,UpdateStmt:q,TableAbstraction2:A}=o,F=r.rootContext.hash(this,"main"),R=U=>U.jsonfy(a,r,s),D=R(n),ue=R(p),se=R(c),le=n.jsonfy({toKind:1}),de=p.jsonfy({toKind:1}),ra={...se,nodeName:_.NODE_NAME},Ne=e.left()instanceof m?"dependent":"dependency",Te=l instanceof d,ve;if(l instanceof w)ve=R(l);else if(l instanceof x||l instanceof d)ve={nodeName:w.NODE_NAME,entries:[R(l)]};else throw new Error(`Invalid columns spec: ${e}`);let da=ve.entries.length,$e=(U,Q=null)=>{if(Te)return U;let ne=1;if(Q?ne=Q.length:U instanceof H||U instanceof K||U instanceof K?ne=U.length:U instanceof T&&(ne=U.expr().length),ne>da)throw new Error(`[${U}] Payload has more columns than target columns: ${l}.`);if(ne<da)throw new Error(`[${U}] Payload has fewer columns than target columns: ${l}.`);return U},yt=(U,Q,ne=null,pe=null)=>{let V,Z;typeof ne=="number"?Z={nodeName:I.NODE_NAME,value:ne+1}:ne&&(Z=ne),Z?V={nodeName:W.NODE_NAME,left:{nodeName:g.NODE_NAME,value:"$row_number~b"},operator:"=",right:Z}:pe&&(V={nodeName:W.NODE_NAME,left:{nodeName:g.NODE_NAME,value:pe},operator:"IS",right:{nodeName:O.NODE_NAME,value:"TRUE"}});let te={nodeName:b.NODE_NAME,expr:{nodeName:_.NODE_NAME,value:Z?`${U}~indices`:U}},st={nodeName:B.NODE_NAME,select_list:{nodeName:S.NODE_NAME,entries:[{nodeName:N.NODE_NAME,expr:{...Q,qualifier:void 0}}]},from_clause:{nodeName:G.NODE_NAME,entries:[te]},where_clause:V&&{nodeName:$.NODE_NAME,expr:V}};return{nodeName:j.NODE_NAME,expr:st}};if(this instanceof q||t){let U=t?`${F}_conflict_based_update`:null,Q={nodeName:W.NODE_NAME,left:de,operator:"IN",right:yt(F,D,null,U)},ne={uuid:r.rootContext.rand(Ne),nodeName:q.NODE_NAME,table_expr:{nodeName:A.NODE_NAME,table_ref:ra},set_clause:{nodeName:P.NODE_NAME,entries:[]},where_clause:{nodeName:$.NODE_NAME,expr:Q}},V={refMode:Ne,query:ne,offload:Z=>{if(Z instanceof k)throw new Error(`Single-row payload structure expected for column structure: ${l}. Recieved ${Z.NODE_NAME}.`);if(ne.set_clause.entries.length)throw new Error(`Unexpected multiple offload() call on ${e}`);let te=R(Z);if(Te&&!(Z instanceof L)&&(Z=M.fromJSON({entries:[te]},this.options),te=R(Z)),Z instanceof K?(te={nodeName:T.NODE_NAME,expr:te,result_schema:te.result_schema},$e(Z,te.result_schema)):Z instanceof T?$e(Z,te.result_schema):Z instanceof H?$e(Z):Z instanceof L||(te={nodeName:M.NODE_NAME,entries:[te]}),ne.set_clause.entries.push({nodeName:v.NODE_NAME,left:ve,operator:"=",right:te}),Ne==="dependency")return le},lhsOperandJson:D,conflictHandlingClauseContext:t};return y.add(V),V}let ye=[],sa=(U,Q,ne=null)=>{if(Q instanceof L)if(ne){let pe=U.column_list.entries.length-1;U.values_clause.entries.push({nodeName:M.NODE_NAME,entries:U.column_list.entries.map((V,Z)=>Z===pe?ne:{nodeName:J.NODE_NAME,value:"DEFAULT"})})}else delete U.values_clause,U.pg_default_values_clause=R(Q);else{$e(Q);let pe=R(Q);Q instanceof H||(pe={nodeName:M.NODE_NAME,entries:[pe]}),ne&&(pe={...pe,entries:pe.entries.concat(ne)}),U.values_clause.entries.push(pe)}};if(Ne==="dependent"){let U=()=>({uuid:r.rootContext.rand(Ne),nodeName:this.NODE_NAME,table_ref:se,column_list:w.fromJSON({entries:ve.entries.concat(ue)}).jsonfy()}),Q=(V,Z)=>{let te={nodeName:N.NODE_NAME,expr:Z,alias:p instanceof x?{nodeName:E.NODE_NAME,as_kw:!0,value:p.value(),delim:p._get("delim")}:void 0};return{...V,select_list:{...V.select_list,entries:V.select_list.entries.concat(te)}}},pe={refMode:Ne,queries:ye,offload:(V,Z=null)=>{ye.length||ye.push(U());let te=ye[ye.length-1];V instanceof K&&(Z={nodeName:g.NODE_NAME,value:"$row_number~a"});let st=yt(F,D,Z),ga;if(V instanceof T&&(V=V.expr(),(te.select_clause||te.values_clause)&&(te=U(),ye.push(te)),ga=!0),V instanceof K){let Be=R(V);!ga&&!Te&&(Be=ba(Be,ve)),$e(V,Be.result_schema),te.select_clause=Q(Be,st);return}if(te.select_clause&&(te=U(),ye.push(te)),te.values_clause||(te.values_clause={nodeName:Y.NODE_NAME,entries:[]}),Te&&!(V instanceof L)&&(V=M.fromJSON({entries:[R(V)]})),V instanceof k)for(let Be of V.entries())sa(te,Be,st);else sa(te,V,st)},lhsOperandJson:D};return y.add(pe),pe}let _a={nodeName:g.NODE_NAME,value:p.value(),delim:p._get("delim")},aa=()=>({uuid:r.rootContext.rand(Ne),nodeName:this.NODE_NAME,table_ref:se,column_list:ve,returning_clause:{nodeName:f.NODE_NAME,entries:[{nodeName:N.NODE_NAME,expr:de}]}}),ha={refMode:Ne,queries:ye,offload:U=>{if(U instanceof k)throw new Error(`Single-row payload structure expected for column structure: ${e.right()}. Recieved ${U.NODE_NAME}.`);ye.length||ye.push(aa());let Q=ye[ye.length-1],ne=!1;if(U instanceof T&&(U=U.expr(),(Q.select_clause||Q.values_clause)&&(Q=aa(),ye.push(Q)),ne=!0),U instanceof K){let V=R(U),Z;return ne||(Te||(V=ba(V,ve)),Z={nodeName:g.NODE_NAME,value:"$row_number~a"}),$e(U,V.result_schema),Q.select_clause=V,yt(Q.uuid,_a,Z)}Q.select_clause&&(Q=aa(),ye.push(Q)),Q.values_clause||(Q.values_clause={nodeName:Y.NODE_NAME,entries:[]}),Te&&!(U instanceof L)&&(U=M.fromJSON({entries:[R(U)]})),sa(Q,U);let pe;return Q.values_clause&&(pe=Q.values_clause.entries.length-1),yt(Q.uuid,_a,pe)},lhsOperandJson:D,rhsOperandJson:de};return y.add(ha),ha}finalizePayloadJSON(e,r,s,t){let a=r.statementContext.artifacts.get("payloadDimensions");if(!a.size)return e;let{ColumnRef0:n,ColumnRef1:p,TableRef1:c,FromItem:l,FromClause:y,AggrCallExpr:d,ReturningClause:m,SelectList:f,SelectItem:x,SelectItemAlias:g,NumberLiteral:_,BinaryExpr:S,CTE:N,CTEItem:E,CTEItemAlias:v,CompleteSelectStmt:w,UpdateStmt:M}=o,H=r.rootContext.hash(this,"main"),L={nodeName:N.NODE_NAME,declarations:[],body:null},Y=r,k=(T,b,G=[],P=Y)=>{let W=E.fromJSON({nodeName:E.NODE_NAME,alias:{nodeName:v.NODE_NAME,value:T},expr:b},this.options).jsonfy(t,P,s);if(W.expr?.nodeName===N.NODE_NAME){if(L.declarations.push(...W.expr.declarations),this instanceof M&&W.expr.body.nodeName===w.NODE_NAME)return;W={nodeName:E.NODE_NAME,alias:{nodeName:v.NODE_NAME,value:T},expr:W.expr.body}}L.declarations.push(W),G.length&&L.declarations.push(E.fromJSON({nodeName:E.NODE_NAME,alias:{nodeName:v.NODE_NAME,value:`${T}~indices`},expr:Ha(G,T)},this.options).jsonfy(t,P,s))},J=[],K=[],$=[],B=!1,j=e.returning_clause?.entries||[];for(let{refMode:T,query:b,queries:G,lhsOperandJson:P,rhsOperandJson:W,conflictHandlingClauseContext:O}of a)for(let{uuid:I,...q}of b&&[b]||G)if(T==="dependent"||this instanceof M&&T==="dependency"||O){if(!$.find(A=>oe(A.expr.value,P.value))){let A={nodeName:x.NODE_NAME,expr:P};j.find(F=>oe((F.alias||F.expr).value,P.value))&&(A.alias={nodeName:g.NODE_NAME,as_kw:!0,value:r.rand("key")}),$.push(A)}O&&(B=!0),J.push({uuid:I,...q})}else if(T==="dependency"){let A=[{nodeName:x.NODE_NAME,expr:W}];e.select_clause?K.push({uuid:I,wherePredicate:A,...q}):q.pg_default_values_clause||q.select_clause?k(I,q):k(I,q,A)}else k(I,q);for(let{uuid:T,wherePredicate:b,...G}of K)k(T,G,b);if(J.length){let T=[],b=[];for(let O of j)O.alias||(O={...O,alias:{nodeName:g.NODE_NAME,as_kw:!0,value:r.rand("key")}}),T.push(O),b.push({...O,expr:{nodeName:p.NODE_NAME,value:O.alias.value,delim:O.alias.delim}});if(B){let O=`${H}_conflict_based_update`;T.push({nodeName:x.NODE_NAME,expr:{nodeName:S.NODE_NAME,left:{nodeName:p.NODE_NAME,value:"XMAX"},operator:"!=",right:{nodeName:_.NODE_NAME,value:"0"}},alias:{nodeName:g.NODE_NAME,as_kw:!0,value:O}})}let G={nodeName:m.NODE_NAME,entries:[...T,...$]};this instanceof M||B?k(H,{...e,returning_clause:G}):e.pg_default_values_clause?k(H,{...e,returning_clause:G}):k(H,{...e,returning_clause:G},$);for(let{uuid:O,...I}of J)k(O,I);let P=b;P.length||(P=[{nodeName:x.NODE_NAME,expr:{nodeName:d.NODE_NAME,name:"COUNT",arguments:[{nodeName:n.NODE_NAME,value:"*"}]},alias:{nodeName:g.NODE_NAME,as_kw:!0,value:"COUNT"}}]);let W={nodeName:l.NODE_NAME,expr:{nodeName:c.NODE_NAME,value:H}};L.body=w.fromJSON({nodeName:w.NODE_NAME,select_list:{nodeName:f.NODE_NAME,entries:P},from_clause:{nodeName:y.NODE_NAME,entries:[W]}},this.options).jsonfy(t,Y,s)}else{let b=[this.constructor].concat(this.constructor.morphsTo()).reduce((G,P)=>G||P.fromJSON(e,this.options),void 0);L.body=b.jsonfy(t,Y,s)}return{...L,origin_schemas:L.body.origin_schemas,result_schema:L.body.result_schema}}},ba=(u,e)=>{let r=u.select_list.entries.reduce((s,t,a)=>{if(!t.alias){let n=e.entries[a];t={...t,alias:{nodeName:o.SelectItemAlias.NODE_NAME,as_kw:!0,value:n.value,delim:n.delim}}}return s.concat(t)},[]);return{...u,select_list:{...u.select_list,entries:r}}},Ha=(u,e)=>{let r=wa("$row_number~b");u=u.map(t=>t.alias?{...t,expr:{...t.expr,value:t.alias.value,delim:t.alias.delim,qualifier:void 0},alias:{...t.alias,value:t.expr.value,delim:t.expr.delim}}:t.expr.nodeName===o.ColumnRef0.NODE_NAME?i:{...t,expr:{...t.expr,qualifier:void 0},alias:{nodeName:o.SelectItemAlias.NODE_NAME,as_kw:!0,value:t.expr.value,delim:t.expr.delim}}).concat(r);let s={nodeName:o.FromItem.NODE_NAME,expr:{nodeName:o.TableRef1.NODE_NAME,value:e}};return{nodeName:o.CompleteSelectStmt.NODE_NAME,select_list:{nodeName:o.SelectList.NODE_NAME,entries:u},from_clause:{nodeName:o.FromClause.NODE_NAME,entries:[s]}}},wa=u=>({nodeName:o.SelectItem.NODE_NAME,expr:{nodeName:o.AggrCallExpr.NODE_NAME,name:"ROW_NUMBER",arguments:[],over_clause:{nodeName:o.WindowSpec.NODE_NAME}},alias:{nodeName:o.SelectItemAlias.NODE_NAME,as_kw:!0,value:u||3}});var Pe=class extends ys(Le){static get _clause(){return"INSERT"}static get syntaxRules(){let e={optional:!0,syntax:[{type:"keyword",value:"AS",booleanfy:!0},{type:"Identifier",as:"pg_table_alias",assert:!0}]},r={optional:!0,dialect:"mysql",if:["!select_clause","!my_table_clause"],syntax:[{type:"keyword",value:"AS"},{type:"FromItemAlias",as:"my_row_alias",assert:!0}]};return[{type:"keyword",value:this._clause},{type:"keyword",value:"INTO"},{assert:!0,syntax:[{dialect:"postgres",syntax:[{type:"TableRef2",as:"table_ref"},{...e},{type:"ColumnsConstructor",as:"column_list",optional:!0,autoIndent:!0},{syntaxes:[{type:"PGDefaultValuesClause",as:"pg_default_values_clause"},{type:"ValuesConstructor",as:"values_clause"},{type:"SelectStmt",as:"select_clause"}],autoSpacing:`
`},...this._clause==="INSERT"?[{type:"PGOnConflictClause",as:"conflict_handling_clause",optional:!0,autoSpacing:`
`}]:[],{type:"ReturningClause",as:"returning_clause",optional:!0,autoSpacing:`
`}]},{dialect:"mysql",syntax:[{type:"TableRef2",as:"table_ref"},{type:"MYPartitionClause",as:"my_partition_clause",optional:!0,autoIndent:!0},{syntaxes:[[{type:"ColumnsConstructor",as:"column_list",optional:!0,autoIndent:!0},{syntaxes:[{type:"ValuesConstructor",as:"values_clause"},{type:"SelectStmt",as:"select_clause"},{type:"TableStmt",as:"my_table_clause"}],autoSpacing:`
`}],{type:"SetClause",as:"my_set_clause",autoSpacing:`
`}]},{...r},...this._clause==="INSERT"?[{type:"MYOnDuplicateKeyUpdateClause",as:"conflict_handling_clause",optional:!0,autoSpacing:`
`}]:[],{type:"ReturningClause",as:"returning_clause",optional:!0,autoSpacing:`
`}]}]}]}tableRef(){return this._get("table_ref")}columnList(){return this._get("column_list")}valuesClause(){return this._get("values_clause")}selectClause(){return this._get("select_clause")}conflictHandlingClause(){return this._get("conflict_handling_clause")}returningClause(){return this._get("returning_clause")}pgTableAlias(){return this._get("pg_table_alias")}pgDefaultValuesClause(){return this._get("pg_default_values_clause")}myRowAlias(){return this._get("my_row_alias")}myPartitionClause(){return this._get("my_partition_clause")}mySetClause(){return this._get("my_set_clause")}myTableClause(){return this._get("my_table_clause")}jsonfy(e={},r=null,s=null){if(!e.deSugar)return super.jsonfy(e,r,s);r=new ae((n,p)=>{if(n instanceof o.TableRef2){let c=p(),l=c.result_schema;return c.pg_table_alias&&(l=l.clone({renameTo:c.pg_table_alias})),r.statementContext.artifacts.get("tableSchemas").add({type:"dml",resultSchema:l}),c}return p()},r,this);let t=super.jsonfy(e,r,s),a=e.toDialect||this.options.dialect;if(a==="mysql"?t={uuid:t.uuid,nodeName:t.nodeName,table_ref:t.table_ref,my_partition_clause:t.my_partition_clause,column_list:t.column_list,values_clause:t.values_clause,select_clause:t.select_clause,my_table_clause:t.my_table_clause,my_set_clause:t.my_set_clause,my_row_alias:t.my_row_alias,conflict_handling_clause:t.conflict_handling_clause,returning_clause:t.returning_clause,result_schema:t.result_schema}:t={uuid:t.uuid,nodeName:t.nodeName,table_ref:t.table_ref,pg_table_alias:t.pg_table_alias,column_list:t.column_list,pg_default_values_clause:t.pg_default_values_clause,values_clause:t.values_clause,select_clause:t.select_clause,conflict_handling_clause:t.conflict_handling_clause,returning_clause:t.returning_clause,result_schema:t.result_schema},t.conflict_handling_clause?.entries&&!t.conflict_handling_clause.entries.length){let p=t.table_ref.result_schema.pkConstraint(!0).columns()[0];t={...t,conflict_handling_clause:{...t.conflict_handling_clause,entries:[{nodeName:o.AssignmentExpr.NODE_NAME,left:p.jsonfy(),operator:"=",right:p.jsonfy({toKind:1})}]}}}return a==="postgres"&&!t.pg_table_alias&&(e.deSugar===!0||Number(e.deSugar?.tableAliases)===1)&&(t={...t,pg_table_alias:{nodeName:o.Identifier.NODE_NAME,value:t.table_ref.value,delim:t.table_ref.delim}}),t=this.finalizeOutputJSON(t,r,s,e),t={...t,origin_schemas:this.getOriginSchemas(r)},t=this.finalizePayloadJSON(t,r,s,e),t}};var ms=class extends C{static get syntaxRules(){return[{type:"keyword",value:"SET"},{type:"MYVarAssignmentExpr",as:"entries",arity:{min:1},itemSeparator:{type:"punctuation",value:","},assert:!0,autoIndent:2}]}};var ds=class extends ys(et(Le)){static get syntaxRules(){return[{type:"keyword",value:"UPDATE"},{assert:!0,syntaxes:[{dialect:"postgres",syntax:[{type:"TableAbstraction2",as:"table_expr"},{type:"SetClause",as:"set_clause",autoSpacing:`
`},{type:"FromClause",as:"pg_from_clause",optional:!0,dialect:"postgres",autoSpacing:`
`},{type:"JoinClause",as:"join_clauses",arity:1/0,optional:!0,autoSpacing:`
`},{type:["PGWhereCurrentClause","WhereClause"],as:"where_clause",optional:!0,autoSpacing:`
`},{type:"ReturningClause",as:"returning_clause",optional:!0,autoSpacing:`
`}]},{dialect:"mysql",syntax:[{type:"TableAbstraction2",as:"table_expr"},{type:"SetClause",as:"set_clause",autoSpacing:`
`},{type:"WhereClause",as:"where_clause",optional:!0,autoSpacing:`
`},{type:"OrderByClause",as:"my_order_by_clause",optional:!0,autoSpacing:`
`},{type:"LimitClause",as:"my_limit_clause",optional:!0,autoSpacing:`
`},{type:"ReturningClause",as:"returning_clause",optional:!0,autoSpacing:`
`}]},{dialect:"mysql",syntax:[{type:"TableAbstraction1",as:"my_update_list",arity:{min:1},itemSeparator:{type:"punctuation",value:","}},{type:"JoinClause",as:"join_clauses",arity:1/0,optional:!0,autoSpacing:`
`},{type:"SetClause",as:"set_clause",autoSpacing:`
`},{type:"WhereClause",as:"where_clause",optional:!0,autoSpacing:`
`},{type:"ReturningClause",as:"returning_clause",optional:!0,autoSpacing:`
`}]}]}]}tableExpr(){return this._get("table_expr")}joinClauses(){return this._get("join_clauses")}setClause(){return this._get("set_clause")}whereClause(){return this._get("where_clause")}returningClause(){return this._get("returning_clause")}pgFromClause(){return this._get("pg_from_clause")}myUpdateList(){return this._get("my_update_list")}myOrderByClause(){return this._get("my_order_by_clause")}myLimitClause(){return this._get("my_limit_clause")}jsonfy(e={},r=null,s=null){if(!e.deSugar)return super.jsonfy(e,r,s);let t={set_clause:null};r=new ae((n,p)=>{if(n instanceof o.SetClause){t.set_clause=p;return}return p()},r,this);let a=super.jsonfy(e,r,s);if(a={...a,set_clause:t.set_clause()},(e.toDialect||this.options.dialect)==="mysql"?a={uuid:a.uuid,nodeName:a.nodeName,table_expr:a.table_expr,my_update_list:a.my_update_list,join_clauses:a.join_clauses,set_clause:a.set_clause,where_clause:a.where_clause,my_order_by_clause:a.my_order_by_clause,my_limit_clause:a.my_limit_clause,returning_clause:a.returning_clause,result_schema:a.result_schema}:a={uuid:a.uuid,nodeName:a.nodeName,table_expr:a.table_expr,set_clause:a.set_clause,pg_from_clause:a.pg_from_clause,join_clauses:a.join_clauses,where_clause:a.where_clause,returning_clause:a.returning_clause,result_schema:a.result_schema},!a.set_clause?.entries.length){let p=a.table_expr.result_schema.pkConstraint(!0).columns()[0];a={...a,set_clause:{...a.set_clause,entries:[{nodeName:o.AssignmentExpr.NODE_NAME,left:p.jsonfy(),operator:"=",right:p.jsonfy({toKind:1})}]}}}return a=this.finalizeOutputJSON(a,r,s,e),a=this.finalizeSelectorJSON(a,r,s,e),a={...a,origin_schemas:this.getOriginSchemas(r)},a=this.finalizePayloadJSON(a,r,s,e),a}};var _s=class extends Ke(Pe){static get _clause(){return"UPSERT"}static morphsTo(){return[Pe].concat(super.morphsTo())}finalizePayloadJSON(e,r,s,t){if(e.conflict_handling_clause)throw new Error("An explicit conflict handling clause is forbidden on the UPSERT statement.");let a=[...r.statementContext.artifacts.get("tableSchemas")].map(l=>l.resultSchema)[0],n=t.toDialect||this.options.dialect,p;e.my_set_clause?p=e.my_set_clause.entries.map(l=>({value:l.left.value,delim:l.left.delim})):e.column_list?p=e.column_list.entries.map(l=>({value:l.value,delim:l.delim})):p=a.columns().map(l=>l.name().jsonfy({nodeNames:!1}));let c={nodeName:n==="mysql"?o.MYOnDuplicateKeyUpdateClause.NODE_NAME:o.PGOnConflictClause.NODE_NAME,entries:p.map(l=>({nodeName:o.AssignmentExpr.NODE_NAME,left:{nodeName:n==="mysql"?o.ColumnRef1.NODE_NAME:o.ColumnRef2.NODE_NAME,...l},operator:"=",right:{...l,nodeName:o.ColumnRef1.NODE_NAME,qualifier:{value:n==="mysql"?"VALUES":"EXCLUDED"}}}))};if(n==="postgres"){let l=[].concat(a.pkConstraint(!0)||[]).concat(a.ukConstraints(!0)).map(d=>d.columns().map(m=>m.jsonfy()));if(!l.length)throw new Error(`Table ${this.tableRef()} has no unique keys defined to process an UPSERT operation. You may want to perform a direct INSERT operation.`);let y=l.find(d=>d.find(m=>p.find(f=>oe(m.value,f.value,m.delim||f.delim))))||l[0];c.conflict_target={nodeName:o.PGConflictTarget.NODE_NAME,index_list:y.map(d=>({nodeName:o.PGConflictTargetIndexSpec.NODE_NAME,column_name:d}))}}return super.finalizePayloadJSON({...e,nodeName:Pe.NODE_NAME,conflict_handling_clause:c},r,s,t)}};var fa={};Ce(fa,{BasicSelectStmt:()=>rt,CompleteSelectStmt:()=>Vs,CompositeSelectStmt:()=>Qs,DerivedQuery:()=>Ye,DistinctClause:()=>hs,ForClause:()=>gs,FromClause:()=>xs,FromItem:()=>tt,FromItemAlias:()=>Js,GroupByClause:()=>Ns,GroupingElement:()=>Es,HavingClause:()=>Ss,JoinClause:()=>As,LimitClause:()=>Ts,OffsetClause:()=>Os,OnClause:()=>Rs,OrderByClause:()=>vs,OrderElement:()=>Cs,PGFetchClause:()=>ws,PGOrderOperator:()=>ks,PartitionByClause:()=>bs,SRFExpr1:()=>Fs,SRFExpr2:()=>qs,SRFExpr3:()=>Gs,SRFExpr4:()=>Ys,SRFExprDDL1:()=>Ws,SRFExprDDL2:()=>Ks,SelectItem:()=>$s,SelectItemAlias:()=>Bs,SelectList:()=>ze,SelectStmt:()=>Ue,TableStmt:()=>Xs,UsingClause:()=>Ds,ValuesTableLiteral:()=>Hs,WhereClause:()=>Is,WindowClause:()=>Ms,WindowDeclaration:()=>Ls,WindowFrameBound:()=>Us,WindowFrameSpec:()=>Ps,WindowSpec:()=>js});var hs=class extends h{static get syntaxRules(){return{syntaxes:[{dialect:"postgres",syntax:[{type:"keyword",value:"DISTINCT"},{type:"keyword",value:"ON"},{type:"paren_block",syntax:{type:"Expr",as:"pg_distinct_on_list",arity:{min:1},itemSeparator:{type:"punctuation",value:","},assert:!0}}]},{type:"keyword",as:"all_or_distinct",value:["ALL","DISTINCT"]}]}}allOrDistinct(){return this._get("all_or_distinct")}pgDistinctOnList(){return this._get("pg_distinct_on_list")}};var gs=class extends h{static get syntaxRules(){return[{type:"keyword",value:"FOR"},{optional:!0,dialect:"postgres",syntaxes:[[{type:"keyword",as:"pg_no_key_kw",value:"NO",booleanfy:!0},{type:"keyword",value:"KEY",if:"pg_no_key_kw",assert:!0}],{type:"keyword",as:"pg_key_kw",value:"KEY",booleanfy:!0}]},{type:"keyword",as:"intent_kw",value:["UPDATE","SHARE"],assert:!0},{optional:!0,syntax:[{type:"keyword",value:"OF"},{type:"TableRef2",as:"table_names",arity:{min:1},itemSeparator:{type:"punctuation",value:","},assert:!0}]},{optional:!0,syntaxes:[[{type:"keyword",as:"skip_locked_kw",value:"SKIP",booleanfy:!0},{type:"keyword",value:"LOCKED",assert:!0}],{type:"keyword",as:"nowait_kw",value:"NOWAIT",booleanfy:!0},{dialect:"mysql",syntax:[{type:"keyword",as:"my_lock_in_share_mode",value:"LOCK",booleanfy:!0},{type:"operator",value:"IN",assert:!0},{type:"keyword",value:"SHARE",assert:!0},{type:"keyword",value:"MODE",assert:!0}]}]}]}intentKW(){return this._get("intent_kw")}tableNames(){return this._get("table_names")}skipLockedKW(){return this._get("skip_locked_kw")}nowaitKW(){return this._get("nowait_kw")}pgKeyKW(){return this._get("pg_key_kw")}pgNoKeyKW(){return this._get("pg_no_key_kw")}myLockInShareMode(){return this._get("my_lock_in_share_mode")}};var xs=class extends C{static get syntaxRules(){return[{type:"keyword",value:"FROM"},{type:"FromItem",as:"entries",arity:{min:1},itemSeparator:{type:"punctuation",value:","},assert:!0}]}};var Ns=class extends C{static get syntaxRules(){return[{type:"keyword",value:"GROUP"},{type:"keyword",value:"BY",assert:!0},{type:"keyword",as:"all_or_distinct",value:["ALL","DISTINCT"],optional:!0},{type:"GroupingElement",as:"entries",arity:{min:1},itemSeparator:{type:"punctuation",value:","},assert:!0,autoIndent:2},{optional:!0,autoIndent:!0,syntax:[{type:"keyword",as:"with_rollup",value:"WITH",booleanfy:!0},{type:"keyword",value:"ROLLUP",assert:!0}]}]}allOrDistinct(){return this._get("all_or_distinct")}withRollup(){return this._get("with_rollup")}};var Es=class extends h{static get syntaxRules(){return{syntaxes:[[{type:"keyword",value:"GROUPING SETS"},{type:"paren_block",syntax:{type:"GroupingElement",as:"grouping_sets",arity:{min:1},itemSeparator:{type:"punctuation",value:","},assert:!0,autoIndent:2},autoIndent:!0}],[{type:"keyword",value:"ROLLUP"},{type:"RowConstructor",as:"rollup_set",assert:!0}],[{type:"keyword",value:"CUBE"},{type:"RowConstructor",as:"cube_set",assert:!0}],{type:"Expr",as:"expr"}]}}groupingSets(){return this._get("grouping_sets")}rollupSet(){return this._get("rollup_set")}cubeSet(){return this._get("cube_set")}expr(){return this._get("expr")}};var Ss=class extends h{static get syntaxRules(){return[{type:"keyword",value:"HAVING"},{type:"Expr",as:"expr",assert:!0}]}static get syntaxPriority(){return-1}expr(){return this._get("expr")}};var tt=class extends X(h){static get syntaxRules(){let e={type:"punctuation",value:","};return{syntaxes:[[{type:"keyword",as:"lateral_kw",value:"LATERAL",booleanfy:!0,optional:!0},{type:"SRFExpr1",as:"expr"}],[{type:"keyword",as:"lateral_kw",value:"LATERAL",booleanfy:!0,optional:!0},{type:["SRFExpr2","SRFExpr4"],as:"expr"},{type:"FromItemAlias",as:"alias",optional:!0}],[{type:"keyword",as:"lateral_kw",value:"LATERAL",booleanfy:!0,optional:!0},{type:["DerivedQuery","ValuesTableLiteral"],as:"expr",dialect:"postgres"},{type:"DerivedQuery",as:"expr",dialect:"mysql"},{type:"FromItemAlias",as:"alias",optional:!0}],[{type:"keyword",as:"pg_only_kw",value:"ONLY",optional:!0,dialect:"postgres"},{type:["TableRef1","TableRef2"],as:"expr"},{type:"operator",as:"pg_star_ref",value:"*",booleanfy:!0,optional:!0,dialect:"postgres"},{type:"FromItemAlias",as:"alias",optional:!0},{...{optional:!0,dialect:"postgres",syntax:[{type:"keyword",value:"TABLESAMPLE"},{syntaxes:[[{type:"keyword",as:"pg_sampling_method",value:["BERNOULLI","SYSTEM"]},{type:"paren_block",syntax:{type:"Expr",as:"pg_sampling_arguments",arity:1,itemSeparator:e,assert:!0}}],[{type:"identifier",as:"pg_sampling_method"},{type:"paren_block",syntax:{type:"Expr",as:"pg_sampling_arguments",arity:1/0,itemSeparator:e,assert:!0}}]],assert:!0},{optional:!0,syntax:[{type:"keyword",value:"REPEATABLE"},{type:"paren_block",syntax:{type:"Expr",as:"pg_repeatable_seed"},assert:!0}]}]}}]]}}lateralKW(){return this._get("lateral_kw")}expr(){return this._get("expr")}alias(){return this._get("alias")}pgOnlyKW(){return this._get("pg_only_kw")}pgStarRef(){return this._get("pg_star_ref")}pgSamplingMethod(){return this._get("pg_sampling_method")}pgSamplingArguments(){return this._get("pg_sampling_arguments")}pgRepeatableSeed(){return this._get("pg_repeatable_seed")}deriveAlias(){let e;if(this.alias()?.value()?e={as_kw:!0,value:this.alias().value(),delim:this.alias()._get("delim")}:this.expr()instanceof o.TableRef1||this.expr()instanceof o.TableRef2?e={as_kw:!0,value:this.expr().value(),delim:this.expr()._get("delim")}:this.expr()instanceof o.SRFExpr1&&this.expr().qualif()instanceof o.SRFExprDDL2&&(e={as_kw:!0,value:this.expr().qualif().alias().value(),delim:this.expr().qualif().alias()._get("delim")}),e)return o.FromItemAlias.fromJSON(e)}jsonfy(e={},r=null,s=null){let t=super.jsonfy(e,r,s);if(e.deSugar){let a=t.alias||this.deriveAlias()?.jsonfy(),n=a?.value&&{nodeName:o.Identifier.NODE_NAME,value:a.value,delim:a.delim},p=t.expr.result_schema;if(p instanceof o.TableSchema?p=p.clone({renameTo:n}):n&&(p=o.TableSchema.fromJSON({name:n,entries:p?.entries().map(l=>l.jsonfy())||[]},{assert:!0})),t.alias?.columns?.length){if(t.alias.columns.length!==p.length)throw new SyntaxError(`[${this}] Number of column aliases must match number of result columns.`);p=p.clone({},new ae((l,y,d)=>typeof d=="number"&&l.parentNode===p?l instanceof o.ColumnSchema?l.jsonfy({renameTo:t.alias.columns[d]}):{...l.jsonfy(),nodeName:o.ColumnSchema.NODE_NAME,name:t.alias.columns[d]}:y()))}r.statementContext.artifacts.get("tableSchemas").add({type:this.joinType?.()||"dql",lateral:this.lateralKW(),resultSchema:p});let c=!(this.expr()instanceof o.SRFExpr1)&&(e.deSugar===!0||Number(e.deSugar?.tableAliases)===1||e.deSugar?.tableAliases===-1&&(this.parentNode?.length||0)>1)&&a||t.alias;t={...t,alias:c,result_schema:p}}return t}};var As=class extends tt{static get syntaxRules(){return{syntaxes:[[{type:"keyword",as:"join_type",value:"CROSS"},{type:"keyword",value:"JOIN",assert:!0},...[].concat(super.syntaxRules)],[{type:"keyword",as:"natural_kw",value:"NATURAL",booleanfy:!0,optional:!0},{optional:!0,syntaxes:[{type:"keyword",as:"join_type",value:"INNER"},[{type:"keyword",as:"join_type",value:["LEFT","RIGHT","FULL"],dialect:"postgres"},{type:"keyword",as:"join_type",value:["LEFT","RIGHT"],dialect:"mysql"},{type:"keyword",as:"outer_kw",value:"OUTER",booleanfy:!0,optional:!0}]]},{type:"keyword",value:"JOIN"},...[].concat(super.syntaxRules),{type:["OnClause","UsingClause"],as:"condition_clause",if:"!natural_kw",assert:!0,autoIndent:!0}]]}}naturalKW(){return this._get("natural_kw")}joinType(){return this._get("join_type")}outerKW(){return this._get("outer_kw")}conditionClause(){return this._get("condition_clause")}jsonfy(e={},r=null,s=null){let t;e.deSugar&&(r=new ae((n,p,c)=>{if(c==="condition_clause")t=p;else return p()},r,this.statementNode));let a=super.jsonfy(e,r,s);return t&&(a={...a,condition_clause:t()}),a}};var Ts=class extends h{static get syntaxRules(){return[{type:"keyword",value:"LIMIT"},{dialect:"mysql",syntax:[{optional:!0,syntax:[{type:"Expr",as:"my_offset"},{type:"punctuation",value:",",autoSpacing:!1}]},{type:"Expr",as:"expr",assert:!0}]},{dialect:"postgres",syntaxes:[{type:"keyword",as:"pg_all_kw",value:"ALL"},{type:"Expr",as:"expr",assert:!0}]}]}expr(){return this._get("expr")}pgAllKW(){return this._get("pg_all_kw")}myOffset(){return this._get("my_offset")}};var Os=class extends h{static get syntaxRules(){return[{type:"keyword",value:"OFFSET"},{type:"Expr",as:"expr",assert:!0},{type:"keyword",as:"pg_row_kw",value:["ROW","ROWS"],optional:!0,dialect:"postgres"}]}expr(){return this._get("expr")}pgRowKW(){return this._get("pg_row_kw")}};var Rs=class extends h{static get syntaxRules(){return[{type:"keyword",value:"ON"},{type:"Expr",as:"expr",assert:!0}]}expr(){return this._get("expr")}};var vs=class extends C{static get syntaxRules(){return[{type:"keyword",value:"ORDER"},{type:"keyword",value:"BY",assert:!0},{type:"OrderElement",as:"entries",arity:{min:1},itemSeparator:{type:"punctuation",value:","},assert:!0,autoIndent:2},{optional:!0,autoIndent:!0,syntax:[{type:"keyword",as:"with_rollup",value:"WITH",booleanfy:!0},{type:"keyword",value:"ROLLUP",assert:!0}]}]}withRollup(){return this._get("with_rollup")}};var Cs=class extends h{static get syntaxRules(){return[{type:"Expr",as:"expr"},{optional:!0,syntaxes:[{type:"keyword",value:["ASC","DESC"],as:"dir"},{type:"PGOrderOperator",as:"dir"}]},{optional:!0,syntax:[{type:"keyword",value:"NULLS"},{type:"keyword",as:"nulls_spec",value:["FIRST","LAST"],assert:!0}]}]}expr(){return this._get("expr")}dir(){return this._get("dir")}nullsSpec(){return this._get("nulls_spec")}};var bs=class extends C{static get syntaxRules(){return[{type:"keyword",value:"PARTITION"},{type:"keyword",value:"BY",assert:!0},{type:"Expr",as:"entries",arity:{min:1},itemSeparator:{type:"punctuation",value:","},assert:!0,autoIndent:2}]}};var ws=class extends h{static get syntaxRules(){return{dialect:"postgres",syntax:[{type:"keyword",value:"FETCH"},{type:"keyword",as:"rel_kw",value:["FIRST","NEXT"]},{type:"Expr",as:"expr",optional:!0},{type:"keyword",as:"row_kw",value:["ROW","ROWS"],assert:!0},{syntaxes:[{type:"keyword",value:"ONLY"},[{type:"keyword",as:"with_ties",value:"WITH"},{type:"keyword",value:"TIES",assert:!0}]]}]}}relKW(){return this._get("rel_kw")}expr(){return this._get("expr")}rowKW(){return this._get("row_kw")}withTies(){return this._get("with_ties")}};var ks=class extends h{static get syntaxRules(){return{dialect:"postgres",syntax:[{type:"keyword",value:"USING"},{type:"operator",as:".",assert:!0}]}}value(){return this._get("value")}};var Ds=class extends h{static get syntaxRules(){return[{type:"keyword",value:"USING"},{syntaxes:[{type:"Identifier",as:"column"},{type:"paren_block",syntax:{type:"Identifier",as:"columns",arity:{min:1},itemSeparator:{type:"punctuation",value:","},assert:!0}}],assert:!0}]}column(){return this._get("column")}columns(){return this._get("columns")}};var Is=class extends h{static get syntaxRules(){return[{type:"keyword",value:"WHERE"},{type:"Expr",as:"expr",assert:!0}]}expr(){return this._get("expr")}};var Ms=class extends C{static get syntaxRules(){return[{type:"keyword",value:"WINDOW"},{type:"WindowDeclaration",as:"entries",arity:{min:1},itemSeparator:{type:"punctuation",value:","},assert:!0,autoIndent:2}]}};var Ls=class extends h{static get syntaxRules(){return[{type:"Identifier",as:"name"},{type:"keyword",value:"AS"},{type:"WindowSpec",as:"spec",assert:!0}]}name(){return this._get("name")}spec(){return this._get("spec")}};var Ps=class extends h{static get syntaxRules(){let e={type:"operator",value:"AND"};return[{type:"keyword",as:"specifier",value:["ROWS","RANGE","GROUPS"]},{syntaxes:[[{type:"operator",as:"with_between_clause",value:"BETWEEN",booleanfy:!0},{type:"WindowFrameBound",as:"bounds",arity:2,itemSeparator:e,assert:!0}],{type:"WindowFrameBound",as:"bounds",arity:1,itemSeparator:e,assert:!0}]},{optional:!0,syntax:[{type:"keyword",value:"EXCLUDE"},{type:"keyword",as:"exclusion",value:["CURRENT ROW","GROUP","TIES","NO OTHERS"],assert:!0}]}]}specifier(){return this._get("specifier")}withBetweenClause(){return this._get("with_between_clause")}bounds(){return this._get("bounds")}exclusion(){return this._get("exclusion")}};var Us=class extends h{static get syntaxRules(){return{syntaxes:[{type:"keyword",as:"specifier",value:"CURRENT ROW"},[{type:"keyword",as:"specifier",value:"UNBOUNDED"},{type:"keyword",as:"dir",value:["PRECEDING","FOLLOWING"]}],[{type:"number_literal",as:"specifier"},{type:"keyword",as:"dir",value:["PRECEDING","FOLLOWING"]}],[{type:"Expr",as:"specifier"},{type:"keyword",as:"dir",value:["PRECEDING","FOLLOWING"]}]]}}specifier(){return this._get("specifier")}dir(){return this._get("dir")}};var js=class extends h{static get syntaxRules(){return{type:"paren_block",syntax:[{type:"WindowRef",as:"super_window",optional:!0},{type:"PartitionByClause",as:"partition_by_clause",optional:!0,autoIndent:!0},{type:"OrderByClause",as:"order_by_clause",optional:!0,autoIndent:!0},{type:"WindowFrameSpec",as:"frame_spec",optional:!0,autoIndent:!0}],autoIndent:!0,autoIndentAdjust:-1}}superWindow(){return this._get("super_window")}partitionByClause(){return this._get("partition_by_clause")}orderByClause(){return this._get("order_by_clause")}frameSpec(){return this._get("frame_spec")}};var Js=class extends ie{static get syntaxRules(){let e={type:"punctuation",value:","};return[{syntaxes:[{...[].concat(super.syntaxRules)[0]},[{type:"keyword",as:"as_kw",value:"AS",booleanfy:!0},{...[].concat(super.syntaxRules)[0],assert:!0}]]},{type:"paren_block",syntax:{type:"Identifier",as:"columns",arity:{min:1},itemSeparator:e,assert:!0},if:"value",optional:!0,optionalParens:!0}]}asKW(){return this._get("as_kw")}columns(){return this._get("columns")}jsonfy(e={},r=null,s=null){let t=super.jsonfy(e,r,s);return(e.deSugar===!0||e.deSugar?.normalizeCasing)&&!t.delim&&(t={...t,value:t.value.toLowerCase()}),t}};var $s=class u extends X(h){static get syntaxRules(){return[{type:["Expr","ColumnRef0","MYVarAssignmentExpr"],as:"expr"},{type:"SelectItemAlias",as:"alias",optional:!0}]}expr(){return this._get("expr")}alias(){return this._get("alias")}deriveAlias(){let e=this.alias()?.jsonfy(),r=this.expr();if(!(r instanceof o.ColumnRef0)){if(r instanceof o.RowConstructor&&(r=r.exprUnwrapped()),(r instanceof o.CastExpr||r instanceof o.PGCastExpr2)&&(r=r.expr()),!e)if(r instanceof o.ColumnRef1)e={as_kw:!0,value:r.value(),delim:r._get("delim")};else if(r instanceof o.LQDeepRef1&&r.endpoint()instanceof o.ColumnRef2){let s=r.endpoint();e={as_kw:!0,value:s.value(),delim:s._get("delim")}}else{let s=this.options.dialect==="postgres";r instanceof o.CallExpr&&s&&(e={as_kw:!0,value:r.name().toLowerCase()})}return o.SelectItemAlias.fromJSON(e)}}jsonfy(e={},r=null,s=null){if(e.deSugar){let t=this.deriveAlias(),a,n=t&&(r?r.transform(t,(f=e)=>t.jsonfy(f),"alias",e):t.jsonfy(e));n?.is_aggr&&({is_aggr:a,...n}=n);let p=this.expr(),c;a&&!(p instanceof o.LQDeepRef1)?c=(f=e,x=r)=>({nodeName:o.AggrCallExpr.NODE_NAME,name:(e.toDialect||this.options.dialect)==="mysql"?"JSON_ARRAYAGG":"JSON_AGG",arguments:[p.jsonfy(f,x,s)]}):c=(f=e,x=r)=>p.jsonfy(f,x,s);let l=r?r.transform(p,c,"expr",{...e,asAggr:a}):c(),y=n&&{nodeName:o.Identifier.NODE_NAME,value:n.value,delim:n.delim}||{nodeName:o.Identifier.NODE_NAME,value:this.options.dialect==="postgres"?"?column?":p.stringify()},d=l.result_schema;if(d instanceof o.ColumnSchema){let f=d.parentNode;d=d.clone({renameTo:y}),f?._adoptNodes(d)}else!(p instanceof o.LQDeepRef1)&&!(p instanceof o.ColumnRef0)&&(d=o.ColumnSchema.fromJSON({name:y,data_type:this.expr().dataType().jsonfy()}),p._adoptNodes(d));let m=(a||e.deSugar===!0||Number(e.deSugar?.selectAliases)===1||e.deSugar?.selectAliases===-1&&(this.parentNode?.entries().length||0)>1)&&n||this.alias()?.jsonfy();return{nodeName:u.NODE_NAME,expr:l,alias:m,result_schema:d}}return super.jsonfy(e,r,s)}};var Bs=class extends ie{static get syntaxRules(){return[{syntaxes:[{...[].concat(super.syntaxRules)[0]},[{type:"keyword",as:"as_kw",value:"AS",booleanfy:!0},{...[].concat(super.syntaxRules)[0],assert:!0}]]},{type:"AggrNotation",as:"is_aggr",autoSpacing:!1,optional:!0}]}asKW(){return this._get("as_kw")}isAggr(){return this._get("is_aggr")}jsonfy(e={},r=null,s=null){let t=super.jsonfy(e,r,s);return(e.deSugar===!0||e.deSugar?.normalizeCasing)&&!t.delim&&(t={...t,value:t.value.toLowerCase()}),t}};var Fs=class extends X(h){static get syntaxRules(){return[{type:"CallExpr",as:"call_expr"},{type:["SRFExprDDL1","SRFExprDDL2"],as:"qualif"}]}callExpr(){return this._get("call_expr")}qualif(){return this._get("qualif")}jsonfy(e={},r=null,s=null){let t=super.jsonfy(e,r,s);if(e.deSugar){let a=t.qualif?.column_defs||[],n=t.qualif?.alias?o.TableSchema.fromJSON({name:t.qualif.alias,entries:a}):o.JSONSchema.fromJSON({entries:a});t={...t,result_schema:n}}return t}};var qs=class extends X(h){static get syntaxRules(){return[{type:"CallExpr",as:"call_expr"},{optional:!0,syntax:[{type:"keyword",as:"with_ordinality",value:"WITH",booleanfy:!0},{type:"keyword",value:"ORDINALITY",assert:!0}]}]}callExpr(){return this._get("call_expr")}withOrdinality(){return this._get("with_ordinality")}jsonfy(e={},r=null,s=null){let t=super.jsonfy(e,r,s);if(e.deSugar){let a,n;t.with_ordinality&&(n=o.ColumnSchema.fromJSON({name:{nodeName:o.Identifier.NODE_NAME,value:"ordinality"},data_type:{nodeName:o.DataType.NODE_NAME,value:"INT"}}));let p={nodeName:o.Identifier.NODE_NAME,value:t.call_expr.name};if(t.call_expr?.result_schema)if(a=t.call_expr.result_schema,a instanceof o.TableSchema||a instanceof o.JSONSchema)if(n){let c=a.jsonfy();a=a.constructor.fromJSON({name:p,...c,entries:[...c.entries,n]})}else a=a.clone();else a=o.JSONSchema.fromJSON({entries:[a.jsonfy()].concat(n||[])});else a=o.JSONSchema.fromJSON({entries:[{nodeName:o.ColumnSchema.NODE_NAME,name:p,data_type:this.callExpr().dataType().jsonfy()}].concat(n||[])});t={...t,result_schema:a}}return t}};var Gs=class extends X(h){static get syntaxRules(){return[{type:"CallExpr",as:"call_expr"},{type:"SRFExprDDL1",as:"qualif",optional:!0}]}callExpr(){return this._get("call_expr")}qualif(){return this._get("qualif")}jsonfy(e={},r=null,s=null){let t=super.jsonfy(e,r,s);if(e.deSugar){let a;if(t.qualif?.column_defs.length)a=o.JSONSchema.fromJSON({entries:t.qualif.column_defs});else if(t.call_expr?.result_schema){let n=t.call_expr.result_schema;a=n instanceof o.TableSchema||n instanceof o.JSONSchema?n.clone():o.JSONSchema.fromJSON({entries:[n.jsonfy()]})}else{let n={nodeName:o.Identifier.NODE_NAME,value:t.call_expr.name};a=o.JSONSchema.fromJSON({entries:[{nodeName:o.ColumnSchema.NODE_NAME,name:n,data_type:this.callExpr().dataType().jsonfy()}]})}t={...t,result_schema:a}}return t}};var Ys=class extends X(C){static get syntaxRules(){return[{type:"keyword",value:"ROWS"},{type:"keyword",value:"FROM"},{type:"paren_block",syntax:{type:"SRFExpr3",as:"entries",arity:{min:1},itemSeparator:{type:"punctuation",value:","},assert:!0,autoIndent:2},autoIndent:!0},{optional:!0,syntax:[{type:"keyword",as:"with_ordinality",value:"WITH",booleanfy:!0},{type:"keyword",value:"ORDINALITY",assert:!0}]}]}static get syntaxPriority(){return-1}withOrdinality(){return this._get("with_ordinality")}jsonfy(e={},r=null,s=null){let t=super.jsonfy(e,r,s);if(e.deSugar){let a=1,n=t.entries.reduce((c,l)=>{let y=l.result_schema.jsonfy().entries.map(d=>({...d,name:{...d.name,value:a++}}));return c.concat(y)},[]);t.with_ordinality&&n.push({name:{nodeName:o.Identifier.NODE_NAME,value:a},data_type:{nodeName:o.DataType.NODE_NAME,value:"INT"}});let p=o.JSONSchema.fromJSON({entries:n});t={...t,result_schema:p}}return t}};var Ws=class extends h{static get syntaxRules(){return[{type:"keyword",as:"as_kw",value:"AS"},{type:"paren_block",syntax:{type:"ColumnSchema",as:"column_defs",arity:{min:1},itemSeparator:{type:"punctuation",value:","}}}]}asKW(){return this._get("as_kw")}columnDefs(){return this._get("column_defs")}};var Ks=class extends h{static get syntaxRules(){return[{syntaxes:[{type:"Identifier",as:"alias",peek:[1,"paren_block"]},[{type:"keyword",as:"as_kw",value:"AS",peek:[2,"paren_block"]},{type:"Identifier",as:"alias",assert:!0}]]},{type:"paren_block",syntax:{type:"ColumnSchema",as:"column_defs",arity:{min:1},itemSeparator:{type:"punctuation",value:","}}}]}asKW(){return this._get("as_kw")}alias(){return this._get("alias")}columnDefs(){return this._get("column_defs")}};var Hs=class extends Ze{static get syntaxRules(){return{type:"paren_block",syntax:super.syntaxRules,autoIndent:!0}}};var Ue=class extends _e{static get syntaxRules(){return{type:["CompleteSelectStmt","CompositeSelectStmt"],expression:2}}static buildSyntaxRules(e=null){let r=(t=[])=>[{type:"keyword",value:"SELECT"},{type:"DistinctClause",as:"distinct_clause",optional:!0},{type:"SelectList",as:"select_list"},{optional:!0,syntax:[{type:"FromClause",as:"from_clause",autoSpacing:`
`},{type:"JoinClause",as:"join_clauses",arity:1/0,optional:!0,autoSpacing:`
`},{type:"MYPartitionClause",as:"my_partition_clause",optional:!0,autoSpacing:`
`},{type:"WhereClause",as:"where_clause",optional:!0,autoSpacing:`
`},{optional:!0,syntax:[{type:"GroupByClause",as:"group_by_clause",autoSpacing:`
`},{type:"HavingClause",as:"having_clause",optional:!0,autoSpacing:`
`}]},{type:"WindowClause",as:"window_clause",optional:!0,autoSpacing:`
`},...t],autoSpacing:`
`}],s=()=>[{type:"OrderByClause",as:"order_by_clause",optional:!0,autoSpacing:`
`},{type:"LimitClause",as:"limit_clause",optional:!0,autoSpacing:`
`},{type:"OffsetClause",as:"offset_clause",optional:!0,autoSpacing:`
`},{type:"PGFetchClause",as:"pg_fetch_clause",optional:!0,dialect:"postgres",autoSpacing:`
`},{type:"ForClause",as:"for_clause",optional:!0,autoSpacing:`
`}];return e===1?r():e===2?s():r(s())}dataType(){return o.DataType.fromJSON({value:"SET"})}};var rt=class extends et(Ue){static get syntaxRules(){return this.buildSyntaxRules(1)}static get syntaxPriority(){return-1}distinctClause(){return this._get("distinct_clause")}selectList(){return this._get("select_list")}fromClause(){return this._get("from_clause")}joinClauses(){return this._get("join_clauses")}whereClause(){return this._get("where_clause")}groupByClause(){return this._get("group_by_clause")}havingClause(){return this._get("having_clause")}windowClause(){return this._get("window_clause")}myPartitionClause(){return this._get("my_partition_clause")}get length(){return this.selectList()?.length??0}[Symbol.iterator](){return(this.selectList()||[])[Symbol.iterator]()}jsonfy(e={},r=null,s=null){if(!e.deSugar)return super.jsonfy(e,r,s);let t={select_list:null,group_by_clause:new Set,having_clause:new Set,order_by_clause:new Set};r=new ae((l,y,d)=>{if(l instanceof o.SelectList){t.select_list=y;return}return l instanceof o.GroupByClause||l instanceof o.HavingClause||l instanceof o.OrderByClause&&l.parentNode===this?y((m,f,x)=>{if((typeof x=="number"||x==="expr")&&m.parentNode===l){try{t[d].add(f())}catch(g){if(g instanceof Oe)t[d].add(f);else throw g}return}return f()}):y()},r,this);let a=super.jsonfy(e,r,s),n=t.select_list(),{select_list:p,...c}=this.finalizeSelectorJSON(a,r,s,e);n=this.selectList().finalizeJSON(n,r,s,e),a={select_list:n,...c,result_schema:n.result_schema,origin_schemas:this.getOriginSchemas(r)};for(let[l,y]of Object.entries(t)){if(l==="select_list"||!y.size)continue;let d=[];for(let m of y)typeof m=="function"&&(m=m()),d.push(m);l==="having_clause"?a={...a,[l]:{expr:d[0]}}:(l==="group_by_clause"||l==="order_by_clause")&&(a={...a,[l]:{entries:d}})}return a}};var Vs=class extends rt{static get syntaxRules(){return this.buildSyntaxRules()}static get syntaxPriority(){return 99}orderByClause(){return this._get("order_by_clause")}offsetClause(){return this._get("offset_clause")}limitClause(){return this._get("limit_clause")}forClause(){return this._get("for_clause")}pgFetchClause(){return this._get("pg_fetch_clause")}};var Qs=class extends Ue{static get syntaxRules(){let e=["DerivedQuery","ValuesTableLiteral","ValuesConstructor","TableStmt","BasicSelectStmt"];return[{type:[...e,"CompositeSelectStmt"],as:"left"},{type:"operator",as:"operator",value:["INTERSECT","UNION","EXCEPT"],autoSpacing:`
`},{type:"keyword",as:"all_or_distinct",value:["ALL","DISTINCT"],optional:!0},{type:e,as:"right",assert:!0,autoSpacing:`
`},...this.buildSyntaxRules(2)]}static get syntaxPriority(){return-1}left(){return this._get("left")}operator(){return this._get("operator")}allOrDistinct(){return this._get("all_or_distinct")}right(){return this._get("right")}orderByClause(){return this._get("order_by_clause")}offsetClause(){return this._get("offset_clause")}limitClause(){return this._get("limit_clause")}forClause(){return this._get("for_clause")}pgFetchClause(){return this._get("pg_fetch_clause")}get length(){return this.left()?.length??0}[Symbol.iterator](){return(this.left()||[])[Symbol.iterator]()}jsonfy(e={},r=null,s=null){if(!e.deSugar)return super.jsonfy(e,r,s);let t={order_by_clause:null};r=new ae((c,l)=>{if(c instanceof o.OrderByClause){t.order_by_clause=l;return}return l()},r,this);let a=super.jsonfy(e,r,s),n=a.left.result_schema;r.statementContext.artifacts.set("outputSchemas",new Set(n?.entries()||[]));let p=t.order_by_clause?.();return a={...a,order_by_clause:p,result_schema:n},a}static async _parseFromRules(e,r,{left:s=void 0,minPrecedence:t=0,trail:a,...n},p={}){let c=a.slice(-3);if(!(c[0]===this.NODE_NAME&&c[2]===this.NODE_NAME)){if((await e.match("operator"))?.isSetOp&&s instanceof o.CompleteSelectStmt){if(s.orderByClause()||s.offsetClause()||s.limitClause()||s.forClause()){let l=e.current(),y=`[${this.NODE_NAME}] Unexpected ${l.type} token:${typeof l.value=="string"?` "${l.value}"`:""} at <line ${l.line}, column ${l.column}>`;throw new SyntaxError(y)}s=o.BasicSelectStmt.fromJSON({...s.jsonfy(),nodeName:void 0})}return await super._parseFromRules(e,r,{left:s,minPrecedence:t,trail:a,...n},p)}}};var Xs=class extends _e{static get syntaxRules(){return[{type:"keyword",value:"TABLE"},{type:"keyword",as:"pg_only_kw",value:"ONLY",optional:!0,dialect:"postgres"},{type:"TableRef2",as:"table_ref",assert:!0},{type:"operator",as:"pg_star_ref",value:"*",booleanfy:!0,optional:!0,dialect:"postgres"}]}tableRef(){return this._get("table_ref")}pgOnlyKW(){return this._get("pg_only_kw")}pgStarRef(){return this._get("pg_star_ref")}jsonfy(e={},r=null,s=null){let t=super.jsonfy({...e,forceDeSugar:e.deSugar},r,s);if(e.deSugar){let a=t.table_ref.result_schema;t={...t,result_schema:o.JSONSchema.fromJSON({entries:a.jsonfy().entries}),origin_schemas:[a]}}return t}};var ya={};Ce(ya,{AggrNotation:()=>zs,LQVersionSpec:()=>Zs});var zs=class extends h{static get syntaxRules(){return{type:"bracket_block",syntax:{type:"Expr",as:"_",arity:0,assert:!0}}}static get syntaxPriority(){return-1}};var Zs=class extends h{static get syntaxRules(){return{type:"version_spec",as:"."}}static get syntaxPriority(){return-1}value(){return this._get("value")}};var ma={};Ce(ma,{DataType:()=>ea});var ea=class extends h{static get syntaxRules(){return[{syntaxes:[{type:"data_type",as:"."},{type:"keyword",as:".",value:["SET"]}]},{type:"paren_block",syntax:{type:"Expr",as:"specificity",arity:1/0,itemSeparator:{type:"punctuation",value:","},assert:!0},optional:!0,optionalParens:!0,autoSpacing:!1},{type:"AggrNotation",as:"pg_is_aggr",autoSpacing:!1,optional:!0,dialect:"postgres"}]}value(){return this._get("value")}specificity(){return this._get("specificity")}pgIsAggr(){return this._get("pg_is_aggr")}};var ta=class extends C{static get syntaxRules(){return{type:["JSONSchema","TableSchema","ColumnSchema","ColumnRef1"],as:"entries",arity:1/0}}};var ft=class extends C{static get _contentTypes(){return["SelectStmt","TableStmt","InsertStmt","UpsertStmt","UpdateStmt","DeleteStmt","MYSetStmt","CTE","CreateSchemaStmt","DropSchemaStmt","CreateTableStmt","DropTableStmt"]}static get syntaxRules(){let e={type:"punctuation",value:";"};return{type:this._contentTypes,as:"entries",arity:1/0,itemSeparator:e,autoSpacing:`
`}}static async parse(e,r={}){let s=await this.toStream(e,r),t=await super.parse(s,r);if(!s.done&&s.current()){let a=s.current(),n=`[${this.NODE_NAME}] Unexpected ${a.type} token:${typeof a.value=="string"?` "${a.value}"`:""} at <line ${a.line}, column ${a.column}>`;throw new SyntaxError(n)}return t}stringify(e={}){return`${super.stringify(e)};`}};Object.assign(o,{...ua,...pa,...ca,...fa,...ge,...ya,...ma,Script:ft,JSONSchema:ta});})();
//# sourceMappingURL=main.js.map
