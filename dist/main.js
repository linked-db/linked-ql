(()=>{function z(c){return c instanceof String||typeof c=="string"&&c!==null}function Z(c){return arguments.length&&(c===void 0||typeof c>"u")}function Mt(c){return typeof c=="function"}function G(c){return Mt(c)||c&&{}.toString.call(c)==="[object function]"}function R(c){return Array.isArray(c)}function Se(c){return!z(c)&&!Z(c.length)}function St(c){return c===null||c===""}function H(c){return Array.isArray(c)||typeof c=="object"&&c||Mt(c)}function Dt(c){return St(c)||Z(c)||c===!1||c===0||H(c)&&!Object.keys(c).length}function I(c){return!Array.isArray(c)&&typeof c=="object"&&c}function Rt(c,t=!0){return R(c)?c:!t&&I(c)?[c]:c!==!1&&c!==0&&Dt(c)?[]:Se(c)?Array.prototype.slice.call(c):I(c)?Object.values(c):[c]}function gt(c){return c instanceof Number||typeof c=="number"}function v(c){return gt(c)||c!==!0&&c!==!1&&c!==null&&c!==""&&!isNaN(c*1)}var Ue=function(c,t=1,e=!0){return!v(t)||t<=0||(!R(c)&&I(c)&&e&&(c=Object.values(c)),!R(c))?c:c.reduce((s,r)=>R(r)||I(r)&&e?s.concat(Ue(R(r)?r:Object.values(r),t-1,e)):s.concat(r),[])},Re=Ue;function Ot(c,t=1){var e=0;c.forEach(r=>{e++});var s=c.slice(c.length-e,t);return arguments.length>1?s:s[0]}function it(c,t=1){return arguments.length>1?Ot(c.slice().reverse(),t).reverse():Ot(c.slice().reverse())}function ue(c,...t){return t.forEach(e=>{c.indexOf(e)<0&&c.push(e)}),c}function Me(s,t){t=t||Object.prototype,t=t&&!R(t)?[t]:t;for(var e=[],s=s;s&&(!t||t.indexOf(s)<0)&&s.name!=="default";)e.push(s),s=s?Object.getPrototypeOf(s):null;return e}function De(c,t){var e=[];return Me(c,t).forEach(s=>{ue(e,...Object.getOwnPropertyNames(s))}),e}function It(c,t,e=!1,s=!1,r=!1){var n=0,i=c.shift();if((v(i)||i===!0||i===!1)&&(n=i,i=c.shift()),!c.length)throw new Error("_merge() requires two or more array/objects.");return c.forEach((a,o)=>{!H(a)&&!G(a)||(e?De(a):Object.keys(a)).forEach(l=>{if(t(l,i,a,o)){var u=i[l],f=a[l];if((R(u)&&R(f)||I(u)&&I(f))&&(n===!0||n>0))i[l]=R(u)&&R(f)?[]:{},It([v(n)?n-1:n,i[l],u,f],t,e,s,r);else if(R(i)&&R(a))s?i[l]=f:i.push(f);else try{r?Object.defineProperty(i,l,Object.getOwnPropertyDescriptor(a,l)):i[l]=a[l]}catch{}}})}),i}function fe(...c){return It(c,(t,e,s)=>!0,!1,!1,!1)}function he(c){return I(c)&&Object.getPrototypeOf(c)===Object.prototype}function qt(c){return c===!0||c===!1}function me(c,t){var e=void 0;return H(c)&&Object.keys(c).forEach((s,r)=>{e!==!1&&(e=t(v(s)?parseFloat(s):s,c[s],r))}),e}function Pe(c,t,e=!0,s=!0,r=!1,n=!1){if(R(c)&&R(t)){var i=[],a=!0;return c.forEach(o=>{if(a){var l=!1;me(t,(u,f)=>{(!l||s&&H(o))&&(l=e(o,f),(R(l)&&!l.length||I(l)&&!Object.keys(l).length)&&(l=!1),H(l)&&s&&(o=l))}),H(l)?i.push(s?l:o):qt(l)?r&&!l||!r&&l?i.push(o):n&&(a=!1):i.push(l)}}),i}if(I(c)&&I(t)){var i={},a=!0;return Object.keys(c).forEach(u=>{if(a){var f=e(c[u],t[u]);(R(f)&&!f.length||I(f)&&!Object.keys(f).length)&&(f=!1),H(f)?i[u]=s?f:c[u]:qt(f)?r&&!f||!r&&f?i[u]=c[u]:n&&(a=!1):i[u]=f}}),i}}var ge=function(c,t,e=!0,s=1){if(R(c)&&R(t)&&c.length!==t.length)return!e;if(I(c)&&I(t)){var r=Object.keys(c),n=Object.keys(t);if(!r.length&&!n.length)return he(c)&&he(t)?e:c===t===e;if(!ge(r,n))return!e}if(s>0&&(R(c)&&R(t)||I(c)&&I(t))){var i=Pe(c,t,(a,o)=>ge(a,o,e,s-1),!1,!1,!0);return R(i)?i.length===c.length&&i.length===t.length:I(i)&&I(c)?Object.keys(i).length===Object.keys(c).length&&Object.keys(i).length===Object.keys(t).length:i}return G(e)?e(c,t):gt(c)&&gt(t)&&isNaN(c)&&isNaN(t)?e:c===t===e},Fe=ge;function Oe(c,t=[]){return It([{},c],(e,s,r)=>{if(!G(r[e]))return G(t)?t(e):R(t)&&t.length?t.indexOf(e)>-1:!0},!1,!1,!1)}function Pt(c,t,e=null){return R(t)?c.filter(s=>e?t.filter(r=>e(s,r)).length:t.indexOf(s)!==-1):[]}var nt=class c{static lex(t,e,s={}){if(!z(t=t+""))throw new Error("Argument1 must be a string!");var r=l=>({delims:l.delims.slice(),options:Oe(l.options),nesting:l.nesting.slice(),maxDepth:l.maxDepth,comments:l.comments.slice(),tokens:l.tokens.slice(),matches:l.matches.slice(),matchesi:Oe(l.matchesi)});if(c.$cache[t]&&s.cache!==!1)for(var n=0;n<c.$cache[t].length;n++){var i=c.$cache[t][n];if(Fe(i.delims,e))return r(i)}var a=new c(t,s),o=a.lex(e);return s.cache!==!1&&(c.$cache[t]=c.$cache[t]||[],c.$cache[t].push(o)),r(o)}static split(t,e,s){return c.lex(t,e,s).tokens}static match(t,e,s){return c.lex(t,e,s).matches}constructor(t,e){if(!z(t))throw new Error("Lexer requires the first argument to be a string.");this.$str=t,this.$options=e||{},this.$options.blocks||(this.$options.blocks=c.$blocks),this.$options.quotes||(this.$options.quotes=c.$quotes),this.$options.comments||(this.$options.comments=c.$comments)}lex(t,e){for(var s={delims:Rt(t),options:fe(!0,{},this.$options,e||{}),nesting:[],maxDepth:0,comments:[],tokens:[],matches:[],matchesi:{}},r=0;typeof r=="number";)r=this._evalCharsAt(s,r);if(s.nesting.length)throw new Error("Error parsing the string: "+this.$str+". Unterminated blocks: "+Re(s.nesting).join(", "));return s}_evalCharsAt(t,e){if(!(e>=this.$str.length)){var s=1,r={},n={},i={};if(t.openComment||(n=this._testQuotes(t,e)),t.openQuote||(r=this._testComments(t,e)),t.openComment||r.ending)if(!t.nesting.length&&!i.ending){var a=r.starting||r.ending||this.$str[e];s=a.length,this._push(t,a,"comments",r.starting)}else this._push(t,this.$str[e]);else if(t.openQuote||n.ending)this._push(t,this.$str[e]);else{if(t.options.limit&&t.matches.length===t.options.limit)return this._push(t,this.$str[e]),e+1;i=this._testNesting(t,e);var i=this._testNesting(t,e),o=this._testChars(t.options.stopChars||[],t,e);if(!t.nesting.length&&o!==!1){t.options.stopChar=o,t.options.stopCharForward=this.$str.substr(e);return}if(!t.delims.length)t.nesting.length===2&&i.starting?(t.matches.push(null),this._push(t,i.starting),s=i.starting.length):!t.nesting.length&&i.ending?(this._push(t,i.ending),s=i.ending.length,t.matches.push(null)):this._push(t,this.$str[e]);else if(!t.nesting.length&&!i.ending){this._push(t,"");var l=this._testChars(t.delims,t,e);if(l!==!1&&(t.matches.push(l),t.matchesi[e]=l,s=l.length||1,!t.options.preserveDelims)){var u=e+(l.length||1);return u===this.$str.length&&this._push(t,""),u}this._push(t,l||this.$str[e])}else{var a=i.starting||i.ending||this.$str[e];s=a.length,this._push(t,a)}}return e+s}}_testQuotes(t,e){var s={};return(t.options.quotes||[]).forEach(r=>{this.$str.substr(e,1)===r&&(t.openQuote?r===t.openQuote&&(t.openQuote=!1,s.ending=r):(t.openQuote=r,s.starting=r))}),s}_testComments(t,e){var s={};return(t.options.comments||[]).forEach(r=>{if(t.openComment){if(it(r)===it(t.openComment)){var i=it(r);this.$str.substr(e).startsWith(i)&&(t.openComment=!1,s.ending=i)}}else{var n=Ot(r);this.$str.substr(e).startsWith(n)&&(t.openComment=r,s.starting=n)}}),s}_testNesting(t,e){var s={};return(t.options.blocks||[]).forEach(r=>{let n=Ot(r),i;if(n instanceof RegExp?[i]=n.exec(this.$str.substr(e))||[]:this.$str.substr(e).startsWith(n)&&(i=n),i)t.nesting=t.nesting.concat([r]),s.starting=i;else if(t.nesting.length&&it(r)===it(it(t.nesting))){var a=it(r),o;a instanceof RegExp?[o]=a.exec(this.$str.substr(e))||[]:this.$str.substr(e).startsWith(a)&&(o=a),o&&(t.nesting=t.nesting.slice(0,-1),s.ending=o)}}),t.maxDepth=Math.max(t.maxDepth,t.nesting.length),s}_testChars(t,e,s){for(var r=0;r<t.length;r++){let a={useRegex:e.options.useRegex,ci:e.options.ci,...I(t[r])?t[r]:{test:t[r]}};if(G(a.test)){var n=a.test(this.$str.substr(0,s),this.$str.substr(s),e.tokens.slice());if(n!==!1)return n;continue}if(a.useRegex){let l=a.useRegex!==!0?a.useRegex:"";var i=this.$str.substr(s).match(new RegExp("^"+a.test,l));if(i&&(!a.backtest||this.$str.substr(0,s).match(new RegExp(a.backtest,l))))return i[0];continue}let o=(l,u)=>a.ci?l.toLowerCase()===u.toLowerCase():l===u;if(o(this.$str.substr(s,a.test.length),a.test)&&(!a.backtest||o(this.$str.substr(s-a.backtest.length,s),a.backtest)))return a.test}return!1}_push(t,e,s="tokens",r=!1){var n=t.matches.length;if(Z(t.tokens[n])&&(t.tokens[n]=""),s==="comments"){t.tokens[n].comments||(t.tokens[n]=new String(t.tokens[n]),t.tokens[n].comments=[]);var i=t.tokens[n].comments.length-(!t.tokens[n].comments.length||r?0:1);t.tokens[n].comments[i]=(t.tokens[n].comments[i]||"")+e}else{var a=t.tokens[n].comments;t.tokens[n]=t.tokens[n]+e}}split(t,e,s){return this.lex(e,s).tokens}match(t,e,s){return this.lex(e,s).matches}regParse(t,e){return this.lex(t,fe({useRegex:!0},e||{}))}regSplit(t,e){return this.regParse(t,e).tokens}regMatch(t,e){return this.regParse(t,e).matches}};nt.$blocks=[["(",")"],["[","]"],["{","}"]];nt.$quotes=['"',"'","`"];nt.$comments=[["/*","*/"],["//",`
`]];nt.$cache=Object.create(null);var p=class extends nt{static $blocks=[...nt.$blocks,[new RegExp("^CASE ","i"),new RegExp("^ END","i")]]};var A=class c{CONTEXT;FLAGS=[];constructor(t){this.CONTEXT=t;let e=this.statementNode;e===this&&(e=e.CONTEXT?.statementNode),e?.connectedNodeCallback?.(this)}get params(){return this.CONTEXT?.params||{}}get rootNode(){return this.CONTEXT&&this.CONTEXT instanceof c?this.CONTEXT.rootNode:this}get statementNode(){return this.CONTEXT&&this.CONTEXT instanceof c?this.CONTEXT.statementNode:this}static getQuoteChars(t,e=!1){return(e&&t?.params?.inputDialect||t?.params?.dialect)==="mysql"&&!t.params.ansiQuotes?['"',"'"]:["'"]}get quoteChars(){return this.constructor.getQuoteChars(this)}static getEscChar(t,e=!1){return(e&&t?.params?.inputDialect||t?.params?.dialect)==="mysql"&&!t.params.ansiQuotes?"`":'"'}get escChar(){return this.constructor.getEscChar(this)}static autoUnesc(t,e,s=!1){let r=this.getEscChar(t,s);return(e||"").replace(new RegExp(r+r,"g"),r)}static parseIdent(t,e,s=!1){let r=this.getEscChar(t,s),n=p.split(e,["."]),i=n.map(o=>new RegExp(`^(?:(\\*|[\\w]+)|(${r})((?:\\2\\2|[^\\2])+)\\2)$`).exec(o.trim())).filter(o=>o);if(i.length!==n.length)return;let a=o=>o?.[1]||this.autoUnesc(t,o?.[3]);return[a(i.pop()),a(i.pop())]}autoEsc(t){let e=(Array.isArray(t)?t:[t]).map(s=>s&&!/^(\*|[\w]+)$/.test(s)?`${this.escChar}${s.replace(new RegExp(this.escChar,"g"),this.escChar.repeat(2))}${this.escChar}`:s);return Array.isArray(t)?e:e[0]}with(t){for(let e in t)this[e]=t[e];return this}withFlag(...t){return this.FLAGS.push(...t.filter(e=>e).map(e=>e.toUpperCase())),this}hasFlag(t){return this.FLAGS.includes(t.toUpperCase())}build(t,e,s,r){let n=Array.isArray(s)?s:s?[s]:[];if(!n.length)throw new Error("At least one node type must be defined.");let i=o=>n.reduce((l,u)=>l||(o instanceof u?o:u.fromJson(this,o)),null),a=(...o)=>{for(let l of o)Array.isArray(this[t])?this[t].push(l):this[t]=l};if(e.length===1&&typeof e[0]!="function"){let o=i(e[0]);if(o)return a(o)}if(r){if(n.length!==1)throw new Error("To support argument delegation, number of node types must be 1.");let o=this[t]&&!Array.isArray(this[t])?this[t]:new n[0](this);return a(o),o[r](...e)}for(let o of e){if(typeof o=="function"){if(this[t]&&!Array.isArray(this[t])){o(this[t]);continue}if(n.length===1){let f=new n[0](this);a(f),o(f);continue}let u=f=>(...m)=>{let E=n.reduce((h,d)=>h||(d.factoryMethods?f in d.factoryMethods&&d.factoryMethods[f](this,...m):f in d.prototype&&new d(this)),null);if(!E)throw new Error(`Unknow method: ${f}()`);if(a(E),E[f])return E[f](...m);for(let h of m)h(E)};o(new Proxy({},{get:(f,m)=>u(m)}));continue}let l=i(o);if(l){a(l);continue}throw new Error(`Arguments must be of type ${n.map(u=>u.name).join(", ")} or a JSON equivalent. Recieved: ${typeof o}`)}}clone(){return this.constructor.fromJson(this.CONTEXT,this.toJson())}static parse(t,e,s=null){}toString(){return this.stringify()}static fromJson(t,e){}toJson(){return{}}};var g=class extends A{BASENAME;NAME;name(t){let e=Array.isArray(t)?[...t]:[t];if(this.NAME=e.pop(),this.BASENAME=e.pop(),e.length)throw new Error(`Idents can be maximum of two parts. Recieved: ${e.reverse().join(".")}.${this.BASENAME}.${this.NAME}`)}toJson(){return{name:this.BASENAME?[this.BASENAME,this.NAME]:this.NAME,flags:this.FLAGS}}static fromJson(t,e){if(typeof e=="string"||Array.isArray(e))e={name:e};else if(typeof e?.name!="string"&&!Array.isArray(e?.name))return;let s=new this(t).withFlag(...e?.flags||[]);return s.name(e.name),s}stringify(){return this.autoEsc([this.BASENAME,this.NAME].filter(t=>t)).join(".")+(this.FLAGS.length?` ${this.FLAGS.map(t=>t.replace(/_/g," ")).join(" ")}`:"")}static parse(t,e){let[s,r]=this.parseIdent(t,e,!0)||[];if(!s)return;let n=new this(t);return n.name(r?[r,s]:s),n}};var x=class extends A{get type(){return this.constructor.name.toUpperCase()}get statementNode(){return this}connectedNodeCallback(t){}static mySubstitutePlaceholders(t,e){return(t?.params?.inputDialect||t?.params?.dialect)!=="mysql"||e.indexOf("?")===-1?e:p.split(e,["?"],{blocks:[]}).reduce((s,r,n)=>s?s+"?"+n+r:r,null)}get expandable(){return!1}async expand(t=!1){return t?this:this.clone()}};var j=class extends x{NAME="";constructor(t,e){super(t),this.NAME=e}name(t){this.NAME=t}toJson(){return{name:this.NAME,flags:this.FLAGS}}static fromJson(t,e){if(typeof e?.name=="string")return new this(t,e.name).withFlag(...e.flags||[])}stringify(){return`CREATE SCHEMA${this.hasFlag("IF_NOT_EXISTS")?" IF NOT EXISTS":""} ${this.autoEsc(this.NAME)}`}static parse(t,e){let[s,r,n]=/^CREATE\s+DATABASE\s+(IF\s+NOT\s+EXISTS\s+)?(.+)$/i.exec(e)||[];if(!s)return;let[i]=this.parseIdent(t,n.trim(),!0)||[];if(!i)return;let a=new this(t,i,params);return r&&a.withFlag("IF_NOT_EXISTS"),a}static cloneJson(t){let e={name:t.name};return((r,n)=>{let i=r[n];Object.defineProperty(r,`$${n}`,{get:()=>i})})(e,"name"),e}};function pe(c,t,e=!1){if(t=="")return c;var s=e?c.lastIndexOf(t):c.indexOf(t);return s===-1?"":c.substr(s+t.length)}function Ie(c,t,e=!1){if(t=="")return c;var s=e?c.lastIndexOf(t):c.indexOf(t);return s===-1?c:c.substr(0,s)}function ye(c,t){return Ie(c,t,!0)}function L(c,t,e){return ye(pe(c,t),e)}function q(c,t,e){return c.startsWith(t)&&c.endsWith(e)}var yt=class extends A{stringifyName(){return this.CONSTRAINT_NAME?`CONSTRAINT ${this.autoEsc(this.CONSTRAINT_NAME)}`:""}stringifyReference(){let t=this.DETAIL.basename||this.BASENAME,e=r=>typeof r=="object"&&r?`${r.rule} (${r.columns.join(",")})`:r,s=`${this.autoEsc([t,this.DETAIL.table].filter(r=>r)).join(".")} (${this.autoEsc(this.DETAIL.columns).join(",")})`;return this.DETAIL.matchRule&&(s+=` MATCH ${this.DETAIL.matchRule}`),this.DETAIL.updateRule&&(s+=` ON UPDATE ${e(this.DETAIL.updateRule)}`),this.DETAIL.deleteRule&&(s+=` ON DELETE ${e(this.DETAIL.deleteRule)}`),s}stringifyCheck(){return`(${this.DETAIL.expr})`}static parseName(t,e,s=!1){let n=`(?:CONSTRAINT(?:\\s+(\\w+)|\\s+(${this.getEscChar(t,s)})((?:\\2\\2|[^\\2])+)\\2)\\s+)?`,[,i,,a,o=""]=e.match(new RegExp(`^${n}([\\s\\S]+)$`,"i"))||[];return{constraintName:i||this.autoUnesc(t,a),expr:o.trim()}}static parseReference(t,e){let[s,r,n=""]=p.split(e,[]),[i,a]=this.parseIdent(t,s.trim(),!0),o=p.split(L(r,"(",")"),[","]).map(u=>this.parseIdent(t,u.trim(),!0)[0]),l=(u,f)=>{if(f==="MATCH")return u.match(/MATCH\s+(\w+)/i)?.[1];let m=/(NO\s+ACTION|RESTRICT|CASCADE|(SET\s+NULL|SET\s+DEFAULT)(?:\s+\(([^\)]+)\))?)/,[,E,h,d]=u.match(new RegExp(`ON\\s+${f}\\s+${m.source}`,"i"))||[];return h?d?{rule:h,columns:d.split(",").map(N=>N.trim())}:h:E};return{basename:a,table:i,columns:o,matchRule:l(n,"MATCH"),updateRule:l(n,"UPDATE"),deleteRule:l(n,"DELETE")}}static parseCheck(t){let[,e,s=""]=p.split(t,[]);return{expr:L(e,"(",")")}}};var M=class extends yt{CONSTRAINT_NAME="";TYPE="";COLUMNS=[];DETAIL={};constructor(t,e,s,r,n={}){super(t),this.CONSTRAINT_NAME=e,this.TYPE=s,this.COLUMNS=r,this.DETAIL=n}get BASENAME(){return this.CONTEXT.BASENAME}toJson(){return{...this.CONSTRAINT_NAME?{constraintName:this.CONSTRAINT_NAME}:{},type:this.TYPE,...this.COLUMNS.length?{columns:this.COLUMNS}:{},detail:this.DETAIL}}stringify(){let t=[this.stringifyName(),this.TYPE.replace(/_/i," ")];return this.COLUMNS?.length&&this.TYPE!=="CHECK"&&t.push(`(${this.autoEsc(this.COLUMNS).join(",")})`),this.TYPE==="FOREIGN_KEY"?t.push("REFERENCES",this.stringifyReference()):this.TYPE==="CHECK"&&t.push(this.stringifyCheck()),t.filter(e=>e).join(" ")}static parse(t,e){let s=l=>p.split(L(l,"(",")"),[","]).map(u=>this.parseIdent(t,u.trim(),!0)[0]),{constraintName:r="",expr:n}=this.parseName(t,e,!0);if(!n)return;let[i,a,...o]=p.split(n,[]);if(/^PRIMARY\s+KEY/i.test(i))return new this(t,r.trim(),"PRIMARY_KEY",s(a));if(/^UNIQUE/i.test(i))return new this(t,r.trim(),"UNIQUE",s(a));if(/^FOREIGN\s+KEY/i.test(n))return new this(t,r,"FOREIGN_KEY",s(a),this.parseReference(t,o.join("").trim().replace(/^REFERENCES\s+/i,"")));if(/^CHECK/i.test(n))return new this(t,r,"CHECK",[],this.parseCheck(a.replace(/^CHECK\s+/i,"")))}static fromJson(t,e){if(!(typeof e.constraintName!="string"&&(typeof e?.type!="string"||!e.type.match(/PRIMARY_KEY|UNIQUE|CHECK|FOREIGN_KEY/i))))return new this(t,e.constraintName,e.type.replace(/UNIQUE_KEY/i,"UNIQUE"),e.columns,e.references||e.expr||e.detail)}static fromColumnLevelConstraint(t,e){return new this(t.CONTEXT.CONTEXT,t.CONSTRAINT_NAME,t.TYPE,[e],t.DETAIL)}};var U=class extends yt{CONSTRAINT_NAME="";TYPE="";DETAIL={};constructor(t,e,s,r={}){super(t),this.CONSTRAINT_NAME=e,this.TYPE=s,this.DETAIL=r}get BASENAME(){return this.CONTEXT.CONTEXT.BASENAME}stringify(){let t=[this.stringifyName()];return this.TYPE==="DEFAULT"?t.push("DEFAULT",this.DETAIL.expr?`(${this.DETAIL.expr})`:this.DETAIL.value):["IDENTITY","EXPRESSION"].includes(this.TYPE)?(t.push("GENERATED",this.DETAIL.always?"ALWAYS":"BY DEFAULT","AS"),this.TYPE==="IDENTITY"?t.push("IDENTITY"):this.DETAIL.expr&&t.push(this.DETAIL.expr,"STORED")):this.TYPE==="FOREIGN_KEY"?t.push("REFERENCES",this.stringifyReference()):this.TYPE==="CHECK"?t.push("CHECK",this.stringifyCheck()):t.push(this.TYPE.replace(/(?<!AUTO)_/i," ")),t.filter(e=>e).join(" ")}toJson(){return{...this.CONSTRAINT_NAME?{constraintName:this.CONSTRAINT_NAME}:{},type:this.TYPE,detail:{...this.DETAIL}}}static fromJson(t,e){if(Object.values(this.attrEquivalents).includes(e?.type))return new this(t,e.constraintName,e.type,e.detail).withFlag(...e.flags||[])}static parse(t,e){let{constraintName:s,expr:r}=this.parseName(t,e,!0);if(/^GENERATED/i.test(r)){let[,n,,i]=r.match(new RegExp("^GENERATED\\s+(ALWAYS|BY[ ]+DEFAULT)\\s+AS(?:\\s+(IDENTITY)?|(?:\\s+)?\\(([\\s\\S]+)\\)(?:\\s+)?STORED$)","i"));return i?new this(t,s,"EXPRESSION",{always:!0,expr:i}):new this(t,s,"IDENTITY",{always:/^ALWAYS$/i.test(n)})}if(/^DEFAULT/i.test(r)){let[,n,i,a]=r.trim().match(/^DEFAULT\s+(?:([\w]+)|(\w[\s\S]+\))|\(([\s\S]+)\))$/i);return new this(t,s,"DEFAULT",n?{value:/^[\d.]+$/.test(n)?parseFloat(n):n}:{expr:i||L(a,"(",")")})}if(/^(PRIMARY[ ]+KEY|UNIQUE|AUTO_INCREMENT|NOT[ ]+NULL)/i.test(r))return new this(t,s,r.replace(/\s+/,"_").toUpperCase());if(/^REFERENCES/i.test(r))return new this(t,s,"FOREIGN_KEY",this.parseReference(t,r.replace(/^REFERENCES\s+/i,"")));if(/^CHECK/i.test(r))return new this(t,s,"CHECK",this.parseCheck(r.replace(/^CHECK\s+/i,"")))}static attrEquivalents={notNull:"NOT_NULL",primaryKey:"PRIMARY_KEY",uniqueKey:"UNIQUE",check:"CHECK",references:"FOREIGN_KEY",identity:"IDENTITY",expression:"EXPRESSION",autoIncrement:"AUTO_INCREMENT",default:"DEFAULT"}};var K=class extends A{NAME="";PRECISION=0;constructor(t,e,s){super(t),this.NAME=e,this.PRECISION=s}toJson(){return this.PRECISION?{name:this.NAME,precision:this.PRECISION}:this.NAME}stringify(){return`${this.NAME}${this.PRECISION?`(${this.PRECISION})`:""}`}static fromJson(t,e){if(typeof e=="string"&&(e={name:e}),!(typeof e=="object"&&e)||typeof e.name!="string")return;let s=e.name+(e.precision?`(${e.precision})`:""),[r,n]=Je(s);if(r)return new this(t,r,n)}static parse(t,e){let[s,r]=Je(e);if(s)return new this(t,s.toUpperCase(),r)}static pgFixedTypesRe=/(bigint|int8|bigserial|serial8|boolean|bool|box|bytea|cidr|circle|date|double\s+precision|float8|inet|integer|int|int4|json|jsonb|line|lseg|macaddr|macaddr8|money|path|pg_lsn|pg_snapshot|point|polygon|real|float4|smallint|int2|smallserial|serial2|serial|serial4|text|timetz|timestamptz|tsquery|tsvector|txid_snapshot|uuid|xml)/;static pgVariableTypesRe=/(bit|bit\s+varying|varbit|character|char|character\s+varying|varchar|interval|numeric|time|timestamp)(?:\s+)?(?:\(([\d, ]+)\))?/;static myFixedTypesRe=/(tinyint|smallint|mediumint|enum|set|tinyblob|mediumblob|longblob|geometry|longstring|geometrycollection|multilinestring|multipoint|multipolygon)/;static myVariableTypesRe=/(float|decimal|double|tinytext|mediumtext|longtext|binary|varbinary|blob)(?:\s+)?(?:\(([\d, ]+)\))?/},Je=c=>{let t,e;for(let s of["pgFixedTypesRe","pgVariableTypesRe","myFixedTypesRe","myVariableTypesRe"])if([,t,e]=c.match(new RegExp(K[s].source,"i"))||[],t)break;return[t,e]};var J=class extends A{NAME="";TYPE=null;CONSTRAINTS=[];constructor(t,e){super(t),this.NAME=e}type(t){return this.build("TYPE",[t],K)}constraint(...t){return this.build("CONSTRAINTS",t,U)}toJson(){let t={name:this.NAME,type:this.TYPE?.toJson()};for(let e of this.CONSTRAINTS){let{constraintName:s,type:r,detail:n}=e.toJson(),i=Object.keys(U.attrEquivalents).find(a=>U.attrEquivalents[a]===r);t={...t,[i]:{constraintName:s,...n}}}return t}static fromJson(t,e){if(typeof e?.name!="string")return;let s=new this(t,e.name);for(let r in U.attrEquivalents){if(!e[r])continue;let{constraintName:n,...i}=e[r],a=U.attrEquivalents[r];s.constraint(U.fromJson(s,{constraintName:n,type:a,detail:i}))}return e.type&&s.type(K.fromJson(s,e.type)),s}stringify(){let t=Object.values(U.attrEquivalents).map(e=>this.CONSTRAINTS.find(s=>s.TYPE===e)).filter(e=>e);return this.params.dialect==="mysql"&&(t=t.filter(e=>e.TYPE!=="FOREIGN_KEY")),`${this.autoEsc(this.NAME)} ${this.TYPE}${t.length?` ${t.join(" ")}`:""}`}static parse(t,e,s){let[r,n]=p.split(e,["\\s+"],{useRegex:!0,limit:1}),[i]=this.parseIdent(t,r.trim(),!0)||[];if(!i)return;let a=new this(t,i),o="(CONSTRAINT\\s+.+?\\s+)?",l=[{test:`${o}(PRIMARY[ ]+KEY|NOT[ ]+NULL|GENERATED|REFERENCES|UNIQUE(?:[ ]+KEY)?|CHECK|AUTO_INCREMENT)`},{backtest:"^(?!.*\\s+(NOT|SET)\\s+$)",test:`${o}NULL`},{backtest:"^(?!.*\\s+BY\\s+$)",test:`${o}DEFAULT`}],[u,...f]=p.split(n,l,{useRegex:"i",preserveDelims:!0});a.type(s(a,u.trim(),[K]));for(let m of f)a.constraint(s(a,m,[U]));return a}};var B=class extends A{INDEX_NAME="";TYPE="";COLUMNS=[];constructor(t,e,s,r){super(t),this.INDEX_NAME=e,this.TYPE=s,this.COLUMNS=r}toJson(){return{type:this.TYPE,columns:this.COLUMNS,...this.INDEX_NAME?{indexName:this.INDEX_NAME}:{}}}stringify(){return`${this.TYPE}${this.INDEX_NAME?` ${this.INDEX_NAME}`:""} (${this.COLUMNS.join(", ")})`}static parse(t,e){let[s,r,n]=/^((?:(?:FULLTEXT|SPATIAL)(?:\s+INDEX|\s+KEY)?)|(?:INDEX|KEY))([\s\S]+)$/i.exec(e)||[];if(!s)return;let[i,a]=p.split(n,[]),[o]=this.parseIdent(t,i.trim(),!0),l=p.split(L(a,"(",")"),[","]).map(u=>this.parseIdent(t,u.trim(),!0)[0]);return new this(t,o,r.toUpperCase(),l)}static fromJson(t,e){if(!(typeof e.indexName!="string"&&(typeof e?.type!="string"||!e.type.match(/INDEX|KEY|FULLTEXT/i))))return new this(t,e.indexName,e.type,e.columns)}static attrEquivalents={fulltext:"FULLTEXT",index:"INDEX"}};var W=class c extends A{TYPE="";REFERENCE=null;ARGUMENT=null;renameTo(t){return this.TYPE="RENAME",this.ARGUMENT=t,this}relocateTo(t){return this.TYPE="RELOCATE",this.ARGUMENT=t,this}drop(t){return this.TYPE="DROP",this.ARGUMENT=t,this}add(t){return this.TYPE="ADD",this.ARGUMENT=t,this}set(t){return this.TYPE="SET",this.ARGUMENT=t,this}alter(t,e){return this.TYPE="ALTER",this.REFERENCE=t,this.build("ARGUMENT",[e],c),this}toJson(){return{type:this.TYPE,...this.REFERENCE?{reference:this.REFERENCE}:{},argument:typeof this.ARGUMENT?.toJson=="function"?this.ARGUMENT.toJson():this.ARGUMENT,flags:this.FLAGS}}static fromJson(t,e){if(typeof e?.type!="string"||!e.argument)return;let s=new this(t).withFlag(...e.flags||[]);if(["RENAME","RELOCATE"].includes(e.type))return s[e.type==="RENAME"?"renameTo":"relocateTo"](e.argument),s;if(["DROP","ADD","SET"].includes(e.type)){let r=[M,B,J].reduce((n,i)=>n||i.fromJson(t,e.argument),null);return s[e.type==="DROP"?"drop":e.type==="SET"?"set":"add"](r),s}if(e.type==="ALTER"){let{reference:r,argument:n}=e,i=n.argument;r.kind==="COLUMN"?i=[U,K].reduce((o,l)=>o||l.fromJson(t,i),null)||i:i=(r.kind==="CONSTRAINT"?M:B).fromJson(t,i)||i;let a=n.type.toLowerCase()+(["RENAME","RELOCATE"].includes(n.type)?"To":"");return s.alter(r,o=>o[a](i)),s}}};var at=class extends x{NAME="";ACTIONS=[];constructor(t,e){super(t),this.NAME=e}name(t){this.NAME=t}renameTo(t){return this.build("ACTIONS",[t],W,"renameTo")}toJson(){return{name:this.NAME,actions:this.ACTIONS.map(t=>t.toJson()),flags:this.FLAGS}}static fromJson(t,e){if(typeof e?.name!="string")return;let s=new this(t,e.name).withFlag(...e.flags||[]);for(let r of e.actions)s.ACTIONS.push(W.fromJson(t,r));return s}stringify(){let t=this.ACTIONS.find(e=>e.TYPE==="RENAME"&&!e.REFERENCE)?.ARGUMENT;return t?`ALTER SCHEMA${this.hasFlag("IF_EXISTS")?" IF EXISTS":""} ${this.autoEsc(this.NAME)} RENAME TO ${this.autoEsc(t)}`:""}static parse(t,e){let[s,r,n]=/^ALTER\s+DATABASE\s+(IF\s+EXISTS\s+)?([\s\S]+)$/i.exec(e)||[];if(!s)return;let[i,a]=p.split(n,["RENAME\\s+TO"],{useRegex:"i"}),[o]=this.parseIdent(t,i.trim(),!0)||[],[l]=this.parseIdent(t,a.trim(),!0)||[];if(!o||!l)return;let u=new this(t,o);return r&&u.withFlag("IF_EXISTS"),u.renameTo(l),u}static fromDiffing(t,e,s,r=[]){if(!e.name)throw new Error("Could not assertain database1 name or database1 name invalid.");if(!s.name)throw new Error("Could not assertain database2 name or database2 name invalid.");let n=new this(t,e.name).withFlag(...r);return s.name!==e.name&&n.renameTo(s.name),n}};var ot=class extends x{NAME="";constructor(t,e){super(t),this.NAME=e}name(t){this.NAME=t}toJson(){return{name:this.NAME,flags:this.FLAGS}}static fromJson(t,e){if(typeof e?.name=="string")return new this(t,e.name).withFlag(...e.flags||[])}stringify(){return`DROP SCHEMA${this.hasFlag("IF_EXISTS")?" IF EXISTS":""} ${this.autoEsc(this.NAME)}${this.hasFlag("CASCADE")?" CASCADE":""}`}static parse(t,e){let[s,r,n]=/^DROP\s+DATABASE\s+(IF\s+EXISTS\s+)?(.+)$/i.exec(e)||[];if(!s)return;let[i]=this.parseIdent(t,n.trim(),!0)||[];if(!i)return;let a=new this(t,i);return r&&a.withFlag("IF_EXISTS"),a}};var Y=class extends x{NAME="";BASENAME="";COLUMNS=[];CONSTRAINTS=[];INDEXES=[];constructor(t,e,s){super(t),this.NAME=e,this.BASENAME=s}name(t){let e=Array.isArray(t)?[...t]:[t];if(this.NAME=e.pop(),this.BASENAME=e.pop(),e.length)throw new Error(`Idents can be maximum of two parts. Recieved: ${e.reverse().join(".")}.${this.BASENAME}.${this.NAME}`)}column(...t){return this.build("COLUMNS",t,J)}constraint(...t){return this.build("CONSTRAINTS",t,M)}index(...t){return this.build("INDEXES",t,B)}toJson(){return{name:this.NAME,basename:this.BASENAME,columns:this.COLUMNS.map(e=>e.toJson()),constraints:this.CONSTRAINTS.map(e=>e.toJson()),indexes:this.INDEXES.map(e=>e.toJson()),flags:this.FLAGS}}static fromJson(t,e){if(typeof e?.name!="string"||!Array.isArray(e.columns))return;let s=new this(t,e.name,e.basename).withFlag(...e.flags||[]);return s.column(...e.columns),e.constraints?.length&&s.constraint(...e.constraints),e.indexes?.length&&s.index(...e.indexes),s}stringify(){let t=[this.COLUMNS.map(s=>s.stringify()).join(`,
	`)],e=this.CONSTRAINTS.slice(0);return this.params.dialect==="mysql"&&e.push(...this.COLUMNS.reduce((s,r)=>{let n=r.CONSTRAINTS.find(i=>i.TYPE==="FOREIGN_KEY");return n?s.concat(M.fromColumnLevelConstraint(n,r.NAME)):s},[])),e.length&&t.push(e.map(s=>s.stringify()).join(`,
	`)),this.INDEXES.length&&t.push(this.INDEXES.map(s=>s.stringify()).join(`,
	`)),`CREATE TABLE${this.hasFlag("IF_NOT_EXISTS")?" IF NOT EXISTS":""} ${this.autoEsc([this.BASENAME,this.NAME].filter(s=>s)).join(".")} (
	${t.join(`,
	`)}
)`}static parse(t,e,s){let[r,n,i]=/^CREATE\s+TABLE\s+(IF\s+NOT\s+EXISTS\s+)?([\s\S]+)$/i.exec(e.trim())||[];if(!r)return;let[a,o]=p.split(i,[],{limit:2}),[l,u]=this.parseIdent(t,a.trim(),!0)||[];if(!l)return;let f=new this(t,l,u||t?.name);n&&f.withFlag("IF_NOT_EXISTS");let m=p.split(L(o,"(",")"),[","]).map(E=>s(f,E.trim(),[M,B,J]));for(let E of m)E instanceof M?f.constraint(E):E instanceof B?f.index(E):f.column(E);return f}static cloneJson(t){let e=structuredClone(t),s=(n,i)=>{let a=n[i];Object.defineProperty(n,`$${i}`,{get:()=>a,configurable:!0})};s(e,"name");for(let n of e.columns||[]){for(let i of["primaryKey","references","uniqueKey","check"])n[i]&&s(n[i],"constraintName");s(n,"name")}for(let n of e.constraints||[])s(n,"constraintName");for(let n of e.indexes||[])s(n,"indexName");let r=(n,i,a)=>{let o=n[i];Object.defineProperty(n,i,{get(){return o}}),Object.defineProperties(o,{get:{value:l=>o.find(u=>u[a]===l),configurable:!0},has:{value:l=>!!o.get(l),configurable:!0},delete:{value:l=>o.splice(o.findIndex(u=>u[a]===l),1),configurable:!0}})};return r(e,"columns","name"),r(e,"constraints","constraintName"),r(e,"indexes","indexName"),e}};var V=class extends x{NAME="";BASENAME="";JSON_BEFORE={};ACTIONS=[];constructor(t,e,s=null,r={}){super(t),this.NAME=e,this.BASENAME=s,this.JSON_BEFORE=r}name(t){let e=Array.isArray(t)?[...t]:[t];if(this.NAME=e.pop(),this.BASENAME=e.pop(),e.length)throw new Error(`Idents can be maximum of two parts. Recieved: ${e.reverse().join(".")}.${this.BASENAME}.${this.NAME}`)}renameTo(t){return this.build("ACTIONS",[t],W,"renameTo")}relocateTo(t){return this.build("ACTIONS",[t],W,"relocateTo")}drop(t){return this.build("ACTIONS",[t],W,"drop")}add(t){return this.build("ACTIONS",[t],W,"add")}alter(t,e){return this.build("ACTIONS",[t,e],W,"alter")}toJson(){return{name:this.NAME,basename:this.BASENAME,jsonBefore:this.JSON_BEFORE,actions:this.ACTIONS.map(t=>t.toJson()),flags:this.FLAGS}}static fromJson(t,e){if(typeof e?.name!="string"||!Array.isArray(e.actions))return;let s=new this(t,e.name,e.basename,e.jsonBefore).withFlag(...e.flags||[]);for(let r of e.actions)s.ACTIONS.push(W.fromJson(s,r));return s}stringify(){if(!this.ACTIONS.length)return"";let t=[],e=[];for(let s of this.ACTIONS){if(s.TYPE==="RENAME"){t.push(`RENAME TO ${this.autoEsc(s.ARGUMENT)}`);continue}if(s.TYPE==="RELOCATE"){t.push(`SET SCHEMA ${this.autoEsc(s.ARGUMENT)}`);continue}if(s.TYPE==="DROP"){let r=s.hasFlag("IF_EXISTS"),n=(s.FLAGS?.join(" ")||"").match(/RESTRICT|CASCADE/i)||[],i=s.ARGUMENT instanceof M?"CONSTRAINT":s.ARGUMENT instanceof B?"INDEX":"COLUMN";if(this.params.dialect==="mysql"&&i==="CONSTRAINT"&&s.ARGUMENT.CONSTRAINT_NAME==="PRIMARY")e.push("DROP PRIMARY KEY");else{let a=i==="CONSTRAINT"?"CONSTRAINT_NAME":i==="INDEX"?"INDEX_NAME":"NAME";e.push(`DROP ${this.params.dialect==="mysql"&&i==="CONSTRAINT"&&s.ARGUMENT.TYPE==="FOREIGN_KEY"?"FOREIGN KEY":i}${r?" IF EXISTS":""} ${this.autoEsc(s.ARGUMENT[a])}${n.length?` ${n[0]}`:""}`)}continue}if(s.TYPE==="ADD"){let r=s.hasFlag("IF_NOT_EXISTS"),[,n,i]=/(FIRST)|AFTER\s+(\w+)/i.exec(s.FLAGS?.join(" ")||"")||[];if(e.push(`ADD ${s.ARGUMENT instanceof J?"COLUMN ":""}${r?"IF NOT EXISTS ":""}${s.ARGUMENT}${n?" FIRST":i?` AFTER ${i.toLowerCase()}`:""}`),this.params.dialect==="mysql"&&s.ARGUMENT instanceof J){let a=s.ARGUMENT.CONSTRAINTS.find(o=>o.TYPE==="FOREIGN_KEY");a&&e.push(`ADD ${M.fromColumnLevelConstraint(a,s.ARGUMENT.NAME)}`)}continue}if(s.TYPE==="ALTER"){let{REFERENCE:r,ARGUMENT:n}=s;if(n.TYPE==="RENAME"){e.push(`RENAME ${r.kind} ${this.autoEsc(r.name)} TO ${this.autoEsc(n.ARGUMENT)}`);continue}if(r.kind==="COLUMN"){let a=()=>{if(n.TYPE==="ADD")e.push(`ADD ${M.fromColumnLevelConstraint(n.ARGUMENT,r.name)}`);else{let l=u=>`DROP CONSTRAINT ${this.autoEsc(u.CONSTRAINT_NAME)}`;this.params.dialect==="mysql"&&["PRIMARY_KEY","FOREIGN_KEY"].includes(dropTarget.TYPE)&&(l=u=>u.TYPE==="PRIMARY_KEY"?"DROP PRIMARY KEY":`DROP FOREIGN KEY ${this.autoEsc(u.CONSTRAINT_NAME)}`),n.TYPE==="DROP"?e.push(l(n.ARGUMENT)):n.TYPE==="SET"&&(e.push(l({TYPE:n.ARGUMENT.TYPE,CONSTRAINT_NAME:r.name})),e.push(`ADD ${M.fromColumnLevelConstraint(n.ARGUMENT,r.name)}`))}},o=()=>{e.push(`ALTER COLUMN ${this.autoEsc(r.name)} ${n.TYPE} ${n.ARGUMENT}`)};this.params.dialect==="mysql"?n.ARGUMENT instanceof U?n.ARGUMENT.TYPE==="DEFAULT"?e.push(`ALTER COLUMN ${this.autoEsc(r.name)} ${n.TYPE==="DROP"?"DROP":"SET"} ${n.ARGUMENT}`):["PRIMARY_KEY","FOREIGN_KEY","UNIQUE"].includes(n.ARGUMENT.TYPE)?a():o():o():n.ARGUMENT instanceof K?e.push(`ALTER COLUMN ${this.autoEsc(r.name)} SET DATA TYPE ${n.ARGUMENT}`):n.ARGUMENT instanceof U?["IDENTITY","EXPRESSION","DEFAULT","NOT_NULL"].includes(n.ARGUMENT.TYPE)?((n.TYPE==="DROP"||n.ARGUMENT.TYPE==="IDENTITY"&&n.TYPE==="SET")&&e.push(`ALTER COLUMN ${this.autoEsc(r.name)} DROP ${n.ARGUMENT.TYPE.replace(/_/," ")}${n.TYPE==="DROP"&&["IDENTITY","EXPRESSION"].includes(n.ARGUMENT.TYPE)&&s.FLAGS?.includes("IF_EXISTS")?" IF EXISTS":""}`),["ADD","SET"].includes(n.TYPE)&&n.ARGUMENT.TYPE!=="EXPRESSION"&&e.push(`ALTER COLUMN ${this.autoEsc(r.name)} ${n.ARGUMENT.TYPE==="IDENTITY"?"ADD":"SET"} ${n.ARGUMENT}`)):["PRIMARY_KEY","FOREIGN_KEY","UNIQUE","CHECK"].includes(n.ARGUMENT.TYPE)?a():o():o();continue}if(typeof n.ARGUMENT=="string"){e.push(`ALTER ${r.kind} ${this.autoEsc(r.name)} ${n.ARGUMENT}`);continue}let i=`DROP ${r.kind} ${this.autoEsc(r.name)}`;this.params.dialect==="mysql"&&["PRIMARY_KEY","FOREIGN_KEY"].includes(n.ARGUMENT.TYPE)&&(i=n.ARGUMENT.TYPE==="PRIMARY_KEY"?"DROP PRIMARY KEY":`DROP FOREIGN KEY ${this.autoEsc(r.name)}`),e.push(i,`ADD ${n.ARGUMENT}`);continue}}return`ALTER TABLE${this.hasFlag("IF_EXISTS")?" IF EXISTS":""} ${this.autoEsc([this.BASENAME,this.NAME].filter(s=>s)).join(".")}
	${[...e,...t].join(`,
	`)}`}static parse(t,e,s){let[r,n,i]=/^ALTER\s+TABLE\s+(IF\s+EXISTS\s+)?([\s\S]+)$/i.exec(e.trim())||[];if(!r)return;let[a,o]=p.split(i,["\\s+"],{useRegex:!0,limit:1}),[l,u]=this.parseIdent(t,a.trim(),!0)||[];if(!l)return;let f=new this(t,l,u||t?.name);n&&f.withFlag("IF_EXISTS");let m=h=>new RegExp(`${this[h].source}`,"i"),E=p.split(o,[","]).map(h=>h.trim());for(let h of E){let[d,N,_,,T,O,,S]=m("renameRe").exec(h)||[];if(d){let ft=_||this.autoUnesc(f,T),rt=O||this.autoUnesc(f,S);if(ft){let Nt={kind:/KEY|INDEX/i.test(N)?"INDEX":N.toUpperCase(),name:ft};f.alter(Nt,k=>k.renameTo(rt))}else f.renameTo(rt);continue}let[C,w,,le]=m("relocateRe").exec(h)||[];if(C){f.relocateTo(w||this.autoUnesc(f,le));continue}let[_e,_t="COLUMN",We,Xe,,ke,Ve]=m("dropRe").exec(h)||[];if(_e){let ft=/CONSTRAINT|PRIMARY\s+KEY|FOREIGN\s+KEY|CHECK/i.test(_t)?"CONSTRAINT":/INDEX|KEY/i.test(_t)?"INDEX":"COLUMN",rt=Xe||this.autoUnesc(f,ke)||_t.trim().replace(/\s+KEY/i,"").toUpperCase(),Et=ft==="CONSTRAINT"?new M(f,rt,_t.trim().toUpperCase(),[],null):ft==="INDEX"?new B(f,rt,_t.trim().toUpperCase(),[]):new J(f,rt,null,[]),Nt=[We,Ve].filter(k=>k).map(k=>k.trim().replace(/\s+/g,"_").toUpperCase());f.drop(Et).withFlag(...Nt);continue}let[Qe,ze,Ze,be]=m("addRe").exec(h)||[];if(Qe){let[,ft,rt]=be.match(/([\s\S]+)\s+(FIRST|AFTER\s+.+)$/i)||[,be],Et=s(f,ft.trim(),ze?[J]:[M,B,J]),Nt=[Ze,rt].filter(k=>k).map(k=>k.trim().replace(/\s+/g,"_").toUpperCase());f.add(Et).withFlag(...Nt);continue}let[je,$e,ts,,es,xe="",Ne="",ss,rs]=m("alterRe").exec(h)||[];if(je){let ft=ts||this.autoUnesc(f,es),rt=/CONSTRAINT|CHECK/i.test($e)?"CONSTRAINT":/INDEX|KEY/i.test($e)?"INDEX":"COLUMN",Et=xe.toUpperCase()||"SET",Nt=ss?["IF_EXISTS"]:[],k={},Kt;Et.endsWith("TYPE")?(Kt=s(f,Ne,[K]),Et="SET"):(k.argument=s(f,Ne,[U],{assert:!1}))?Kt=k.argument:xe?Kt=Ne:Kt=rs;let is={kind:rt,name:ft};f.alter(is,ns=>ns[Et.toLowerCase()](Kt)).withFlag(...Nt);continue}throw new SyntaxError(h)}return f}static fromDiffing(t,e,s,r=[]){if(!e?.name)throw new Error("Could not assertain table1 name or table1 name invalid.");if(!s?.name)throw new Error("Could not assertain table2 name or table2 name invalid.");let n=new this(t,e.name,e.basename,e).withFlag(...r);s.name!==e.name&&n.renameTo(s.name),s.basename!==e.basename&&n.relocateTo(s.basename);for(let i of["columns","constraints","indexes"]){let a=i==="constraints"?"constraintName":i==="indexes"?"indexName":"name",o=i==="constraints"?"CONSTRAINT":i==="indexes"?"INDEX":"COLUMN",l=o==="CONSTRAINT"?M:o==="INDEX"?B:J,[u,f,m]=Ce(e[i],s[i],a);for(let E of m){let h=e[i].find(_=>_[a]===E),d=s[i].find(_=>(`$${a}`in _?_[`$${a}`]:_[a])===E),N={kind:o,name:E};if(u.has(E)&&!f.has(E))n.drop(l.fromJson(n,h));else if(!u.has(E)&&f.has(E))n.add(l.fromJson(n,d));else if(u.has(E)&&f.has(E))if(o==="COLUMN"){let[_,T,O]=Ce(h,d);for(let S of O){let C=w=>{let le=U.attrEquivalents[S];if(le){let{constraintName:_e,..._t}=w[S];return U.fromJson(n,{constraintName:_e,type:le,detail:_t})}throw new Error(`Unkown attribute: ${S}.`)};_.has(S)&&h[S]&&(!T.has(S)||!d[S])?n.alter(N,w=>w.drop(C(h))):(!_.has(S)||!h[S])&&T.has(S)&&d[S]?n.alter(N,w=>w.add(C(d))):_.has(S)&&T.has(S)&&!Ee(h[S],d[S])&&(S==="name"?n.alter(N,w=>w.renameTo(d[S])):S==="type"?n.alter(N,w=>w.set(K.fromJson(n,d[S]))):n.alter(N,w=>w.set(C(d))))}}else Ee(h,d)||n.alter(N,_=>_.set(l.fromJson(n,d)))}}return n}static fromDiffing2d(t,e,s,r=[]){let n="name",i=[],[a,o,l]=Ce(e,s,n);for(let u of l)if(a.has(u)&&!o.has(u))i.push({type:"DROP",argument:u});else if(!a.has(u)&&o.has(u)){let f=s.find(m=>(`$${n}`in m?m[`$${n}`]:m[n])===u);i.push({type:"ADD",argument:Y.fromJson(t,f,r)})}else if(a.has(u)&&o.has(u)){let f=e.find(h=>h[n]===u),m=s.find(h=>(h[`$${n}`]||h[n])===u),E=this.fromDiffing(t,f,m,r);E.ACTIONS.length&&i.push({type:"ALTER",argument:E})}return i}static renameRe=/^RENAME\s+(?:(?:(COLUMN|CONSTRAINT|INDEX|KEY)\s+)?(?:(\w+)|([`"])((?:\3\3|[^\3])+)\3)\s+)?(?:TO|AS)\s+(?:(\w+)|([`"])([^\6]+)\6)$/;static relocateRe=/^SET\s+SCHEMA\s+(?:(\w+)|([`"])((?:\2\2|[^\3])+)\2)$/;static dropRe=/^DROP\s+(COLUMN\s+|CONSTRAINT\s+|PRIMARY\s+KEY|FOREIGN\s+KEY\s+|CHECK\s+|INDEX\s+|KEY\s+)?(IF\s+EXISTS\s+)?(?:(\w+)|([`"])((?:\4\4|[^\3])+)\4)?(?:\s+(RESTRICT|CASCADE))?$/;static addRe=/^ADD\s+(COLUMN\s+)?(IF\s+NOT\s+EXISTS\s+)?([\s\S]+)$/;static alterRe=/^ALTER\s+(?:(COLUMN|CONSTRAINT|CHECK|INDEX|KEY)\s+)?(?:(\w+)|([`"])((?:\3\3|[^\3])+?)\3)\s+(?:(ADD|DROP|(?:SET\s+DATA\s+)?TYPE|SET)\s+(.+)(IF\s+EXISTS)?$|(VISIBLE|(?:NOT\s+)?INVISIBLE|NOT\s+ENFORCED|ENFORCED|DEFERRABLE|NOT\s+DEFERRABLE|INITIALLY\s+DEFERRED|INITIALLY\s+IMMEDIATE))/};function Ce(c,t,e){Array.isArray(c)?(c=c.map(r=>r[e]),t=t.map(r=>`$${e}`in r?r[`$${e}`]:r[e])):(c=Object.keys(c),t=Object.keys(t).filter(r=>!r.startsWith("$"))),c=new Set(c),t=new Set(t);let s=new Set([...c,...t]);return[c,t,s]}function Ee(c,t){if(c===t)return!0;if(Array.isArray(c)&&Array.isArray(t)&&c.length===t.length){let s=t.slice(0).sort();return c.slice(0).sort().every((r,n)=>Ee(r,s[n]))}let e={};return typeof c=="object"&&c&&typeof t=="object"&&t&&(e.keys_a=Object.keys(c)).length===(e.keys_b=Object.keys(t)).length?e.keys_a.reduce((s,r)=>s&&Ee(c[r],t[r]),!0):!1}var tt=class extends x{NAME="";BASENAME="";constructor(t,e,s){super(t),this.NAME=e,this.BASENAME=s}name(t){let e=Array.isArray(t)?[...t]:[t];if(this.NAME=e.pop(),this.BASENAME=e.pop(),e.length)throw new Error(`Idents can be maximum of two parts. Recieved: ${e.reverse().join(".")}.${this.BASENAME}.${this.NAME}`)}toJson(){return{name:this.NAME,basename:this.BASENAME,flags:this.FLAGS}}static fromJson(t,e){if(typeof e?.name=="string")return new this(t,e.name,e.basename).withFlag(...e.flags||[])}stringify(){return`DROP TABLE${this.hasFlag("IF_EXISTS")?" IF EXISTS":""} ${this.autoEsc([this.BASENAME,this.NAME].filter(t=>t)).join(".")}${this.hasFlag("CASCADE")?" CASCADE":""}`}static parse(t,e){let[s,r,n]=/^DROP\s+TABLE\s+(IF\s+EXISTS\s+)?([\s\S]+)$/i.exec(e)||[];if(!s)return;let[i,a]=this.parseIdent(t,n.trim(),!0)||[];if(!i)return;let o=new this(t,i,a);return r&&o.withFlag("IF_EXISTS"),o}};var Ct=class extends A{OFFSET;constructor(t,e){super(t),this.OFFSET=parseInt(e)}toJson(){return{offset:this.OFFSET}}static fromJson(t,e){if(typeof e?.offset=="number")return new this(t,e.offset)}stringify(){return this.params.dialect==="mysql"?"?":"$"+this.OFFSET}static parse(t,e){let s=(t?.params?.inputDialect||t?.params?.dialect)==="mysql"?"?":"$",[r,n]=new RegExp(`^\\${s}(\\d)$`).exec(e)||[];if(r)return new this(t,parseInt(n))}};var ct=class extends A{VALUE="";QUOTE="";constructor(t,e,s="'"){super(t),this.VALUE=e,this.QUOTE=s}literal(t){this.VALUE=t}stringify(){let t=this.QUOTE||this.quoteChars[0];return`${t}${this.VALUE.replace(new RegExp(t,"g"),t.repeat(2))}${t}`}toJson(){return{value:this.VALUE}}static fromJson(t,e){if(typeof e?.value=="string")return new this(t,e.value,e.quote)}static parse(t,e){let[s,r]=this.parseText(t,e,!0)||[];if(r)return new this(t,s,r)}static parseText(t,e,s=!1){let r=this.getQuoteChars(t,s),n={};if(!(!(n.quote=r.find(i=>q(e,i,i)))||p.match(e,[" "]).length))return[L(e,n.quote,n.quote).replace(new RegExp(n.quote+n.quote,"g"),n.quote),n.quote]}};var lt=class extends ct{TYPE="";constructor(t,e,s,r){super(t,e,r),this.TYPE=s}object(t){this.VALUE=typeof t=="object"&&t?JSON.stringify(t):t,this.TYPE="OBJECT"}array(t){this.VALUE=Array.isArray(t)?JSON.stringify(t):t,this.TYPE="ARRAY"}toJson(){return{type:this.TYPE,...super.toJson()}}static fromJson(t,e){if(typeof e?.type!="string"||!/OBJECT|ARRAY/i.test(e.type)||!e.value)return;let s=new this(t);return s[e.type.toLowerCase()](e.value),s}stringify(){return`${super.stringify()}`}static parse(t,e){let s=[["{","}"],["[","]"]],r={},[n,i]=this.parseText(t,e)||[];if(i&&!(!(r.braces=s.find(a=>q(e,a[0],a[1])))||p.match(e,[" "]).length))return new this(t,n,r.braces[0]==="{"?"OBJECT":"ARRAY",i)}};var dt=class extends A{VALUE=0;constructor(t,e){super(t),this.VALUE=e}toJson(){return{value:this.VALUE,flags:this.FLAGS}}static fromJson(t,e){if(typeof e=="number"||typeof e=="string"&&/^[.\d]+$/.test(e)&&(e=parseFloat(e)))e={value:e};else if(typeof e?.value!="number")return;return new this(t,e.value).withFlag(...e.flags||[])}stringify(){return`${this.VALUE}`}static parse(t,e){if(/^\d+$/.test(e))return new this(t,parseFloat(e))}};var et=class extends A{static OPERATORS=["->","->>","#>","#>>"];OPERATOR="";LHS=null;RHS=null;path(t,e,s){if(!this.constructor.OPERATORS.includes(e))throw new Error(`Unknown operator: "${e}".`);this.build("LHS",[t],[lt,g]),this.build("RHS",[s],[lt,dt,ct]),this.OPERATOR=e}toJson(){return{lhs:this.LHS?.toJson(),rhs:this.RHS?.toJson(),operator:this.OPERATOR,flags:this.FLAGS}}static fromJson(t,e){if(!this.OPERATORS.includes(e?.operator))return;let s=new this(t).withFlag(...e.flags||[]);return s.path(e.lhs,e.operator,e.rhs),s}stringify(){return`${this.LHS} ${this.OPERATOR} ${this.RHS}`}static parse(t,e,s){if((t?.params?.inputDialect||t?.params?.dialect)==="mysql")return;let{tokens:r,matches:n}=p.lex(e,this.OPERATORS,{limit:1});if(!n.length)return;let i=new this(t),a=s(i,r[0],[lt,g]),o=s(i,r[1].trim(),[lt,dt,ct]);return i.path(a,n[0],o),i}static factoryMethods={path:(t,e,s,r)=>this.OPERATORS.includes(s)&&new this(t)}};var Q=class c extends A{static ARR_RIGHT="~>";static ARR_LEFT="<~";OPERATOR="";LHS=null;RHS=null;UUID=null;get isOutgoing(){return this.OPERATOR===this.constructor.ARR_RIGHT}get isIncoming(){return this.OPERATOR===this.constructor.ARR_LEFT}get uuid(){return this.UUID||(this.UUID=`$path:${(0|Math.random()*9e6).toString(36)}`),this.UUID}path(t,e,s){let r=this.constructor;if(![r.ARR_LEFT,r.ARR_RIGHT].includes(e))throw new Error(`Unknown operator: "${e}".`);this.build("LHS",[t],g),this.build("RHS",[s],[r,et,g]),this.OPERATOR=e}async eval(){let t=m=>m.columns.find(E=>E.primaryKey)?.name||m.constraints.find(E=>E.type==="PRIMARY_KEY")?.columns[0],e=(m,E)=>m.columns.find(h=>h.name===E.NAME)?.references||m.constraints.find(h=>h.type==="FOREIGN_KEY"&&h.columns.includes(E.NAME))?.references,s=async(m,E)=>{let h=this.rootNode.CONTEXT,d=E||await h.getBasename(m),N=h.database(d);if((await N.tables({name:m})).length)return await N.describeTable(m,{force:!0})};if(!this.rootNode.CONTEXT)throw new Error("No client API in context.");if(this.isIncoming){if(!(this.RHS instanceof c))throw new Error(`Unterminated path: ${this.RHS}`);let m,E,h,d;if(this.RHS.isIncoming){if(!(this.RHS.RHS instanceof c))throw new Error(`Unterminated path: ${this.RHS.RHS}`);({LHS:m,RHS:d}=this),h=(await d.eval()).lhs.schema,E=g.fromJson(this,h)}else if({LHS:m,RHS:{LHS:E,RHS:d}}=this,h=await s(E.NAME,E.BASENAME),!h)throw new Error(`[${this}]: The implied table ${E} does not exist.`);let N=e(h,m);if(!N)throw new Error(`[${this}]: Table ${E} does not define the implied foreign key: ${m}.`);let _=g.fromJson(this,N.basename?[N.basename,N.table]:N.table),T=await s(_.NAME,_.BASENAME);if(!T)throw new Error(`[${this}]: The implied table ${_} does not exist.`);let O=t(T);if(!O)throw new Error(`[${this}]: Table ${T.name} does not define a primary key.`);return{lhs:{schema:T,primaryKey:O},rhs:{schema:h,foreignKey:m,path:d}}}let r=this.statementNode.TABLES[0]?.EXPR;if(!r)throw new Error("No tables in query.");if(!(r instanceof g))throw new Error(`[${this}]: Base query must not be derived.`);let n=await s(r.NAME,r.BASENAME);if(!n)throw new Error(`[${this}]: The implied table ${r} does not exist.`);let{LHS:i,RHS:a}=this,o=e(n,i);if(!o)throw new Error(`[${this}]: Table ${r} does not define the implied foreign key: ${i}.`);let l=g.fromJson(this,o.basename?[o.basename,o.table]:o.table),u=await s(l.NAME,l.BASENAME||r.BASENAME);if(!u)throw new Error(`[${this}]: The implied table ${l} does not exist.`);let f=t(u);if(!f)throw new Error(`[${this}]: Table ${l} does not define a primary key.`);return{lhs:{schema:n,foreignKey:i},rhs:{schema:u,primaryKey:f,path:a}}}async plot(){if(this.JOINT)return;let t=this.statementNode,e=t.TABLES[0];if(!e)throw new Error("No tables in query.");if(!(e.EXPR instanceof g))throw new Error(`[${this}]: Base query must not be derived.`);let{lhs:s,rhs:r}=await this.eval(),n=s.foreignKey||s.primaryKey,i=r.primaryKey||r.foreignKey;if(s.primaryKey&&s.schema.name.toLowerCase()!==e.EXPR.NAME.toLowerCase())throw new Error(`[${this}]: Cannot resolve incoming path to base table ${e.EXPR}.`);let a=`$view:${[n,r.schema.basename,r.schema.name,i].join(":")}`,o=()=>this.JOINT=t.JOIN_LIST.find(l=>l.ALIAS.NAME===a);if(!o()){let l=["ALIAS","EXPR"].reduce((f,m)=>f||e[m]?.NAME,null),u=`${i}:${(0|Math.random()*9e6).toString(36)}`;t.leftJoin(f=>f.query(m=>m.select(E=>E.name(i).as(u)),m=>m.from([r.schema.basename,r.schema.name]))).with({IS_SMART_JOIN:!0}).as(a).on(f=>f.equals([a,u],[l,n])),o()}this.JOINT.EXPR.select(l=>l.expr(r.path.toJson()).as(this.uuid))}toJson(){return{lhs:this.LHS?.toJson(),rhs:this.RHS?.toJson(),operator:this.OPERATOR,flags:this.FLAGS}}static fromJson(t,e){if(![this.ARR_LEFT,this.ARR_RIGHT].includes(e?.operator))return;let s=new this(t).withFlag(...e.flags||[]);return s.path(e.lhs,e.operator,e.rhs),s}stringify(){return this.JOINT?this.autoEsc([this.JOINT.ALIAS.NAME,this.uuid]).join("."):`${this.LHS} ${this.OPERATOR} ${this.RHS}`}static parse(t,e,s){let{tokens:r,matches:n}=p.lex(e,[this.ARR_LEFT,this.ARR_RIGHT],{limit:1});if(!n.length)return;let i=new this(t),a=s(i,r[0],[g]),o=s(i,r[1],n[0]===this.ARR_LEFT?[this]:[this,et,g]);return i.path(a,n[0],o),i}static factoryMethods={path:(t,e,s,r)=>[this.ARR_LEFT,this.ARR_RIGHT].includes(s)&&new this(t)}};var Ft=class extends A{CONDITION=null;CONSEQUENCE=null;condition(t){return this.build("CONDITION",[t],y.Types),this}then_(t){return this.build("CONSEQUENCE",[t],y.Types)}toJson(){return{condition:this.CONDITION?.toJson(),consequence:this.CONSEQUENCE?.toJson()}}static fromJson(t,e){if(!(typeof e=="object"&&e&&"condition"in e))return;let s=new this(t);return s.condition(e.condition),s.then_(e.consequence),s}stringify(){return`${this.CONDITION} THEN ${this.CONSEQUENCE}`}static parse(t,e,s){let r=p.split(e,["\\s+THEN\\s+"],{useRegex:"i"});if(r.length!==2)return;let n=new this(t),[i,a]=r.map(o=>s(n,o.trim()));return n.condition(i).then_(a),n}};var wt=class extends A{BASE_VALUE;WHEN_CLAUSES=[];ELSE_CLAUSE;compare(t){if(this.WHEN_CLAUSES.length||this.ELSE_CLAUSE)throw new Error('A "case" clause must come before any "when" or "else" clauses.');return this.build("BASE_VALUE",[t],y.Types)}when(t){if(this.ELSE_CLAUSE)throw new Error('A "when" clause cannot come after an "else" clause.');return this.build("WHEN_CLAUSES",[t],Ft,"condition"),this.WHEN_CLAUSES[this.WHEN_CLAUSES.length-1]}else(t){if(!this.WHEN_CLAUSES.length)throw new Error('An "else" clause cannot come before "when" clauses.');return this.build("ELSE_CLAUSE",[t],y.Types)}toJson(){return{base_value:this.BASE_VALUE?.toJson(),when_clauses:this.WHEN_CLAUSES.map(t=>t.toJson()),else_clause:this.ELSE_CLAUSE?.toJson(),flags:this.FLAGS}}static fromJson(t,e){if(!Array.isArray(e?.when_clauses))return;let s=new this(t).withFlag(...e.flags||[]);e.base_value&&s.compare(e.base_value);for(let r of e.when_clauses)s.when(r);return e.else_clause&&s.else(e.else_clause),s}stringify(){let t=[];return this.BASE_VALUE&&t.push(this.BASE_VALUE),t.push(`WHEN ${this.WHEN_CLAUSES.join(" WHEN ")}`),this.ELSE_CLAUSE&&t.push("ELSE",this.ELSE_CLAUSE),`CASE ${t.join(" ")} END${this.params.dialect==="mysql"?" CASE":""}`}static parse(t,e,s){let[r,n]=e.match(/^CASE\s+([\s\S]*)\s+END(\s+CASE)?$/i)||[];if(!r)return;let{tokens:[i,...a],matches:o}=p.lex(n,["WHEN","ELSE"],{useRegex:"i"}),l=new this(t);i.trim()&&l.compare(s(l,i.trim()));for(let u of o){let f=a.shift();if(/ELSE/i.test(u))l.else(s(l,f.trim()));else if(/WHEN/i.test(u))l.when(s(l,f.trim(),[Ft]));else throw new Error(`Can't have multiple "${u}" clauses in a CASE construct.`)}return l}static factoryMethods={case:t=>new this(t)}};var Wt=class extends A{OPERAND=null;TYPE="";SYNTAX2=!1;cast(t,e,s=!1){return this.TYPE=e,this.SYNTAX2=s,this.build("OPERAND",[t],y.Types)}toJson(){return{operand:this.OPERAND?.toJson(),type:this.TYPE,syntax2:this.SYNTAX2,flags:this.FLAGS}}static fromJson(t,e){if(!e?.operand||!e?.type)return;let s=new this(t).withFlag(...e.flags||[]);return s.cast(e.operand,e.type,e.syntax2),s}stringify(){return this.SYNTAX2?`${this.OPERAND}::${this.TYPE}`:`CAST(${this.OPERAND} AS ${this.TYPE})`}static parse(t,e,s){let r,n,i=!1;if(/^CAST(?:\s+)?\([\s\S]+\)$/i.test(e)){let[,o]=p.split(e,[]);[r,n]=p.split(o.slice(1,-1),["AS"],{useRegex:"i"})}else{if((t?.params?.inputDialect||t?.params?.dialect)==="mysql"||([r,n]=p.split(e,["::"]),!n))return;i=!0}let a=new this(t);return a.cast(s(a,r.trim()),n.trim(),i),a}};var ht=class extends A{$EXPR;constructor(t,e){super(t),this.$EXPR=e}get NAME(){return this.$EXPR?.NAME}get BASENAME(){return this.$EXPR?.BASENAME}get EXPR(){return this.$EXPR?.EXPR||this.$EXPR}query(...t){return this.build("$EXPR",t,X),this.$EXPR}expr(...t){return this.build("$EXPR",t,[X,...y.Types]),this.$EXPR}toJson(){return{expr:this.$EXPR?.toJson(),flags:this.FLAGS}}static fromJson(t,e){if(!e?.expr||Object.keys(e).length!==(e.flags?2:1))return;let s=new this(t).withFlag(...e.flags||[]);return s.expr(e.expr),s}stringify(){return"("+this.$EXPR.stringify()+")"}static parse(t,e,s){if(!(!q(e,"(",")")||p.match(e,[" "]).length&&p.split(e,[]).length===2))return new this(t,s(t,L(e,"(",")"),[X,...y.Types]))}};var Xt=class extends A{OPERATOR="";OPERANDS=[];constructor(t,e,...s){super(t),this.OPERATOR=e,this.OPERANDS=s}calc(t,...e){return this.OPERATOR&&this.OPERATOR!==t?new this.constructor(this).calc(t,this,...e):(this.OPERATOR=t,this.build("OPERANDS",e,y.Types),this)}sum(...t){return this.calc("+",...t)}sub(...t){return this.calc("-",...t)}div(...t){return this.calc("/",...t)}times(...t){return this.calc("*",...t)}toJson(){return{operator:this.OPERATOR,operands:this.OPERANDS.map(t=>t.toJson()),flags:this.FLAGS}}static fromJson(t,e){if(typeof e?.operator!="string"||!/\+|\-|\*|\//.test(e.operator)||!Array.isArray(e.operands))return;let s=new this(t).withFlag(...e.flags||[]);return s.calc(e.operator,...e.operands),s}stringify(){return this.OPERANDS.join(` ${this.OPERATOR} `)}static parse(t,e,s){for(let r of["\\*","\\/","\\+","\\-"]){let{tokens:n,matches:i}=p.lex(e,[`(\\s+)?${r}(\\s+)?`],{useRegex:"i"});if(!(n.filter(a=>a.trim()).length<2))return new this(t,i.pop().trim(),...n.map(a=>s(t,a.trim())))}}};var Lt=class extends A{CRITERIA=[];criterion(...t){return this.build("CRITERIA",t,y.Types)}stringify(){return this.CRITERIA.map(t=>t.stringify()).join(",")}toJson(){return{criteria:this.CRITERIA.map(t=>t.toJson()),flags:this.FLAGS}}static fromJson(t,e){if(!Array.isArray(e?.criteria))return;let s=new this(t).withFlag(...e.flags||[]);return s.criterion(...e.criteria),s}static parse(t,e,s){let[r,n]=e.match(new RegExp(`^${this.regex}([\\s\\S]*)$`,"i"))||[];if(!r)return;let i=new this(t);for(let a of p.split(n.trim(),[","]))i.criterion(s(i,a));return i}static regex="GROUP\\s+BY"};var vt=class extends Lt{stringify(){return["PARTITION BY",super.stringify()].join(" ")}static regex="PARTITION\\s+BY"};var kt=class extends A{CRITERIA=[];criterion(...t){return this.build("CRITERIA",t,y.Types)}toJson(){return{criteria:this.CRITERIA.map(t=>t.toJson()),flags:this.FLAGS}}static fromJson(t,e){if(!Array.isArray(e?.criteria))return;let s=new this(t).withFlag(...e.flags||[]);return s.criterion(...e.criteria),s}stringify(){return this.CRITERIA.map(t=>[t,...t.FLAGS].join(" ")).join(",")}static parse(t,e,s){let[r,n]=e.match(new RegExp(`^${this.regex}([\\s\\S]*)$`,"i"))||[];if(!r)return;let i=new this(t);for(let a of p.split(n.trim(),[","])){let[,o,l]=/([\s\S]+)\s+(ASC|DESC)$/i.exec(a)||[,a];i.criterion(s(i,o).withFlag(l))}return i}static regex="ORDER\\s+BY"};var P=class extends kt{withRollup(){return this.withFlag("WITH_ROLLUP")}stringify(){return["ORDER BY",super.stringify(),...this.FLAGS.map(t=>t.replace(/_/g," "))].join(" ")}static parse(t,e,s){let{tokens:[r],matches:n}=p.lex(e,["\\s+WITH\\s+ROLLUP$"],{useRegex:"i"}),i=super.parse(t,r.trim(),s);if(i)return n.length&&i.withFlag("WITH_ROLLUP"),i}};var At=class extends A{NAME;WINDOW_REF;PARTITION_BY_CLAUSE;ORDER_BY_CLAUSE;name(t){return this.NAME=t,this}existing(t){return this.WINDOW_REF=t,this}extends(t){return this.WINDOW_REF=t,this}partitionBy(...t){if(this.WINDOW_REF)throw new Error("The PARTITION BY clause is not allowed when inheriting from a base window.");return this.build("PARTITION_BY_CLAUSE",t,vt,"criterion")}orderBy(...t){return this.build("ORDER_BY_CLAUSE",t,P,"criterion")}toJson(){return{name:this.NAME,window_ref:this.WINDOW_REF,partition_by_clause:this.PARTITION_BY_CLAUSE?.toJson(),order_by_clause:this.ORDER_BY_CLAUSE?.toJson()}}static fromJson(t,e){if(typeof e=="string")e={window_ref:e};else if(!(typeof e=="object"&&e)||!["name","window_ref","partition_by_clause","order_by_clause"].some(r=>r in e))return;let s=new this(t);return e.name&&s.name(e.name),e.window_ref&&s.extends(e.window_ref),e.partition_by_clause&&s.partitionBy(e.partition_by_clause),e.order_by_clause&&s.orderBy(e.order_by_clause),s}stringify(){let t=[];return!this.NAME&&this.WINDOW_REF&&!this.PARTITION_BY_CLAUSE&&!this.ORDER_BY_CLAUSE?t.push(this.WINDOW_REF):(this.NAME&&t.push(`${this.NAME} AS `),t.push(`(${[this.WINDOW_REF,this.PARTITION_BY_CLAUSE,this.ORDER_BY_CLAUSE].filter(e=>e).join(" ")})`)),t.join("")}static parse(t,e,s){let r=new this(t),n=async o=>{let{tokens:[l,...u],matches:f}=p.split(L(o.trim(),"(",")"),["PARTITION\\s+BY","ORDER\\s+BY"],{useRegex:"i",preserveDelims:!0});l.trim()&&r.extends(l.trim());for(let m of f){if(/PARTITION\s+BY/i.test(m)){r.partitionBy(s(r,u.shift().trim(),[vt]));continue}r.orderBy(s(r,u.shift().trim(),[P]))}},i=e.endsWith(")");if(i&&!e.startsWith("(")){let[o,l]=spec.split(new RegExp(" AS ","i"));r.name(o.trim()),n(l)}else i?n(e):r.existing(e);return r}static regex="WINDOW|OVER"};var mt=class extends A{NAME="";ARGS=[];call(t,...e){return this.NAME=t,this.build("ARGS",e,y.Types)}toJson(){return{name:this.NAME,args:this.ARGS.map(t=>t.toJson()),flags:this.FLAGS}}static fromJson(t,e){if(typeof e?.name!="string"||!Array.isArray(e.args))return;let s=new this(t).withFlag(...e.flags||[]);return s.call(e.name,...e.args),s}stringify(){return`${this.NAME.toUpperCase()}(${this.ARGS.join(",")})`}static parse(t,e,s){if(!e.endsWith(")")||p.match(e,[" "]).length)return;let[,r,n=""]=/^(\w+)\(([\s\S]+)?\)$/i.exec(e),i=new this(t);return i.call(r,...p.split(n,[","]).map(a=>s(i,a.trim()))),i}};var ut=class extends mt{ORDER_BY_CLAUSE;OVER_CLAUSE;call(...t){return super.call(...t),this}orderBy(...t){return this.build("ORDER_BY_CLAUSE",t,P,"criterion"),this}over(t){return t||(t={name:""}),this.build("OVER_CLAUSE",[t],At),this.OVER_CLAUSE}toJson(){return{...super.toJson(),order_by_clause:this.ORDER_BY_CLAUSE?.toJson(),over_clause:this.OVER_CLAUSE?.toJson()}}static fromJson(t,e){let s=super.fromJson(t,e);if(s)return this.names.flat().includes(s.NAME.toUpperCase())&&(e.order_by_clause&&s.orderBy(e.order_by_clause),e.over_clause&&s.over(e.over_clause)),s}stringify(){return`${this.NAME.toUpperCase()}(${[...this.FLAGS,this.ARGS.join(","),this.ORDER_BY_CLAUSE].filter(e=>e).join(" ")})`+(this.OVER_CLAUSE?` OVER ${this.OVER_CLAUSE}`:"")}static parse(t,e,s){let[r,n]=p.split(e,["OVER\\s+"],{useRegex:"i"}).map(m=>m.trim());if(!r.endsWith(")")||p.match(r,[" "]).length)return;let[,i,a,o=""]=/^(\w+)\((?:\s+)?(?:(ALL|DISTINCT)\s+)?([\s\S]+)?\)$/i.exec(r);if(!this.names.flat().includes(i.toUpperCase()))return;let[,l,u]=/^([\s\S]+)(?:\s+(ORDER\s+BY\s+.+))$/i.exec(o)||[,o],f=super.parse(t,`${i}(${l})`,s);return a&&f.withFlag(a),u?f.orderBy(s(f,u,[P])):n&&f.over(s(f,n,[At])),f}static factoryMethods={call:(t,e,...s)=>this.names.flat().includes(e?.toUpperCase())&&new this(t)};static names=[["AVG","BIT_AND","BIT_OR","BIT_XOR","COUNT","JSON_ARRAYAGG","JSON_OBJECTAGG","MAX","MIN","STDDEV_POP","STDDEV","STD","STDDEV_SAMP","SUM","VAR_POP","VARIANCE","VAR_SAMP","GROUP_CONCAT","GROUP_CONCAT_WS"],["CUME_DIST","DENSE_RANK","FIRST_VALUE","LAG","LAST_VALUE","LEAD","NTH_VALUE","NTLE","PERCENT_RANK","RANK","ROW_NUMBER"],["ANY_VALUE","COLUMN","COLUMNS","GROUPING"]]};var Vt=class extends A{STRINGS=[];join(...t){return this.build("STRINGS",t,y.Types)}toJson(){return{strings:this.STRINGS.map(t=>t.toJson()),flags:this.FLAGS}}static fromJson(t,e){if(!Array.isArray(e?.strings))return;let s=new this(t).withFlag(...e.flags||[]);return s.join(...e.strings),s}stringify(){return this.STRINGS.join(" || ")}static parse(t,e,s){if((t?.params?.inputDialect||t?.params?.dialect)==="mysql")return;let r=p.split(e,["||"]);if(r.length<2)return;let n=new this(t);return n.join(...r.map(i=>s(n,i.trim()))),n}};var Qt=class extends A{VALUE;constructor(t,e){super(t),this.VALUE=e}true(){this.VALUE=!0}false(){this.VALUE=!1}null(){this.VALUE=null}toJson(){return this.VALUE}static fromJson(t,e){if([!0,!1,null].includes(e))return new this(t,e)}stringify(){return`${this.VALUE}`}static parse(t,e){if(/^(TRUE|FALSE|NULL)$/i.test(e))return new this(t,JSON.parse(e))}};var y=class{static cast(t,e,s=this.Types){if(typeof e=="function"){if(s.length===1){let i=new s[0](t);return e(i),i}let r,n=i=>(...a)=>{let o=s.reduce((l,u)=>l||(u.factoryMethods?i in u.factoryMethods&&u.factoryMethods[i](t,...a):i in u.prototype&&new u(t)),null);if(!o)throw new Error(`Unknow method: ${i}()`);if(r=o,o[i])return o[i](...a);for(let l of a)l(o)};return e(new Proxy({},{get:(i,a)=>n(a)})),r}return this.fromJson(t,e,s)}static fromJson(t,e,s=this.Types){let r=s.reduce((n,i)=>n||(e instanceof i?e:i.fromJson(t,e)),null);if(!r)throw new Error("");return r}static parse(t,e,s){return s(t,e,this.Types)}static get Types(){return[ht,wt,Vt,b,Q,et,F,Xt,Wt,ut,mt,lt,ct,dt,Qt,Ct,g]}};var F=class extends A{OPERATOR="";OPERANDS=[];constructor(t,e,...s){super(t),this.OPERATOR=e,this.OPERANDS=s}assert(t,...e){return this.OPERATOR&&this.OPERANDS.splice(0),this.OPERATOR=t,this.build("OPERANDS",e,y.Types),this}equals(...t){return this.assert("=",...t)}eq(...t){return this.equal(...t)}notEqual(...t){return this.assert("<>",...t)}notEq(...t){return this.notEqual(...t)}lesserThan(...t){return this.assert("<",...t)}lt(...t){return this.lesserThan(...t)}lessThanOrEqual(...t){return this.assert("<=",...t)}ltOrEq(...t){return this.lessThanOrEqual(...t)}greaterThan(...t){return this.assert(">",...t)}gt(...t){return this.greaterThan(...t)}greaterThanOrEqual(...t){return this.assert(">=",...t)}gtOrEq(...t){return this.greaterThanOrEqual(...t)}in(...t){return this.assert("IN",...t)}any(...t){return this.assert("ANY",...t)}like(...t){return this.assert("LIKE",...t)}isNull(...t){return this.assert("IS NULL",...t)}isNotNull(...t){return this.assert("IS NOT NULL",...t)}isTrue(...t){return this.assert("IS TRUE",...t)}isNotTrue(...t){return this.assert("IS NOT TRUE",...t)}isFalse(...t){return this.assert("IS FALSE",...t)}isNotFalse(...t){return this.assert("IS NOT FALSE",...t)}isUnknow(...t){return this.assert("IS UNKNOWN",...t)}isNotUnknow(...t){return this.assert("IS NOT UNKNOWN",...t)}isDistinctFrom(...t){return this.assert("IS DISTINCT FROM",...t)}isNotDistinctFrom(...t){return this.assert("IS NOT DISTINCT FROM",...t)}isBetween(...t){return this.assert("IS BETWEEN",...t)}isNotBetween(...t){return this.assert("IS NOT BETWEEN",...t)}isBetweenSymmetric(...t){return this.assert("IS BETWEEN SYMMETRIC",...t)}isNotBetweenSymmetric(...t){return this.assert("IS NOT BETWEEN SYMMETRIC",...t)}and(...t){return new b(this,"AND").and(this,...t)}or(...t){return new b(this,"OR").or(this,...t)}toJson(){return{operator:this.OPERATOR,operands:this.OPERANDS.map(t=>t.toJson()),flags:this.FLAGS}}static fromJson(t,e){if(!Array.isArray(e?.operands)||typeof e?.operator!="string"||!this.regexes.some(r=>new RegExp(r.regex||r.test||r).test(` ${e.operator} `)))return;let s=new this(t).withFlag(...e.flags||[]);return s.assert(e.operator,...e.operands),s}stringify(){let t=this.OPERANDS.slice(0),e=[t.shift(),this.OPERATOR.toUpperCase()],s=t;return this.OPERATOR==="IN"?e.push(`(${s.join(",")})`):/BETWEEN/i.test(this.OPERATOR)?e.push(`(${s.join(" AND ")})`):e.push(`${s.join(" ")}`),e.filter(r=>r).join(" ")}static parse(t,e,s){let{tokens:[r,n=""],matches:[i]}=p.lex(e,this.regexes,{useRegex:"i"});if(!i)return;let a=i.trim().toUpperCase(),o=[r];return a==="IN"?o.push(...p.split(L(n.trim(),"(",")"),[","])):/BETWEEN/.test(a)?o.push(...p.split(n,[" AND "])):n&&o.push(n),new this(t,a,...o.map(l=>s(t,l.trim())))}static regexes=[{test:"<(?!~)"},{backtest:"^(?!.*~$)",test:">",regex:"(?<!~)>"},"((\\s+(?:NOT\\s+)?IS\\s+(?:NOT\\s+)?(TRUE|FALSE|NULL|UNKNOWN|DISTINCT\\s+FROM)\\s+)|\\s+(ISNULL|NOTNULL|IN|ANY|LIKE|(?:NOT\\s+)?BETWEEN(?:\\s+SYMMETRIC)?)\\s+|(?:\\s+)?(=|<=|>=|!=|<>)(?:\\s+)?)"]};var b=class c extends A{LOGIC="";ASSERTIONS=[];constructor(t,e){super(t),this.LOGIC=e}and(...t){return this.LOGIC==="OR"?new this.constructor(this).and(this,...t):(this.LOGIC="AND",this.build("ASSERTIONS",t,[c,F]),this)}or(...t){return this.LOGIC==="AND"?new this.constructor(this).or(this,...t):(this.LOGIC="OR",this.build("ASSERTIONS",t,[c,F]),this)}toJson(){return{logic:this.LOGIC,assertions:this.ASSERTIONS.map(t=>t.toJson()),flags:this.FLAGS}}static fromJson(t,e){if(typeof e?.logic!="string"||!/AND|OR/i.test(e.logic)||!Array.isArray(e.assertions))return;let s=new this(t).withFlag(...e.flags||[]);return s[e.logic.toLowerCase()](...e.assertions),s}stringify(){return this.ASSERTIONS.map(t=>t instanceof c?`(${t.stringify()})`:t.stringify()).join(" "+this.LOGIC+" ")}static parse(t,e,s){for(let r of["AND","OR"]){let n=p.split(e,[`\\s+${r}\\s+`],{useRegex:"i"});if(n.length>1){let i=new this(t,r);for(let a of n)i[r.toLowerCase()](s(i,a));return i}}}};var bt=class extends A{$EXPR;ALIAS;CLAUSED;get NAME(){return this.$EXPR?.NAME}get BASENAME(){return this.$EXPR?.BASENAME}get EXPR(){return this.$EXPR?.EXPR||this.$EXPR}name(t){return this.build("$EXPR",[t],g,"name"),this}query(...t){return this.build("$EXPR",t,ht,"query"),this}expr(t){return this.build("$EXPR",[t],this.constructor.exprTypes),this}as(t,e=!0){return this.build("ALIAS",[t],g),this.CLAUSED=e,this}toJson(){return{expr:this.$EXPR?.toJson(),alias:this.ALIAS?.toJson(),claused:this.CLAUSED,flags:this.FLAGS}}static fromJson(t,e){let s=new this(t).withFlag(...e.flags||[]);return e?.expr?(s.expr(e.expr),e.alias&&s.as(e.alias,e.claused)):e&&s.expr(e),s}stringify(){let t=this.ALIAS||this.$EXPR instanceof Q&&this.$EXPR.JOINT&&this.autoEsc(this.$EXPR.clone().stringify());return[this.$EXPR,this.CLAUSED?"AS":"",t].filter(e=>e).join(" ")}static parse(t,e,s){let r=new this(t),n=this.getEscChar(t,!0),[,i,a,o,,l]=new RegExp(`^([\\s\\S]+?)(?:(\\s+AS\\s+|(?<!(?:~>|<~))\\s+)(?:([\\w]+)|(${n})((?:\\4\\4|[^\\4])+)\\4))?$`,"i").exec(e.trim())||[],u,f=o||l;if(f&&!a?.trim()&&!i.trim().endsWith(")")){try{u=s(r,i,this.exprTypes)}catch{}u||(o=l=null,i=e)}if(u||(u=s(r,i,this.exprTypes)),r.expr(u),f){let m=o||this.autoUnesc(r,l),E=!!a?.trim();r.as(m,E)}return r}static get exprTypes(){return y.Types}};var D=class extends bt{static get exprTypes(){return[ht,g]}};var $=class extends D{TYPE="";CORRELATION=null;full(t){return this.TYPE="JOIN",this.expr(t),this}left(t){return this.TYPE="LEFT_JOIN",this.expr(t),this}right(t){return this.TYPE="RIGHT_JOIN",this.expr(t),this}inner(t){return this.TYPE="INNER_JOIN",this.expr(t),this}cross(t){return this.TYPE="CROSS_JOIN",this.expr(t),this}on(...t){return this.build("CORRELATION",t,b,"and")}using(t){return this.build("CORRELATION",[t],g)}toJson(){return{type:this.TYPE,correlation:this.CORRELATION?.toJson(),...super.toJson()}}static fromJson(t,e){let s=super.fromJson(t,e);if(!(!s||!e.type))return e?.expr&&e.type&&(s.TYPE=e.type),e?.expr&&e.correlation&&s.build("CORRELATION",[e.correlation],[g,b]),s}stringify(){return[this.TYPE?.replace(/_/," ").toUpperCase()||"JOIN",super.stringify(),this.CORRELATION instanceof g?`USING ${this.CORRELATION}`:`ON ${this.CORRELATION}`].filter(t=>t).join(" ")}static parse(t,e,s){let[r,n,i]=e.match(new RegExp(`^${this.regex}([\\s\\S]*)$`,"i"))||[];if(!r)return;let{tokens:[a,o],matches:l}=p.lex(i,["ON|USING"],{useRegex:"i"}),u=super.parse(t,a.trim(),s);return u.TYPE=n.trim().toUpperCase()+"_JOIN",/^USING$/i.test(l[0])?u.using(s(u,o.trim(),[g])):/^ON$/i.test(l[0])&&u.on(s(u,o.trim(),[b,F])),u}static regex="(INNER\\s+|CROSS\\s+|(?:LEFT|RIGHT)(?:\\s+OUTER)?\\s+)?JOIN"};var Jt=class extends Lt{withRollup(){return this.withFlag("WITH_ROLLUP")}stringify(){return["GROUP BY",super.stringify(),...this.FLAGS.map(t=>t.replace(/_/g," "))].join(" ")}static parse(t,e,s){let{tokens:[r],matches:n}=Lexer.lex(e,["\\s+WITH\\s+ROLLUP$"],{useRegex:"i"}),i=super.parse(t,r,s);if(i)return n.length&&i.withFlag("WITH_ROLLUP"),i}};var Bt=class extends A{WINDOWS_LIST=[];define(...t){return this.build("WINDOWS_LIST",t,At)}toJson(){return{window_list:this.WINDOWS_LIST.map(t=>t.toJson())}}static fromJson(t,e){if(!Array.isArray(e?.window_list))return;let s=new this(t);return s.define(...e.window_list),s}stringify(){return`WINDOW ${this.WINDOWS_LIST.join(",")}`}static parse(t,e,s){let[r,n]=e.match(new RegExp(`^${this.regex}([\\s\\S]*)$`,"i"))||[];if(!r)return;let i=new this(t);for(let a of p.split(n,[","]))i.define(s(i,a.trim(),[Window]));return i}static regex="WINDOW"};var Yt=class extends bt{path(t,e,s){return this.build("$EXPR",[t,e,s],et.OPERATORS.includes(e)?et:Q,"path"),this}call(t,...e){return this.build("$EXPR",[t,...e],ut.names.flat().includes(t.toUpperCase())?ut:mt,"call"),this}case(...t){return this.build("$EXPR",t,wt),this}};var X=class c extends x{SELECT_LIST=[];FROM_LIST=[];JOIN_LIST=[];WHERE_CLAUSE=null;GROUP_BY_CLAUSE=null;HAVING_CLAUSE=null;WINDOW_CLAUSE=null;ORDER_BY_CLAUSE=null;OFFSET_CLAUSE=null;LIMIT_CLAUSE=null;get TABLES(){return this.FROM_LIST}AGGRS=[];PATHS=[];VARS=[];SUBQUERIES=[];select(...t){return this.build("SELECT_LIST",t,Yt)}from(...t){return this.build("FROM_LIST",t,D),this.FROM_LIST[this.FROM_LIST.length-1]}join(t){return this.build("JOIN_LIST",[t],$,"full")}leftJoin(t){return this.build("JOIN_LIST",[t],$,"left")}rightJoin(t){return this.build("JOIN_LIST",[t],$,"right")}innerJoin(t){return this.build("JOIN_LIST",[t],$,"inner")}crossJoin(t){return this.build("JOIN_LIST",[t],$,"cross")}where(...t){return this.build("WHERE_CLAUSE",t,b,"and")}groupBy(...t){return this.build("GROUP_BY_CLAUSE",t,Jt,"criterion"),this.GROUP_BY_CLAUSE}having(...t){return this.build("HAVING_CLAUSE",t,b,"and")}window(...t){return this.build("WINDOW_CLAUSE",t,Bt,"define")}orderBy(...t){return this.build("ORDER_BY_CLAUSE",t,P,"criterion"),this.ORDER_BY_CLAUSE}offset(t){if(typeof t!="number")throw new Error("Offsets must be of type number.");this.OFFSET_CLAUSE=t}limit(...t){if(!t.every(e=>typeof e=="number"))throw new Error("Limits must be of type number.");this.LIMIT_CLAUSE=t}connectedNodeCallback(t){t instanceof ut&&this.AGGRS.push(t),t instanceof Q&&!(t.CONTEXT instanceof Q)&&this.PATHS.push(t),t instanceof Ct&&this.VARS.push(t),t instanceof c&&this.SUBQUERIES.push(t)}get expandable(){return this.PATHS.length>0||this.SUBQUERIES.some(t=>t.expandable)}async expand(t=!1){let e=t?this:this.clone();if(!e.expandable)return e;for(let s of e.PATHS)await s.plot();for(let s of e.SUBQUERIES)await s.expand(!0);return e}toJson(){return{select_list:this.SELECT_LIST.map(t=>t.toJson()),from_list:this.FROM_LIST.map(t=>t.toJson()),join_list:this.JOIN_LIST.map(t=>t.toJson()),where_clause:this.WHERE_CLAUSE?.toJson(),group_by_clause:this.GROUP_BY_CLAUSE?.toJson(),having_clause:this.HAVING_CLAUSE?.toJson(),window_clause:this.WINDOW_CLAUSE?.toJson(),order_by_clause:this.ORDER_BY_CLAUSE?.toJson(),offset_clause:this.OFFSET_CLAUSE,limit_clause:this.LIMIT_CLAUSE,flags:this.FLAGS}}static fromJson(t,e){if(!Array.isArray(e?.select_list))return;let s=new this(t).withFlag(...e.flags||[]);return s.select(...e.select_list),e.from_list?.length&&s.from(...e.from_list),e.join_list?.length&&s.join(...e.join_list),e.where_clause&&s.where(e.where_clause),e.group_by_clause&&s.groupBy(e.group_by_clause),e.having_clause&&s.having(e.having_clause),e.window_clause&&s.window(e.window_clause),e.order_by_clause&&s.orderBy(e.order_by_clause),e.offset_clause&&s.offset(e.offset_clause),e.limit_clause&&s.limit(e.limit_clause),s}stringify(t={}){let e=["SELECT"];return this.FLAGS.length&&e.push(this.FLAGS.map(s=>s.replace(/_/g," "))),e.push(this.SELECT_LIST.join(", ")),e.push("FROM",this.FROM_LIST.join(", ")),this.JOIN_LIST.length&&e.push(...this.JOIN_LIST),this.WHERE_CLAUSE&&e.push("WHERE",this.WHERE_CLAUSE),this.GROUP_BY_CLAUSE&&e.push(this.GROUP_BY_CLAUSE),this.HAVING_CLAUSE&&e.push("HAVING",this.HAVING_CLAUSE),this.WINDOW_CLAUSE&&e.push(this.WINDOW_CLAUSE),this.ORDER_BY_CLAUSE&&e.push(this.ORDER_BY_CLAUSE),this.OFFSET_CLAUSE&&e.push("OFFSET",this.OFFSET_CLAUSE),this.LIMIT_CLAUSE&&e.push("LIMIT",(Array.isArray(this.LIMIT_CLAUSE)?this.LIMIT_CLAUSE:[this.LIMIT_CLAUSE]).join(",")),e.join(" ")}static parse(t,e,s){let[r,n,i,a]=/^SELECT\s+(?:(WITH\s+UAC)\s+)?(ALL|DISTINCT)?([\s\S]+)$/i.exec(e)||[];if(!r)return;let o=new this(t);n&&o.withFlag("WITH_UAC"),i&&o.withFlag(i);let l=this.mySubstitutePlaceholders(o,a.trim()),u={from:{backtest:"^(?!.*\\s+DISTINCT\\s+$)",test:"FROM"},join:$,where:"WHERE",groupBy:Jt,having:"HAVING",window:Bt,orderBy:P,offset:"OFFSET",limit:"LIMIT"},{tokens:[f,...m],matches:E}=p.lex(l,Object.values(u).map(h=>typeof h=="string"||h.test?h:h.regex),{useRegex:"i"});for(let h of p.split(f,[","])){let d=s(o,h.trim(),[Yt]);o.select(d)}for(let h of E){let d=h.replace(/\s+/g,""),N=Object.keys(u).find(_=>new RegExp(_,"i").test(d));if(N==="from")for(let _ of p.split(m.shift(),[","])){let T=s(o,_.trim(),[D]);o.from(T)}else if(["where","having"].includes(N)){let _=s(o,m.shift().trim(),[b,F]);o[N](_)}else if(["offset","limit"].includes(N)){let _=m.shift().split(",").map(T=>parseInt(T.trim()));o[N](..._)}else{let _=s(o,`${h} ${m.shift().trim()}`,[u[N]]);o[N](_)}}return o}};var st=class extends A{ENTRIES=[];set(t,e){return Array.isArray(t)?t=t.map(s=>s instanceof A?s:g.fromJson(this,s)):t instanceof A||(t=g.fromJson(this,t)),Array.isArray(e)?e=e.map(s=>s instanceof A?s:y.cast(this,s)):e instanceof A||(e=y.cast(this,e)),this.ENTRIES.push([t,e]),this}toJson(){return{entries:this.ENTRIES.map(([t,e])=>(Array.isArray(t)?t=t.map(s=>s.toJson()):t=t.toJson(),Array.isArray(e)?e=e.map(s=>s.toJson()):e=e.toJson(),[t,e]))}}static fromJson(t,e){if(!Array.isArray(e?.entries))return;let s=new this(t);for(let[r,n]of e.entries)s.set(r,n);return s}stringify(){return`
	${this.ENTRIES.map(([t,e])=>(Array.isArray(t)&&(t=`(${t.join(", ")})`),Array.isArray(e)&&(e=`(${e.join(", ")})`),`${t} = ${e}`)).join(`,
	`)}`}static parse(t,e,s){let r=new this(t);for(let n of p.split(e,[","])){let[i,a]=p.split(n,["="]).map(o=>o.trim()).filter(o=>o);if(!a)return;if(q(i,"(",")")){let o=p.split(L(i,"(",")"),[","]).map(u=>s(r,u.trim(),[g]));if(!q(a,"(",")"))return;let l=/^\((\s+)?SELECT\s+/i.test(a)?s(r,a):p.split(L(a,"(",")"),[","]).map(u=>s(r,u.trim()));r.set(o,l)}else{let o=s(r,i),l=s(r,a);r.set(o,l)}}return r}};var Gt=class extends st{WHERE_CLAUSE=null;where(...t){return this.build("WHERE_CLAUSE",t,b,"and")}toJson(){return{...super.toJson(),where_clause:this.WHERE_CLAUSE?.toJson()}}static fromJson(t,e){let s=super.fromJson(t,e);if(s)return e.where_clause&&s.where(e.where_clause),s}stringify(){let t=[];return this.params.dialect==="mysql"?t.push("ON DUPLICATE KEY UPDATE"):t.push(`ON CONFLICT ${this.ENTRIES.length?"DO UPDATE SET":"DO NOTHING"}`),t.push(super.stringify()),this.WHERE_CLAUSE&&t.push("WHERE",this.WHERE_CLAUSE),t.join(" ")}static parse(t,e,s){let[r,n,i,a]=e.match(new RegExp(`^${this.regex}([\\s\\S]*)$`,"i"))||[];if(!r)return;if(/DO\s+NOTHING/i.test(i))return new this(t);let[o,l]=p.split(a,["WHERE"],{ci:!0}),u=super.parse(t,o,s);return l&&u.where(s(u,l.trim(),[b,F])),u}static regex="ON\\s+(?:DUPLICATE\\s+KEY|CONFLICT(?:\\s+([\\s\\S]+))?)\\s+(UPDATE|DO\\s+NOTHING|DO\\s+UPDATE\\s+SET\\s+)"};var $t=class extends x{TABLE=null;COLUMNS_LIST=[];VALUES_LIST=[];SET_CLAUSE=null;SELECT_CLAUSE=null;ON_CONFLICT_CLAUSE=null;get TABLES(){return this.TABLE?[this.TABLE]:[]}into(t){return this.build("TABLE",[t],D)}columns(...t){return this.build("COLUMNS_LIST",t,g)}values(...t){return this.VALUES_LIST.push(t)}set(...t){return this.build("SET_CLAUSE",t,st,"set")}select(t){return this.build("SELECT_CLAUSE",[t],X)}onConflict(...t){return this.build("ON_CONFLICT_CLAUSE",t,Gt)}toJson(){return{table:this.TABLE.toJson(),columns_list:this.COLUMNS_LIST.map(t=>t.toJson()),values_list:this.VALUES_LIST.map(t=>t),set_clause:this.SET_CLAUSE?.toJson(),select_clause:this.SELECT_CLAUSE?.toJson(),on_conflict_clause:this.ON_CONFLICT_CLAUSE?.toJson(),flags:this.FLAGS}}static fromJson(t,e){if(!e?.table)return;let s=new this(t).withFlag(...e.flags||[]);s.into(e.table),e.columns_list?.length&&s.columns(...e.columns_list);for(let r of e.values_list||[])s.values(...r);return e.set_clause&&s.set(e.set_clause),e.select_clause&&s.select(e.select_clause),e.on_conflict_clause&&s.onConflict(e.on_conflict_clause),s}stringify(){let t=["INSERT"];return this.FLAGS.length&&t.push(this.FLAGS.map(e=>e.replace(/_/g," "))),t.push("INTO",this.TABLE),this.SET_CLAUSE?t.push("SET",this.SET_CLAUSE):(this.COLUMNS_LIST.length&&t.push(`(${this.COLUMNS_LIST.join(", ")})`),this.SELECT_CLAUSE?t.push(this.SELECT_CLAUSE):t.push("VALUES",`
	(${this.VALUES_LIST.map(e=>e.join(", ")).join(`),
	(`)})`)),this.ON_CONFLICT_CLAUSE&&t.push(this.ON_CONFLICT_CLAUSE),t.join(" ")}static parse(t,e,s){let[r,n,i,a]=/^INSERT(\s+WITH\s+UAC)?(?:\s+(IGNORE))?(?:\s+INTO)?([\s\S]+)$/i.exec(e)||[];if(!r)return;let o=this.mySubstitutePlaceholders(t,a.trim()),{tokens:[l,u,f],matches:[m,E]}=p.lex(o,["(VALUES|VALUE|SET|SELECT)","ON\\s+(DUPLICATE\\s+KEY|CONFLICT)"],{useRegex:"i"}),h=new this(t);if(n&&h.withFlag("WITH_UAC"),i&&h.withFlag(i),/^SET$/i.test(m))h.into(s(h,l,[D])),h.set(s(h,u.trim(),[st]));else{let d=p.split(l,[]);if(h.into(s(h,d.shift().trim(),[D])),d.length){let N=p.split(L(d.shift().trim(),"(",")"),[","]).map(_=>s(h,_.trim(),[g]));h.columns(...N)}if(/^SELECT$/i.test(m))h.select(s(h,`SELECT ${u}`));else for(let N of p.split(u,[","])){let _=p.split(L(N.trim(),"(",")"),[","]).map(T=>s(h,T.trim()));h.values(..._)}}return E&&h.onConflict(s(h,`${E} ${f}`,[Gt])),h}};var xt=class extends x{TABLE_LIST=[];JOIN_LIST=[];SET_CLAUSE=null;WHERE_CLAUSE=null;ORDER_BY_CLAUSE=null;LIMIT_CLAUSE=null;get TABLES(){return this.TABLE_LIST}table(...t){return this.build("TABLE_LIST",t,D)}join(t){return this.build("JOIN_LIST",[t],$,"full")}leftJoin(t){return this.build("JOIN_LIST",[t],$,"left")}rightJoin(t){return this.build("JOIN_LIST",[t],$,"right")}innerJoin(t){return this.build("JOIN_LIST",[t],$,"inner")}crossJoin(t){return this.build("JOIN_LIST",[t],$,"cross")}set(...t){return this.build("SET_CLAUSE",t,st,"set")}where(...t){return this.build("WHERE_CLAUSE",t,b,"and")}orderBy(...t){return this.build("ORDER_BY_CLAUSE",t,P,"criterion"),this.ORDER_BY_CLAUSE}limit(...t){if(!t.every(e=>typeof e=="number"))throw new Error("Limits must be of type number.");this.LIMIT_CLAUSE=t}toJson(){return{table_list:this.TABLE_LIST.map(t=>t.toJson()),join_list:this.JOIN_LIST.map(t=>t.toJson()),set_clause:this.SET_CLAUSE?.toJson(),where_clause:this.WHERE_CLAUSE?.toJson(),order_by_clause:this.ORDER_BY_CLAUSE?.toJson(),limit_clause:this.LIMIT_CLAUSE,flags:this.FLAGS}}static fromJson(t,e){if(!Array.isArray(e?.table_list))return;let s=new this(t).withFlag(...e.flags||[]);return s.table(...e.table_list),e.join_list?.length&&s.join(...e.join_list),e.set_clause&&s.set(e.set_clause),e.where_clause&&s.where(e.where_clause),e.order_by_clause&&s.orderBy(e.order_by_clause),e.limit_clause&&s.limit(e.limit_clause),s}stringify(){let t=["UPDATE"];return this.FLAGS.length&&t.push(this.FLAGS.map(e=>e.replace(/_/g," "))),t.push(this.TABLE_LIST.join(", ")),this.JOIN_LIST.length&&t.push(...this.JOIN_LIST),t.push("SET",this.SET_CLAUSE),this.WHERE_CLAUSE&&t.push("WHERE",this.WHERE_CLAUSE),this.ORDER_BY_CLAUSE&&t.push(this.ORDER_BY_CLAUSE),this.LIMIT_CLAUSE&&t.push("LIMIT",this.LIMIT_CLAUSE),t.join(" ")}static parse(t,e,s){let[r,n,i,a]=/^UPDATE(\s+WITH\s+UAC)?(?:\s+(IGNORE))?([\s\S]+)$/i.exec(e)||[];if(!r)return;let o=new this(t);n&&o.withFlag("WITH_UAC"),i&&o.withFlag(i);let l=this.mySubstitutePlaceholders(o,a.trim()),u={join:$,set:"SET",where:"WHERE",orderBy:P,limit:"LIMIT"},{tokens:[f,...m],matches:E}=p.lex(l,Object.values(u).map(h=>typeof h=="string"||h.test?h:h.regex),{useRegex:"i"});for(let h of p.split(f,[","])){let d=s(o,h.trim(),[D]);o.table(d)}for(let h of E){let d=h.replace(/\s+/g,""),N=Object.keys(u).find(_=>new RegExp(_,"i").test(d));if(N==="set"){let _=s(o,m.shift().trim(),[st]);o.set(_)}else if(N==="where"){let _=s(o,m.shift().trim(),[b,F]);o.where(_)}else if(N==="limit")o.limit(parseInt(m.shift().trim()));else{let _=s(o,`${h} ${m.shift().trim()}`,[u[N]]);o[N](_)}}return o}};var Ut=class extends x{DELETE_LIST=[];FROM_LIST=[];USING_LIST=[];JOIN_LIST=[];WHERE_CLAUSE=null;ORDER_BY_CLAUSE=null;LIMIT_CLAUSE=null;get TABLES(){return this.USING_LIST.length?this.USING_LIST:this.FROM_LIST}delete(...t){return this.build("DELETE_LIST",t,g)}from(...t){return this.build("FROM_LIST",t,[g,D])}using(...t){return this.build("USING_LIST",t,D)}join(t){return this.build("JOIN_LIST",[t],$,"full")}leftJoin(t){return this.build("JOIN_LIST",[t],$,"left")}rightJoin(t){return this.build("JOIN_LIST",[t],$,"right")}innerJoin(t){return this.build("JOIN_LIST",[t],$,"inner")}crossJoin(t){return this.build("JOIN_LIST",[t],$,"cross")}where(...t){return this.build("WHERE_CLAUSE",t,b,"and")}orderBy(...t){return this.build("ORDER_BY_CLAUSE",t,P,"criterion"),this.ORDER_BY_CLAUSE}limit(...t){if(!t.every(e=>typeof e=="number"))throw new Error("Limits must be of type number.");this.LIMIT_CLAUSE=t}toJson(){return{delete_list:this.DELETE_LIST.map(t=>t.toJson()),from_list:this.FROM_LIST.map(t=>t.toJson()),using_list:this.USING_LIST.map(t=>t.toJson()),join_list:this.JOIN_LIST.map(t=>t.toJson()),where_clause:this.WHERE_CLAUSE?.toJson(),order_by_clause:this.ORDER_BY_CLAUSE?.toJson(),limit_clause:this.LIMIT_CLAUSE,flags:this.FLAGS}}static fromJson(t,e){if(!Array.isArray(e?.from_list))return;let s=new this(t).withFlag(...e.flags||[]);return e.delete_list?.length&&s.delete(...e.delete_list),s.from(...e.from_list),e.using_list?.length&&s.using(...e.using_list),e.join_list?.length&&s.join(...e.join_list),e.where_clause&&s.where(e.where_clause),e.order_by_clause&&s.orderBy(e.order_by_clause),e.limit_clause&&s.limit(e.limit_clause),s}stringify(){let t=["DELETE"];return this.FLAGS.length&&t.push(this.FLAGS.map(e=>e.replace(/_/g," "))),this.DELETE_LIST.length&&t.push(this.DELETE_LIST.join(", ")),t.push("FROM",this.FROM_LIST.join(", ")),this.USING_LIST.length&&t.push("USING",this.USING_LIST.join(", ")),this.JOIN_LIST.length&&t.push(...this.JOIN_LIST),this.WHERE_CLAUSE&&t.push("WHERE",this.WHERE_CLAUSE),this.ORDER_BY_CLAUSE&&t.push(this.ORDER_BY_CLAUSE),this.LIMIT_CLAUSE&&t.push("LIMIT",this.LIMIT_CLAUSE),t.join(" ")}static parse(t,e,s){let[r,n,i,a]=/^DELETE(\s+WITH\s+UAC)?(?:\s+(IGNORE))?([\s\S]+)$/i.exec(e.trim())||[];if(!r)return;let o=new this(t);n&&o.withFlag("WITH_UAC"),i&&o.withFlag(i);let l=this.mySubstitutePlaceholders(o,a.trim()),u={from:{backtest:"^(?!.*\\s+DISTINCT\\s+$)",test:"FROM"},using:{backtest:"^(?!.*\\s+JOIN\\s+)",test:"USING"},join:$,where:"WHERE",orderBy:P,limit:"LIMIT"},{tokens:[f,...m],matches:E}=p.lex(l,Object.values(u).map(h=>typeof h=="string"||h.test?h:h.regex),{useRegex:"i"});for(let h of p.split(f,[","])){let d=s(o,h.trim(),[g]);o.delete(d)}for(let h of E){let d=h.replace(/\s+/g,""),N=Object.keys(u).find(_=>new RegExp(_,"i").test(d));if(["from","using"].includes(N))for(let _ of p.split(m.shift(),[","])){let T=N==="from"&&E.some(S=>S.toLowerCase()==="using")?g:D,O=s(o,_.trim(),[T]);o[N](O)}else if(N==="where"){let _=s(o,m.shift().trim(),[b,F]);o.where(_)}else if(N==="limit")o.limit(parseInt(m.shift().trim()));else{let _=s(o,`${h} ${m.shift().trim()}`,[u[N]]);o[N](_)}}return o}};var Be=[j,at,ot,Y,V,tt,$t,xt,Ut,X,...y.Types];var zt=class{static grammar=Be;static parse(t,e,s,r={}){if(!e?.length)return;let n=s?.length?s:this.grammar;for(let i of n){let a=this.parseOne(t,e,i,r);if(a)return r.log&&console.log(".................",e,".................>",a.constructor.name),a}if(r.assert!==!1)throw new SyntaxError(e)}static parseOne(t,e,s,r={}){return s.parse(t,e,(n,i,a,o={})=>this.parse(n,i,a,{...r,...o}))}};var pt=class{constructor(t,e,s="backward"){Object.defineProperty(this,"$",{value:{client:t,details:e,direction:s}})}get client(){return this.$.client}get id(){return this.$.details.id}get name_snapshot(){return this.$.details.name_snapshot}get savepoint_desc(){return this.$.details.savepoint_desc}get savepoint_date(){return this.$.details.savepoint_date}get rollback_date(){return this.$.details.rollback_date}get current_name(){return this.$.details.current_name}get id_active(){return"id_active"in this.$.details?this.$.details.id_active:void 0}get direction(){return this.$.direction}toJson(){return{...this.$.details}}async status(){let t=await this.client.database(this.current_name||this.name_snapshot).savepoint({direction:this.direction})||{};return t.id===this.id?(this.$.details.rollback_date=t.rollback_date,this.$.details.id_active=t.id_active,{canRollback:!0}):{canRollback:!1}}async getAssociatedSnapshots(){let t=this.client.constructor.OBJ_INFOSCHEMA_DB;return this.client.query("select",e=>{e.select("*"),e.from([t,"table_savepoints"]),e.where(s=>s.equals("savepoint_id",r=>r.literal(this.id)))})}async rollback(t={}){if(!this.current_name&&!this.name_snapshot)throw new Error("Invalid savepoint; null record.");if(!(await this.status()).canRollback)throw new Error("Invalid rollback order.");let e=async()=>(await this.getAssociatedSnapshots()).map(o=>({name:o.name_snapshot,$name:o.current_name,database:this.current_name,columns:o.columns_snapshot.map(l=>({...l,...this.direction==="forward"&&l.$name?{name:l.$name,$name:l.name}:{}})),constraints:o.constraints_snapshot.map(l=>({...l,...this.direction==="forward"&&l.$constraintName?{constraintName:l.$constraintName,$constraintName:l.constraintName}:{}})),indexes:o.indexes_snapshot.map(l=>({...l,...this.direction==="forward"&&l.$indexName?{indexName:l.$indexName,$indexName:l.indexName}:{}}))})),s={},r=this.direction==="forward"||this.id_active;if(!this.name_snapshot)t.allowMutateDB?await this.client.dropDatabase(this.current_name,{cascade:!0,noCreateSavepoint:r}):s.noMutateDB=!0;else if(!this.current_name)t.allowMutateDB?await this.client.createDatabase({name:this.name_snapshot,tables:await e()},{noCreateSavepoint:r}):s.noMutateDB=!0;else{let a=await e();await this.client.alterDatabase({name:this.current_name,tables:a.map(o=>o.$name).filter(o=>o)},o=>{o.name=this.name_snapshot,o.tables.splice(0),o.tables.push(...a.filter(l=>l.name))},{noCreateSavepoint:r})}if(Object.keys(s).length)return!1;let i=[this.client.constructor.OBJ_INFOSCHEMA_DB,"database_savepoints"];return this.direction==="forward"?(this.$.details.rollback_date=null,await this.client.query("update",a=>{a.table(i),a.set("rollback_date",null),a.where(o=>o.equals("current_name",l=>l.literal(this.name_snapshot)),o=>o.isNotNull("rollback_date"))})):(this.$.details.rollback_date=new Date,await this.client.query("update",a=>{a.table(i),a.set("rollback_date",o=>o.call("now")),a.where(o=>o.or(l=>l.equals("id",u=>u.literal(this.id)),l=>l.and(u=>u.equals("name_snapshot",f=>f.literal(this.current_name)),u=>u.isNull("rollback_date"))))})),!0}};var Zt={infoSchemaDB:"obj_information_schema",instances:new Set,schemas:new Map},jt=class{constructor(t,e={}){if(!this.constructor.kind)throw new Error('Subclasses of Objective SQL Client must implement a static "kind" property.');Zt.schemas.has(this.constructor.kind)||Zt.schemas.set(this.constructor.kind,new Map),Zt.instances.add(this),Object.defineProperty(this,"$",{value:{driver:t,schemas:Zt.schemas.get(this.constructor.kind),params:e}})}static get OBJ_INFOSCHEMA_DB(){return Zt.infoSchemaDB}get driver(){return this.$.driver}get params(){return this.$.params}async searchPath(...t){return this.searchPathCallback(()=>{},...arguments)}async schemas(){return this.$.schemas.size||await this.databases(),this.$.schemas}async databases(t={}){return this.databasesCallback(()=>[],...arguments)}async createDatabase(t,e={}){return this.createDatabaseCallback(...arguments)}async createDatabaseIfNotExists(t,e={}){return this.createDatabase(t,{...e,ifNotExists:!0})}async alterDatabase(t,e,s={}){return this.alterDatabaseCallback(...arguments)}async dropDatabase(t,e={}){return this.dropDatabaseCallback(...arguments)}async dropDatabaseIfExists(t,e={}){return this.dropDatabase(t,{...e,ifNotExists:!0})}database(t,e={}){let s=this.$.schemas;return s.has(t)||s.set(t,{name:t,tables:new Map,hiddenAs:"inmemory"}),new this.constructor.Database(this,...arguments)}async searchPathCallback(t,...e){if(e.length){let s=await t(e);return this.$.searchPath=e,s}return this.$.searchPath||(this.$.searchPath=await t()),this.$.searchPath}async getBasename(t){return(await this.searchPath()).reduce(async(s,r)=>await s||(await this.database(r).tables({name:t})).length?r:null,null)}async databasesCallback(t,e={},s=[]){let r=this.$.schemas;if(!r._touched||e.force){r._touched=!0;for(let i of await t())typeof i=="string"&&(i={name:i}),r.has(i.name)?delete r.get(i.name).hiddenAs:r.set(i.name,{...i,tables:new Map})}let n=[...r.values()].filter(i=>!i.hiddenAs).map(i=>i.name);if(e.name)n=n.filter(i=>i===e.name);else if(!e.includeStandardExclusions){let i=this.constructor.OBJ_INFOSCHEMA_DB,a=new RegExp(`^${s.concat(i).join("|")}$`,"i");n=n.filter(o=>!a.test(o))}return n}async createDatabaseCallback(t,e,s={}){let r;if(e instanceof j)r=e,e=r.toJson();else{if(typeof e=="string"&&(e={name:e}),typeof e!="object"||!e.name)throw new Error("Invalid argument#1 to createDatabase().");if((await this.databases(e))[0]){if(s.ifNotExists)return;throw new Error(`Database ${e.name} already exists.`)}r=j.fromJson(this,e),s.ifNotExists&&r.withFlag("IF_NOT_EXISTS")}let n=this.database(e.name,s),i=await this.schemas(),a=new Set,o,l=async()=>{o=!0,delete i.get(e.name).hiddenAs,i.get(e.name).schemaEdit={get tablesSavepoints(){return a}};for(let f of e.tables||[])await n.createTable(f,s);delete i.get(e.name).schemaEdit};await t(r,l,s),o||await l();let u=!0;return(s.noCreateSavepoint||new RegExp(`^${this.constructor.OBJ_INFOSCHEMA_DB}$`).test(e.name))&&(u=!1),u&&await this.createSavepoint({savepoint_desc:s.savepointDesc||"Database create",name_snapshot:null,current_name:e.name},a),n}async alterDatabaseCallback(t,e,s,r={}){let n=await this.schemas(),i=new Set,a,o,l,u,f=()=>{};if(e instanceof at)a=e,o=a.NAME,r=s||{},l=n.get(o);else if(typeof s=="function"){let d=[];if(typeof e=="object"&&e?(Array.isArray(e.tables)&&(d=e.tables),o=e.name):o=e,typeof o!="string")throw new Error("Invalid argument#1 to alterDatabase().");if(!(await this.databases({name:o}))[0]){if(r.ifExists)return;throw new Error(`Database ${o} does not exist.`)}if(l=n.get(o),l.schemaEdit)return await s(l.schemaEdit);let _=this.database(o,r),T=j.cloneJson(l),O=await _.describeTable(d,r);Object.defineProperty(T,"tables",{value:O.map(S=>Y.cloneJson(S))}),Object.defineProperties(T.tables,{get:{value:S=>T.tables.find(C=>C.name===S),configurable:!0},has:{value:S=>!!T.tables.get(S),configurable:!0},delete:{value:S=>T.tables.splice(T.tables.findIndex(C=>C.name===S),1),configurable:!0}}),Object.defineProperty(T,"tablesSavepoints",{get(){return i}}),l.schemaEdit=T,await s(T),a=at.fromDiffing(this,l,T),f=async(S=o)=>{u=!0;let C=V.fromDiffing2d(_,O,T.tables);for(let w of C)w.type==="DROP"&&await _.dropTable(w.argument,r),w.type==="ADD"&&await _.createTable(w.argument,r),w.type==="ALTER"&&await _.alterTable(w.argument,r);delete l.schemaEdit}}else throw new Error(`Alter database "${o}" called without a valid callback function.`);await t(a,f,r);let m=a.ACTIONS.find(d=>d.TYPE==="RENAME"&&!d.REFERENCE)?.ARGUMENT;m&&(l.name=m,n.delete(o),n.set(l.name,l)),u||await f(m||o);let E,h=a.ACTIONS.length||i.size;return(r.noCreateSavepoint||new RegExp(`^${this.constructor.OBJ_INFOSCHEMA_DB}$`).test(o))&&(h=!1),h&&(E=await this.createSavepoint({savepoint_desc:r.savepointDesc||"Database alter",name_snapshot:o,current_name:m||o},i)),E}async dropDatabaseCallback(t,e,s={}){let r;if(e instanceof ot)r=e,e=r.NAME;else{if(!(await this.databases({name:e}))[0]){if(s.ifExists)return;throw new Error(`Database ${e} does not exist.`)}r=new ot(this,e),s.ifExists&&r.withFlag("IF_EXISTS"),s.cascade&&r.withFlag("CASCADE")}let i=(await this.schemas()).get(e);if(i.schemaEdit)throw new Error("Cannot delete database when already in edit mode.");let a=!0,o;if((s.noCreateSavepoint||new RegExp(`^${this.constructor.OBJ_INFOSCHEMA_DB}$`).test(i.name))&&(a=!1),a){let l=this.database(e,s);o=new Set((await l.describeTable("*")).map(u=>({name_snapshot:u.name,columns_snapshot:JSON.stringify(u.columns),constraints_snapshot:JSON.stringify(u.constraints),indexes_snapshot:JSON.stringify(u.indexes),current_name:null})))}await t(r,s),i.hiddenAs="dropped";for(let[,l]of i.tables)l.hiddenAs="dropped";if(a)return this.createSavepoint({savepoint_desc:s.savepointDesc||"Database drop",name_snapshot:i.name,current_name:null},o)}async queryCallback(t,...e){let s=[$t,xt,Ut,X,ot,tt,j,Y,at,V],r=typeof e[e.length-1]=="object"?e.pop():{},n=async i=>{if(i instanceof j)return await this.createDatabase(i,r);if(i instanceof at)return await this.alterDatabase(i,r);if(i instanceof ot)return await this.dropDatabase(i,r);let a=i.BASENAME;if(!a){let o=await this.searchPath();a=o.find(l=>!l.startsWith("$"))||o[0]}return i instanceof Y?await this.database(a).createTable(i,r):i instanceof V?await this.database(a).alterTable(i,r):i instanceof tt?await this.database(a).dropTable(i,r):await t(i,r)};if(typeof e[0]=="string"&&typeof e[1]=="function"){let i=e.shift(),a=i.toLowerCase().replace(/^\w|_./g,u=>u.toUpperCase().replace("_","")),o=s.find(u=>u.name===a);if(!o)throw new Error(`Unknown query type: ${i}.`);let l=new o(this);return e.forEach((u,f)=>{if(typeof u!="function")throw new Error(`Invalid argument at #${f}.`);u(l)}),await n(l)}if(e.length>1)throw new Error("Invalid argument count.");if(typeof e[0]=="object"&&e[0]){let i=s.reduce((a,o)=>a||o.fromJson(this,e[0]),null);if(i)return await n(i)}if(typeof e[0]=="string"){let i=zt.parse(this,e[0]);return await n(i)}throw new Error("Invalid arguments.")}async createSavepoint(t,e=new Set){let s=this.constructor.OBJ_INFOSCHEMA_DB,r=this.database(s);(await this.databases({name:s}))[0]||(await this.createDatabase(s),await r.createTable({name:"database_savepoints",columns:[{name:"id",type:"uuid",primaryKey:!0,default:{expr:"gen_random_uuid()"}},{name:"name_snapshot",type:"varchar"},{name:"savepoint_desc",type:"varchar"},{name:"savepoint_date",type:"timestamp"},{name:"rollback_date",type:"timestamp"},{name:"current_name",type:"varchar"}]}),await r.createTable({name:"table_savepoints",columns:[{name:"savepoint_id",type:"uuid",references:{table:"database_savepoints",columns:["id"],deleteRule:"cascade"}},{name:"name_snapshot",type:"varchar"},{name:"columns_snapshot",type:"json"},{name:"constraints_snapshot",type:"json"},{name:"indexes_snapshot",type:"json"},{name:"current_name",type:"varchar"}]}));let n=[s,"database_savepoints"],i=l=>l.in(u=>u.literal(t.name_snapshot||t.current_name),["active","name_snapshot"],["active","current_name"]);for(;i;){let l=await this.query("select",u=>{u.select(["active","id"],f=>f.name(["following","id"]).as("id_following")),u.from(n).as("active"),u.leftJoin(n).as("following").on(f=>f.equals(["following","name_snapshot"],["active","current_name"])),u.where(i),u.where(f=>f.isNotNull(["active","rollback_date"])),u.orderBy(["active","savepoint_date"]).withFlag("ASC"),u.limit(1)});l[0]?.id&&await this.query("delete",u=>{u.from(n),u.where(f=>f.equals("id",m=>m.literal(l[0].id)))}),l[0]?.id_following?i=u=>u.equals(["active","id"],f=>f.literal(l[0].id_following)):i=null}let a=await r.table("database_savepoints").add({...t,savepoint_date:"now()"}),o=new pt(this,{...a.toJson(),id_active:null});return e.size&&(e=[...e].map(l=>({...l,savepoint_id:o.id})),await r.table("table_savepoints").addAll(e)),o}};function de(c,t){return c.reduce((e,s,r)=>e&&t(s,r),!0)}function Ae(c,t){return c.reduce((e,s,r)=>e||t(s,r),!1)}function Le(c){let t=(e,s,r)=>r.indexOf(e)===s;return c.filter(t)}var te=class{constructor(t,e,s={}){this.$={client:t,schema:t.$.schemas.get(e),params:s}}get client(){return this.$.client}get name(){return this.$.schema.name}get params(){return this.$.params}get dropped(){return this.$.schema.hiddenAs==="dropped"}async tables(t={}){return this.tablesCallback(()=>[],...arguments)}async describeTable(t,e={}){return this.describeTableCallback((s,r)=>{},...arguments)}async createTable(t,e={},s={}){return this.createTableCallback(()=>[],...arguments)}async createTableIfNotExists(t,e={},s={}){return this.createTable(t,e,{...s,ifNotExists:!0})}async alterTable(t,e,s={}){return this.alterTableCallback((r,n,i)=>{},...arguments)}async dropTable(t,e={}){return this.dropTableCallback((s,r)=>{},...arguments)}async dropTableIfExists(t,e={}){return this.dropTable(t,{...e,ifNotExists:!0})}table(t,e={}){let s=this.$.schema.tables;return s.has(t)||s.set(t,{name:t,hiddenAs:"inmemory"}),new this.constructor.Table(this,...arguments)}async savepoint(t={}){let e=this.client.constructor.OBJ_INFOSCHEMA_DB;if((await this.client.databases({name:e}))[0]){let s=t.direction==="forward",r=[e,"database_savepoints"],n=await this.client.query("select",i=>{i.from(r).as(s?"active":"preceding"),s?(i.select(["following","*"],a=>a.name(["active","id"]).as("id_active")),i.rightJoin(r).as("following").on(a=>a.equals(["following","name_snapshot"],["active","current_name"])),i.where(a=>a.in(o=>o.literal(this.name),["active","name_snapshot"],["active","current_name"]),a=>a.isNotNull(["active","rollback_date"])),i.orderBy(["active","savepoint_date"]).withFlag("ASC")):(i.select(["preceding","*"],a=>a.name(["active","id"]).as("id_active")),i.leftJoin(r).as("active").on(a=>a.equals(["active","name_snapshot"],["preceding","current_name"])),i.where(a=>a.in(o=>o.literal(this.name),["preceding","name_snapshot"],["preceding","current_name"]),a=>a.isNull(["preceding","rollback_date"])),i.orderBy(["preceding","savepoint_date"]).withFlag("DESC")),i.limit(1)});return n[0]&&new pt(this.client,n[0],t.direction)}}async tablesCallback(t,e={}){let s=this.$.schema.tables;if(!s._touched||e.force){s._touched=!0;for(let n of await t())typeof n=="string"&&(n={name:n}),s.has(n.name)?delete s.get(n.name).hiddenAs:s.set(n.name,{...n})}let r=[...s.values()].filter(n=>!n.hiddenAs).map(n=>n.name);return e.name&&(r=r.filter(n=>n===e.name)),r}async describeTableCallback(t,e,s={}){let r=Array.isArray(e),n=r?e:[e],i=n.length===1&&n[0]==="*";if(this.dropped)return i||r?[]:void 0;let a=this.$.schema.tables,o=i?["*"]:n;if(o.length){let l=await t(o,s);for(let u of l)a.has(u.name)?(delete a.get(u.name).hiddenAs,Object.assign(a.get(u.name),u)):a.set(u.name,u)}return i?[...a.values()].filter(l=>!l.hiddenAs):r?n.map(l=>a.get(l)).filter(l=>!l.hiddenAs):a.get(e)?.hiddenAs?void 0:a.get(e)}async createTableCallback(t,e,s={}){return await this.client.alterDatabase(this.name,async r=>{let n;if(e instanceof Y)n=e,e=n.toJson();else{if((await this.tables({name:e.name}))[0]){if(s.ifNotExists)return;throw new Error(`Table ${e.name} already exists.`)}if(e.basename&&e.basename!==this.name)throw new Error(`A table schema of database ${e.basename} is being passed to ${this.name}.`);n=Y.fromJson(this.client,e),s.ifNotExists&&n.withFlag("IF_NOT_EXISTS")}n.name([this.name,n.NAME]),r.tablesSavepoints.add({name_snapshot:null,columns_snapshot:JSON.stringify([]),constraints_snapshot:JSON.stringify([]),indexes_snapshot:JSON.stringify([]),current_name:e.name}),await t(n,s);let i=this.$.schema.tables;i.get(e.name)?.hiddenAs?delete i.get(e.name).hiddenAs:i.set(e.name,{name:e.name})},{savepointDesc:"Table create",...s}),this.table(e.name,s)}async alterTableCallback(t,e,s,r={}){return this.client.alterDatabase(this.name,async n=>{let i,a;if(e instanceof V)i=e,e=i.NAME,r=s||{},a=i.JSON_BEFORE?.columns?i.JSON_BEFORE:await this.describeTable(e,r);else if(typeof s=="function"){if(!(await this.tables({name:e}))[0]){if(r.ifExists)return;throw new Error(`Table ${e} does not exist.`)}if(a=await this.describeTable(e,r),a.schemaEdit)return await s(a.schemaEdit);a.schemaEdit=Y.cloneJson(a),await s(a.schemaEdit),i=V.fromDiffing(this.client,a,a.schemaEdit),r.ifExists&&i.withFlag("IF_EXISTS"),delete a.schemaEdit}else throw new Error(`Alter table "${e}" called with invalid arguments.`);i.name([this.name,i.NAME]);let o=i.ACTIONS.find(f=>f.TYPE==="RENAME"&&!f.REFERENCE)?.ARGUMENT,l=i.ACTIONS.find(f=>f.TYPE==="RELOCATE")?.ARGUMENT;if(i.ACTIONS.length){for(let f of i.ACTIONS)if(f.TYPE==="RENAME"&&f.REFERENCE){let m=f.REFERENCE.type==="CONSTRAINT"?"constraints":f.REFERENCE.type==="INDEX"?"indexes":"columns",E=m==="constraints"?"constraintName":m==="indexes"?"indexName":"name";a[m].find(h=>h[E]===f.REFERENCE.name)[`$${E}`]=f.ARGUMENT}n.tablesSavepoints.add({name_snapshot:a.name,columns_snapshot:JSON.stringify(a.columns),constraints_snapshot:JSON.stringify(a.constraints||[]),indexes_snapshot:JSON.stringify(a.indexes||[]),current_name:o||e}),await t(i,r)}let u=this.$.schema.tables;delete u.get(e).columns,o&&(a.name=o),l&&(a.basename=l,u.delete(e))},{savepointDesc:"Table alter",...r})}async dropTableCallback(t,e,s={}){return this.client.alterDatabase(this.name,async r=>{let n;if(e instanceof tt)n=e,e=n.NAME;else{if(!(await this.tables({name:e}))[0]){if(s.ifExists)return;throw new Error(`Table ${e} does not exist.`)}n=new tt(this.client,e,this.name),s.ifExists&&n.withFlag("IF_EXISTS"),s.cascade&&n.withFlag("CASCADE")}n.name([this.name,n.NAME]);let i=await this.describeTable(e,s);if(i.schemaEdit)throw new Error("Cannot delete table when already in edit mode.");r.tablesSavepoints.add({name_snapshot:i.name,columns_snapshot:JSON.stringify(i.columns),constraints_snapshot:JSON.stringify(i.constraints),indexes_snapshot:JSON.stringify(i.indexes),current_name:null}),await t(n,s);let a=this.$.schema.tables;a.get(e).hiddenAs="dropped",delete a.get(e).columns,delete a.get(e).constraints,delete a.get(e).indexes},{savepointDesc:"Table drop",...s})}};var ee=class{constructor(t,e,s,r,n={}){this.table=t,this.rawResultMeta=e,this.columns=s,this.entries=r,this.duplicateKeyUpdateObj=n}toJson(){return(this.rawResultMeta.rows||this.rawResultMeta)[0]}lastInsertID(){return(this.rawResultMeta.rows||this.rawResultMeta)[0]?.id}async getAffectedRowsPointers(){if(!(!R(this.columns)||!R(this.entries))){var t=[],e={all:{},each:[]},s=await this.table.primaryKeyColumns();if(Ae(s,a=>this.columns.includes(a)))t=[s],e.by="primaryKey";else{var r=this.table.columnsForConstraint("UNIQUE");t=r.filter(a=>Ae(a,o=>this.columns.includes(o))),e.by="uniqueKeys"}if(t.length){var n={};Le(t.reduce((a,o)=>a.concat(o),[])).forEach(a=>{var o=this.columns.indexOf(a);o===-1?e.all[a]=this.table.def.schema.columns[a].default:n[a]=o});var i=Object.keys(n);i.length&&this.entries.forEach(a=>{var o={};i.forEach(l=>{R(a)?o[l]=a[n[l]]:o[l]=a[l],this.duplicateKeyUpdateObj&&l in this.duplicateKeyUpdateObj&&(o[l]=[o[l],this.duplicateKeyUpdateObj[l]])}),e.each.push(o)})}return e}}};var Tt=class extends ee{info(){var t,e=(this.rawResultMeta.info||"").replace(/ /g,"").match(/Records:([0-9]*)Duplicates:([0-9]*)Warnings:([0-9]*)/);return e?t=e.slice(1).map(s=>parseInt(s)):t=[0,0,0],{records:t[0],duplicates:t[1],warnings:t[2]}}async getAffectedRows(t=!1){var e=this.getAffectedRowsPointers();if(e.by==="primaryKey"){var s=Object.keys(e.each[0]);if(s.length===1){var r=e.each.map(f=>f[s[0]]);if(de(r,f=>v(f)))return t?r.map(f=>parseInt(f)):r.length}}var n="id";let i=f=>{var m=Object.keys(f),E=m.reduce((h,d)=>h.concat(R(f[d])?`${d} IN ("${f[d].join('", "')}")`:`${d} = "${f[d]}"`),[]).join(" AND ");return m.length>1?`(${E})`:E};var a="",o="";if(Dt(e.all)||(a=i(e.all)),!Dt(e.each)){var l=Object.keys(e.each[0]);l.length===1&&!R(e.each[0][l[0]])?o=`${l[0]} IN (${e.each.map(f=>f[l[0]]).join(", ")})`:o=e.each.map(f=>i(f)).join(" OR ")}if(a||o){var u=this.table.database.client.params.driver;return new Promise((f,m)=>{var E=a&&o?`${a} AND (${o})`:a||o,h=`SELECT ${t?n:"COUNT(*) AS count"} FROM ${this.table.name} WHERE ${E} ORDER BY ${n} ASC`;u.query(h,(d,N)=>{if(d)return m(d);if(!t)return f(N[0].count);f(N.map(_=>_[n]))})})}return this.rawResultMeta.insertId?t?this.entries.map((f,m)=>this.rawResultMeta.insertId+1):this.entries.length:t?[]:0}};var se=class{constructor(t,e,s){this.table=t,this.rawResultMeta=e,this.whereObj=s}};var Ht=class extends se{async getAffectedRows(t=!1){if(t)throw new Error('The "withIDs" argument is not supported for delete queries.');return this.rawResultMeta.affectedRows}};var re=class{constructor(t,e,s={}){this.$={database:t,schema:t.$.schema.tables.get(e),params:s}}get name(){return this.$.schema.name}get database(){return this.$.database}get params(){return this.$.params}get dropped(){return this.$.schema.hiddenAs==="dropped"}async schema(){return await this.database.describeTable(this.name)}async savepoint(t={}){let e=this.database.client.constructor.OBJ_INFOSCHEMA_DB;if((await this.database.client.databases({name:e}))[0]){let s=t.direction==="forward",r=[e,"database_savepoints"],n=[e,"table_savepoints"],i=["name_snapshot","columns_snapshot","constraints_snapshot","indexes_snapshot","current_name"],a=["id","name_snapshot","savepoint_desc","savepoint_date","rollback_date","current_name"],o=await this.database.client.query("select",m=>{m.from(n).as("tbl"),m.select(...i.map(E=>["tbl",E])),m.select(...a.map(E=>h=>h.name(["db",E]).as(`db_${E}`))),m.rightJoin(r).as("db").on(E=>E.equals(["db","id"],["tbl","savepoint_id"]),E=>E.in(h=>h.literal(this.database.name),["db","name_snapshot"],["db","current_name"]),E=>E[s?"isNotNull":"isNull"](["db","rollback_date"])),m.where(E=>E.in(h=>h.literal(this.name),["tbl","name_snapshot"],["tbl","current_name"])),m.orderBy(["db","savepoint_date"]).withFlag(s?"ASC":"DESC"),m.limit(1)});if(!o[0])return;let[l,u]=Object.keys(o[0]).reduce(([m,E],h)=>h.startsWith("db_")?[m,{...E,[h.replace("db_","")]:o[0][h]}]:[{...m,[h]:o[0][h]},E],[{},{}]),f=new pt(this.database.client,u,t.direction);return Object.defineProperty(l,"context",{get:()=>f})}}async primaryKeyColumns(){return(await this.columnsForConstraint("PRIMARY_KEY"))[0]}async columnsForConstraint(t){let e=await this.database.describeTable(this.name),s={PRIMARY_KEY:"primaryKey",UNIQUE:"uniqueKey",CHECK:"check",FOREIGN_KEY:"references"},r=t in s?e.columns.filter(n=>n[s[t]]).map(n=>[n.name]):[];return e.constraints.length&&(r=r.concat(e.constraints.filter(n=>n.type===t).reduce((n,i)=>n.concat([i.columns])))),r}async columnsForIndex(t){let e=await this.database.describeTable(this.name);return e.indexes.length?e.indexes.filter(s=>s.type===t).reduce((s,r)=>s.concat([r.columns])):[]}async syncCursor(t){return await this.putAll(t.cache)}async match(t){let e,s;if(this.def.schema.primaryKey&&(e=Te(t,this.def.schema.primaryKey))&&(s=await this.get(e)))return{matchingKey:"PRIMARY_KEY",primaryKey:e,row:s};let r=await this.primaryKeyColumns(),n=await this.columnsForConstraint("UNIQUE");r.concat(n).map(o=>`(${o.map(l=>`${this.quote(obj[l])} IN (${o.join(",")})`).join(" AND ")})`).join(" OR ");var i,a=Object.keys(this.def.schema.indexes).filter(o=>this.def.schema.indexes[o].type==="unique");return a.length&&(await this.getAll()).forEach((o,l)=>{i||a.forEach(u=>{var f=this.def.schema.indexes[u].keyPath;o&&Te(t,f)===Te(o,f)&&(i={matchingKey:u,primaryKey:this.def.schema.primaryKey?Te(o,this.def.schema.primaryKey):l,row:{...o}})})}),i}async addAll(t,e=[],s=null,r=!1){let n=[],i=[];for(let a of t){let o=a;if(Array.isArray(a)){let l=e.length?e:(await this.schema()).columns.map(u=>u.name);if(l.length&&l.length!==a.length)throw new Error(`Column/values count mismatch at line ${t.indexOf(a)}.`);o=l.reduce((u,f,m)=>({...u,[f]:a[m]}),{})}if(await this.handleInput(o,!0),await this.shouldMatchInput(o)||s){let l=await this.match(o);if(l&&s){let u={...l.row};s(u,o)&&i.push(u),n.push("0");continue}await this.beforeAdd(o,l),n.push(await this.add(o));continue}await this.beforeAdd(o),n.push(await this.add(o))}return i.length&&n.push(...await this.putAll(i)),n.filter((a,o)=>a!==0&&n.indexOf(a)===o)}async beforeAdd(t,e){let s=new Date().toISOString();for(let r of(await this.schema()).columns){let n=I(r.type)?r.type.name:r.type;(n==="datetime"||n==="timestamp")&&r.default.expr==="CURRENT_TIMESTAMP"&&(t[r.name]=s)}}async putAll(t){let e=[];for(let s of t){if(await this.handleInput(s),await this.shouldMatchInput(s)){await this.beforePut(s,await this.match(s)),e.push(await this.put(s));continue}await this.beforePut(s),e.push(await this.put(s))}return e}async beforePut(t,e){if(e&&!Object.keys(t).every(s=>t[s]===e.row[s])){let s=new Date().toISOString();for(let r of(await this.schema()).columns){let n=I(r.type)?r.type.name:r.type;(n==="datetime"||n==="timestamp")&&r.onupdate==="CURRENT_TIMESTAMP"&&(t[r.name]=s)}}}async deleteAll(t){let e=[];for(let s of t)e.push(this.delete(await this.beforeDelete(s)));return e}async beforeDelete(t){return t}async handleInput(t,e=!1){let s=Object.keys(t),r=await this.schema(),n=r.columns.map(a=>a.name),i=s.filter(a=>n.indexOf(a)===-1);if(i.length)throw new Error(`Unknown column: ${i[0]}`);for(let a of n){let o=t[a],l=r.columns.find(u=>u.name===a)||{};if(s.includes(a)){let u=I(l.type)?l.type.name:l.type;u==="json"?!H(o)&&(!z(o)||!q(o,"[","]")&&q(o,"{","}")):["char","tinytext","smalltext","text","bigtext","varchar"].includes(u)?z(o):["bit","tinyint","smallint","int","bigint","decimal","number","float","real"].includes(u)?v(o):["enum","set"].includes(u)?v(o):["date","datetime","timestamp"].includes(u)&&z(o)}else e&&!Pt([a],await this.primaryKeyColumns()).length&&(t[a]="default"in l&&!(["date","datetime","timestamp"].includes(columnType)&&l.default.expr==="CURRENT_TIMESTAMP")?l.default.value:null);if(l.notNull&&(St(t[a])||Z(t[a])))throw new Error(`Inserting NULL on non-nullable column: ${a}.`)}}async shouldMatchInput(t){return(await this.schema()).columns.some(e=>{let s=I(e.type)?e.type.name:e.type;return["datetime","timestamp"].includes(s)&&(e.default.expr==="CURRENT_TIMESTAMP"||e.onupdate==="CURRENT_TIMESTAMP")})}},Te=(c,t)=>Rt(t).map(e=>c[e]).filter(e=>e).join("-");var ie=class{_pos=0;_eof=!1;_onfinish=[];constructor(t){this._cache=t}get eof(){return!this._cache.length||this._pos===this._cache.length-1}onfinish(t){this._onfinish.push(t)}next(){if(this.eof){this._onfinish.forEach(t=>t()),this._pos=0;return}this._pos++}async fetch(){if(!this.eof)return this._cache[this._pos]}};var ne=class extends ie{constructor(t){super([]),this._store=t,this._storeFetch=new Promise(async e=>{this.cache=await this._store.getAll(),e()})}async fetch(){return await this._storeFetch,super.fetch()}};var ae=class extends re{getCursor(){return new ne(this)}async getAll(){return new Promise((t,e)=>{this.database.client.driver.query(`SELECT * FROM ${this.database.name}.${this.name}`,(s,r)=>{if(s)return e(s);t(r.rows||r)})})}async get(t){let e=await this.primaryKeyColumns();if(!e.length)throw new Error("Table has no primary key defined.");return new Promise((s,r)=>{this.database.client.driver.query(`SELECT * FROM ${this.database.name}.${this.name} WHERE '${t}' IN (${e.join(",")})`,[],(n,i)=>{if(n)return r(n);s((i.rows||i)[0])})})}async count(t="*"){return new Promise((e,s)=>{this.database.client.driver.query(`SELECT COUNT(${t}) AS c FROM ${this.database.name}.${this.name}`,(r,n)=>{if(r)return s(r);e((n.rows||n)[0].c)})})}async addAll(t,e=[],s=null){if(!t.length)return;let r={};return e.length||(I(t[0])?e=Object.keys(t[0]):e=(await this.database.describeTable(this.name)).columns.map(i=>i.name)),new Promise((n,i)=>{let a=`INSERT INTO ${this.database.name}.${this.name}
	${e.length?`(${e.join(",")})
	`:""}`;a+=`VALUES
	${t.map(o=>He(Object.values(o),this.database.client.params.dialect)).join(`,
	`)}`,s&&(s(r),a+=` ${this.database.client.params.dialect==="mysql"?"ON DUPLICATE KEY UPDATE":"ON CONFLICT DO UPDATE SET"} ${qe(r,this.database.client.params.dialect)}`),this.database.client.driver.query(a,(o,l)=>{if(o)return i(o);n(new Tt(this,l,e,t,r))})})}async add(t){return new Promise((e,s)=>{let r=`INSERT INTO ${this.database.name}.${this.name}
	(${Object.keys(t).join(",")})
	`;r+=`VALUES
	${He(Object.values(t),this.database.client.params.dialect)}
	`,r+="RETURNING *",this.database.client.driver.query(r,(n,i)=>{if(n)return s(n);e(new Tt(this,i,Object.keys(t),Object.values(t)))})})}async putAll(t){return await Promise.all(t.map(e=>this.put(e))),new Tt(this,{},Object.keys(t[0]),t)}async put(t){return new Promise((e,s)=>{let r=`INSERT INTO ${this.database.name}.${this.name}
	${Es(t,this.database.client.params.dialect)}`;this.database.client.driver.query(r,(n,i)=>{if(n)return s(n);e(new Tt(this,i,Object.keys(t),Object.values(t)))})})}async deleteAll(t=[]){let e=await this.primaryKeyColumns();if(!e.length)throw new Error("Table has no primary key defined.");return new Promise((s,r)=>{let n=`DELETE FROM ${this.database.name}.${this.name}${t.length?` WHERE ${t.map(i=>`'${i}' in (${e.join(",")})`).join(" OR ")}`:""}`;this.database.client.driver.query(n,[],(i,a)=>{if(i)return r(i);s(new Ht(this,a))})})}async delete(t){let e=await this.primaryKeyColumns();if(!e.length)throw new Error("Table has no primary key defined.");return new Promise((s,r)=>{let n=`DELETE FROM ${this.database.name}.${this.name} WHERE ${t} IN (${e.join(",")})`;this.database.client.driver.query(n,[],(i,a)=>{if(i)return r(i);s(new Ht(this,a))})})}},Ke=(c,t)=>{if(c instanceof Date)try{return`'${c.toISOString().split(".")[0]}'`}catch{return"NULL"}return v(c)?c:St(c)?"NULL":t==="mysql"?`'${c.replace(/'/g,"\\'")}'`:`'${c.replace(/'/g,"''")}'`},He=(c,t)=>"("+c.map(e=>Ke(e,t)).join(",")+")",qe=(c,t)=>Object.keys(c).map(e=>`${e} = ${Ke(c[e],t)}`).join(","),Es=(c,t)=>{let e=qe(c,t);return`SET ${e} ${t==="mysql"?"ON DUPLICATE KEY UPDATE":"ON CONFLICT DO UPDATE SET"} ${e}`};var oe=class extends te{static Table=ae;async tables(t={}){return this.tablesCallback(()=>new Promise((e,s)=>{let r=`SELECT table_name FROM information_schema.tables WHERE table_schema = '${this.name}'`;return this.client.driver.query(r,(n,i)=>{if(n)return s(n);e((i.rows||i).map(a=>a.table_name))})}),...arguments)}describeTable(t,e={}){return this.describeTableCallback((s,r)=>new Promise((n,i)=>{let a=this.client.driver,[o,l]=this.getDescribeTableSql(s);return a.query(o,(u,f)=>u?i(u):a.query(l,(m,E)=>{if(m)return i(m);let h=this.formatDescribeTableResult(s,f.rows||f,E.rows||E,[]);n(h)}))}),...arguments)}async createTable(t,e={}){return this.createTableCallback((s,r)=>new Promise((n,i)=>this.client.driver.query(s.toString(),(a,o)=>{if(a)return i(a);n(this.formatSideEffectResult(o))})),...arguments)}async alterTable(t,e,s={}){return this.alterTableCallback((r,n)=>{if(r.ACTIONS.length)return new Promise((i,a)=>this.client.driver.query(r.toString(),(o,l)=>{if(o)return a(o);i(this.formatSideEffectResult(l))}))},...arguments)}async dropTable(t,e={}){return this.dropTableCallback((s,r)=>new Promise((n,i)=>this.client.driver.query(s.toString(),(a,o)=>{if(a)return i(a);n(this.formatSideEffectResult(o))})),...arguments)}getDescribeTableSql(t){let e=`
        SELECT
            COLUMNS.column_name,
            COLUMNS.table_name,
            COLUMNS.ordinal_position,
            COLUMNS.column_default,
            COLUMNS.is_nullable,
            COLUMNS.data_type,
            COLUMNS.character_maximum_length,
            ${this.client.params.dialect==="mysql"?"":`
            COLUMNS.is_identity,
            COLUMNS.identity_generation,
            COLUMNS.identity_start,
            COLUMNS.identity_increment,
            COLUMNS.identity_maximum,
            COLUMNS.identity_minimum,
            COLUMNS.identity_cycle,
            `}
            COLUMNS.is_generated,
            COLUMNS.generation_expression

        FROM INFORMATION_SCHEMA.COLUMNS AS COLUMNS

        WHERE COLUMNS.TABLE_SCHEMA='${this.name}'
            ${t.length&&t[0]!=="*"?`AND COLUMNS.TABLE_NAME IN ('${t.join("','")}')`:""}
        ORDER BY COLUMNS.ordinal_position
        `,s=i=>this.client.params.dialect==="mysql"?i:`ANY_VALUE(${i})`,r=(i,a)=>this.client.params.dialect==="mysql"?`GROUP_CONCAT(${i}${a?` ORDER BY ${a}`:""} SEPARATOR ',')`:`STRING_AGG(${i}, ','${a?` ORDER BY ${a}`:""})`,n=`
        SELECT
            ${s("TABLE_CONSTRAINTS.table_name")} AS table_name,
            ${r("TABLE_CONSTRAINTS_DETAILS.column_name","TABLE_CONSTRAINTS_DETAILS.ordinal_position")} AS column_name,
            TABLE_CONSTRAINTS.constraint_name AS constraint_name,
            ${s("TABLE_CONSTRAINTS.constraint_type")} AS constraint_type,
            ${s("CHECK_CONSTRAINTS_DETAILS.check_clause")} AS check_clause,
                
            ${this.client.params.dialect==="mysql"?`
            ${s("CHECK_CONSTRAINTS_DETAILS.level")} AS check_constraint_level,
            ${r("TABLE_CONSTRAINTS_DETAILS.referenced_column_name")} AS referenced_column_name,
            ${s("TABLE_CONSTRAINTS_DETAILS.referenced_table_name")} AS referenced_table_name,
            ${s("TABLE_CONSTRAINTS_DETAILS.referenced_table_schema")} AS referenced_table_schema,
            `:`
            ${r("RELATION_DETAILS.column_name")} AS referenced_column_name,
            ${s("RELATION_DETAILS.table_name")} AS referenced_table_name,
            ${s("RELATION_DETAILS.table_schema")} AS referenced_table_schema,
            `}
            --${r("RELATION.unique_constraint_name")} AS referenced_constraint_name,
            ${s("RELATION.match_option")} AS match_rule,
            ${s("RELATION.update_rule")} AS update_rule,
            ${s("RELATION.delete_rule")} AS delete_rule

        FROM INFORMATION_SCHEMA.TABLE_CONSTRAINTS AS TABLE_CONSTRAINTS

        LEFT JOIN INFORMATION_SCHEMA.KEY_COLUMN_USAGE AS TABLE_CONSTRAINTS_DETAILS
            ON TABLE_CONSTRAINTS_DETAILS.CONSTRAINT_NAME = TABLE_CONSTRAINTS.CONSTRAINT_NAME
            AND TABLE_CONSTRAINTS_DETAILS.TABLE_NAME = TABLE_CONSTRAINTS.TABLE_NAME
            AND TABLE_CONSTRAINTS_DETAILS.CONSTRAINT_SCHEMA = TABLE_CONSTRAINTS.CONSTRAINT_SCHEMA
            AND TABLE_CONSTRAINTS_DETAILS.CONSTRAINT_CATALOG = TABLE_CONSTRAINTS.CONSTRAINT_CATALOG
        LEFT JOIN INFORMATION_SCHEMA.CHECK_CONSTRAINTS AS CHECK_CONSTRAINTS_DETAILS
            ON CHECK_CONSTRAINTS_DETAILS.CONSTRAINT_NAME = TABLE_CONSTRAINTS.CONSTRAINT_NAME
            AND CHECK_CONSTRAINTS_DETAILS.CONSTRAINT_SCHEMA = TABLE_CONSTRAINTS.CONSTRAINT_SCHEMA
            AND CHECK_CONSTRAINTS_DETAILS.CONSTRAINT_CATALOG = TABLE_CONSTRAINTS.CONSTRAINT_CATALOG

        LEFT JOIN INFORMATION_SCHEMA.REFERENTIAL_CONSTRAINTS AS RELATION
            ON RELATION.CONSTRAINT_NAME = TABLE_CONSTRAINTS.CONSTRAINT_NAME
            AND RELATION.CONSTRAINT_SCHEMA = TABLE_CONSTRAINTS.CONSTRAINT_SCHEMA
            AND RELATION.CONSTRAINT_CATALOG = TABLE_CONSTRAINTS.CONSTRAINT_CATALOG
        ${this.client.params.dialect==="mysql"?"":`
        LEFT JOIN INFORMATION_SCHEMA.KEY_COLUMN_USAGE AS RELATION_DETAILS
            ON RELATION_DETAILS.CONSTRAINT_NAME = RELATION.UNIQUE_CONSTRAINT_NAME
            AND RELATION_DETAILS.CONSTRAINT_SCHEMA = RELATION.UNIQUE_CONSTRAINT_SCHEMA
            AND RELATION_DETAILS.CONSTRAINT_CATALOG = RELATION.UNIQUE_CONSTRAINT_CATALOG
            `}

        WHERE TABLE_CONSTRAINTS.CONSTRAINT_SCHEMA = '${this.name}'
            ${t.length&&t[0]!=="*"?`AND TABLE_CONSTRAINTS.TABLE_NAME IN ('${t.join("','")}')`:""}
        GROUP BY (TABLE_CONSTRAINTS.constraint_name)
        `;return[e,n]}formatDescribeTableResult(t,e,s,r){let n=a=>a==="character varying"?"varchar":a==="integer"?"int":a,i=(a,o=!1)=>({...o?{}:{constraintName:a.constraint_name},basename:a.referenced_table_schema,table:a.referenced_table_name,columns:a.referenced_column_name.split(",").map(l=>l.trim()),...a.match_rule!=="NONE"?{matchRule:a.match_rule}:{},updateRule:a.update_rule,deleteRule:a.delete_rule});return(t.length&&t[0]!=="*"?t:[...new Set(e.map(a=>a.table_name))]).map(a=>{let o=e.filter(T=>T.table_name===a),l=s.filter(T=>T.table_name===a),u=r.filter(T=>T.table_name===a),f=o.map(T=>T.column_name),m=T=>{let O=(T.check_clause.replace(/(["'])(?:(?=(\\?))\2.)*?\1/g,"").match(/\w+/g)||[]).map(S=>S.toLowerCase());return T.columns=Pt(f,O),T},[E,h,d,N]=l.reduce(([T,O,S,C],w)=>w.constraint_type==="PRIMARY KEY"?[T.concat(w),O,S,C]:w.constraint_type==="UNIQUE"?[T,O.concat(w),S,C]:w.constraint_type==="FOREIGN KEY"?[T,O,S.concat(w),C]:w.constraint_type==="CHECK"&&!(this.client.params.dialect==="postgres"&&/^[\d_]+not_null/.test(w.constraint_name))?[T,O,S,C.concat(m(w))]:[T,O,S,C],[[],[],[],[]]),_={name:a,basename:this.name,columns:o.reduce((T,O)=>{let S={};return T.concat({name:O.column_name,type:O.character_maximum_length?{name:n(O.data_type),maxLen:O.character_maximum_length}:n(O.data_type),...E.length===1&&E[0].column_name===O.column_name&&(S.pKeys=E.pop())?{primaryKey:{constraintName:S.pKeys.constraint_name}}:{},...(S.uKeys=h.filter(C=>C.column_name===O.column_name)).length===1&&(h=h.filter(C=>C!==S.uKeys[0]))?{uniqueKey:{constraintName:S.uKeys[0].constraint_name}}:{},...(S.fKeys=d.filter(C=>C.column_name===O.column_name)).length===1&&(d=d.filter(C=>C!==S.fKeys[0]))?{references:i(S.fKeys[0])}:{},...(S.cKeys=N.filter(C=>C.check_constraint_level!=="Table"&&C.columns.length===1&&C.columns[0]===O.column_name)).length===1&&(N=N.filter(C=>C!==S.cKeys[0]))?{check:{constraintName:S.cKeys[0].constraint_name,expr:S.cKeys[0].check_clause}}:{},...O.is_identity!=="NO"?{identity:{always:O.identity_generation==="ALWAYS"}}:{},...O.is_generated!=="NEVER"?{generated:{always:O.is_generated==="ALWAYS",expr:O.generation_expression}}:{},...O.is_nullable==="NO"?{notNull:!0}:{},...O.default?{default:O.default}:{}})},[]),constraints:[],indexes:[]};return _.constraints.push(...[...E,...h,...d].map(T=>({constraintName:T.constraint_name,type:T.constraint_type,columns:T.column_name.split(",").map(O=>O.trim()),...T.constraint_type==="FOREIGN KEY"?{references:i(T,!0)}:{}}))),_.constraints.push(...N.map(T=>({constraintName:T.constraint_name,type:T.constraint_type,columns:T.columns,expr:T.check_clause}))),_})}formatSideEffectResult(t){return t}};var ce=class extends jt{constructor(t,e={}){if(typeof t!="object")throw new Error("The options.driver parameter is required and must be an object.");if(typeof t.query!="function")throw new Error("The provided driver must expose a .query() function.");super(t,e)}static kind="sql";static Database=oe;static systemDBs=["information_schema","mysql","performance_schema","sys","pg_catalog","pg_toast"];async searchPath(...t){return this.searchPathCallback(e=>new Promise((s,r)=>{let n=this.driver;if(e){e=e.map(l=>g.fromJson(this,l));let o=this.params.dialect==="mysql"?`USE ${e[0]}`:`SET SEARCH_PATH TO ${e.join(",")}`;return n.query(o,(l,u)=>{if(l)return r(l);s(u)})}let i,a;return this.params.dialect==="mysql"?(i="SELECT database() AS default_db",a="default_db"):(i="SHOW SEARCH_PATH",a="search_path",i="SELECT current_setting('SEARCH_PATH')",a="current_setting"),n.query(i,(o,l)=>{if(o)return r(o);let f=((l.rows||l)[0]||{})[a];s(p.split(f,[","]).map(m=>g.parseIdent(this,m.trim())[0]))})}),...t)}async databases(t={}){return this.databasesCallback(()=>new Promise((e,s)=>this.driver.query("SELECT schema_name FROM information_schema.schemata",(n,i)=>{if(n)return s(n);e((i.rows||i).map(a=>a.schema_name))})),t,this.constructor.systemDBs)}async createDatabase(t,e={}){return this.createDatabaseCallback((s,r,n)=>new Promise((i,a)=>this.driver.query(s.toString(),(o,l)=>{if(o)return a(o);i(l)})),...arguments)}async alterDatabase(t,e,s={}){return this.alterDatabaseCallback(async(r,n,i)=>{if(r.ACTIONS.length)return await n(),new Promise((a,o)=>this.driver.query(r.toString(),(l,u)=>{if(l)return o(l);a(u)}))},...arguments)}async dropDatabase(t,e={}){return this.dropDatabaseCallback((s,r)=>new Promise((n,i)=>this.driver.query(s.toString(),(a,o)=>{if(a)return i(a);n(o)})),...arguments)}async query(...t){return this.queryCallback(async(e,s)=>(e.expandable&&await e.expand(!0),new Promise((r,n)=>{console.log("..........////////",s),this.driver.query(`${e}`,s.params||[],(i,a)=>{if(i)return n(i);r(a.rows||a)})})),...t)}};self.webqit||(self.webqit={});self.webqit.ObjectiveSQL={SQL:ce};})();
//# sourceMappingURL=main.js.map
