import{_ as a,c as e,o as n,ag as l}from"./chunks/framework.B-XtCDNB.js";const D=JSON.parse('{"title":"UPSERT","description":"","frontmatter":{},"headers":[],"relativePath":"docs/capabilities/upsert.md","filePath":"docs/capabilities/upsert.md"}'),o={name:"docs/capabilities/upsert.md"};function p(t,s,c,r,i,y){return n(),e("div",null,[...s[0]||(s[0]=[l(`<h1 id="upsert" tabindex="-1">UPSERT <a class="header-anchor" href="#upsert" aria-label="Permalink to &quot;UPSERT&quot;">​</a></h1><p><em>Do upserts with a literal <code>UPSERT</code> statement.</em></p><div class="language-sql"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki material-theme-palenight vp-code" tabindex="0"><code><span class="line"><span style="color:#BABED8;">UPSERT </span><span style="color:#F78C6C;">INTO</span><span style="color:#BABED8;"> users (</span><span style="color:#F78C6C;">name</span><span style="color:#BABED8;">, email)</span></span>
<span class="line"><span style="color:#F78C6C;">VALUES</span><span style="color:#BABED8;"> (</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">Jane</span><span style="color:#89DDFF;">&#39;</span><span style="color:#BABED8;">, </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">jane@example.com</span><span style="color:#89DDFF;">&#39;</span><span style="color:#BABED8;">);</span></span></code></pre></div><p>It’s identical in form to <code>INSERT</code>, but performs <strong>update-on-conflict</strong> automatically using your schema’s defined unique or primary keys.</p><h2 id="overview" tabindex="-1">Overview <a class="header-anchor" href="#overview" aria-label="Permalink to &quot;Overview&quot;">​</a></h2><p>An <strong>UPSERT</strong> operation is an <code>INSERT</code> that automatically becomes an <code>UPDATE</code> when the inserted data matches an existing record by a unique or primary key.</p><p>Traditionally, this behavior requires dialect-specific conflict clauses:</p><div class="language-sql"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki material-theme-palenight vp-code" tabindex="0"><code><span class="line"><span style="color:#676E95;font-style:italic;">-- PostgreSQL</span></span>
<span class="line"><span style="color:#F78C6C;">INSERT INTO</span><span style="color:#BABED8;"> users (</span><span style="color:#F78C6C;">name</span><span style="color:#BABED8;">, email)</span></span>
<span class="line"><span style="color:#F78C6C;">VALUES</span><span style="color:#BABED8;"> (</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">Jane</span><span style="color:#89DDFF;">&#39;</span><span style="color:#BABED8;">, </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">jane@example.com</span><span style="color:#89DDFF;">&#39;</span><span style="color:#BABED8;">)</span></span>
<span class="line"><span style="color:#F78C6C;">ON</span><span style="color:#BABED8;"> CONFLICT (email) DO </span><span style="color:#F78C6C;">UPDATE</span><span style="color:#F78C6C;"> SET</span><span style="color:#F78C6C;"> name</span><span style="color:#89DDFF;"> =</span><span style="color:#BABED8;"> EXCLUDED.name;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">-- MySQL</span></span>
<span class="line"><span style="color:#F78C6C;">INSERT INTO</span><span style="color:#BABED8;"> users (</span><span style="color:#F78C6C;">name</span><span style="color:#BABED8;">, email)</span></span>
<span class="line"><span style="color:#F78C6C;">VALUES</span><span style="color:#BABED8;"> (</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">Jane</span><span style="color:#89DDFF;">&#39;</span><span style="color:#BABED8;">, </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">jane@example.com</span><span style="color:#89DDFF;">&#39;</span><span style="color:#BABED8;">)</span></span>
<span class="line"><span style="color:#F78C6C;">ON</span><span style="color:#BABED8;"> DUPLICATE </span><span style="color:#F78C6C;">KEY</span><span style="color:#F78C6C;"> UPDATE</span><span style="color:#F78C6C;"> name</span><span style="color:#89DDFF;"> =</span><span style="color:#F78C6C;"> VALUES</span><span style="color:#BABED8;">(</span><span style="color:#F78C6C;">name</span><span style="color:#BABED8;">);</span></span></code></pre></div><p>LinkedQL collapses that into one statement:</p><div class="language-sql"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki material-theme-palenight vp-code" tabindex="0"><code><span class="line"><span style="color:#BABED8;">UPSERT </span><span style="color:#F78C6C;">INTO</span><span style="color:#BABED8;"> users (</span><span style="color:#F78C6C;">name</span><span style="color:#BABED8;">, email)</span></span>
<span class="line"><span style="color:#F78C6C;">VALUES</span><span style="color:#BABED8;"> (</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">Jane</span><span style="color:#89DDFF;">&#39;</span><span style="color:#BABED8;">, </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">jane@example.com</span><span style="color:#89DDFF;">&#39;</span><span style="color:#BABED8;">);</span></span></code></pre></div><p>No conflict clause. No manual key specification. LinkedQL infers everything directly from your schema.</p><h2 id="basic-syntax" tabindex="-1">Basic Syntax <a class="header-anchor" href="#basic-syntax" aria-label="Permalink to &quot;Basic Syntax&quot;">​</a></h2><p><code>UPSERT</code> shares the exact same syntax as <code>INSERT</code>:</p><div class="language-sql"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki material-theme-palenight vp-code" tabindex="0"><code><span class="line"><span style="color:#BABED8;">UPSERT </span><span style="color:#F78C6C;">INTO</span><span style="color:#BABED8;"> table_name (col1, col2, ...)</span></span>
<span class="line"><span style="color:#F78C6C;">VALUES</span><span style="color:#BABED8;"> (val1, val2, ...);</span></span></code></pre></div><p>Just replace the keyword <code>INSERT</code> with <code>UPSERT</code>. All column and value rules remain identical — including multi-row inserts.</p><p><code>UPSERT</code> statements <strong>must not</strong> include explicit conflict clauses such as <code>ON CONFLICT</code> (PostgreSQL) or <code>ON DUPLICATE KEY</code> (MySQL); LinkedQL generates these internally.</p><h2 id="how-it-works" tabindex="-1">How It Works <a class="header-anchor" href="#how-it-works" aria-label="Permalink to &quot;How It Works&quot;">​</a></h2><p>LinkedQL already knows your schema — it draws on that here.</p><h3 id="dialect-aware-conflict-handling" tabindex="-1">Dialect-Aware Conflict Handling <a class="header-anchor" href="#dialect-aware-conflict-handling" aria-label="Permalink to &quot;Dialect-Aware Conflict Handling&quot;">​</a></h3><p>At compile time, LinkedQL rewrites an <code>UPSERT</code> into a dialect-appropriate <code>INSERT</code> with its conflict clause automatically generated.</p><p><strong>PostgreSQL (expanded):</strong></p><div class="language-sql"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki material-theme-palenight vp-code" tabindex="0"><code><span class="line"><span style="color:#F78C6C;">INSERT INTO</span><span style="color:#BABED8;"> users (</span><span style="color:#F78C6C;">name</span><span style="color:#BABED8;">, email)</span></span>
<span class="line"><span style="color:#F78C6C;">VALUES</span><span style="color:#BABED8;"> (</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">Jane</span><span style="color:#89DDFF;">&#39;</span><span style="color:#BABED8;">, </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">jane@example.com</span><span style="color:#89DDFF;">&#39;</span><span style="color:#BABED8;">)</span></span>
<span class="line"><span style="color:#F78C6C;">ON</span><span style="color:#BABED8;"> CONFLICT (email)</span></span>
<span class="line"><span style="color:#BABED8;">DO </span><span style="color:#F78C6C;">UPDATE</span><span style="color:#F78C6C;"> SET</span></span>
<span class="line"><span style="color:#F78C6C;">  name</span><span style="color:#89DDFF;"> =</span><span style="color:#BABED8;"> EXCLUDED.name,</span></span>
<span class="line"><span style="color:#BABED8;">  email </span><span style="color:#89DDFF;">=</span><span style="color:#BABED8;"> EXCLUDED.email;</span></span></code></pre></div><p><strong>MySQL (expanded):</strong></p><div class="language-sql"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki material-theme-palenight vp-code" tabindex="0"><code><span class="line"><span style="color:#F78C6C;">INSERT INTO</span><span style="color:#BABED8;"> users (</span><span style="color:#F78C6C;">name</span><span style="color:#BABED8;">, email)</span></span>
<span class="line"><span style="color:#F78C6C;">VALUES</span><span style="color:#BABED8;"> (</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">Jane</span><span style="color:#89DDFF;">&#39;</span><span style="color:#BABED8;">, </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">jane@example.com</span><span style="color:#89DDFF;">&#39;</span><span style="color:#BABED8;">)</span></span>
<span class="line"><span style="color:#F78C6C;">ON</span><span style="color:#BABED8;"> DUPLICATE </span><span style="color:#F78C6C;">KEY</span><span style="color:#F78C6C;"> UPDATE</span></span>
<span class="line"><span style="color:#F78C6C;">  name</span><span style="color:#89DDFF;"> =</span><span style="color:#F78C6C;"> VALUES</span><span style="color:#BABED8;">(</span><span style="color:#F78C6C;">name</span><span style="color:#BABED8;">),</span></span>
<span class="line"><span style="color:#BABED8;">  email </span><span style="color:#89DDFF;">=</span><span style="color:#F78C6C;"> VALUES</span><span style="color:#BABED8;">(email);</span></span></code></pre></div><p>Each target column is paired with an assignment expression for the update step. The compiler handles clause construction and dialect differences automatically.</p><h3 id="unique-key-resolution-postgresql" tabindex="-1">Unique Key Resolution (PostgreSQL) <a class="header-anchor" href="#unique-key-resolution-postgresql" aria-label="Permalink to &quot;Unique Key Resolution (PostgreSQL)&quot;">​</a></h3><p>Before emitting PostgreSQL SQL, LinkedQL inspects the table schema to determine which <strong>unique</strong> or <strong>primary key</strong> constraint should serve as the conflict target. MySQL requires no such step — its <code>ON DUPLICATE KEY UPDATE</code> clause automatically uses all defined keys.</p><p>LinkedQL’s selection process is schema-driven:</p><ol><li><p>It enumerates all primary and unique key constraints on the target table.</p></li><li><p>If multiple exist, it picks the first whose columns appear among the columns being upserted.</p></li><li><p>If none overlap, it falls back to the first available unique or primary key.</p></li><li><p>If no unique or primary keys are defined, compilation fails with a clear error:</p><blockquote><p>“Table <code>users</code> has no unique or primary keys defined to process an UPSERT operation.”</p></blockquote></li></ol><p>This ensures deterministic, schema-aware conflict resolution for PostgreSQL.</p><h2 id="appendix-a-—-notes-constraints" tabindex="-1">Appendix A — Notes &amp; Constraints <a class="header-anchor" href="#appendix-a-—-notes-constraints" aria-label="Permalink to &quot;Appendix A — Notes &amp; Constraints&quot;">​</a></h2><ul><li>Multi-row inserts are fully supported.</li><li>In PostgreSQL, the target table must define at least one <strong>unique</strong> or <strong>primary key</strong> constraint.</li></ul>`,32)])])}const u=a(o,[["render",p]]);export{D as __pageData,u as default};
